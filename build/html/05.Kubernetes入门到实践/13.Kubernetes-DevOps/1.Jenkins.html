<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jenkins &mdash; 运维开发修炼之路</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Gitlab" href="2.Gitlab.html" />
    <link rel="prev" title="13.Kubernetes-DevOps" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> 小健_Docker_K8s_Blog
            <img src="../../_static/docker-k8s.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../01.Docker%E6%8A%80%E6%9C%AF%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E6%88%983%E7%89%88/index.html">01.Docker技术入门与实战3版</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../02.Kubernetes%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97/index.html">02.Kubernetes实战指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../03.Docker%E7%BB%8F%E5%85%B8%E5%AE%9E%E4%BE%8B/index.html">03.Docker经典实例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../04.Prometheus%E7%9B%91%E6%8E%A7%E8%BF%90%E7%BB%B4%E5%AE%9E%E6%88%98/index.html">04.Prometheus监控运维实战</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">05.Kubernetes入门到实践</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../1.%E5%AE%B9%E5%99%A8%E7%9A%84%E5%8F%91%E5%B1%95%E5%8F%B2/index.html">1.容器的发展史</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2.Kubernetes%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5/index.html">2.Kubernetes的核心概念</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3.Kubernetes%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E9%83%A8%E7%BD%B2/index.html">3.Kubernetes的安装和部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4.Pod/index.html">4.Pod的基本操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5.%E6%8E%A7%E5%88%B6%E5%99%A8/index.html">5.控制器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../6.Service%E5%92%8CIngress/index.html">6.Service和Ingress</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7.%E5%AD%98%E5%82%A8%E4%B8%8E%E9%85%8D%E7%BD%AE/index.html">7.存储与配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../8.Kubernetes%E8%B5%84%E6%BA%90%E7%9A%84%E7%AE%A1%E7%90%86%E5%8F%8A%E8%B0%83%E5%BA%A6/index.html">8.Kubernetes资源的管理及调度</a></li>
<li class="toctree-l2"><a class="reference internal" href="../9.API-Server/index.html">9.API-Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10.Kubernetes%E7%9A%84%E6%89%A9%E5%B1%95/index.html">10.Kubernetes的扩展</a></li>
<li class="toctree-l2"><a class="reference internal" href="../11.%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E6%A1%88%E4%BE%8B/index.html">11.项目部署案例</a></li>
<li class="toctree-l2"><a class="reference internal" href="../12.Helm%E5%AD%A6%E4%B9%A0%E6%8C%87%E5%8D%97/index.html">12.Helm学习指南</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">13.Kubernetes-DevOps</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Jenkins</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">1.安装</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">2.架构</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">3.配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">4.测试</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">5.参考文献</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="2.Gitlab.html">Gitlab</a></li>
<li class="toctree-l3"><a class="reference internal" href="3.Harbor.html">Harbor</a></li>
<li class="toctree-l3"><a class="reference internal" href="4.Tekton.html">Tekton</a></li>
<li class="toctree-l3"><a class="reference internal" href="5.k9s%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7.html">k9s集群管理工具</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">小健_Docker_K8s_Blog</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">05.Kubernetes入门到实践</a> &raquo;</li>
          <li><a href="index.html">13.Kubernetes-DevOps</a> &raquo;</li>
      <li>Jenkins</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/05.Kubernetes入门到实践/13.Kubernetes-DevOps/1.Jenkins.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#jenkins" id="id7">Jenkins</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id8">1.安装</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id9">2.架构</a></p></li>
<li><p><a class="reference internal" href="#id3" id="id10">3.配置</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id11">4.测试</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id12">5.参考文献</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="jenkins">
<h1><a class="toc-backref" href="#id7">Jenkins</a><a class="headerlink" href="#jenkins" title="Permalink to this headline">¶</a></h1>
<p>提到基于 Kubernete 的CI/CD，可以使用的工具有很多，比如 Jenkins、Gitlab
CI 以及新兴的 drone 之类的，我们这里会使用大家最为熟悉的 Jenkins 来做
CI/CD 的工具。</p>
<blockquote>
<div><p>参考文档：</p>
<p><a class="reference external" href="https://github.com/jenkinsci/docker">https://github.com/jenkinsci/docker</a></p>
<p><a class="reference external" href="https://github.com/jenkinsci/helm-charts/tree/main/charts/jenkins">https://github.com/jenkinsci/helm-charts/tree/main/charts/jenkins</a></p>
</div></blockquote>
<section id="id1">
<h2><a class="toc-backref" href="#id8">1.安装</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>既然要基于 Kubernetes 来做 CI/CD，我们这里最好还是将 Jenkins 安装到
Kubernetes
集群当中，安装的方式也很多，我们这里仍然还是使用手动的方式，这样可以了解更多细节，对应的资源清单文件如下所示：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins-pv</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">storageClassName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">local</span>  <span class="c1"># Local PV</span>
  <span class="nt">capacity</span><span class="p">:</span>
    <span class="nt">storage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2Gi</span>
  <span class="nt">volumeMode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Filesystem</span>
  <span class="nt">accessModes</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
  <span class="nt">local</span><span class="p">:</span>
    <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/data/k8s/jenkins</span>
  <span class="nt">nodeAffinity</span><span class="p">:</span>
    <span class="nt">required</span><span class="p">:</span>
      <span class="nt">nodeSelectorTerms</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">matchExpressions</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kubernetes.io/hostname</span>
          <span class="nt">operator</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">In</span>
          <span class="nt">values</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ydzs-node6</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins-pvc</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-ops</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">storageClassName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">local</span>
  <span class="nt">accessModes</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
  <span class="nt">resources</span><span class="p">:</span>
    <span class="nt">requests</span><span class="p">:</span>
      <span class="nt">storage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2Gi</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-ops</span>
<span class="nn">---</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1beta1</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins</span>
<span class="nt">rules</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">apiGroups</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;extensions&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;apps&quot;</span><span class="p p-Indicator">]</span>
    <span class="nt">resources</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;deployments&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;ingresses&quot;</span><span class="p p-Indicator">]</span>
    <span class="nt">verbs</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;create&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;delete&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;list&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;watch&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;patch&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;update&quot;</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="nt">apiGroups</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;&quot;</span><span class="p p-Indicator">]</span>
    <span class="nt">resources</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;services&quot;</span><span class="p p-Indicator">]</span>
    <span class="nt">verbs</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;create&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;delete&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;list&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;watch&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;patch&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;update&quot;</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="nt">apiGroups</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;&quot;</span><span class="p p-Indicator">]</span>
    <span class="nt">resources</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;pods&quot;</span><span class="p p-Indicator">]</span>
    <span class="nt">verbs</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;create&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;delete&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;list&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;patch&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;update&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;watch&quot;</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="nt">apiGroups</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;&quot;</span><span class="p p-Indicator">]</span>
    <span class="nt">resources</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;pods/exec&quot;</span><span class="p p-Indicator">]</span>
    <span class="nt">verbs</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;create&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;delete&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;list&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;patch&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;update&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;watch&quot;</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="nt">apiGroups</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;&quot;</span><span class="p p-Indicator">]</span>
    <span class="nt">resources</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;pods/log&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;events&quot;</span><span class="p p-Indicator">]</span>
    <span class="nt">verbs</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;list&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;watch&quot;</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="nt">apiGroups</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;&quot;</span><span class="p p-Indicator">]</span>
    <span class="nt">resources</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;secrets&quot;</span><span class="p p-Indicator">]</span>
    <span class="nt">verbs</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">]</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ClusterRoleBinding</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-ops</span>
<span class="nt">roleRef</span><span class="p">:</span>
  <span class="nt">apiGroup</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
  <span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins</span>
<span class="nt">subjects</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins</span>
    <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-ops</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins-mirror-conf</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-ops</span>
<span class="nt">data</span><span class="p">:</span>
  <span class="nt">nginx.conf</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">user nginx;</span>
    <span class="no">worker_processes  3;</span>
    <span class="no">error_log  /dev/stderr;</span>
    <span class="no">events {</span>
      <span class="no">worker_connections  10240;</span>
    <span class="no">}</span>
    <span class="no">http {</span>
      <span class="no">log_format main &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span>
                      <span class="no">&#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span>
                      <span class="no">&#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; $request_time&#39;;</span>
      <span class="no">access_log    /dev/stdout main;</span>
      <span class="no">server {</span>
          <span class="no">listen 80;</span>
          <span class="no">server_name mirrors.jenkins-ci.org;</span>
          <span class="no">location / {</span>
            <span class="no">proxy_redirect off;</span>
            <span class="no">proxy_pass https://mirrors.tuna.tsinghua.edu.cn/jenkins/;</span>
            <span class="no">proxy_set_header X-Real-IP $remote_addr;</span>
            <span class="no">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span>
            <span class="no">proxy_set_header Accept-Encoding &quot;&quot;;</span>
            <span class="no">proxy_set_header Accept-Language &quot;zh-CN&quot;;</span>
          <span class="no">}</span>
          <span class="no">index index.html index.htm index.php;</span>
          <span class="no">location ~ /\. {</span>
            <span class="no">deny all;</span>
          <span class="no">}</span>
      <span class="no">}</span>
    <span class="no">}</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-ops</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">matchLabels</span><span class="p">:</span>
      <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins</span>
  <span class="nt">template</span><span class="p">:</span>
    <span class="nt">metadata</span><span class="p">:</span>
      <span class="nt">labels</span><span class="p">:</span>
        <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins</span>
    <span class="nt">spec</span><span class="p">:</span>
      <span class="nt">serviceAccount</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins</span>
      <span class="nt">hostAliases</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">ip</span><span class="p">:</span> <span class="s">&quot;127.0.0.1&quot;</span>
        <span class="nt">hostnames</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="s">&quot;mirrors.jenkins-ci.org&quot;</span>
      <span class="nt">initContainers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fix-permissions</span>
        <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">busybox</span>
        <span class="nt">command</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;sh&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;-c&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;chown</span><span class="nv"> </span><span class="s">-R</span><span class="nv"> </span><span class="s">1000:1000</span><span class="nv"> </span><span class="s">/var/jenkins_home&quot;</span><span class="p p-Indicator">]</span>
        <span class="nt">securityContext</span><span class="p">:</span>
          <span class="nt">privileged</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="nt">volumeMounts</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkinshome</span>
          <span class="nt">mountPath</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/var/jenkins_home</span>
      <span class="nt">containers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mirror</span>
        <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx:1.7.9</span>
        <span class="nt">ports</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">containerPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
        <span class="nt">volumeMounts</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">mountPath</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/nginx</span>
          <span class="nt">readOnly</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
          <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx-conf</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins</span>
        <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins/jenkins:lts</span>
        <span class="nt">imagePullPolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span>
        <span class="nt">ports</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">containerPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
          <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">web</span>
          <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
        <span class="p p-Indicator">-</span> <span class="nt">containerPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">50000</span>
          <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">agent</span>
          <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
        <span class="nt">resources</span><span class="p">:</span>
          <span class="nt">limits</span><span class="p">:</span>
            <span class="nt">cpu</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1500m</span>
            <span class="nt">memory</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2048Mi</span>
          <span class="nt">requests</span><span class="p">:</span>
            <span class="nt">cpu</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1500m</span>
            <span class="nt">memory</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2048Mi</span>
        <span class="nt">readinessProbe</span><span class="p">:</span>
          <span class="nt">httpGet</span><span class="p">:</span>
            <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/login</span>
            <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
          <span class="nt">initialDelaySeconds</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">60</span>
          <span class="nt">timeoutSeconds</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
          <span class="nt">failureThreshold</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">12</span>
        <span class="nt">volumeMounts</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkinshome</span>
          <span class="nt">mountPath</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/var/jenkins_home</span>
      <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkinshome</span>
        <span class="nt">persistentVolumeClaim</span><span class="p">:</span>
          <span class="nt">claimName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins-pvc</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx-conf</span>
        <span class="nt">configMap</span><span class="p">:</span>
          <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins-mirror-conf</span>
          <span class="nt">items</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="nt">key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx.conf</span>
            <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx.conf</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-ops</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins</span>
  <span class="nt">ports</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">web</span>
    <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
    <span class="nt">targetPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">web</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">agent</span>
    <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">50000</span>
    <span class="nt">targetPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">agent</span>
<span class="c1"># ---</span>
<span class="c1"># apiVersion: extensions/v1beta1</span>
<span class="c1"># kind: Ingress</span>
<span class="c1"># metadata:</span>
<span class="c1">#   name: jenkins</span>
<span class="c1">#   namespace: kube-ops</span>
<span class="c1"># spec:</span>
<span class="c1">#   rules:</span>
<span class="c1">#   - host: jenkins.k8s.local</span>
<span class="c1">#     http:</span>
<span class="c1">#       paths:</span>
<span class="c1">#       - backend:</span>
<span class="c1">#           serviceName: jenkins</span>
<span class="c1">#           servicePort: web</span>
<span class="nn">---</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">traefik.containo.us/v1alpha1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">IngressRoute</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-ops</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">entryPoints</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">web</span>
  <span class="nt">routes</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Rule</span>
    <span class="nt">match</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Host(`jenkins.k8s.local`)</span>
    <span class="nt">services</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jenkins</span>
      <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
</pre></div>
</div>
<p>我们这里使用一个名为 <code class="docutils literal notranslate"><span class="pre">jenkins/jenkins:lts</span></code> 的镜像，这是 jenkins 官方的
Docker
镜像，然后也有一些环境变量，当然我们也可以根据自己的需求来定制一个镜像，比如我们可以将一些插件打包在自定义的镜像当中，可以参考文档：<a class="reference external" href="https://github.com/jenkinsci/docker">https://github.com/jenkinsci/docker</a>，我们这里使用默认的官方镜像就行，另外一个还需要注意的数据的持久化，将容器的
<code class="docutils literal notranslate"><span class="pre">/var/jenkins_home</span></code> 目录持久化即可，同样为了性能考虑，我们这里使用
Local PV，将 Pod 调度到固定的节点上。</p>
<p>由于我们这里使用的镜像内部运行的用户
<code class="docutils literal notranslate"><span class="pre">uid=1000</span></code>，所以我们这里挂载出来后会出现权限问题，为解决这个问题，我们同样还是用一个简单的
<code class="docutils literal notranslate"><span class="pre">initContainer</span></code> 来修改下我们挂载的数据目录。</p>
<p>另外我们这里还需要使用到一个拥有相关权限的
<code class="docutils literal notranslate"><span class="pre">serviceAccount：jenkins</span></code>，我们这里只是给 jenkins
赋予了一些必要的权限，当然如果你对 serviceAccount
的权限不是很熟悉的话，我们给这个 sa 绑定一个 <code class="docutils literal notranslate"><span class="pre">cluster-admin</span></code>
的集群角色权限也是可以的，当然这样具有一定的安全风险。</p>
<p>除此之外，这里我们还添加了一个额外的名为 <code class="docutils literal notranslate"><span class="pre">mirror</span></code>
的容器，添加这个容器的目的是使用一个 nginx 容器来反向代理 Jenkins
插件的官方源到清华大学的源上面，因为官方源实在是太慢了，我们这里将官方的镜像地址
<code class="docutils literal notranslate"><span class="pre">mirrors.jenkins-ci.org</span></code> 通过 <code class="docutils literal notranslate"><span class="pre">hostAlias</span></code> 映射到了 <code class="docutils literal notranslate"><span class="pre">127.0.0.1</span></code>
这个地址上，而这个地址恰好就是 <code class="docutils literal notranslate"><span class="pre">mirror</span></code> 这个 nginx 容器，我们通过一个
ConfigMap 来配置 Nginx，将 <code class="docutils literal notranslate"><span class="pre">mirros.jenkins-ci.org</span></code> 反向代理到了
<code class="docutils literal notranslate"><span class="pre">proxy_pass</span> <span class="pre">https://mirrors.tuna.tsinghua.edu.cn/jenkins/;</span></code>，这样当我们在
Jenkins
中要下载插件的时候实际上会被代理到清华的源上面去，这样就大大加快了插件下载的速度。</p>
<p>最后就是通过 IngressRoute 来暴露我们的服务，这个比较简单。</p>
<p>我们直接来创建 jenkins 的资源清单即可：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f jenkins.yaml

$ kubectl get pods -n kube-ops -l <span class="nv">app</span><span class="o">=</span>jenkins
NAME                       READY   STATUS    RESTARTS   AGE
jenkins-5b957d4b8f-t22gp   <span class="m">2</span>/2     Running   <span class="m">0</span>          18m

$ kubectl logs -f jenkins-5b957d4b8f-t22gp jenkins -n kube-ops
......
<span class="m">2019</span>-12-16 <span class="m">13</span>:26:03.756+0000 <span class="o">[</span><span class="nv">id</span><span class="o">=</span><span class="m">39</span><span class="o">]</span>    INFO    hudson.model.AsyncPeriodicWork<span class="nv">$1</span><span class="c1">#run: Finished Download metadata. 28,073 ms</span>
<span class="m">2019</span>-12-16 <span class="m">13</span>:26:03.760+0000 <span class="o">[</span><span class="nv">id</span><span class="o">=</span><span class="m">26</span><span class="o">]</span>    INFO    jenkins.InitReactorRunner<span class="nv">$1</span><span class="c1">#onAttained: Completed initialization</span>
<span class="m">2019</span>-12-16 <span class="m">13</span>:26:03.863+0000 <span class="o">[</span><span class="nv">id</span><span class="o">=</span><span class="m">19</span><span class="o">]</span>    INFO    hudson.WebAppMain<span class="nv">$3</span><span class="c1">#run: Jenkins is fully up and running</span>
</pre></div>
</div>
<p>看到上面的 <code class="docutils literal notranslate"><span class="pre">run:</span> <span class="pre">Jenkins</span> <span class="pre">is</span> <span class="pre">fully</span> <span class="pre">up</span> <span class="pre">and</span> <span class="pre">running</span></code> 信息就证明我们的
Jenkins 应用以前启动起来了。</p>
<p>然后我们可以通过 IngressRoute 中定义的域名
<code class="docutils literal notranslate"><span class="pre">jenkins.k8s.local</span></code>(需要做 DNS 解析或者在本地 <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code>
中添加映射)来访问 jenkins 服务：</p>
<p><img alt="image0" src="../../_images/image-20220526094058494.png" /></p>
<p>然后可以执行下面的命令获取解锁的管理员密码：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ kubectl <span class="nb">exec</span> -it jenkins-5b957d4b8f-t22gp -c jenkins -n kube-ops -- cat /var/jenkins_home/secrets/initialAdminPassword
35b083de1d25409eaef57255e0da481a   <span class="c1"># jenkins启动日志里面也有</span>
</pre></div>
</div>
<p>然后选择安装推荐的插件即可，由于我们已经做了插件的反向代理了，所以理论上安装速度会比较快</p>
<p><img alt="image1" src="../../_images/image-20220526094129373.png" /></p>
<p>安装完成后添加管理员帐号即可进入到 jenkins 主界面：</p>
<p><img alt="image2" src="../../_images/image-20220526094150742.png" /></p>
</section>
<section id="id2">
<h2><a class="toc-backref" href="#id9">2.架构</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>Jenkins 安装完成了，接下来我们不用急着就去使用，我们要了解下在
Kubernetes 环境下面使用 Jenkins 有什么好处。</p>
<p>我们知道持续构建与发布是我们日常工作中必不可少的一个步骤，目前大多公司都采用
Jenkins 集群来搭建符合需求的 CI/CD 流程，然而传统的 Jenkins Slave
一主多从方式会存在一些痛点，比如：</p>
<ul class="simple">
<li><p>主 Master 发生单点故障时，整个流程都不可用了</p></li>
<li><p>每个 Slave
的配置环境不一样，来完成不同语言的编译打包等操作，但是这些差异化的配置导致管理起来非常不方便，维护起来也是比较费劲</p></li>
<li><p>资源分配不均衡，有的 Slave 要运行的 job 出现排队等待，而有的 Slave
处于空闲状态</p></li>
<li><p>资源有浪费，每台 Slave 可能是物理机或者虚拟机，当 Slave
处于空闲状态时，也不会完全释放掉资源。</p></li>
</ul>
<p>正因为上面的这些种种痛点，我们渴望一种更高效更可靠的方式来完成这个 CI/CD
流程，而 Docker 虚拟化容器技术能很好的解决这个痛点，又特别是在
Kubernetes 集群环境下面能够更好来解决上面的问题，下图是基于 Kubernetes
搭建 Jenkins 集群的简单示意图：</p>
<p><img alt="image3" src="../../_images/image-20220526094345086.png" /></p>
<p>从图上可以看到 <code class="docutils literal notranslate"><span class="pre">Jenkins</span> <span class="pre">Master</span></code> 和 <code class="docutils literal notranslate"><span class="pre">Jenkins</span> <span class="pre">Slave</span></code> 以 Pod 形式运行在
Kubernetes 集群的 Node 上，Master
运行在其中一个节点，并且将其配置数据存储到一个 Volume 上去，Slave
运行在各个节点上，并且它不是一直处于运行状态，它会按照需求动态的创建并自动删除。</p>
<p>这种方式的工作流程大致为：当 Jenkins Master 接受到 Build
请求时，会根据配置的 Label 动态创建一个运行在 Pod 中的 Jenkins Slave
并注册到 Master 上，当运行完 Job 后，这个 Slave 会被注销并且这个 Pod
也会自动删除，恢复到最初状态。</p>
<p>那么我们使用这种方式带来了哪些好处呢？</p>
<ul class="simple">
<li><p><strong>服务高可用</strong>，当 Jenkins Master 出现故障时，Kubernetes
会自动创建一个新的 Jenkins Master 容器，并且将 Volume
分配给新创建的容器，保证数据不丢失，从而达到集群服务高可用。</p></li>
<li><p><strong>动态伸缩</strong>，合理使用资源，每次运行 Job 时，会自动创建一个 Jenkins
Slave，Job 完成后，Slave 自动注销并删除容器，资源自动释放，而且
Kubernetes 会根据每个资源的使用情况，动态分配 Slave
到空闲的节点上创建，降低出现因某节点资源利用率高，还排队等待在该节点的情况。</p></li>
<li><p><strong>扩展性好</strong>，当 Kubernetes 集群的资源严重不足而导致 Job
排队等待时，可以很容易的添加一个 Kubernetes Node
到集群中，从而实现扩展。 是不是以前我们面临的种种问题在 Kubernetes
集群环境下面是不是都没有了啊？看上去非常完美。</p></li>
</ul>
</section>
<section id="id3">
<h2><a class="toc-backref" href="#id10">3.配置</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>接下来我们就需要来配置 Jenkins，让他能够动态的生成 Slave 的 Pod。</p>
<p>第1步. 我们需要安装 <a class="reference external" href="https://github.com/jenkinsci/kubernetes-plugin">kubernetes
插件</a>， 点击 Manage
Jenkins -&gt; Manage Plugins -&gt; Available -&gt; Kubernetes 勾选安装即可。</p>
<p><img alt="image4" src="../../_images/image-20220526094643977.png" /></p>
<p>第2步. 安装完毕后，点击 Manage Jenkins —&gt; Configure System —&gt;
(拖到最下方)，如果有 <code class="docutils literal notranslate"><span class="pre">Add</span> <span class="pre">a</span> <span class="pre">new</span> <span class="pre">cloud</span></code> —&gt; 选择 Kubernetes，然后填写
Kubernetes 和 Jenkins 配置信息即可，但是最新版本的 Kubernetes
插件将配置单独放置到了一个页面中：</p>
<p><img alt="image5" src="../../_images/image-20220526094711782.png" /></p>
<p>这个时候需要点击 <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">separate</span> <span class="pre">configuration</span> <span class="pre">page</span></code> 这个链接，跳转到
<code class="docutils literal notranslate"><span class="pre">Configure</span> <span class="pre">Cloud</span></code> 页面：</p>
<p><img alt="image6" src="../../_images/image-20220526094735008.png" /></p>
<p>在该页面我们可以点击 <code class="docutils literal notranslate"><span class="pre">Add</span> <span class="pre">a</span> <span class="pre">new</span> <span class="pre">cloud</span></code> -&gt; 选择 Kubernetes，然后填写
Kubernetes 和 Jenkins 配置信息：</p>
<figure class="align-default" id="id6">
<img alt="image-20220526094804415" src="../../_images/image-20220526094804415.png" />
<figcaption>
<p><span class="caption-text">image-20220526094804415</span><a class="headerlink" href="#id6" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>注意 namespace，我们这里填 kube-ops，然后点击
<code class="docutils literal notranslate"><span class="pre">Test</span> <span class="pre">Connection</span></code>，如果出现 <code class="docutils literal notranslate"><span class="pre">Connection</span> <span class="pre">test</span> <span class="pre">successful</span></code>
的提示信息证明 Jenkins 已经可以和 Kubernetes 系统正常通信了，然后下方的
Jenkins URL
地址：<code class="docutils literal notranslate"><span class="pre">http://jenkins.kube-ops.svc.cluster.local:8080</span></code>，这里的格式为：<code class="docutils literal notranslate"><span class="pre">svc服务名.namespace.svc.cluster.local:8080</span></code>，根据上面创建的
jenkins 的服务名填写。</p>
<p>第3步. 配置 <code class="docutils literal notranslate"><span class="pre">Pod</span> <span class="pre">Template</span></code>，其实就是配置 Jenkins Slave 运行的 Pod
模板，命名空间我们同样是用 kube-ops，Labels 这里也非常重要，对于后面执行
Job 的时候需要用到该值，然后我们这里使用的是 <code class="docutils literal notranslate"><span class="pre">cnych/jenkins:jnlp6</span></code>
这个镜像，这个镜像是在官方的 jnlp 镜像基础上定制的，加入了
docker、kubectl 等一些实用的工具。</p>
<p><img alt="image7" src="../../_images/image-20220526100539223.png" /></p>
<p>:warning:<strong>注意</strong>：</p>
<p>容器的名称必须是 jnlp，这是默认拉起的容器，另外需要将 <code class="docutils literal notranslate"><span class="pre">Command</span> <span class="pre">to</span> <span class="pre">run</span></code>
和 <code class="docutils literal notranslate"><span class="pre">Arguments</span> <span class="pre">to</span> <span class="pre">pass</span> <span class="pre">to</span> <span class="pre">the</span> <span class="pre">command</span></code> 的值都删除掉，否则会失败。</p>
<p>然后我们这里需要在下面挂载两个主机目录，一个是
<code class="docutils literal notranslate"><span class="pre">/var/run/docker.sock</span></code>，该文件是用于 Pod 中的容器能够共享宿主机的
Docker，这就是大家说的 <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">in</span> <span class="pre">docker</span></code> 的方式，Docker
二进制文件已经打包到上面的镜像中了，另外一个目录下 <code class="docutils literal notranslate"><span class="pre">/root/.kube</span></code>
目录，我们将这个目录挂载到容器的 <code class="docutils literal notranslate"><span class="pre">/root/.kube</span></code>
目录下面这是为了让我们能够在 Pod 的容器中能够使用 <code class="docutils literal notranslate"><span class="pre">kubectl</span></code>
工具来访问我们的 Kubernetes 集群，方便我们后面在 <code class="docutils literal notranslate"><span class="pre">Slave</span> <span class="pre">Pod</span></code> 部署
Kubernetes 应用。</p>
<p><img alt="image8" src="../../_images/image-20220526103027808.png" /></p>
<p>另外如果在配置了后运行 Slave Pod 的时候出现了权限问题，这是因为 Jenkins
Slave Pod 中没有配置权限，所以需要配置上 ServiceAccount，在 Slave Pod
配置的地方点击下面的高级，添加上对应的 ServiceAccount 即可：</p>
<p><img alt="image9" src="../../_images/image-20220526103054666.png" /></p>
<p>到这里我们的 Kubernetes 插件就算配置完成了。</p>
</section>
<section id="id4">
<h2><a class="toc-backref" href="#id11">4.测试</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<p>Kubernetes 插件的配置工作完成了，接下来我们就来添加一个 Job
任务，看是否能够在 Slave Pod 中执行，任务执行完成后看 Pod 是否会被销毁。</p>
<p>在 Jenkins 首页点击
<code class="docutils literal notranslate"><span class="pre">create</span> <span class="pre">new</span> <span class="pre">jobs</span></code>，创建一个测试的任务，输入任务名称，然后我们选择
<code class="docutils literal notranslate"><span class="pre">Freestyle</span> <span class="pre">project</span></code> 类型的任务，注意在下面的 <code class="docutils literal notranslate"><span class="pre">Label</span> <span class="pre">Expression</span></code>
这里要填入 <code class="docutils literal notranslate"><span class="pre">ydzs-jnlp</span></code>，就是前面我们配置的 Slave Pod 中的
Label，这两个地方必须保持一致：</p>
<p><img alt="image10" src="../../_images/image-20220526103302267.png" /></p>
<p>然后往下拉，在 Build 区域选择<code class="docutils literal notranslate"><span class="pre">Execute</span> <span class="pre">shell</span></code></p>
<p><img alt="image11" src="../../_images/image-20220526103326369.png" /></p>
<p>然后输入我们测试命令</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s2">&quot;测试 Kubernetes 动态生成 jenkins slave&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;==============docker in docker===========&quot;</span>
docker info

<span class="nb">echo</span> <span class="s2">&quot;=============kubectl=============&quot;</span>
kubectl get pods
</pre></div>
</div>
<p>最后点击保存</p>
<p><img alt="image12" src="../../_images/image-20220526103909603.png" /></p>
<p>现在我们直接在页面点击左侧的 <code class="docutils literal notranslate"><span class="pre">Build</span> <span class="pre">now</span></code> 触发构建即可，然后观察
Kubernetes 集群中 Pod 的变化：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ kubectl get pods -n kube-ops
NAME                                           READY   STATUS              RESTARTS   AGE
jenkins-68ccff445c-dk24f                       <span class="m">1</span>/1     Running             <span class="m">0</span>          12h
jnlp-1g893                                     <span class="m">0</span>/1     ContainerCreating   <span class="m">0</span>          83s
</pre></div>
</div>
<p>我们可以看到在我们点击立刻构建的时候可以看到一个新的 Pod：jnlp-1g893
被创建了，这就是我们的 Jenkins
Slave。任务执行完成后我们可以看到任务信息，比如我们这里是 花费了 21s
时间在 jnlp-1g893 这个 Slave上面</p>
<p><img alt="image13" src="../../_images/image-20220526103936149.png" /></p>
<p>到这里证明我们的任务已经构建完成，然后这个时候我们再去集群查看我们的 Pod
列表，发现 kube-ops 这个 namespace 下面已经没有之前的 Slave 这个 Pod
了。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ kubectl get pods -n kube-ops
NAME                                           READY   STATUS              RESTARTS   AGE
jenkins-68ccff445c-dk24f                       <span class="m">1</span>/1     Running             <span class="m">0</span>          12h
</pre></div>
</div>
<p>到这里我们就完成了使用 Kubernetes 动态生成 Jenkins Slave 的方法。</p>
</section>
<section id="id5">
<h2><a class="toc-backref" href="#id12">5.参考文献</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://www.qikqiak.com/k8strain/devops/jenkins/">https://www.qikqiak.com/k8strain/devops/jenkins/</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="13.Kubernetes-DevOps" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="2.Gitlab.html" class="btn btn-neutral float-right" title="Gitlab" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, huxiaojian.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>