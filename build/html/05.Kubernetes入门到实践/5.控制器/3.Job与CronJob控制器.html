<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Job与CronJob控制器 &mdash; 运维开发修炼之路</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="StatefulSet控制器" href="4.StatefulSet%E6%8E%A7%E5%88%B6%E5%99%A8.html" />
    <link rel="prev" title="DaemonSet控制器" href="2.DaemonSet%E6%8E%A7%E5%88%B6%E5%99%A8.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> 小健_Docker_K8s_Blog
            <img src="../../_static/docker-k8s.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../01.Docker%E6%8A%80%E6%9C%AF%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E6%88%983%E7%89%88/index.html">01.Docker技术入门与实战3版</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../02.Kubernetes%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97/index.html">02.Kubernetes实战指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../03.Docker%E7%BB%8F%E5%85%B8%E5%AE%9E%E4%BE%8B/index.html">03.Docker经典实例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../04.Prometheus%E7%9B%91%E6%8E%A7%E8%BF%90%E7%BB%B4%E5%AE%9E%E6%88%98/index.html">04.Prometheus监控运维实战</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">05.Kubernetes入门到实践</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../1.%E5%AE%B9%E5%99%A8%E7%9A%84%E5%8F%91%E5%B1%95%E5%8F%B2/index.html">1.容器的发展史</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2.Kubernetes%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5/index.html">2.Kubernetes的核心概念</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3.Kubernetes%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E9%83%A8%E7%BD%B2/index.html">3.Kubernetes的安装和部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4.Pod/index.html">4.Pod的基本操作</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">5.控制器</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="1.Deployment%E6%8E%A7%E5%88%B6%E5%99%A8.html">Deployment控制器</a></li>
<li class="toctree-l3"><a class="reference internal" href="2.DaemonSet%E6%8E%A7%E5%88%B6%E5%99%A8.html">DaemonSet控制器</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Job与CronJob控制器</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#job">1.Job控制器的基本操作</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">2. Job的异常处理</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cronjob">3.CronJob控制器的基本操作</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="4.StatefulSet%E6%8E%A7%E5%88%B6%E5%99%A8.html">StatefulSet控制器</a></li>
<li class="toctree-l3"><a class="reference internal" href="5.HPA.html">HPA 控制器</a></li>
<li class="toctree-l3"><a class="reference internal" href="6.%E5%85%B6%E4%BB%96%E6%8E%A7%E5%88%B6%E5%99%A8.html">其他控制器</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../6.Service%E5%92%8CIngress/index.html">6.Service和Ingress</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7.%E5%AD%98%E5%82%A8%E4%B8%8E%E9%85%8D%E7%BD%AE/index.html">7.存储与配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../8.Kubernetes%E8%B5%84%E6%BA%90%E7%9A%84%E7%AE%A1%E7%90%86%E5%8F%8A%E8%B0%83%E5%BA%A6/index.html">8.Kubernetes资源的管理及调度</a></li>
<li class="toctree-l2"><a class="reference internal" href="../9.API-Server/index.html">9.API-Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10.Kubernetes%E7%9A%84%E6%89%A9%E5%B1%95/index.html">10.Kubernetes的扩展</a></li>
<li class="toctree-l2"><a class="reference internal" href="../11.%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E6%A1%88%E4%BE%8B/index.html">11.项目部署案例</a></li>
<li class="toctree-l2"><a class="reference internal" href="../12.Helm%E5%AD%A6%E4%B9%A0%E6%8C%87%E5%8D%97/index.html">12.Helm学习指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../13.Kubernetes-DevOps/index.html">13.Kubernetes-DevOps</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">小健_Docker_K8s_Blog</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">05.Kubernetes入门到实践</a> &raquo;</li>
          <li><a href="index.html">5.控制器</a> &raquo;</li>
      <li>Job与CronJob控制器</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/05.Kubernetes入门到实践/5.控制器/3.Job与CronJob控制器.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#jobcronjob" id="id6">Job与CronJob控制器</a></p>
<ul>
<li><p><a class="reference internal" href="#job" id="id7">1.Job控制器的基本操作</a></p>
<ul>
<li><p><a class="reference internal" href="#job-yaml" id="id8">1.1. Job yaml模板</a></p></li>
<li><p><a class="reference internal" href="#id1" id="id9">1.1 一次性任务</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id10">1.2 串行式任务</a></p></li>
<li><p><a class="reference internal" href="#id3" id="id11">1.3 并行式任务</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id4" id="id12">2. Job的异常处理</a></p>
<ul>
<li><p><a class="reference internal" href="#onfailure" id="id13">2.1 OnFailure</a></p></li>
<li><p><a class="reference internal" href="#never" id="id14">2.2 Never</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id15">2.3 超时时间</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#cronjob" id="id16">3.CronJob控制器的基本操作</a></p>
<ul>
<li><p><a class="reference internal" href="#cronjob-yaml" id="id17">3.1 CronJob控制器 yaml模板</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<section id="jobcronjob">
<h1><a class="toc-backref" href="#id6">Job与CronJob控制器</a><a class="headerlink" href="#jobcronjob" title="Permalink to this heading">¶</a></h1>
<p>Kubernetes中还有一种叫作Job的工作负载对象，它基于某一特定任务而运行。</p>
<p>当运行任务的容器完成工作后，就会成功退出。</p>
<p>如果需要执行一次性任务，而非提供连续的服务，Job就非常适合。</p>
<p>CronJob控制器其实就是在Job的基础上加上了时间调度，可以在给定的时间点运行一个任务，也可以定期地运行。</p>
<p><strong>这个控制器实际上和Linux系统中的crontab命令非常类似。</strong></p>
<section id="job">
<h2><a class="toc-backref" href="#id7">1.Job控制器的基本操作</a><a class="headerlink" href="#job" title="Permalink to this heading">¶</a></h2>
<p>Job控制器可以执行3种类型的任务。</p>
<ul class="simple">
<li><p>一次性任务：通常只会启动一个Pod（除非Pod失败）。一旦Pod成功终止，Job就算完成了。</p></li>
<li><p>串行式任务：连续、多次地执行某一任务。当上一个任务完成时，接着执行下一个任务，直到全部任务执行完，可以通过spec.completions属性指定执行次数。</p></li>
<li><p>并行式任务：同一时间并发多次执行任务。可以通过
spec.parallelism指定并发数，也可以配合
spec.completions属性指定总任务的执行次数。</p></li>
</ul>
<section id="job-yaml">
<h3><a class="toc-backref" href="#id8">1.1. Job yaml模板</a><a class="headerlink" href="#job-yaml" title="Permalink to this heading">¶</a></h3>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">batch/v1</span><span class="w">  </span><span class="c1">#必填，版本号</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Job</span><span class="w"> </span><span class="c1"># 必填，资源类型</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c1"># 必填，元数据</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;name&gt;-job</span><span class="w"> </span><span class="c1"># 必填，资源名称</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span><span class="w"> </span><span class="c1"># pod所属的命名空间</span><span class="w"></span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c1"># 自定义标签</span><span class="w"></span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span><span class="w"> </span><span class="c1">#自定义标签名字&lt;key: value&gt;</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c1"># 必填，部署的详细定义</span><span class="w"></span>
<span class="w">  </span><span class="nt">completions</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">int</span><span class="w"> </span><span class="c1"># 资源重复作业数，默认值: 1</span><span class="w"></span>
<span class="w">  </span><span class="nt">parallelism</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">int</span><span class="w"> </span><span class="c1"># 资源并行作业数，默认值: 1</span><span class="w"></span>
<span class="w">  </span><span class="nt">backoffLimit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">int</span><span class="w"> </span><span class="c1"># 资源失败重试次数，默认值：6</span><span class="w"></span>
<span class="w">  </span><span class="nt">activeDeadlineSecond</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">int</span><span class="w"> </span><span class="c1"># 资源作业超时时间，默认0 永不超时</span><span class="w"></span>
<span class="w">  </span><span class="nt">ttlSecondsAfterFinished</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">int</span><span class="w"> </span><span class="c1"># 任务执行完，多少秒自动删除，默认300</span><span class="w"></span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="c1"># 必填，应用容器模板定义</span><span class="w"></span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w"> </span><span class="c1">#此处参考pod的containers</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span><span class="w"></span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox:latest</span><span class="w"></span>
<span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;echo&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;hello</span><span class="nv"> </span><span class="s">world&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span><span class="w"> </span><span class="c1"># job类型资源重启策略必须为Never或者OnFailure</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>yaml示例：以busybox镜像启动，输出hello
world举例。记得将重启策略设置为Never或者OnFailure</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">batch/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Job</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello-job</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span><span class="w"></span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello-job</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span><span class="w"></span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox:latest</span><span class="w"></span>
<span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;echo&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;hello</span><span class="nv"> </span><span class="s">world&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="id1">
<h3><a class="toc-backref" href="#id9">1.1 一次性任务</a><a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">examplejobv1.yml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">batch/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Job</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">examplejobv1</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span><span class="w"></span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">examplejobcontainer</span><span class="w"></span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span><span class="w"></span>
<span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;sh&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;-c&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;echo</span><span class="nv"> </span><span class="s">&quot;Start</span><span class="nv"> </span><span class="s">Job!&quot;;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">30;</span><span class="nv"> </span><span class="s">echo</span><span class="nv"> </span><span class="s">&quot;Job</span><span class="nv"> </span><span class="s">Done!&quot;&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>
</pre></div>
</div>
<p>该模板的含义如下。</p>
<ul class="simple">
<li><p>apiVersion表示使用的API版本，Job位于batch/v1中，v1表示使用Kubernetes
API的稳定版本。</p></li>
<li><p>kind表示要创建的资源对象，这里使用关键字Job。</p></li>
<li><p>metadata表示该资源对象的元数据。一个资源对象可拥有多个元数据，其中一项是name，它表示当前资源的名称。</p></li>
<li><p>spec表示该资源对象的具体设置。</p></li>
<li><p>template：Pod模板，具体的模板定义。这里创建了一个Pod，Pod启动后会执行一连串命令，刚开始会输出
“Start Job!”，然后休眠30s（假设在处理任务），任务完成后输出“Job
Done!”。</p></li>
</ul>
<p>接下来，运行以下命令，通过模板创建Job。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f examplejobv1.yml
</pre></div>
</div>
<p>现在，Job开始运行。可以通过以下命令查看Job的运行状态，
COMPLETIONS表示执行进度，DURATION表示当前Job的执行时间。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl get job
NAME           COMPLETIONS   DURATION   AGE
examplejobv1   <span class="m">1</span>/1           32s        0s
</pre></div>
</div>
<p>此时通过<code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">pod</span> <span class="pre">-o</span> <span class="pre">wide</span></code>命令可以看到已经创建了一个对应于Job的Pod，且它处于运行完成状态</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl get pod -o wide
NAME                 READY   STATUS      RESTARTS   AGE     IP           NODE            NOMINATED NODE   READINESS GATES
examplejobv1-vnw6j   <span class="m">0</span>/1     Completed   <span class="m">0</span>          2m18s   <span class="m">10</span>.0.23.57   gitee-k8s-w28   &lt;none&gt;           &lt;none&gt;
</pre></div>
</div>
<p>这个Job会执行30s，待Job执行完毕后再通过各个命令查看其状态。可以发现已经发生了变化。</p>
<p>Job状态中的COMPLETIONS变为1/1，表示全部执行完成；DURATION表示Job总共执行了32s；</p>
<p>而Pod状态变为Completed；因为不再运行；所以READY变为0/1。</p>
<p>最后查看日志，发现结束日志“Job Done!”已输出到控制台</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl logs pod/examplejobv1-vnw6j
Start Job!
Job Done!
</pre></div>
</div>
<p>执行完毕后，可以通过<code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">kubectl</span> <span class="pre">delete</span> <span class="pre">job</span> <span class="pre">examplejobv1</span></code>命令将Job删除。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl delete job examplejobv1
job.batch <span class="s2">&quot;examplejobv1&quot;</span> deleted
</pre></div>
</div>
<blockquote>
<div><p>注意：Job执行完成后是不会自动删除的。执行后保留它有一定好处，如用于查看执行日志，或者在出现问题时了解Pod所处的状态。</p>
</div></blockquote>
<p>但坏处在于，如果执行次数越多，并且不删除，则这种垃圾式的残留
Job也会越多，人工删除会略显麻烦。有没有自动删除的办法呢？</p>
<p><em>答案是肯定的。只需要修改yml文件，加上一个spec.ttlSecondsAfterFinished属性，该属性用于确定在所有任务执行完成后，需要等待多少秒才可删除Job。</em></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">batch/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Job</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">examplejobv1</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">automountServiceAccountToken</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span><span class="w"></span>
<span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span><span class="w"></span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">examplejobcontainer</span><span class="w"></span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span><span class="w"></span>
<span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;sh&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;-c&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;echo</span><span class="nv"> </span><span class="s">&quot;Start</span><span class="nv"> </span><span class="s">Job!&quot;;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">30;</span><span class="nv"> </span><span class="s">echo</span><span class="nv"> </span><span class="s">&quot;Job</span><span class="nv"> </span><span class="s">Done!&quot;&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>
</pre></div>
</div>
<p>这个功能默认是关闭的，需要手动开启，修改的组件包括apiserver、controller和scheduler。</p>
<p>直接修改/etc/kubernetes/manifests下面对应的3个同名的.yaml静态文件，加入
—feature-gates=TTLAfterFinished=true命 令，然后令对应的Pod重新运行即可。</p>
<p>例如，修改后kube-scheduler.yaml的spec部分如下，对于<code class="docutils literal notranslate"><span class="pre">kube-apiserver.yaml</span></code>和<code class="docutils literal notranslate"><span class="pre">kube-controller-</span> <span class="pre">manager.yaml</span></code>，也在spec部分加入<code class="docutils literal notranslate"><span class="pre">-</span> <span class="pre">--feature-gates=TTLAfterFinished=true</span></code>即可。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="o">...</span>
<span class="n">spec</span><span class="p">:</span>
<span class="n">containers</span><span class="p">:</span>
<span class="o">-</span> <span class="n">command</span><span class="p">:</span>
<span class="o">-</span> <span class="n">kube</span><span class="o">-</span><span class="n">scheduler</span>
<span class="o">-</span> <span class="o">--</span><span class="n">address</span><span class="o">=</span><span class="mf">127.0.0.1</span>
<span class="o">-</span> <span class="o">--</span><span class="n">kubeconfig</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">Kubernetes</span><span class="o">/</span><span class="n">scheduler</span><span class="o">.</span><span class="n">conf</span>
<span class="o">-</span> <span class="o">--</span><span class="n">leader</span><span class="o">-</span><span class="n">elect</span><span class="o">=</span><span class="n">true</span>
<span class="o">-</span> <span class="o">--</span><span class="n">feature</span><span class="o">-</span><span class="n">gates</span><span class="o">=</span><span class="n">TTLAfterFinished</span><span class="o">=</span><span class="n">true</span>
<span class="o">...</span>
</pre></div>
</div>
</section>
<section id="id2">
<h3><a class="toc-backref" href="#id10">1.2 串行式任务</a><a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h3>
<p>串行式任务可以连续、多次地执行某一任务。</p>
<p>当上一个任务完成时，接着执行下一个任务，直到全部任务执行完。</p>
<p>可以通过spec.completions属性来指定执行次数。</p>
<p><code class="docutils literal notranslate"><span class="pre">examplejobv2.yml</span></code></p>
<p>这里，通过定义spec.completions，我们将这个任务的执行次数设置为5。</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">batch/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Job</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">examplejobv2</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">completions</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span><span class="w"></span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span><span class="w"></span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">examplejobcontainer</span><span class="w"></span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span><span class="w"></span>
<span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;sh&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;-c&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;echo</span><span class="nv"> </span><span class="s">&quot;Start</span><span class="nv"> </span><span class="s">Job!&quot;;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">30;</span><span class="nv"> </span><span class="s">echo</span><span class="nv"> </span><span class="s">&quot;Job</span><span class="nv"> </span><span class="s">Done!&quot;&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>
</pre></div>
</div>
<p>接下来，运行以下命令，通过模板创建Job。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f examplejobv2.yml
</pre></div>
</div>
<p>这5个Pod会依次创建，执行完上一个Pod，才会创建并执行下一个Pod，同时只能有一个处于Running（或ContainerCreating）状态的Pod</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl get pod -o wide
NAME                 READY   STATUS      RESTARTS   AGE         IP           NODE            NOMINATED NODE   READINESS GATES
examplejobv2-6mbqr   <span class="m">0</span>/1     Completed   <span class="m">0</span>          50s         <span class="m">10</span>.0.6.186   gitee-k8s-w27   &lt;none&gt;           &lt;none&gt;
examplejobv2-h4vzz   <span class="m">0</span>/1     Completed   <span class="m">0</span>          &lt;invalid&gt;   <span class="m">10</span>.0.6.103   gitee-k8s-w27   &lt;none&gt;           &lt;none&gt;
examplejobv2-l9xwx   <span class="m">1</span>/1     Running     <span class="m">0</span>          &lt;invalid&gt;   <span class="m">10</span>.0.6.228   gitee-k8s-w27   &lt;none&gt;           &lt;none&gt;
examplejobv2-ltchr   <span class="m">0</span>/1     Completed   <span class="m">0</span>          16s         <span class="m">10</span>.0.6.170   gitee-k8s-w27   &lt;none&gt;           &lt;none&gt;
</pre></div>
</div>
<p>Job的进度也会跟随Pod的执行情况动态变化</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl get <span class="nb">jobs</span>
NAME           COMPLETIONS   DURATION   AGE
examplejobv2   <span class="m">3</span>/5           2m9s       3m5s
</pre></div>
</div>
<p>这里也可以看出，Job的执行是不会区分机器的。与Deployment控制器一样，Job会根据调度规则动态分配到各个Node上并执行.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">pod</span> <span class="o">-</span><span class="n">o</span> <span class="n">wide</span>
<span class="n">NAME</span>                 <span class="n">READY</span>   <span class="n">STATUS</span>      <span class="n">RESTARTS</span>   <span class="n">AGE</span>     <span class="n">IP</span>           <span class="n">NODE</span>            <span class="n">NOMINATED</span> <span class="n">NODE</span>   <span class="n">READINESS</span> <span class="n">GATES</span>
<span class="n">examplejobv2</span><span class="o">-</span><span class="mi">6</span><span class="n">mbqr</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Completed</span>   <span class="mi">0</span>          <span class="mi">3</span><span class="n">m17s</span>   <span class="mf">10.0.6.186</span>   <span class="n">gitee</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">w27</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>           <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
<span class="n">examplejobv2</span><span class="o">-</span><span class="n">h4vzz</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Completed</span>   <span class="mi">0</span>          <span class="mi">2</span><span class="n">m11s</span>   <span class="mf">10.0.6.103</span>   <span class="n">gitee</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">w27</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>           <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
<span class="n">examplejobv2</span><span class="o">-</span><span class="n">l9xwx</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Completed</span>   <span class="mi">0</span>          <span class="mi">99</span><span class="n">s</span>     <span class="mf">10.0.6.228</span>   <span class="n">gitee</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">w27</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>           <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
<span class="n">examplejobv2</span><span class="o">-</span><span class="n">ltchr</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Completed</span>   <span class="mi">0</span>          <span class="mi">2</span><span class="n">m43s</span>   <span class="mf">10.0.6.170</span>   <span class="n">gitee</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">w27</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>           <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
<span class="n">examplejobv2</span><span class="o">-</span><span class="n">vwbzd</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Completed</span>   <span class="mi">0</span>          <span class="mi">66</span><span class="n">s</span>     <span class="mf">10.0.6.66</span>    <span class="n">gitee</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">w27</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>           <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@ci</span><span class="o">-</span><span class="n">base</span> <span class="n">job</span><span class="o">-</span><span class="n">cronjob</span><span class="p">]</span><span class="c1"># kubectl get jobs</span>
<span class="n">NAME</span>           <span class="n">COMPLETIONS</span>   <span class="n">DURATION</span>   <span class="n">AGE</span>
<span class="n">examplejobv2</span>   <span class="mi">5</span><span class="o">/</span><span class="mi">5</span>           <span class="mi">2</span><span class="n">m43s</span>      <span class="mi">3</span><span class="n">m19s</span>
</pre></div>
</div>
</section>
<section id="id3">
<h3><a class="toc-backref" href="#id11">1.3 并行式任务</a><a class="headerlink" href="#id3" title="Permalink to this heading">¶</a></h3>
<p>当任务比较多时（比如执行几十甚至上百次），串行式任务就不太合适了。</p>
<p>此时可以将其设定为并行式任务，同一时间并发多次执行任务。可以通过spec.parallelism指定并发数，也可以配合
spec.completions属性来指定总任务的执行次数。</p>
<p><code class="docutils literal notranslate"><span class="pre">examplejobv3.yml</span></code></p>
<p>通过定义spec.completions，我们将这个任务设置为执行11次，并行数为4。</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">batch/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Job</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">examplejobv3</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">completions</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">11</span><span class="w"></span>
<span class="w">  </span><span class="nt">parallelism</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span><span class="w"></span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span><span class="w"></span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">examplejobcontainer</span><span class="w"></span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span><span class="w"></span>
<span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;sh&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;-c&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;echo</span><span class="nv"> </span><span class="s">&quot;Start</span><span class="nv"> </span><span class="s">Job!&quot;;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">30;</span><span class="nv"> </span><span class="s">echo</span><span class="nv"> </span><span class="s">&quot;Job</span><span class="nv"> </span><span class="s">Done!&quot;&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>
</pre></div>
</div>
<p>运行以下命令，通过模板创建Pod。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f examplejobv3.yml
</pre></div>
</div>
<p>一开始会创建4个Pod并同时运行，然后待某一Pod运行结束后，继续创建后续的Pod，保持4个Pod同时处于Running（或
ContainerCreating）状态，直到达到设置的执行总数（11个）。</p>
<p><img alt="image0" src="../../_images/image-20220412105720335.png" /></p>
</section>
</section>
<section id="id4">
<h2><a class="toc-backref" href="#id12">2. Job的异常处理</a><a class="headerlink" href="#id4" title="Permalink to this heading">¶</a></h2>
<p>因为不同于需要持续提供服务的Pod，Job中的Pod在正常完成任务后，需要及时退出，所以Pod模板中restartPolicy字段的值可以为
Always、OnFailure和Never。</p>
<p>但在Job中，该字段的值只能是<code class="docutils literal notranslate"><span class="pre">OnFailure</span></code>和<code class="docutils literal notranslate"><span class="pre">Never</span></code>中的一个。</p>
<p>这里，我们将故意产生错误，看看restartPolicy字段分别设置为OnFailure和Never会有什么区别。</p>
<section id="onfailure">
<h3><a class="toc-backref" href="#id13">2.1 OnFailure</a><a class="headerlink" href="#onfailure" title="Permalink to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">examplejobforonfailure.yml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">batch/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Job</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">examplejobforonfailure</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">backoffLimit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">6</span><span class="w"></span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OnFailure</span><span class="w"></span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">examplejobcontainer</span><span class="w"></span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span><span class="w"></span>
<span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;sh&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;-c&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;this</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">error</span><span class="nv"> </span><span class="s">command!!&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>
</pre></div>
</div>
<p>backoffLimit属性表示重试次数的上限，默认为6次。这里的设置和默认值一样，不写也可以，之所以写出来是为了让读者明确地
知道这个属性正在起作用。在这个例子里，我们输入一条错误的命令“args:
[‘this is error command!!’]”，以便让执行失败。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f examplejobforonfailure.yml
</pre></div>
</div>
<p>通过<code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">pod</span></code>命令可以看到这个Pod一直处于失败状态（CrashLoop
BackOff），然后不断重启，RESTARTS的值不断累加</p>
<p>之前已经提到过Pod失败时的<strong>递增延迟重启策略</strong>，它将会以递增延迟方式尝试重新启动（10s，20s，40s，…），上限时间为6min。当延迟增加到了6min后，就相当于要再等6min才会重启。</p>
<p>Job模板中的属性spec.backoffLimit表示重试次数的上限，默认为6次。如果6次以内没有出现失败，则会重置计数。但如果达到
重试次数的上限，则这个Job对应的容器将会被终止并删除。</p>
<p><img alt="image1" src="../../_images/image-20220412182246885.png" /></p>
</section>
<section id="never">
<h3><a class="toc-backref" href="#id14">2.2 Never</a><a class="headerlink" href="#never" title="Permalink to this heading">¶</a></h3>
<p>然后，再来看看restartPolicy字段设置为Never会发生什么事情。</p>
<p><code class="docutils literal notranslate"><span class="pre">examplejobfornever.yml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">batch/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Job</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">examplejobfornever</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">backoffLimit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">6</span><span class="w"></span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span><span class="w"></span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">examplejobcontainer</span><span class="w"></span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span><span class="w"></span>
<span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;sh&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;-c&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;this</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">error</span><span class="nv"> </span><span class="s">command!!&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>
</pre></div>
</div>
<p>运行以下命令，通过模板创建Pod。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f examplejobfornever.yml
</pre></div>
</div>
<p>可以看到，因为Pod不会重新启动（restartPolicy字段设置为Never），且Job的任务并没有成功执行，所以J<em>ob会不停地创建新</em>
<em>Pod，直到Pod成功执行。</em></p>
<p><img alt="image2" src="../../_images/image-20220412182351834.png" /></p>
<p>相对于OnFailure，推荐使用Never，因为OnFailure在重试一定次数后会删除Pod，导致日志或Pod中记录的其他信息丢失，不利于排查
问题。而Never会保留每次Pod启动后的现场，使排查问题更加容易。</p>
<p>除了上述明显的异常处理（如执行失败、执行中断等）之外，Job的执行过程中还有一类很难以察觉的异常。比如，任务中出现死循环，表现为一直卡在那里一动不动，看起来一直处于Running状态，但怎么执行都不会有结果。</p>
</section>
<section id="id5">
<h3><a class="toc-backref" href="#id15">2.3 超时时间</a><a class="headerlink" href="#id5" title="Permalink to this heading">¶</a></h3>
<p>对于这类异常，Job模板提供了<code class="docutils literal notranslate"><span class="pre">spec.activeDeadlineSeconds</span></code>属性，指定执行任务的上限时间（单位为秒）。</p>
<p>如果超过这个时间上限，任务将强制终止并删除,防止程序一直死循环或者假死。</p>
<p><code class="docutils literal notranslate"><span class="pre">examplejobfordeadline.yml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">batch/v1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Job</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">examplejobfordeadline</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">activeDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w"></span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span><span class="w"></span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">examplejobcontainer</span><span class="w"></span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span><span class="w"></span>
<span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;sh&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;-c&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;echo</span><span class="nv"> </span><span class="s">&quot;Hello</span><span class="nv"> </span><span class="s">Kubernetes!&quot;;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">3600&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>
</pre></div>
</div>
<p>这里将上限时间设置为10s，但在命令里面设置了长时间休眠，让这个任务持续执行3600s。</p>
<p>运行以下命令，通过模板创建Pod。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f examplejobfordeadline.yml
</pre></div>
</div>
<p>可以看到，因为有运行时间限制，所以在最开始的10s内，Pod处于运行状态，10s后Pod就被终止，直到最后被删除（不管
restartPolicy字段设置为Never还是OnFailure）</p>
<p><img alt="image3" src="../../_images/image-20220412182825666.png" /></p>
</section>
</section>
<section id="cronjob">
<h2><a class="toc-backref" href="#id16">3.CronJob控制器的基本操作</a><a class="headerlink" href="#cronjob" title="Permalink to this heading">¶</a></h2>
<p>CronJob控制器是比Job更高级的资源对象。CronJob控制器基于Job，并且添加了时间管理功能。通过CronJob控制器，可以实现以下
类型的Job。</p>
<ul class="simple">
<li><p>在未来的某个指定时间运行一次Job，例如，某项临时任务。</p></li>
<li><p>周期性地运行Job，例如，定期备份、发送邮件等。</p></li>
</ul>
<section id="cronjob-yaml">
<h3><a class="toc-backref" href="#id17">3.1 CronJob控制器 yaml模板</a><a class="headerlink" href="#cronjob-yaml" title="Permalink to this heading">¶</a></h3>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">batch/v1</span><span class="w">  </span><span class="c1">#必填，版本号</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Job</span><span class="w"> </span><span class="c1"># 必填，资源类型</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c1"># 必填，元数据</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;name&gt;-cj</span><span class="w"> </span><span class="c1"># 必填，资源名称</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span><span class="w"> </span><span class="c1"># pod所属的命名空间</span><span class="w"></span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c1"># 自定义标签</span><span class="w"></span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span><span class="w"> </span><span class="c1">#自定义标签名字&lt;key: value&gt;</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c1"># 必填，部署的详细定义</span><span class="w"></span>
<span class="w">  </span><span class="nt">schedule</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*&quot;</span><span class="w"> </span><span class="c1"># 必填，运行时间点</span><span class="w"></span>
<span class="w">  </span><span class="nt">concurrencyPolicy</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">Allow 允许|Forbid 禁止|Replace 替换</span><span class="p p-Indicator">]</span><span class="w"> </span><span class="c1"># 并发执行策略，默认允许</span><span class="w"></span>
<span class="w">  </span><span class="nt">failedJobHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">int</span><span class="w"> </span><span class="c1"># 为失败的任务执行保留的历史记录数，默认为1</span><span class="w"></span>
<span class="w">  </span><span class="nt">successfulJobsHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">int</span><span class="w"> </span><span class="c1"># 为成功的任务执行保留的历史记录数，默认为3。</span><span class="w"></span>
<span class="w">  </span><span class="nt">startingDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">int</span><span class="w"> </span><span class="c1"># 因各种原因缺乏执行作业的时间点所导致的启动作业错误的超时时长，会被记入错误历史记录。</span><span class="w"></span>
<span class="w">  </span><span class="nt">suspend</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">boolean</span><span class="w"> </span><span class="c1"># 是否挂起后续的任务执行，默认为false，对运行中的作业不会产生影响。</span><span class="w"></span>
<span class="w">  </span><span class="nt">jobTemplate</span><span class="p">:</span><span class="w"> </span><span class="c1"># 控制器模板，与template类似</span><span class="w"></span>
<span class="w">    </span><span class="nt">metedata</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c1"># 自定义标签</span><span class="w"></span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span><span class="w"> </span><span class="c1">#自定义标签名字&lt;key: value&gt;</span><span class="w"></span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="c1"># 必填，应用容器模板定义</span><span class="w"></span>
<span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w"> </span><span class="c1">#此处参考pod的containers</span><span class="w"></span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span><span class="w"></span>
<span class="w">            </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox:latest</span><span class="w"></span>
<span class="w">            </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;echo&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;hello</span><span class="nv"> </span><span class="s">world&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">          </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span><span class="w"> </span><span class="c1"># job类型资源重启策略必须为Never或者OnFailure</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>yaml示例：以busybox镜像启动，输出hello
world举例。记得将重启策略设置为Never或者OnFailure</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">batch/v1beta1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CronJob</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello-cj</span><span class="w"></span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span><span class="w"></span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello-cronjob</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">schedule</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;*/2</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">jobTemplate</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello-cronjob</span><span class="w"></span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span><span class="w"></span>
<span class="w">            </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox:latest</span><span class="w"></span>
<span class="w">            </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;echo&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;hello</span><span class="nv"> </span><span class="s">world&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">          </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">examplecronjob.yml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">batch/v1beta1</span><span class="w"></span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CronJob</span><span class="w"></span>
<span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">examplecronjob</span><span class="w"></span>
<span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">schedule</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;*/1</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">jobTemplate</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span><span class="w"></span>
<span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">examplejobcontainer</span><span class="w"></span>
<span class="w">            </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span><span class="w"></span>
<span class="w">            </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class="w"></span>
<span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;sh&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;-c&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">            </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;echo</span><span class="nv"> </span><span class="s">&quot;Start</span><span class="nv"> </span><span class="s">Job!&quot;;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">30;</span><span class="nv"> </span><span class="s">echo</span><span class="nv"> </span><span class="s">&quot;Job</span><span class="nv"> </span><span class="s">Done!&quot;&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>
</pre></div>
</div>
<p>CronJob控制器目前只存在于beta1版本中。CronJob控制器模板中的jobTemplate必须填入Job模板，这里引用了之前示例中的Job模板。
CronJob控制器的schedule设置为”/1
<em>“，表示每隔1min执行一次。</em>schedule的设置规则类似于crontable的用法*</p>
<blockquote>
<div><p>注意：schedule给定的间隔一般不应少于该Job的执行时间。如果当前Job尚未结束，且达到触发时间，则会根据concurrencyPolicy
中的设置决定并发策略，而它的默认值是Allow（允许并发运行Job）。</p>
<p>一般情况下问题不大，但如果这种情况大量出现，就会有大量Job叠加启动，并发访问系统资源，可能导致系统响应变慢甚至崩溃。</p>
</div></blockquote>
<p>运行以下命令，通过模板创建CronJob控制器。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f examplecronjob.yml
</pre></div>
</div>
<p>通过以下命令，可以查看当前正在运行的CronJob控制器。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl get cronjob
</pre></div>
</div>
<p>可以看到，CronJob控制器已创建。接着对应的Job和Job下的Pod也开始进行创建，任务开始执行</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl get cronjob
NAME             SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
examplecronjob   */1 * * * *   False     <span class="m">1</span>        &lt;invalid&gt;       36s
$ kubectl get job
NAME                      COMPLETIONS   DURATION   AGE
examplecronjob-27496001   <span class="m">0</span>/1           81s        81s
$ kubectl get pods
NAME                            READY   STATUS      RESTARTS   AGE
examplecronjob-27496001-s97d6   <span class="m">0</span>/1     Completed   <span class="m">0</span>          50s
</pre></div>
</div>
<p>因为之前设置的是每分钟执行一次，所以在接下来的一分钟，CronJob控制器会创建一个新的Job，并执行这个新任务</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl get cronjob
NAME             SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
examplecronjob   */1 * * * *   False     <span class="m">0</span>        90s             4m19s

$ kubectl get job
NAME                      COMPLETIONS   DURATION    AGE
examplecronjob-27496001   <span class="m">1</span>/1           49s         2m4s
examplecronjob-27496002   <span class="m">1</span>/1           32s         64s
examplecronjob-27496003   <span class="m">1</span>/1           33s         4s

$ kubectl get pods
NAME                            READY   STATUS      RESTARTS   AGE
examplecronjob-27496001-s97d6   <span class="m">0</span>/1     Completed   <span class="m">0</span>          3m40s
examplecronjob-27496002-5qh7d   <span class="m">0</span>/1     Completed   <span class="m">0</span>          2m40s
examplecronjob-27496003-w9vv8   <span class="m">0</span>/1     Completed   <span class="m">0</span>          100s
</pre></div>
</div>
<p>由于<code class="docutils literal notranslate"><span class="pre">spec.successfulJobsHistoryLimit</span></code>属性默认为3，因此这个CronJob控制器最多只保留最近3条执行成功的Job历史记录。</p>
<p>可以通过以下命令删除CronJob控制器。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">delete</span> <span class="n">cronjob</span> <span class="p">{</span><span class="n">CronJob名称</span><span class="p">}</span>
</pre></div>
</div>
<p>执行删除命令之后，CronJob控制器下的所有Job和Pod都会被删除，正在运行的Pod会被强制终止</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl delete cronjob examplecronjob
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="2.DaemonSet%E6%8E%A7%E5%88%B6%E5%99%A8.html" class="btn btn-neutral float-left" title="DaemonSet控制器" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="4.StatefulSet%E6%8E%A7%E5%88%B6%E5%99%A8.html" class="btn btn-neutral float-right" title="StatefulSet控制器" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, huxiaojian.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>