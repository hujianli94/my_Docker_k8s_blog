<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Helm的高级功能 &mdash; 运维开发修炼之路</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="构建chart" href="3.%E6%9E%84%E5%BB%BAchart.html" />
    <link rel="prev" title="使用Helm" href="1.%E4%BD%BF%E7%94%A8Helm.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> 小健_Docker_K8s_Blog
            <img src="../../_static/docker-k8s.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../01.Docker%E6%8A%80%E6%9C%AF%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E6%88%983%E7%89%88/index.html">01.Docker技术入门与实战3版</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../02.Kubernetes%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97/index.html">02.Kubernetes实战指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../03.Docker%E7%BB%8F%E5%85%B8%E5%AE%9E%E4%BE%8B/index.html">03.Docker经典实例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../04.Prometheus%E7%9B%91%E6%8E%A7%E8%BF%90%E7%BB%B4%E5%AE%9E%E6%88%98/index.html">04.Prometheus监控运维实战</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">05.Kubernetes入门到实践</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../1.%E5%AE%B9%E5%99%A8%E7%9A%84%E5%8F%91%E5%B1%95%E5%8F%B2/index.html">1.容器的发展史</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2.Kubernetes%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5/index.html">2.Kubernetes的核心概念</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3.Kubernetes%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E9%83%A8%E7%BD%B2/index.html">3.Kubernetes的安装和部署</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4.Pod/index.html">4.Pod的基本操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5.%E6%8E%A7%E5%88%B6%E5%99%A8/index.html">5.控制器</a></li>
<li class="toctree-l2"><a class="reference internal" href="../6.Service%E5%92%8CIngress/index.html">6.Service和Ingress</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7.%E5%AD%98%E5%82%A8%E4%B8%8E%E9%85%8D%E7%BD%AE/index.html">7.存储与配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../8.Kubernetes%E8%B5%84%E6%BA%90%E7%9A%84%E7%AE%A1%E7%90%86%E5%8F%8A%E8%B0%83%E5%BA%A6/index.html">8.Kubernetes资源的管理及调度</a></li>
<li class="toctree-l2"><a class="reference internal" href="../9.API-Server/index.html">9.API-Server</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10.Kubernetes%E7%9A%84%E6%89%A9%E5%B1%95/index.html">10.Kubernetes的扩展</a></li>
<li class="toctree-l2"><a class="reference internal" href="../11.%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E6%A1%88%E4%BE%8B/index.html">11.项目部署案例</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">12.Helm学习指南</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="1.%E4%BD%BF%E7%94%A8Helm.html">使用Helm</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Helm的高级功能</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">1. 模板和试运行</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">2. 了解发布版本信息</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">3. 历史记录和回滚</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">4.深入了解安装和升级</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="3.%E6%9E%84%E5%BB%BAchart.html">构建chart</a></li>
<li class="toctree-l3"><a class="reference internal" href="4.%E5%BC%80%E5%8F%91%E6%A8%A1%E6%9D%BF.html">开发模板</a></li>
<li class="toctree-l3"><a class="reference internal" href="5.chart%E7%9A%84%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD.html">chart的高级功能</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../13.Kubernetes-DevOps/index.html">13.Kubernetes-DevOps</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">小健_Docker_K8s_Blog</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">05.Kubernetes入门到实践</a> &raquo;</li>
          <li><a href="index.html">12.Helm学习指南</a> &raquo;</li>
      <li>Helm的高级功能</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/05.Kubernetes入门到实践/12.Helm学习指南/2.Helm的高级功能.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#helm" id="id10">Helm的高级功能</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id11">1. 模板和试运行</a></p>
<ul>
<li><p><a class="reference internal" href="#dry-run" id="id12">1.1 –dry-run标志</a></p></li>
<li><p><a class="reference internal" href="#helm-template" id="id13">1.2 helm template命令</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id2" id="id14">2. 了解发布版本信息</a></p>
<ul>
<li><p><a class="reference internal" href="#id3" id="id15">2.1 发布记录</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id16">2.2 列出发布版本</a></p></li>
<li><p><a class="reference internal" href="#helm-get" id="id17">2.3 使用helm get查找发布的详细信息</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id5" id="id18">3. 历史记录和回滚</a></p>
<ul>
<li><p><a class="reference internal" href="#id6" id="id19">3.1 保留历史和回滚</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id7" id="id20">4.深入了解安装和升级</a></p>
<ul>
<li><p><a class="reference internal" href="#generate-namename-template" id="id21">4.1 –generate-name和–name-template标志</a></p></li>
<li><p><a class="reference internal" href="#create-namespace" id="id22">4.2 –create-namespace标志</a></p></li>
<li><p><a class="reference internal" href="#helm-upgradeinstall" id="id23">4.3 使用helm upgrade–install</a></p></li>
<li><p><a class="reference internal" href="#waitatomic" id="id24">4.4 –wait和–atomic标志</a></p></li>
<li><p><a class="reference internal" href="#forcecleanup-on-fail" id="id25">4.5 使用–force和–cleanup-on-fail升级</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<section id="helm">
<h1><a class="toc-backref" href="#id10">Helm的高级功能</a><a class="headerlink" href="#helm" title="Permalink to this heading">¶</a></h1>
<section id="id1">
<h2><a class="toc-backref" href="#id11">1. 模板和试运行</a><a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h2>
<p>当Helm安装一个发行版时，程序会经历几个阶段。它加载chart，解析传递给程序的值，读取chart元数据，等等。大约在这个过程的中间，Helm编译chart中的所有模板（一次完成），然后通过传递值来呈现它们（就像我们在上一章中看到的那样）。</p>
<p>在这个中间部分，它执行所有的模板指令。一旦模板被呈现到YAML中，Helm通过将其解析为Kubernetes对象来验证YAML的结构。最后，Helm序列化这些对象并将它们发送到kubernetes
API服务器。</p>
<p>过程如下：</p>
<ol class="arabic simple">
<li><p>加载整个chart，包括其依赖项。</p></li>
<li><p>解析值。</p></li>
<li><p>执行模板，生成YAML。</p></li>
<li><p>将YAML解析为Kubernetes对象以验证数据。</p></li>
<li><p>将它发送给Kubernetes。</p></li>
</ol>
<section id="dry-run">
<h3><a class="toc-backref" href="#id12">1.1 –dry-run标志</a><a class="headerlink" href="#dry-run" title="Permalink to this heading">¶</a></h3>
<p>helm install和helm
upgrade等命令提供了一个名为–dry-run的标志。当在命令行中添加此标志时，将导致Helm逐步完成前四个阶段（加载chart、确定值、渲染模板、格式化为YAML）。</p>
<p>但是当第四阶段结束时，Helm会将大量信息转储到标准输出，包括所有渲染的模板。然后它将退出，而不将对象发送给Kubernetes，也不创建任何发布记录。</p>
<p>例如，这里是以前的Drupal安装的一个版本，附加了–dry run标志：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm install mysite bitnami/drupal --values values.yaml --set <span class="nv">drupalEmail</span><span class="o">=</span><span class="s2">&quot;hujinali@oschin.cn&quot;</span> --dry-run
</pre></div>
</div>
<p>在输出的最前面，它将打印有关此发布版本的信息：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NAME</span><span class="p">:</span> <span class="n">mysite</span>
<span class="n">LAST</span> <span class="n">DEPLOYED</span><span class="p">:</span> <span class="n">Sat</span> <span class="n">May</span>  <span class="mi">7</span> <span class="mi">02</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">28</span> <span class="mi">2022</span>
<span class="n">NAMESPACE</span><span class="p">:</span> <span class="n">default</span>
<span class="n">STATUS</span><span class="p">:</span> <span class="n">pending</span><span class="o">-</span><span class="n">install</span>
<span class="n">REVISION</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">TEST</span> <span class="n">SUITE</span><span class="p">:</span> <span class="kc">None</span>
<span class="n">HOOKS</span><span class="p">:</span>
<span class="n">MANIFEST</span><span class="p">:</span>
</pre></div>
</div>
<p>接下来，在信息块之后，所有YAML格式的Kubernetes清单的模板都进行了渲染然后被转储到标准输出。</p>
<p>在试运行输出的最后，Helm打印面向用户的发行版本说明：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CHART</span> <span class="n">NAME</span><span class="p">:</span> <span class="n">drupal</span>
<span class="n">CHART</span> <span class="n">VERSION</span><span class="p">:</span> <span class="mf">12.0.1</span>
<span class="n">APP</span> <span class="n">VERSION</span><span class="p">:</span> <span class="mf">9.3.12</span><span class="o">**</span> <span class="n">Please</span> <span class="n">be</span> <span class="n">patient</span> <span class="k">while</span> <span class="n">the</span> <span class="n">chart</span> <span class="ow">is</span> <span class="n">being</span> <span class="n">deployed</span> <span class="o">**</span>

<span class="mf">1.</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">Drupal</span> <span class="n">URL</span><span class="p">:</span>

  <span class="n">NOTE</span><span class="p">:</span> <span class="n">It</span> <span class="n">may</span> <span class="n">take</span> <span class="n">a</span> <span class="n">few</span> <span class="n">minutes</span> <span class="k">for</span> <span class="n">the</span> <span class="n">LoadBalancer</span> <span class="n">IP</span> <span class="n">to</span> <span class="n">be</span> <span class="n">available</span><span class="o">.</span>
        <span class="n">Watch</span> <span class="n">the</span> <span class="n">status</span> <span class="k">with</span><span class="p">:</span> <span class="s1">&#39;kubectl get svc --namespace default -w mysite-drupal&#39;</span>
<span class="o">....</span>
</pre></div>
</div>
</section>
<section id="helm-template">
<h3><a class="toc-backref" href="#id13">1.2 helm template命令</a><a class="headerlink" href="#helm-template" title="Permalink to this heading">¶</a></h3>
<p>虽然–dry-run是为调试而设计的，但helm
template是为了将Helm的模板渲染过程与安装或升级逻辑隔离开来。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm template mysite bitnami/drupal --values values.yaml --set <span class="nv">drupalEmail</span><span class="o">=</span><span class="s2">&quot;hujinali@oschin.cn&quot;</span>
</pre></div>
</div>
<p>前面是一个大大简化了的输出版本，只显示了命令、开始数据和结束数据的示例。</p>
<p>不过，需要重点注意的是，默认情况下只打印YAML格式的Kubernetes清单。</p>
<p><strong>因为Helm在helm
template运行期间不联系Kubernetes集群，所以它不会对输出进行完全验证。在这种情况下，Helm可能不会发现一些错误。</strong></p>
<p>如果你想要这种行为，可以选择使用–validate标志，但是在这种情况下，Helm需要一个有效的kubeconfig文件，其中包含集群的凭据。</p>
<p>helm template命令有大量的标志，这些标志对应于helm
install中的标志。因此，在许多情况下，你可以像执行helm
install一样执行helm template命令，随后捕获YAML并将其与其他工具一起使用。</p>
<p><em>使用后期渲染而不是Helm模板</em></p>
<p>有时你需要截取YAML，用自己的工具修改它，然后将其加载到Kubernetes中。Helm提供了一种执行这个外部工具的方法，而不必使用helm
template。install、upgrade、rollback和template上的–post-renderer标记会导致Helm将YAML数据发送到命令，然后将结果读回Helm。这是使用Kustomize等工具的好方法。</p>
<p>总而言之，helm template是一个用于将Helm
chart渲染到YAML中的工具，–dry-run标志是一个用于调试安装和升级命令，而无须将数据加载到Kubernetes中的工具。</p>
</section>
</section>
<section id="id2">
<h2><a class="toc-backref" href="#id14">2. 了解发布版本信息</a><a class="headerlink" href="#id2" title="Permalink to this heading">¶</a></h2>
<section id="id3">
<h3><a class="toc-backref" href="#id15">2.1 发布记录</a><a class="headerlink" href="#id3" title="Permalink to this heading">¶</a></h3>
<p>每次升级mysite安装时，都会创建一个新的Secret来跟踪每个版本。换句话说，发布记录跟踪安装的每个修订版：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl get secret
</pre></div>
</div>
</section>
<section id="id4">
<h3><a class="toc-backref" href="#id16">2.2 列出发布版本</a><a class="headerlink" href="#id4" title="Permalink to this heading">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ helm ls
NAME    NAMESPACE       REVISION        UPDATED                                 STATUS          CHART           APP VERSION
mysite  default         2               2022-05-07 02:23:59.050699352 -0400 EDT deployed        drupal-12.0.1   9.3.12
</pre></div>
</div>
<p>REVISION的值为2。</p>
</section>
<section id="helm-get">
<h3><a class="toc-backref" href="#id17">2.3 使用helm get查找发布的详细信息</a><a class="headerlink" href="#helm-get" title="Permalink to this heading">¶</a></h3>
<p>虽然helm list提供了安装的摘要视图，但helm
get命令集提供了有关特定发布版本的更深入的信息。</p>
<p>helm
get有5个子命令（hooks、manifests、notes、values和all）。每个子命令都会检索某个版本的Helm跟踪信息的某些部分。</p>
<section id="helm-get-notes">
<h4>1.使用helm get notes<a class="headerlink" href="#helm-get-notes" title="Permalink to this heading">¶</a></h4>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm get notes mysite
NOTES:
CHART NAME: drupal
CHART VERSION: <span class="m">12</span>.0.1
APP VERSION: <span class="m">9</span>.3.12** Please be patient <span class="k">while</span> the chart is being deployed **

<span class="m">1</span>. Get the Drupal URL:

  NOTE: It may take a few minutes <span class="k">for</span> the LoadBalancer IP to be available.
        Watch the status with: <span class="s1">&#39;kubectl get svc --namespace default -w mysite-drupal&#39;</span>

  <span class="nb">export</span> <span class="nv">SERVICE_IP</span><span class="o">=</span><span class="k">$(</span>kubectl get svc --namespace default mysite-drupal --template <span class="s2">&quot;{{ range (index .status.loadBalancer.ingress 0) }}{{ . }}{{ end }}&quot;</span><span class="k">)</span>
  <span class="nb">echo</span> <span class="s2">&quot;Drupal URL: http://</span><span class="nv">$SERVICE_IP</span><span class="s2">/&quot;</span>

<span class="m">2</span>. Get your Drupal login credentials by running:

  <span class="nb">echo</span> Username: admin
  <span class="nb">echo</span> Password: <span class="k">$(</span>kubectl get secret --namespace default mysite-drupal -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&quot;{.data.drupal-password}&quot;</span> <span class="p">|</span> base64 --decode<span class="k">)</span>
</pre></div>
</div>
</section>
<section id="helm-get-values">
<h4>2.使用helm get values<a class="headerlink" href="#helm-get-values" title="Permalink to this heading">¶</a></h4>
<p><strong>查看使用的values配置</strong></p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm get values mysite
USER-SUPPLIED VALUES:
affinity: <span class="o">{}</span>
allowEmptyPassword: <span class="nb">true</span>
args: <span class="o">[]</span>
certificates:
  args: <span class="o">[]</span>
  command: <span class="o">[]</span>
  customCAs: <span class="o">[]</span>
  customCertificate:
    certificateLocation: /etc/ssl/certs/ssl-cert-snakeoil.pem
    certificateSecret: <span class="s2">&quot;&quot;</span>
    chainLocation: /etc/ssl/certs/mychain.pem
    chainSecret:
      key: secret-key
      name: secret-name
    keyLocation: /etc/ssl/private/ssl-cert-snakeoil.key
  extraEnvVars: <span class="o">[]</span>
  extraEnvVarsCM: <span class="s2">&quot;&quot;</span>
.....
</pre></div>
</div>
<p><strong>查看默认值配置</strong></p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm inspect values bitnami/drupal<span class="p">|</span>grep -v <span class="s2">&quot;#&quot;</span><span class="p">|</span>grep -v <span class="s2">&quot;^</span>$<span class="s2">&quot;</span>
global:
  imageRegistry: <span class="s2">&quot;&quot;</span>
  imagePullSecrets: <span class="o">[]</span>
  storageClass: <span class="s2">&quot;&quot;</span>
kubeVersion: <span class="s2">&quot;&quot;</span>
nameOverride: <span class="s2">&quot;&quot;</span>
fullnameOverride: <span class="s2">&quot;&quot;</span>
commonAnnotations: <span class="o">{}</span>
commonLabels: <span class="o">{}</span>
extraDeploy: <span class="o">[]</span>
image:
  registry: docker.io
  repository: bitnami/drupal
  tag: <span class="m">9</span>.3.12-debian-10-r1
  pullPolicy: IfNotPresent
  pullSecrets: <span class="o">[]</span>
  debug: <span class="nb">false</span>
replicaCount: <span class="m">1</span>
drupalProfile: standard
drupalSkipInstall: <span class="nb">false</span>
drupalUsername: user
drupalPassword: <span class="s2">&quot;&quot;</span>
drupalEmail: user@example.com
allowEmptyPasswo
.....
</pre></div>
</div>
</section>
<section id="helm-get-manifest">
<h4>3.使用helm get manifest<a class="headerlink" href="#helm-get-manifest" title="Permalink to this heading">¶</a></h4>
<p>此子命令获取Helm使用Chart模板生成的确切YAML清单：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm get manifest mysite
---
<span class="c1"># Source: drupal/charts/mariadb/templates/serviceaccount.yaml</span>
apiVersion: v1
kind: ServiceAccount
metadata:
  name: mysite-mariadb
  namespace: <span class="s2">&quot;default&quot;</span>
  labels:
    app.kubernetes.io/name: mariadb
    helm.sh/chart: mariadb-11.0.0
    app.kubernetes.io/instance: mysite
    app.kubernetes.io/managed-by: Helm
  annotations:
automountServiceAccountToken: <span class="nb">false</span>
---
<span class="c1"># Source: drupal/charts/mariadb/templates/secrets.yaml</span>
apiVersion: v1
kind: Secret
metadata:
  name: mysite-mariadb
  namespace: <span class="s2">&quot;default&quot;</span>
  labels:
    app.kubernetes.io/name: mariadb
    helm.sh/chart: mariadb-11.0.0
    app.kubernetes.io/instance: mysite
    app.kubernetes.io/managed-by: Helm
type: Opaque
data:
  mariadb-root-password: <span class="nv">b3NjaGluYQ</span><span class="o">==</span>
  mariadb-password: <span class="nv">b3NjaGluYQ</span><span class="o">==</span>
---
<span class="c1"># Source: drupal/templates/secrets.yaml</span>
apiVersion: v1
kind: Secret
metadata:
  name: mysite-drupal
  labels:
    app.kubernetes.io/name: drupal
.....
</pre></div>
</div>
<p>关于这个命令的一个重要细节是，它不会返回所有资源的当前状态。它返回从模板生成的清单。</p>
<p>有了helm get，我们可以仔细检查一个单独的发布版本。</p>
</section>
</section>
</section>
<section id="id5">
<h2><a class="toc-backref" href="#id18">3. 历史记录和回滚</a><a class="headerlink" href="#id5" title="Permalink to this heading">¶</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm list
NAME    NAMESPACE       REVISION        UPDATED                                 STATUS          CHART           APP VERSION
mysite  default         <span class="m">2</span>               <span class="m">2022</span>-05-07 <span class="m">02</span>:23:59.050699352 -0400 EDT deployed        drupal-12.0.1   <span class="m">9</span>.3.12

$ helm <span class="nb">history</span> mysite
REVISION        UPDATED                         STATUS          CHART           APP VERSION     DESCRIPTION
<span class="m">1</span>               Sat May  <span class="m">7</span> <span class="m">02</span>:23:42 <span class="m">2022</span>        superseded      drupal-12.0.1   <span class="m">9</span>.3.12          Install <span class="nb">complete</span>
<span class="m">2</span>               Sat May  <span class="m">7</span> <span class="m">02</span>:23:59 <span class="m">2022</span>        deployed        drupal-12.0.1   <span class="m">9</span>.3.12          Upgrade <span class="nb">complete</span>
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm upgrade mysite bitnami/drupal --version <span class="m">11</span>.0.32 --values values.yaml
$ helm <span class="nb">history</span> mysite
REVISION        UPDATED                         STATUS          CHART           APP VERSION     DESCRIPTION
<span class="m">1</span>               Sat May  <span class="m">7</span> <span class="m">02</span>:23:42 <span class="m">2022</span>        superseded      drupal-12.0.1   <span class="m">9</span>.3.12          Install <span class="nb">complete</span>
<span class="m">2</span>               Sat May  <span class="m">7</span> <span class="m">02</span>:23:59 <span class="m">2022</span>        superseded      drupal-12.0.1   <span class="m">9</span>.3.12          Upgrade <span class="nb">complete</span>
<span class="m">3</span>               Sat May  <span class="m">7</span> <span class="m">02</span>:40:21 <span class="m">2022</span>        deployed        drupal-11.0.32  <span class="m">9</span>.3.11          Upgrade <span class="nb">complete</span>
</pre></div>
</div>
<ul class="simple">
<li><p>superseded（已取代）</p></li>
<li><p>pending-install（挂起-安装）</p></li>
<li><p>deployed（已部署）</p></li>
<li><p>pending-rollback（挂起-回滚）</p></li>
<li><p>uninstalling（正在卸载）</p></li>
<li><p>uninstalled（已卸载）</p></li>
<li><p>failed（失败）</p></li>
</ul>
<p>helm rollback的用途：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm rollback mysite <span class="m">2</span>
Rollback was a success! Happy Helming!
</pre></div>
</div>
<p>这个命令告诉Helm获取wordpress version
2版本，并将清单重新提交给Kubernetes。回滚不会还原到集群的上一个快照。Helm没有追踪足够的信息来做到这一点。它会重新提交以前的配置，而Kubernetes尝试重置资源以匹配。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm <span class="nb">history</span> mysite
REVISION        UPDATED                         STATUS          CHART           APP VERSION     DESCRIPTION
<span class="m">1</span>               Sat May  <span class="m">7</span> <span class="m">02</span>:23:42 <span class="m">2022</span>        superseded      drupal-12.0.1   <span class="m">9</span>.3.12          Install <span class="nb">complete</span>
<span class="m">2</span>               Sat May  <span class="m">7</span> <span class="m">02</span>:23:59 <span class="m">2022</span>        superseded      drupal-12.0.1   <span class="m">9</span>.3.12          Upgrade <span class="nb">complete</span>
<span class="m">3</span>               Sat May  <span class="m">7</span> <span class="m">02</span>:40:21 <span class="m">2022</span>        superseded      drupal-11.0.32  <span class="m">9</span>.3.11          Upgrade <span class="nb">complete</span>
<span class="m">4</span>               Sat May  <span class="m">7</span> <span class="m">02</span>:43:17 <span class="m">2022</span>        deployed        drupal-12.0.1   <span class="m">9</span>.3.12          Rollback to <span class="m">2</span>
</pre></div>
</div>
<p>回滚操作创建了一个新版本（4）。由于回滚是成功的（并且Kubernetes接受了修改），所以这个版本被标记为deployed。</p>
<p>因为Helm保存了历史记录，所以在回滚到已知的良好配置之后，仍然可以检查失败的版本。</p>
<p>在大多数情况下，helm rollback是从灾难中恢复过来的良好方法。</p>
<p>但是，如果手工编辑由Helm管理的资源，可能会出现一个有趣的问题。回滚有时会导致一些意外的行为，特别是在Kubernetes资源已经被用户手工编辑的情况下。如果这些手工编辑的内容与回滚不冲突，Helm和Kubernetes将尝试保留它们。</p>
<p>从本质上讲，回滚将在资源的当前状态、失败的Helm版本和回滚到的Helm版本之间产生一个三向差异。在某些情况下，生成的差异可能导致回滚手工编辑的内容，而在其他情况下，这些差异将被合并。在最坏的情况下，某些手工编辑的内容可能会被覆盖，而其他相关的编辑内容则会被合并，从而导致配置不一致。这是Helm核心维护人员建议不要手工编辑资源的众多原因之一。</p>
<p>如果所有的编辑都是通过Helm进行的，那么你就可以有效地使用Helm工具，而无须猜测。</p>
<section id="id6">
<h3><a class="toc-backref" href="#id19">3.1 保留历史和回滚</a><a class="headerlink" href="#id6" title="Permalink to this heading">¶</a></h3>
<p>在上一章中，我们看到helm
uninstall命令有一个名为–keep-history的标志。通常，删除事件将销毁与该安装相关联的所有发布记录。但是当指定–keep-history时，即使删除了安装，你也可以看到它的历史记录：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm uninstall mysite --keep-history
release <span class="s2">&quot;mysite&quot;</span> uninstalled

$ helm <span class="nb">history</span> mysite
REVISION        UPDATED                         STATUS          CHART           APP VERSION     DESCRIPTION
<span class="m">1</span>               Sat May  <span class="m">7</span> <span class="m">02</span>:23:42 <span class="m">2022</span>        superseded      drupal-12.0.1   <span class="m">9</span>.3.12          Install <span class="nb">complete</span>
<span class="m">2</span>               Sat May  <span class="m">7</span> <span class="m">02</span>:23:59 <span class="m">2022</span>        superseded      drupal-12.0.1   <span class="m">9</span>.3.12          Upgrade <span class="nb">complete</span>
<span class="m">3</span>               Sat May  <span class="m">7</span> <span class="m">02</span>:40:21 <span class="m">2022</span>        superseded      drupal-11.0.32  <span class="m">9</span>.3.11          Upgrade <span class="nb">complete</span>
<span class="m">4</span>               Sat May  <span class="m">7</span> <span class="m">02</span>:43:17 <span class="m">2022</span>        uninstalled     drupal-12.0.1   <span class="m">9</span>.3.12          Uninstallation <span class="nb">complete</span>
</pre></div>
</div>
<p>注意，最后一个版本现在标记为已卸载（uninstalled）。当历史记录被保留时，你可以回滚已删除的安装：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm rollback mysite <span class="m">4</span>
Rollback was a success! Happy Helming!
</pre></div>
</div>
<p>现在我们可以看到新部署的版本5：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm <span class="nb">history</span> mysite
REVISION        UPDATED                         STATUS          CHART           APP VERSION     DESCRIPTION
<span class="m">1</span>               Sat May  <span class="m">7</span> <span class="m">02</span>:23:42 <span class="m">2022</span>        superseded      drupal-12.0.1   <span class="m">9</span>.3.12          Install <span class="nb">complete</span>
<span class="m">2</span>               Sat May  <span class="m">7</span> <span class="m">02</span>:23:59 <span class="m">2022</span>        superseded      drupal-12.0.1   <span class="m">9</span>.3.12          Upgrade <span class="nb">complete</span>
<span class="m">3</span>               Sat May  <span class="m">7</span> <span class="m">02</span>:40:21 <span class="m">2022</span>        superseded      drupal-11.0.32  <span class="m">9</span>.3.11          Upgrade <span class="nb">complete</span>
<span class="m">4</span>               Sat May  <span class="m">7</span> <span class="m">02</span>:43:17 <span class="m">2022</span>        uninstalled     drupal-12.0.1   <span class="m">9</span>.3.12          Uninstallation <span class="nb">complete</span>
<span class="m">5</span>               Sat May  <span class="m">7</span> <span class="m">02</span>:48:21 <span class="m">2022</span>        deployed        drupal-12.0.1   <span class="m">9</span>.3.12          Rollback to <span class="m">4</span>
</pre></div>
</div>
<p>如果没有–keep-history标志，这将不起作用。</p>
</section>
</section>
<section id="id7">
<h2><a class="toc-backref" href="#id20">4.深入了解安装和升级</a><a class="headerlink" href="#id7" title="Permalink to this heading">¶</a></h2>
<section id="generate-namename-template">
<h3><a class="toc-backref" href="#id21">4.1 –generate-name和–name-template标志</a><a class="headerlink" href="#generate-namename-template" title="Permalink to this heading">¶</a></h3>
<p>Kubernetes的工作方式有一个与命名有关的微妙危险。Kubernetes假设名称将具有某些唯一性属性。例如，Deployment对象的命名空间中必须具有唯一的名称。也就是说，在命名空间mynamespace中不能有两个名为myapp的Deployment。但可以有一个Deployment和一个Pod，它们都叫myapp。</p>
<p>这使得某些任务变得更加复杂。例如，自动部署内容的CI系统必须确保这些内容的名称在命名空间中是唯一的。处理这个问题的一种方法是Helm提供一个工具来生成唯一的名称。</p>
<section id="id8">
<h4>1.使用默认名称+随机数<a class="headerlink" href="#id8" title="Permalink to this heading">¶</a></h4>
<p>Helm为helm install提供–generate name标志：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ helm install bitnami/drupal --values values.yaml --generate-name
NAME: drupal-1651906366
LAST DEPLOYED: Sat May  7 02:52:50 2022
NAMESPACE: default
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
CHART NAME: drupal
....
</pre></div>
</div>
<p>使用–generate name标志，我们不再需要提供名称作为helm
install的第一个参数。Helm根据chart名称和时间戳的组合生成名称。在前面的输出中，我们可以看到生成的名称：drupal-1651906366。</p>
</section>
<section id="id9">
<h4>2. 使用自定义名称<a class="headerlink" href="#id9" title="Permalink to this heading">¶</a></h4>
<p>还有一个额外的标志允许你指定命名模板。–name-template标志允许你执行以下操作：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm install bitnami/drupal --values values.yaml --generate-name --name-template <span class="s2">&quot;mysite-{{ randAlpha 9 | lower  }}&quot;</span>
NAME: mysite-lbrmruxpa
LAST DEPLOYED: Sat May  <span class="m">7</span> <span class="m">03</span>:03:21 <span class="m">2022</span>
NAMESPACE: default
STATUS: deployed
REVISION: <span class="m">1</span>
</pre></div>
</div>
<p>在该模板中，我们调用randAlpha函数，从a-z、A-Z字符范围中请求一个9个字符的随机字符串。然后我们通过第二个函数（lower）将结果“管道化”，该函数将所有内容都小写化。</p>
</section>
</section>
<section id="create-namespace">
<h3><a class="toc-backref" href="#id22">4.2 –create-namespace标志</a><a class="headerlink" href="#create-namespace" title="Permalink to this heading">¶</a></h3>
<p>Helm确实允许你通过显式地声明要创建命名空间来覆盖此考虑：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm install mysite bitnami/drupal --values values.yaml -n first-test --create-namespace
NAME: mysite
LAST DEPLOYED: Sat May  <span class="m">7</span> <span class="m">03</span>:06:34 <span class="m">2022</span>
NAMESPACE: first-test
STATUS: deployed
REVISION: <span class="m">1</span>
TEST SUITE: None
NOTES:
CHART NAME: drupal

$ helm list -n first-test
NAME    NAMESPACE       REVISION        UPDATED                                 STATUS          CHART           APP VERSION
mysite  first-test      <span class="m">1</span>               <span class="m">2022</span>-05-07 <span class="m">03</span>:06:34.978329723 -0400 EDT deployed        drupal-12.0.1   <span class="m">9</span>.3.12
</pre></div>
</div>
<p>在helm
uninstall上没有类似的–delete-namespace。原因在于Helm对全局对象的防御性。创建命名空间后，可以将任意数量的对象放入其中，而它们不一定全都是由Helm管理的。<strong>当一个命名空间被删除时，该命名空间内的所有对象也都被删除。</strong>所以Helm不会自动删除用–create-namespace创建的命名空间。</p>
<p><strong>要删除命名空间，请使用kubectl delete
namespace（当然，在确保该命名空间中不存在重要对象之后再删除）。</strong></p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm uninstall mysite -n first-test
$ kubectl delete ns first-test
</pre></div>
</div>
</section>
<section id="helm-upgradeinstall">
<h3><a class="toc-backref" href="#id23">4.3 使用helm upgrade–install</a><a class="headerlink" href="#helm-upgradeinstall" title="Permalink to this heading">¶</a></h3>
<p>这样的系统通常在无状态平台上运行基本脚本，而无状态平台没有查询Kubernetes的方法。</p>
<p>这类系统的用户要求Helm提供一个特性，<strong>允许在一个命令中支持“安装或升级”</strong>。</p>
<p>为了方便这种行为，Helm维护人员在helm upgrade命令中添加了–install标志。</p>
<p>helm
upgrade–install命令将安装一个尚不存在的版本，或者升级一个以该名称命名的版本。在底层，它通过查询Kubernetes以获得具有给定名称的发布版。</p>
<p>如果该版本不存在，它将从升级逻辑切换到安装逻辑。</p>
<p>例如，我们可以使用完全相同的命令依次运行安装和升级：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm upgrade --install  mysite bitnami/drupal --values values.yaml
Release <span class="s2">&quot;mysite&quot;</span> does not exist. Installing it now.
NAME: mysite
LAST DEPLOYED: Sat May  <span class="m">7</span> <span class="m">03</span>:11:18 <span class="m">2022</span>
NAMESPACE: default
STATUS: deployed
REVISION: <span class="m">1</span>
TEST SUITE: None
NOTES:
CHART NAME: drupal
CHART VERSION: <span class="m">12</span>.0.1
</pre></div>
</div>
<p>不过，这个命令确实带来了一些危险。Helm无法确定你提供给helm
upgrade–install的安装名称是属于你要升级的发布版本，还是恰好与你要安装的名称相同。不小心使用此命令可能会导致用另一个安装覆盖某个安装。这就是它不是Helm的默认行为的原因。</p>
</section>
<section id="waitatomic">
<h3><a class="toc-backref" href="#id24">4.4 –wait和–atomic标志</a><a class="headerlink" href="#waitatomic" title="Permalink to this heading">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 通过设置–wait参数，将等待所有Pod、PVC和Service以及Deployment、StatefulSet和ReplicaSet的最小Pod数都处于就绪状态后，然后才将Release标记为deployed状态，然后install命令行返回成功。等待–timeout时间，–timeout缺省为5m0s。</span>
$ helm install myweb bitnami/tomcat <span class="se">\</span>
  --wait <span class="se">\</span>
  --set service.type<span class="o">=</span>NodePort <span class="se">\</span>
  --set persistence.enabled<span class="o">=</span><span class="nb">false</span>



<span class="c1"># 设置–timeout参数，缺省为5m0s。如果超过–timeout还没有就绪，Release状态将被标记为failed，命令行返回值为1，但并不会回退提交给Kubernetes的资源，所以安装不一定失败。如下载镜像时间过长，Release的状态被置为failed，但Kubernetes仍在会继续下载镜像，所以安装最终会成功，但Release不会被重置为deployed。没有找到修改Release状态的命令。</span>


<span class="c1">#设置–atomic参数，如果安装失败，会自动清除Chart，相当于如果状态为failed时会回退所有操作，保持安装的原子性。当设置–atomic参数时，–wait参数会自动配置。</span>
$ helm install myweb bitnami/tomcat <span class="se">\</span>
  --atomic --timeout<span class="o">=</span>1m <span class="se">\</span>
  --set service.type<span class="o">=</span>NodePort <span class="se">\</span>
  --set persistence.enabled<span class="o">=</span><span class="nb">false</span>
</pre></div>
</div>
</section>
<section id="forcecleanup-on-fail">
<h3><a class="toc-backref" href="#id25">4.5 使用–force和–cleanup-on-fail升级</a><a class="headerlink" href="#forcecleanup-on-fail" title="Permalink to this heading">¶</a></h3>
<p>我们下面看到的最后两个标志修改了Helm处理升级的细微差别的方式。</p>
<p>–force标志在升级用于管理pod（如Pod、Deployment和StatefulSet）的资源时修改Helm的行为。</p>
<p>通常，当Kubernetes收到修改此类对象的请求时，它会确定是否需要重新启动此资源管理的pod。</p>
<p>例如，某个Deployment可以运行一个pod的五个副本。但是，如果Kubernetes接收到Deployment对象的更新，它只会在某些字段被修改时重新启动这些pod。</p>
<p>不过，有时Helm用户希望确保pod重启。这时就用到了–force标记。它将删除并重新创建Deployment，而不是修改Deployment（或类似对象）。这迫使Kubernetes删除旧pod并创建新pod。</p>
<p>根据设计，使用–force会导致停机（通常只有几秒钟的停机时间）。建议仅在明确需要的情况使用–force，而不是作为默认选项。</p>
<p>例如，核心维护人员不建议在部署到生产环境的CI管道中使用–force。</p>
<p>修改升级行为的另一种方法是使用–cleanup on
fail标志。类似于–force，这个标志指示Helm做额外的工作。</p>
<p>考虑这样一种情况：安装一个创建Kubernetes
Secret的chart。一个新版本的chart被创建，它创建了第二个Secret。</p>
<p>但在安装过程中，Helm遇到了一个错误，并将发布标记为失败。第二个Secret有可能被挂起。如果使用–wait或–atomic，则更可能出现这种情况，因为在Kubernetes接受清单并创建资源之后，这些操作可能会失败。</p>
<p>–cleanup-on-fail标志将尝试修复此情况。如果失败，它将请求删除升级期间新创建的每个对象。使用它可能会使调试变得更加困难（特别是如果失败是由新创建的对象造成的），但是如果你不想冒险在失败后挂起未使用的对象，那么它是很有用的。</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="1.%E4%BD%BF%E7%94%A8Helm.html" class="btn btn-neutral float-left" title="使用Helm" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="3.%E6%9E%84%E5%BB%BAchart.html" class="btn btn-neutral float-right" title="构建chart" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, huxiaojian.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>