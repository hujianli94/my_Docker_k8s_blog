

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>通过Kubeadm部署kubernetes &mdash; 运维开发修炼之路</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'1.0.0',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Kubespray部署k8s" href="02.Kubespray部署k8s.html" />
    <link rel="prev" title="02.Kubernetes实战指南" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> 小健_Docker_K8s_Blog
          

          
            
            <img src="../_static/docker-k8s.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../01.Docker技术入门与实战-3版/index.html">01.Docker技术入门与实战-第3版</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">02.Kubernetes实战指南</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">通过Kubeadm部署kubernetes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">基本环境配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">部署步骤</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">准备工作</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ipvs">加载 ipvs 内核模块</a></li>
<li class="toctree-l4"><a class="reference internal" href="#docker">安装docker</a></li>
<li class="toctree-l4"><a class="reference internal" href="#kubeadm-kubectl-kubelet">安装kubeadm, kubectl, kubelet</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#masterkubeadm">Master初始化kubeadm</a></li>
<li class="toctree-l3"><a class="reference internal" href="#node">node加入集群</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#join">获得 join命令参数</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id4">查看部署状态</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ingress-controller">安装 Ingress Controller</a></li>
<li class="toctree-l3"><a class="reference internal" href="#kubernetes-dashboard">安装Kubernetes Dashboard</a></li>
<li class="toctree-l3"><a class="reference internal" href="#kuboard-kubernetes">安装Kuboard Kubernetes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">诊断分析</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id6">1．查看日志</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">2．查看资源详情和事件</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id8">参考文献</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="02.Kubespray部署k8s.html">Kubespray部署k8s</a></li>
<li class="toctree-l2"><a class="reference internal" href="03.Docker基础.html">Docker基础</a></li>
<li class="toctree-l2"><a class="reference internal" href="04.Kubernetes基础.html">Kubernetes基础</a></li>
<li class="toctree-l2"><a class="reference internal" href="05.Pod.html">Pod</a></li>
<li class="toctree-l2"><a class="reference internal" href="07.kubernetes实战案例.html">Kubernetes实战案例</a></li>
<li class="toctree-l2"><a class="reference internal" href="20.Helm简化Kubernetes部署.html">Helm简化kubernetes部署</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../03.Docker经典实例/index.html">03.Docker经典实例</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">小健_Docker_K8s_Blog</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">02.Kubernetes实战指南</a> &raquo;</li>
        
      <li>通过Kubeadm部署kubernetes</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/02.Kubernetes实战指南/01.通过Kubeadm部署kubernetes.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#kubeadmkubernetes" id="id9">通过Kubeadm部署kubernetes</a><ul>
<li><a class="reference internal" href="#id1" id="id10">基本环境配置</a></li>
<li><a class="reference internal" href="#id2" id="id11">部署步骤</a><ul>
<li><a class="reference internal" href="#id3" id="id12">准备工作</a></li>
<li><a class="reference internal" href="#ipvs" id="id13">加载 ipvs 内核模块</a></li>
<li><a class="reference internal" href="#docker" id="id14">安装docker</a></li>
<li><a class="reference internal" href="#kubeadm-kubectl-kubelet" id="id15">安装kubeadm, kubectl, kubelet</a></li>
</ul>
</li>
<li><a class="reference internal" href="#masterkubeadm" id="id16">Master初始化kubeadm</a></li>
<li><a class="reference internal" href="#node" id="id17">node加入集群</a><ul>
<li><a class="reference internal" href="#join" id="id18">获得 join命令参数</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id4" id="id19">查看部署状态</a></li>
<li><a class="reference internal" href="#ingress-controller" id="id20">安装 Ingress Controller</a></li>
<li><a class="reference internal" href="#kubernetes-dashboard" id="id21">安装Kubernetes Dashboard</a></li>
<li><a class="reference internal" href="#kuboard-kubernetes" id="id22">安装Kuboard Kubernetes</a></li>
<li><a class="reference internal" href="#id5" id="id23">诊断分析</a><ul>
<li><a class="reference internal" href="#id6" id="id24">1．查看日志</a></li>
<li><a class="reference internal" href="#id7" id="id25">2．查看资源详情和事件</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id8" id="id26">参考文献</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="kubeadmkubernetes">
<h1><a class="toc-backref" href="#id9">通过Kubeadm部署kubernetes</a><a class="headerlink" href="#kubeadmkubernetes" title="Permalink to this headline">¶</a></h1>
<p>公司大部分线下测试环境均采用Kubeadm安装，这也是目前官方默认的安装方式，比二进制安装方式更加简单，可以让初学者快速上手并测试。目前GitHub上也有很多基于Ansible的自动化安装方式，但是为了更好地学习Kubernetes，还是建议体验一下Kubernetes的手动安装过程，以熟悉Kubernetes的各个组件。</p>
<div class="section" id="id1">
<h2><a class="toc-backref" href="#id10">基本环境配置</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<table border="1" class="docutils">
<colgroup>
<col width="31%" />
<col width="38%" />
<col width="31%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">主机名</th>
<th class="head">IP地址</th>
<th class="head">说明</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>k8s-master</td>
<td>172.16.60.236</td>
<td>k8s-master</td>
</tr>
<tr class="row-odd"><td>k8s-node1</td>
<td>172.16.60.178</td>
<td>k8s-node1</td>
</tr>
<tr class="row-even"><td>k8s-node2</td>
<td>172.16.60.226</td>
<td>k8s-node2</td>
</tr>
<tr class="row-odd"><td>k8s-node3</td>
<td>172.16.60.9</td>
<td>k8s-node3</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id11">部署步骤</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div>以下不做特殊说明默认所有机子都执行</div></blockquote>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id12">准备工作</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>各节点通信采用主机名的方式，这种方式与IP地址相比较更具有扩展性。以下介绍具体的安装步骤。所有节点配置hosts，修改/etc/hosts如下：</p>
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span># 更新系统和软件包
yum update

# 设置主机名(master node 名字分开)
hostnamectl set-hostname k8s-master

# 同步时间
systemctl restart chronyd

# 添加host
# 以下ip是所有机器的内网ip
cat &gt;&gt; /etc/hosts &lt;&lt;&#39;EOF&#39;
172.16.60.236   k8s-master
172.16.60.178   k8s-node1
172.16.60.226   k8s-node2
172.16.60.9     k8s-node3
EOF

cat &gt;&gt;/etc/resolv.conf &lt;&lt;&#39;EOF&#39;
nameserver 8.8.8.8
EOF

# 设置所有机器间无密码访问
ssh-keygen -t rsa
for i in k8s-master k8s-node1 k8s-node2 k8s-node3;do ssh-copy-id -i /root/.ssh/id_rsa.pub $i;done


# 关闭防火墙和iptables
systemctl stop firewalld.service
systemctl disable firewalld.service
systemctl stop iptables.service
systemctl disable iptables.service

# 关闭SELinux
setenforce 0
sed -i &quot;s/SELINUX=enforcing/SELINUX=disabled/g&quot; /etc/selinux/config

# 关闭swap
swapoff -a &amp;&amp; sysctl -w vm.swappiness=0
sed -i &#39;/ swap / s/^\(.*\)$/#\1/g&#39; /etc/fstab
</pre></div>
</div>
<p>注释swap挂载选项：</p>
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># grep &quot;swap&quot; /etc/fstab</span>
<span class="c1">#UUID=a5ace1f8-ddcd-434d-afef-b5a73c7ef8e8 swap                    swap    defaults        0 0</span>
</pre></div>
</div>
<p>所有节点同步时间。所有节点同步时间是必须的，并且需要加到开机自启动和计划任务中，如果节点时间不同步，会造成Etcd存储Kubernetes信息的键－值（key-value）数据库同步数据不正常，也会造成证书出现问题。时间同步配置如下：</p>
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">ntp</span>
<span class="n">ln</span> <span class="o">-</span><span class="n">sf</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">zoneinfo</span><span class="o">/</span><span class="n">Asia</span><span class="o">/</span><span class="n">Shanghai</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">localtime</span>
<span class="n">echo</span> <span class="s2">&quot;Asia/Shanghai&quot;</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">timezone</span>
<span class="n">ntpdate</span> <span class="n">time2</span><span class="o">.</span><span class="n">aliyun</span><span class="o">.</span><span class="n">com</span>
<span class="c1"># 加入计划任务</span>
<span class="n">crontab</span> <span class="o">-</span><span class="n">l</span>
<span class="o">*/</span><span class="mi">5</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="n">ntpdate</span> <span class="n">time2</span><span class="o">.</span><span class="n">aliyun</span><span class="o">.</span><span class="n">com</span>

<span class="c1"># 加入开机自启动</span>
<span class="n">cat</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc</span><span class="o">.</span><span class="n">local</span>
<span class="n">ntpdate</span> <span class="n">time2</span><span class="o">.</span><span class="n">aliyun</span><span class="o">.</span><span class="n">com</span>


<span class="c1"># 将桥接的IPv4流量传递到iptables的链</span>
<span class="n">cat</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysctl</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">k8s</span><span class="o">.</span><span class="n">conf</span> <span class="o">&lt;&lt;</span> <span class="n">EOF</span>
<span class="n">net</span><span class="o">.</span><span class="n">bridge</span><span class="o">.</span><span class="n">bridge</span><span class="o">-</span><span class="n">nf</span><span class="o">-</span><span class="n">call</span><span class="o">-</span><span class="n">ip6tables</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">net</span><span class="o">.</span><span class="n">bridge</span><span class="o">.</span><span class="n">bridge</span><span class="o">-</span><span class="n">nf</span><span class="o">-</span><span class="n">call</span><span class="o">-</span><span class="n">iptables</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">EOF</span>
<span class="n">sysctl</span> <span class="o">--</span><span class="n">system</span>  <span class="c1"># 生效</span>
</pre></div>
</div>
<p>所有节点配置limit：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ulimit</span> <span class="o">-</span><span class="n">SHn</span> <span class="mi">65535</span>
</pre></div>
</div>
<p>所有节点都配置国内仓库源</p>
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="o">-</span><span class="n">O</span> <span class="n">CentOS</span><span class="o">-</span><span class="n">Base</span><span class="o">.</span><span class="n">repo</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">mirrors</span><span class="o">.</span><span class="n">aliyun</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">repo</span><span class="o">/</span><span class="n">Centos</span><span class="o">-</span><span class="mf">7.</span><span class="n">repo</span>

<span class="n">wget</span> <span class="o">-</span><span class="n">O</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">yum</span><span class="o">.</span><span class="n">repos</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">epel</span><span class="o">.</span><span class="n">repo</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">mirrors</span><span class="o">.</span><span class="n">aliyun</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">repo</span><span class="o">/</span><span class="n">epel</span><span class="o">-</span><span class="mf">7.</span><span class="n">repo</span>
</pre></div>
</div>
</div>
<div class="section" id="ipvs">
<h3><a class="toc-backref" href="#id13">加载 ipvs 内核模块</a><a class="headerlink" href="#ipvs" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>安装 IPVS 模块</li>
</ul>
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">ipvsadm</span> <span class="n">ipset</span> <span class="n">sysstat</span> <span class="n">conntrack</span> <span class="n">libseccomp</span>
</pre></div>
</div>
<ul class="simple">
<li>设置开机加载配置文件</li>
</ul>
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">&gt;&gt;/</span><span class="n">etc</span><span class="o">/</span><span class="n">modules</span><span class="o">-</span><span class="n">load</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">ipvs</span><span class="o">.</span><span class="n">conf</span><span class="o">&lt;&lt;</span><span class="n">EOF</span>
<span class="n">ip_vs_dh</span>
<span class="n">ip_vs_ftp</span>
<span class="n">ip_vs</span>
<span class="n">ip_vs_lblc</span>
<span class="n">ip_vs_lblcr</span>
<span class="n">ip_vs_lc</span>
<span class="n">ip_vs_nq</span>
<span class="n">ip_vs_pe_sip</span>
<span class="n">ip_vs_rr</span>
<span class="n">ip_vs_sed</span>
<span class="n">ip_vs_sh</span>
<span class="n">ip_vs_wlc</span>
<span class="n">ip_vs_wrr</span>
<span class="n">nf_conntrack_ipv4</span>
<span class="n">EOF</span>
</pre></div>
</div>
<ul class="simple">
<li>设置开机加载 IPVS 模块</li>
</ul>
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 设置开机加载内核模块</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="n">systemd</span><span class="o">-</span><span class="n">modules</span><span class="o">-</span><span class="n">load</span><span class="o">.</span><span class="n">service</span>

<span class="c1"># 重启后检查 ipvs 模块是否加载</span>
<span class="n">lsmod</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">e</span> <span class="n">ip_vs</span> <span class="o">-</span><span class="n">e</span> <span class="n">nf_conntrack_ipv4</span>
</pre></div>
</div>
<ul class="simple">
<li>如果集群已经部署在了 iptables 模式下，可以通过下面命令修改，修改 mode
为 ipvs 重启集群即可。</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">edit</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="n">configmap</span> <span class="n">kube</span><span class="o">-</span><span class="n">proxy</span>
</pre></div>
</div>
</div>
<div class="section" id="docker">
<h3><a class="toc-backref" href="#id14">安装docker</a><a class="headerlink" href="#docker" title="Permalink to this headline">¶</a></h3>
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># master执行以下转到repo目录</span>
<span class="n">cd</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">yum</span><span class="o">.</span><span class="n">repos</span><span class="o">.</span><span class="n">d</span><span class="o">/</span>

<span class="c1"># master执行下载docker阿里云镜像</span>
<span class="n">wget</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">mirrors</span><span class="o">.</span><span class="n">aliyun</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">docker</span><span class="o">-</span><span class="n">ce</span><span class="o">/</span><span class="n">linux</span><span class="o">/</span><span class="n">centos</span><span class="o">/</span><span class="n">docker</span><span class="o">-</span><span class="n">ce</span><span class="o">.</span><span class="n">repo</span>

<span class="c1"># master同步到其他服务器</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@k8s</span><span class="o">-</span><span class="n">master</span> <span class="n">yum</span><span class="o">.</span><span class="n">repos</span><span class="o">.</span><span class="n">d</span><span class="p">]</span><span class="c1"># for i in k8s-master k8s-node1 k8s-node2 k8s-node3;do scp docker-ce.repo $i:/etc/yum.repos.d/;done</span>
<span class="n">docker</span><span class="o">-</span><span class="n">ce</span><span class="o">.</span><span class="n">repo</span>                                                                                                             <span class="mi">100</span><span class="o">%</span> <span class="mi">2640</span>   <span class="mf">162.5</span><span class="n">KB</span><span class="o">/</span><span class="n">s</span>   <span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
<span class="n">docker</span><span class="o">-</span><span class="n">ce</span><span class="o">.</span><span class="n">repo</span>                                                                                                             <span class="mi">100</span><span class="o">%</span> <span class="mi">2640</span>     <span class="mf">3.5</span><span class="n">MB</span><span class="o">/</span><span class="n">s</span>   <span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
<span class="n">docker</span><span class="o">-</span><span class="n">ce</span><span class="o">.</span><span class="n">repo</span>                                                                                                             <span class="mi">100</span><span class="o">%</span> <span class="mi">2640</span>     <span class="mf">3.7</span><span class="n">MB</span><span class="o">/</span><span class="n">s</span>   <span class="mi">00</span><span class="p">:</span><span class="mi">00</span>


<span class="c1"># 安装docker(各个都要装)</span>
<span class="n">yum</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">docker</span><span class="o">-</span><span class="n">ce</span>

<span class="c1"># 修改配置</span>
<span class="n">nano</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">docker</span><span class="o">.</span><span class="n">service</span>

<span class="c1"># master增加一行如下</span>
<span class="n">ExecStartPost</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">iptables</span> <span class="o">-</span><span class="n">P</span> <span class="n">FORWARD</span> <span class="n">ACCEPT</span>

<span class="c1"># 配置阿里云镜像加速</span>
<span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">docker</span>
<span class="n">sudo</span> <span class="n">tee</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">daemon</span><span class="o">.</span><span class="n">json</span> <span class="o">&lt;&lt;-</span><span class="s1">&#39;EOF&#39;</span>
<span class="p">{</span>
  <span class="s2">&quot;registry-mirrors&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;https://25bxwt20.mirror.aliyuncs.com&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">EOF</span>

<span class="c1"># 重启docker</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">docker</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="n">docker</span>
<span class="n">systemctl</span> <span class="n">restart</span> <span class="n">docker</span>
</pre></div>
</div>
</div>
<div class="section" id="kubeadm-kubectl-kubelet">
<h3><a class="toc-backref" href="#id15">安装kubeadm, kubectl, kubelet</a><a class="headerlink" href="#kubeadm-kubectl-kubelet" title="Permalink to this headline">¶</a></h3>
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span># master执行以下
cat &gt;&gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt;&#39;EOF&#39;
[kubernetes]
name=Kubernetes Repository
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
EOF

# master检查仓库
yum repolist
yum list all | grep &quot;^kube&quot;

# master执行安装
yum install kubeadm kubelet kubectl -y

# 检查安装
rpm -ql kubectl
rpm -ql kubeadm

# master上把仓库拷贝过去
cd /etc/yum.repos.d/
for i in k8s-master k8s-node1 k8s-node2 k8s-node3;do scp  kubernetes.repo $i:/etc/yum.repos.d/


# 所有node安装kubelet kubeadm
yum install kubelet kubeadm -y

# master和node执行以下
systemctl enable kubelet.service

# master查看所需的镜像
kubeadm config images list

# 所有机器都执行以下的拉取镜像的操作
# 由于kubeadm依赖国外的k8s.gcr.io的镜像，国内被墙所以这边的解决方案是下载国内的镜像重新打tag的方式
cat &gt; images_pull_k8s.sh &lt;&lt;&#39;EOF&#39;
#!/bin/bash
k8s_Version=&quot;v1.18.3&quot;

images=(
    # 下面的镜像应该去除&quot;k8s.gcr.io/&quot;的前缀
    kube-apiserver:${k8s_Version}
    kube-controller-manager:${k8s_Version}
    kube-scheduler:${k8s_Version}
    kube-proxy:${k8s_Version}
    pause:3.2
    etcd:3.4.3-0
    coredns:1.6.7
)

for imageName in ${images[@]} ; do
    docker pull mirrorgcrio/$imageName
    docker tag mirrorgcrio/$imageName k8s.gcr.io/$imageName
    docker rmi mirrorgcrio/$imageName
done
EOF

chmod 755 images_pull_k8s.sh
./images_pull_k8s.sh
</pre></div>
</div>
<p>或者直接手动拉取镜像</p>
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">pull</span> <span class="n">mirrorgcrio</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.3</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">mirrorgcrio</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="n">manager</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.3</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">mirrorgcrio</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">scheduler</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.3</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">mirrorgcrio</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">proxy</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.3</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">mirrorgcrio</span><span class="o">/</span><span class="n">pause</span><span class="p">:</span><span class="mf">3.2</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">mirrorgcrio</span><span class="o">/</span><span class="n">etcd</span><span class="p">:</span><span class="mf">3.4</span><span class="o">.</span><span class="mi">3</span><span class="o">-</span><span class="mi">0</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">mirrorgcrio</span><span class="o">/</span><span class="n">coredns</span><span class="p">:</span><span class="mf">1.6</span><span class="o">.</span><span class="mi">7</span>

<span class="n">docker</span> <span class="n">tag</span> <span class="n">mirrorgcrio</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.3</span> <span class="n">k8s</span><span class="o">.</span><span class="n">gcr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.3</span>
<span class="n">docker</span> <span class="n">tag</span> <span class="n">mirrorgcrio</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="n">manager</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.3</span> <span class="n">k8s</span><span class="o">.</span><span class="n">gcr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="n">manager</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.3</span>
<span class="n">docker</span> <span class="n">tag</span> <span class="n">mirrorgcrio</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">scheduler</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.3</span> <span class="n">k8s</span><span class="o">.</span><span class="n">gcr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">scheduler</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.3</span>
<span class="n">docker</span> <span class="n">tag</span> <span class="n">mirrorgcrio</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">proxy</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.3</span> <span class="n">k8s</span><span class="o">.</span><span class="n">gcr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">proxy</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.3</span>
<span class="n">docker</span> <span class="n">tag</span> <span class="n">mirrorgcrio</span><span class="o">/</span><span class="n">pause</span><span class="p">:</span><span class="mf">3.2</span> <span class="n">k8s</span><span class="o">.</span><span class="n">gcr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">pause</span><span class="p">:</span><span class="mf">3.2</span>
<span class="n">docker</span> <span class="n">tag</span> <span class="n">mirrorgcrio</span><span class="o">/</span><span class="n">etcd</span><span class="p">:</span><span class="mf">3.4</span><span class="o">.</span><span class="mi">3</span><span class="o">-</span><span class="mi">0</span> <span class="n">k8s</span><span class="o">.</span><span class="n">gcr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">etcd</span><span class="p">:</span><span class="mf">3.4</span><span class="o">.</span><span class="mi">3</span><span class="o">-</span><span class="mi">0</span>
<span class="n">docker</span> <span class="n">tag</span> <span class="n">mirrorgcrio</span><span class="o">/</span><span class="n">coredns</span><span class="p">:</span><span class="mf">1.6</span><span class="o">.</span><span class="mi">7</span> <span class="n">k8s</span><span class="o">.</span><span class="n">gcr</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">coredns</span><span class="p">:</span><span class="mf">1.6</span><span class="o">.</span><span class="mi">7</span>

<span class="n">docker</span> <span class="n">image</span> <span class="n">rm</span> <span class="n">mirrorgcrio</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.3</span>
<span class="n">docker</span> <span class="n">image</span> <span class="n">rm</span> <span class="n">mirrorgcrio</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="n">manager</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.3</span>
<span class="n">docker</span> <span class="n">image</span> <span class="n">rm</span> <span class="n">mirrorgcrio</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">scheduler</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.3</span>
<span class="n">docker</span> <span class="n">image</span> <span class="n">rm</span> <span class="n">mirrorgcrio</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">proxy</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.3</span>
<span class="n">docker</span> <span class="n">image</span> <span class="n">rm</span> <span class="n">mirrorgcrio</span><span class="o">/</span><span class="n">pause</span><span class="p">:</span><span class="mf">3.2</span>
<span class="n">docker</span> <span class="n">image</span> <span class="n">rm</span> <span class="n">mirrorgcrio</span><span class="o">/</span><span class="n">etcd</span><span class="p">:</span><span class="mf">3.4</span><span class="o">.</span><span class="mi">3</span><span class="o">-</span><span class="mi">0</span>
<span class="n">docker</span> <span class="n">image</span> <span class="n">rm</span> <span class="n">mirrorgcrio</span><span class="o">/</span><span class="n">coredns</span><span class="p">:</span><span class="mf">1.6</span><span class="o">.</span><span class="mi">7</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="masterkubeadm">
<h2><a class="toc-backref" href="#id16">Master初始化kubeadm</a><a class="headerlink" href="#masterkubeadm" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div>本小节的所有的操作，只在 Master 节点上进行</div></blockquote>
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span># master执行init初始化
kubeadm init \
--kubernetes-version=&quot;v1.18.3&quot; \
--pod-network-cidr=&quot;10.244.0.0/16&quot; \
--ignore-preflight-errors=&quot;NumCPU&quot;

# 后续步骤
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

# 应用网络插件flannle
[root@k8s-master home]# kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</pre></div>
</div>
</div>
<div class="section" id="node">
<h2><a class="toc-backref" href="#id17">node加入集群</a><a class="headerlink" href="#node" title="Permalink to this headline">¶</a></h2>
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@k8s</span><span class="o">-</span><span class="n">node1</span> <span class="n">home</span><span class="p">]</span><span class="c1"># kubeadm join 172.16.60.236:6443 --token 950v9y.z3lz25askvjw33ou \</span>
<span class="o">&gt;</span>     <span class="o">--</span><span class="n">discovery</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="nb">hash</span> <span class="n">sha256</span><span class="p">:</span><span class="n">e84f8923f43878b530c6d5879c258ccdd5caec1d02ee8d89d1d75b9bdf4d753e</span>
<span class="o">......</span>
<span class="n">Run</span> <span class="s1">&#39;kubectl get nodes&#39;</span> <span class="n">on</span> <span class="n">the</span> <span class="n">control</span><span class="o">-</span><span class="n">plane</span> <span class="n">to</span> <span class="n">see</span> <span class="n">this</span> <span class="n">node</span> <span class="n">join</span> <span class="n">the</span> <span class="n">cluster</span>
</pre></div>
</div>
<ul class="simple">
<li>如果初始化过程被中断可以使用下面命令来恢复</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubeadm</span> <span class="n">reset</span>
</pre></div>
</div>
<ul class="simple">
<li>下面是最后执行成功显示的结果，需要保存这个执行结果，以让 node
节点加入集群</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

You should now deploy a pod network to the cluster.
Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 172.16.100.9:6443 --token 2dyd69.hrfsjkkxs4stim7n \
    --discovery-token-ca-cert-hash sha256:4e30c1f41aefb177b708a404ccb7e818e31647c7dbdd2d42f6c5c9894b6f41e7
</pre></div>
</div>
<ul class="simple">
<li>最好以普通用户的身份运行下面的命令</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># 在当前用户家目录下创建.kube目录并配置访问集群的config 文件
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
</pre></div>
</div>
<ul class="simple">
<li>部署 flannel 网络插件</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">coreos</span><span class="o">/</span><span class="n">flannel</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">Documentation</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">flannel</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<ul class="simple">
<li>查看 kube-system 命名空间中运行的 pods</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
</pre></div>
</div>
<ul class="simple">
<li>查看 k8s 集群组件的状态</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">ComponentStatus</span>
</pre></div>
</div>
<ul class="simple">
<li>配置命令补全</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">bash</span><span class="o">-</span><span class="n">completion</span>
<span class="n">source</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">bash</span><span class="o">-</span><span class="n">completion</span><span class="o">/</span><span class="n">bash_completion</span>
<span class="n">source</span> <span class="o">&lt;</span><span class="p">(</span><span class="n">kubectl</span> <span class="n">completion</span> <span class="n">bash</span><span class="p">)</span>
<span class="n">echo</span> <span class="s2">&quot;source &lt;(kubectl completion bash)&quot;</span> <span class="o">&gt;&gt;</span> <span class="o">~/.</span><span class="n">bashrc</span>
</pre></div>
</div>
<div class="section" id="join">
<h3><a class="toc-backref" href="#id18">获得 join命令参数</a><a class="headerlink" href="#join" title="Permalink to this headline">¶</a></h3>
<p><strong>在 master 节点上执行</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># 只在 master 节点执行
kubeadm token create --print-join-command


可获取kubeadm join 命令及参数，如下所示

# kubeadm token create 命令的输出
kubeadm join apiserver.demo:6443 --token mpfjma.4vjjg8flqihor4vt     --discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303

有效时间

该 token 的有效时间为 2 个小时，2小时内，您可以使用此 token
初始化任意数量的 worker 节点。
</pre></div>
</div>
</div>
</div>
<div class="section" id="id4">
<h2><a class="toc-backref" href="#id19">查看部署状态</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># master查看node节点状态</span>
<span class="n">kubectl</span> <span class="n">get</span> <span class="n">nodes</span>

<span class="c1"># master查看kube-system命名空间下的pod启动的状态</span>
<span class="n">kubectl</span> <span class="n">get</span> <span class="n">po</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>

<span class="c1"># 如果有pod一直启动不起来，通过describe查看状态</span>
<span class="n">kubectl</span> <span class="n">describe</span> <span class="n">po</span><span class="o">/</span><span class="p">{</span><span class="n">具体的pod名字</span><span class="p">}</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
</pre></div>
</div>
</div>
<div class="section" id="ingress-controller">
<h2><a class="toc-backref" href="#id20">安装 Ingress Controller</a><a class="headerlink" href="#ingress-controller" title="Permalink to this headline">¶</a></h2>
<p><strong>安装</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 只在 master 节点执行</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">kuboard</span><span class="o">.</span><span class="n">cn</span><span class="o">/</span><span class="n">install</span><span class="o">-</span><span class="n">script</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mf">19.</span><span class="n">x</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p><strong>卸载</strong></p>
<p>只在您想选择其他 Ingress Controller 的情况下卸载</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 只在 master 节点执行</span>
<span class="n">kubectl</span> <span class="n">delete</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">kuboard</span><span class="o">.</span><span class="n">cn</span><span class="o">/</span><span class="n">install</span><span class="o">-</span><span class="n">script</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mf">19.</span><span class="n">x</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p><strong>定制化ingress</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 如果打算用于生产环境，请参考 https://github.com/nginxinc/kubernetes-ingress/blob/v1.5.5/docs/installation.md 并根据您自己的情况做进一步定制</span>
</pre></div>
</div>
<p>查看ingress运行状态</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@k8s</span><span class="o">-</span><span class="n">master</span> <span class="o">~</span><span class="p">]</span><span class="c1"># kubectl get pods --all-namespaces</span>
<span class="n">NAMESPACE</span>       <span class="n">NAME</span>                                       <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">kube</span><span class="o">-</span><span class="n">system</span>     <span class="n">calico</span><span class="o">-</span><span class="n">kube</span><span class="o">-</span><span class="n">controllers</span><span class="o">-</span><span class="mi">6</span><span class="n">c89d944d5</span><span class="o">-</span><span class="n">th2k7</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">3</span><span class="n">h25m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">system</span>     <span class="n">calico</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">j4g9n</span>                          <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">45</span><span class="n">m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">system</span>     <span class="n">calico</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">qt6sk</span>                          <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">3</span><span class="n">h25m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">system</span>     <span class="n">coredns</span><span class="o">-</span><span class="mi">59</span><span class="n">c898cd69</span><span class="o">-</span><span class="mi">2</span><span class="n">tnvl</span>                   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">1</span>          <span class="mi">3</span><span class="n">h25m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">system</span>     <span class="n">coredns</span><span class="o">-</span><span class="mi">59</span><span class="n">c898cd69</span><span class="o">-</span><span class="n">cdxxq</span>                   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">3</span><span class="n">h25m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">system</span>     <span class="n">etcd</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">master</span>                            <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">3</span><span class="n">h25m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">system</span>     <span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">master</span>                  <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">1</span>          <span class="mi">3</span><span class="n">h25m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">system</span>     <span class="n">kube</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="n">manager</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">master</span>         <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">6</span>          <span class="mi">3</span><span class="n">h25m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">system</span>     <span class="n">kube</span><span class="o">-</span><span class="n">proxy</span><span class="o">-</span><span class="n">ptd7x</span>                           <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">3</span><span class="n">h25m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">system</span>     <span class="n">kube</span><span class="o">-</span><span class="n">proxy</span><span class="o">-</span><span class="n">t97cs</span>                           <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">45</span><span class="n">m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">system</span>     <span class="n">kube</span><span class="o">-</span><span class="n">scheduler</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">master</span>                  <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">6</span>          <span class="mi">3</span><span class="n">h25m</span>
<span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span>   <span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">-</span><span class="n">fzntf</span>                        <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">6</span><span class="n">m21s</span>

<span class="p">[</span><span class="n">root</span><span class="nd">@k8s</span><span class="o">-</span><span class="n">master</span> <span class="o">~</span><span class="p">]</span><span class="c1"># kubectl get pod -n nginx-ingress</span>
<span class="n">NAME</span>                  <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">-</span><span class="n">fzntf</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">6</span><span class="n">m37s</span>
</pre></div>
</div>
</div>
<div class="section" id="kubernetes-dashboard">
<h2><a class="toc-backref" href="#id21">安装Kubernetes Dashboard</a><a class="headerlink" href="#kubernetes-dashboard" title="Permalink to this headline">¶</a></h2>
<p><strong>安装</strong></p>
<p>执行如下命令，以安装 Kubernetes Dashboard</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta5/aio/deploy/recommended.yaml

// 可以直接下载
$ wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta8/aio/deploy/recommended.yaml

如果访问不了该 yaml 文件，请使用下面的命令，效果是等价的

::

    kubectl apply -f https://kuboard.cn/install-script/k8s-dashboard/v2.0.0-beta5.yaml
</pre></div>
</div>
<p><strong>访问</strong></p>
<p>Kubernetes Dashboard 当前，只支持使用 Bearer Token登录。 由于 Kubernetes
Dashboard 默认部署时，只配置了最低权限的 RBAC。因此，我们要创建一个名为
<code class="docutils literal notranslate"><span class="pre">admin-user</span></code> 的 ServiceAccount，再创建一个
ClusterRolebinding，将其绑定到 Kubernetes 集群中默认初始化的
<code class="docutils literal notranslate"><span class="pre">cluster-admin</span></code> 这个 ClusterRole。</p>
<p>执行如下命令可创建 ServiceAccount 和 ClusterRoleBinding</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">kuboard</span><span class="o">.</span><span class="n">cn</span><span class="o">/</span><span class="n">install</span><span class="o">-</span><span class="n">script</span><span class="o">/</span><span class="n">k8s</span><span class="o">-</span><span class="n">dashboard</span><span class="o">/</span><span class="n">auth</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>获取Bearer Token</p>
<p>执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep admin-user | awk &#39;{print $1}&#39;)
</pre></div>
</div>
<p>因为Service是ClusterIP类型，为了方便使用，我们可通过<code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">--namespace=kubernetes-dashboard</span> <span class="pre">edit</span> <span class="pre">service</span> <span class="pre">kubernetes-dashboard</span></code>修改成NodePort类型</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spec</span><span class="p">:</span>
  <span class="n">clusterIP</span><span class="p">:</span> <span class="mf">10.96</span><span class="o">.</span><span class="mf">187.186</span>
  <span class="n">externalTrafficPolicy</span><span class="p">:</span> <span class="n">Cluster</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">nodePort</span><span class="p">:</span> <span class="mi">31966</span>
    <span class="n">port</span><span class="p">:</span> <span class="mi">443</span>
    <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
    <span class="n">targetPort</span><span class="p">:</span> <span class="mi">8443</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">k8s</span><span class="o">-</span><span class="n">app</span><span class="p">:</span> <span class="n">kubernetes</span><span class="o">-</span><span class="n">dashboard</span>
  <span class="n">sessionAffinity</span><span class="p">:</span> <span class="kc">None</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">NodePort</span>        <span class="o">//</span><span class="n">修改这里</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@k8s</span><span class="o">-</span><span class="n">master</span> <span class="o">~</span><span class="p">]</span><span class="c1"># kubectl get service -n kubernetes-dashboard</span>
<span class="n">NAME</span>                        <span class="n">TYPE</span>        <span class="n">CLUSTER</span><span class="o">-</span><span class="n">IP</span>      <span class="n">EXTERNAL</span><span class="o">-</span><span class="n">IP</span>   <span class="n">PORT</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>         <span class="n">AGE</span>
<span class="n">dashboard</span><span class="o">-</span><span class="n">metrics</span><span class="o">-</span><span class="n">scraper</span>   <span class="n">ClusterIP</span>   <span class="mf">10.96</span><span class="o">.</span><span class="mf">205.156</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>        <span class="mi">8000</span><span class="o">/</span><span class="n">TCP</span>        <span class="mi">70</span><span class="n">m</span>
<span class="n">kubernetes</span><span class="o">-</span><span class="n">dashboard</span>        <span class="n">NodePort</span>    <span class="mf">10.96</span><span class="o">.</span><span class="mf">187.186</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>        <span class="mi">443</span><span class="p">:</span><span class="mi">31966</span><span class="o">/</span><span class="n">TCP</span>   <span class="mi">70</span><span class="n">m</span>
</pre></div>
</div>
<p>使用 Firefox 浏览器访问，并忽略 HTTPS 校验错误。</p>
<div class="figure">
<img alt="" src="../_images/k8s-dashborad0001.png" />
</div>
<p>给匿名用户授权</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl create clusterrolebinding test:anonymous --clusterrole=cluster-admin --user=system:anonymous
</pre></div>
</div>
</div>
<div class="section" id="kuboard-kubernetes">
<h2><a class="toc-backref" href="#id22">安装Kuboard Kubernetes</a><a class="headerlink" href="#kuboard-kubernetes" title="Permalink to this headline">¶</a></h2>
<p>Kubernetes 容器编排已越来越被大家关注，然而使用 Kubernetes
的门槛却依然很高，主要体现在这几个方面：</p>
<ul class="simple">
<li>集群的安装复杂，出错概率大</li>
<li>Kubernetes相较于容器化，引入了许多新的概念，学习难度高</li>
<li>需要手工编写 YAML 文件，难以在多环境下管理</li>
<li>缺少好的实战案例可以参考</li>
</ul>
<p>Kuboard，是一款免费的 Kubernetes 图形化管理工具，Kuboard
力图帮助用户快速在 Kubernetes 上落地微服务。</p>
<p>参考文献：</p>
<p><a class="reference external" href="https://www.cnblogs.com/xiao987334176/p/12060855.html">https://www.cnblogs.com/xiao987334176/p/12060855.html</a></p>
</div>
<div class="section" id="id5">
<h2><a class="toc-backref" href="#id23">诊断分析</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id6">
<h3><a class="toc-backref" href="#id24">1．查看日志</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>（1）使用journalctl查看服务日志</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@k8s</span><span class="o">-</span><span class="n">master</span> <span class="n">manifests</span><span class="p">]</span><span class="c1"># journalctl -u docker</span>
</pre></div>
</div>
<p>查看并追踪kubelet的日志：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">journalctl</span> <span class="o">-</span><span class="n">u</span> <span class="n">kubelet</span> <span class="o">-</span><span class="n">f</span>
</pre></div>
</div>
<p>（2）使用“kubectl logs”查看容器日志</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">logs</span> <span class="o">-</span><span class="n">f</span> <span class="n">etcd</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">master</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h3><a class="toc-backref" href="#id25">2．查看资源详情和事件</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>kubectl
describe命令用于查看一个或多个资源的详细情况，包括相关资源和事件，语法如下：</p>
<p>（1）查看节点</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">describe</span> <span class="n">nodes</span> <span class="n">k8s</span><span class="o">-</span><span class="n">master</span>
</pre></div>
</div>
<p>查看所有节点：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">describe</span> <span class="n">nodes</span>
</pre></div>
</div>
<p>查看指定节点以及事件：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">describe</span> <span class="n">nodes</span> <span class="n">k8s</span><span class="o">-</span><span class="n">node01</span> <span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">events</span>
</pre></div>
</div>
<p>2）查看Pod查看指定Pod：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">describe</span> <span class="n">pod</span> <span class="n">calico</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">j4g9n</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
</pre></div>
</div>
<p>查看指定文件描述的所有资源：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">describe</span> <span class="o">-</span><span class="n">f</span> <span class="n">teamcity</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id8">
<h2><a class="toc-backref" href="#id26">参考文献</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://www.cnblogs.com/yangxiaochu/p/10683951.html">kubeadm安装k8s
1.13版本</a></p>
<p><a class="reference external" href="https://blog.csdn.net/happyworld1/article/details/106383464/">ubuntu18.04 kubeadm 安装kubernetes
v1.18.3</a></p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="02.Kubespray部署k8s.html" class="btn btn-neutral float-right" title="Kubespray部署k8s" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="02.Kubernetes实战指南" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2019, huxiaojian

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>