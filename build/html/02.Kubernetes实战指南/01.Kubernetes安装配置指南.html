<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kubernetes安装配置指南 &mdash; 运维开发修炼之路</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Kubespray部署k8s" href="02.Kubespray%E9%83%A8%E7%BD%B2k8s.html" />
    <link rel="prev" title="02.Kubernetes实战指南" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> 小健_Docker_K8s_Blog
            <img src="../_static/docker-k8s.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../01.Docker%E6%8A%80%E6%9C%AF%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E6%88%983%E7%89%88/index.html">01.Docker技术入门与实战3版</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">02.Kubernetes实战指南</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Kubernetes安装配置指南</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">1.软件和硬件的系统要求如表</a></li>
<li class="toctree-l3"><a class="reference internal" href="#kubeadmkubernetes">2.kubeadm快速安装kubernetes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#master">2.1 单Master节点部署参考</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">2.2 安装Kubernetes高可用</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id3">3. Kubeadm部署kubernetes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id4">3.1 基本环境配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">3.2 部署步骤</a></li>
<li class="toctree-l4"><a class="reference internal" href="#masterkubeadm">3.3 Master初始化kubeadm</a></li>
<li class="toctree-l4"><a class="reference internal" href="#node">3.4 node加入集群</a></li>
<li class="toctree-l4"><a class="reference internal" href="#join">3.5 获得 join命令参数</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">3.6 查看部署状态</a></li>
<li class="toctree-l4"><a class="reference internal" href="#calico">3.7 calico网络插件</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ingress-controller">3.8 Ingress Controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="#metrics-server">3.9 Metrics-Server部署</a></li>
<li class="toctree-l4"><a class="reference internal" href="#kubernetes-dashboard">3.10 Kubernetes Dashboard</a></li>
<li class="toctree-l4"><a class="reference internal" href="#kuboard-kubernetes">3.11 Kuboard Kubernetes</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#kubectl">4 kubectl管理工具</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id8">4.1 kubectl管理工具远程连接集群</a></li>
<li class="toctree-l4"><a class="reference internal" href="#kubercthelm">4.2 在kuberct基础上安装helm</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">4.3 kubectl命令补全</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id10">5. 诊断分析</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id11">5.1 查看日志</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">5.2 查看资源详情和事件</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#kubernetes-v1-19-0">6. Kubernetes v1.19.0 高可用安装部署</a></li>
<li class="toctree-l3"><a class="reference internal" href="#nodenode">7. 移除node和重新加入node</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id13">8. 手动管理Node资源与节点</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id14">8.1 节点维护和设置污点操作</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id15">9.集群扩容及缩容</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id16">集群缩容</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id17">参考文献</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="02.Kubespray%E9%83%A8%E7%BD%B2k8s.html">Kubespray部署k8s</a></li>
<li class="toctree-l2"><a class="reference internal" href="03.Docker%E5%9F%BA%E7%A1%80.html">Docker基础</a></li>
<li class="toctree-l2"><a class="reference internal" href="04.Kubernetes%E5%9F%BA%E7%A1%80.html">Kubernetes基础</a></li>
<li class="toctree-l2"><a class="reference internal" href="05.Kubernetes%E7%9A%84%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1.html">Kubernetes的资源对象</a></li>
<li class="toctree-l2"><a class="reference internal" href="06.Serveice.html">Serveice</a></li>
<li class="toctree-l2"><a class="reference internal" href="07.Ingress.html">Ingress</a></li>
<li class="toctree-l2"><a class="reference internal" href="08.Kubernetest%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86.html">Kubernetest数据管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="09.kubernetes%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B.html">Kubernetes实战案例</a></li>
<li class="toctree-l2"><a class="reference internal" href="10.Kubernetes%E7%9B%91%E6%8E%A7.html">Kubernetes监控</a></li>
<li class="toctree-l2"><a class="reference internal" href="11.%E9%9B%86%E7%BE%A4%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F.html">集群日志系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="12.%E4%BD%BF%E7%94%A8EFKLK%E6%90%AD%E5%BB%BAKubernetes%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B7%A5%E5%85%B7%E6%A0%88.html">使用EFKLK搭建Kubernetes日志收集工具栈</a></li>
<li class="toctree-l2"><a class="reference internal" href="13.Kubernetes%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E4%BB%8EDocker%E5%88%87%E6%8D%A2%E6%88%90Containerd.html">Kubernetes容器运行时从Docker切换成Containerd</a></li>
<li class="toctree-l2"><a class="reference internal" href="14.%E6%95%B4%E7%90%86%E5%85%A8%E7%BD%91%E6%9C%80%E5%85%A8K8S%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7-%E5%B9%B3%E5%8F%B0.html">整理全网最全K8S集群管理工具-平台</a></li>
<li class="toctree-l2"><a class="reference internal" href="20.Helm%E7%AE%80%E5%8C%96Kubernetes%E9%83%A8%E7%BD%B2.html">Helm简化Kubernetes部署</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../03.Docker%E7%BB%8F%E5%85%B8%E5%AE%9E%E4%BE%8B/index.html">03.Docker经典实例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04.Prometheus%E7%9B%91%E6%8E%A7%E8%BF%90%E7%BB%B4%E5%AE%9E%E6%88%98/index.html">04.Prometheus监控运维实战</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05.Kubernetes%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E8%B7%B5/index.html">05.Kubernetes入门到实践</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">小健_Docker_K8s_Blog</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">02.Kubernetes实战指南</a> &raquo;</li>
      <li>Kubernetes安装配置指南</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/02.Kubernetes实战指南/01.Kubernetes安装配置指南.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#kubernetes" id="id18">Kubernetes安装配置指南</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id19">1.软件和硬件的系统要求如表</a></p></li>
<li><p><a class="reference internal" href="#kubeadmkubernetes" id="id20">2.kubeadm快速安装kubernetes</a></p>
<ul>
<li><p><a class="reference internal" href="#master" id="id21">2.1 单Master节点部署参考</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id22">2.2 安装Kubernetes高可用</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id3" id="id23">3. Kubeadm部署kubernetes</a></p>
<ul>
<li><p><a class="reference internal" href="#id4" id="id24">3.1 基本环境配置</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id25">3.2 部署步骤</a></p></li>
<li><p><a class="reference internal" href="#masterkubeadm" id="id26">3.3 Master初始化kubeadm</a></p></li>
<li><p><a class="reference internal" href="#node" id="id27">3.4 node加入集群</a></p></li>
<li><p><a class="reference internal" href="#join" id="id28">3.5 获得 join命令参数</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id29">3.6 查看部署状态</a></p></li>
<li><p><a class="reference internal" href="#calico" id="id30">3.7 calico网络插件</a></p></li>
<li><p><a class="reference internal" href="#ingress-controller" id="id31">3.8 Ingress Controller</a></p></li>
<li><p><a class="reference internal" href="#metrics-server" id="id32">3.9 Metrics-Server部署</a></p></li>
<li><p><a class="reference internal" href="#kubernetes-dashboard" id="id33">3.10 Kubernetes Dashboard</a></p></li>
<li><p><a class="reference internal" href="#kuboard-kubernetes" id="id34">3.11 Kuboard Kubernetes</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#kubectl" id="id35">4 kubectl管理工具</a></p>
<ul>
<li><p><a class="reference internal" href="#id8" id="id36">4.1 kubectl管理工具远程连接集群</a></p></li>
<li><p><a class="reference internal" href="#kubercthelm" id="id37">4.2 在kuberct基础上安装helm</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id38">4.3 kubectl命令补全</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id10" id="id39">5. 诊断分析</a></p>
<ul>
<li><p><a class="reference internal" href="#id11" id="id40">5.1 查看日志</a></p></li>
<li><p><a class="reference internal" href="#id12" id="id41">5.2 查看资源详情和事件</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#kubernetes-v1-19-0" id="id42">6. Kubernetes v1.19.0 高可用安装部署</a></p></li>
<li><p><a class="reference internal" href="#nodenode" id="id43">7. 移除node和重新加入node</a></p></li>
<li><p><a class="reference internal" href="#id13" id="id44">8. 手动管理Node资源与节点</a></p>
<ul>
<li><p><a class="reference internal" href="#id14" id="id45">8.1 节点维护和设置污点操作</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id15" id="id46">9.集群扩容及缩容</a></p>
<ul>
<li><p><a class="reference internal" href="#id16" id="id47">集群缩容</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id17" id="id48">参考文献</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="kubernetes">
<h1><a class="toc-backref" href="#id18">Kubernetes安装配置指南</a><a class="headerlink" href="#kubernetes" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>☒ 开源工具安装</p></li>
</ul>
<p><a class="reference external" href="https://github.com/lework/kainstall">https://github.com/lework/kainstall</a></p>
<ul class="simple">
<li><p>☒ ansible工具安装</p></li>
</ul>
<p><a class="reference external" href="https://github.com/easzlab/kubeasz">https://github.com/easzlab/kubeasz</a></p>
<ul class="simple">
<li><p>☒ kuboard教程安装</p></li>
</ul>
<p><a class="reference external" href="https://www.kuboard.cn/install/install-kubernetes.html">https://www.kuboard.cn/install/install-kubernetes.html</a></p>
<p><strong>k8s Kubernetes v1.15 v1.16 v1.17 v1.18 高可用</strong></p>
<blockquote>
<div><p>快速安装 shell</p>
</div></blockquote>
<p><a class="reference external" href="https://www.cnblogs.com/elvi/p/8976305.html">https://www.cnblogs.com/elvi/p/8976305.html</a></p>
<section id="id1">
<h2><a class="toc-backref" href="#id19">1.软件和硬件的系统要求如表</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>至少2台 <strong>2核4G</strong> 的服务器</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># 最低配置
Master：2core和4GB内存
Node：4core和16GB内存


# 推荐配置
Master：4core 16GB内存
Node：根据运行容器数量进行配置
</pre></div>
</div>
<ul class="simple">
<li><p>本文档中，CPU 必须为 x86 架构，暂时未适配 arm 架构的 CPU</p></li>
<li><p>推荐配置CentOS 7.8，Kernel版本要求在3.10及以上</p></li>
</ul>
<p>Kubernetes需要容器运行时（Container Runtime
Interface，CRI）的支持，目前官方支持的容器运行时包括：Docker、Containerd、CRI-O和frakti，推荐版本为Docker
CE 18.09。</p>
<p>而Kubernetes的Master与工作Node之间会有大量的网络通信，安全的做法是在防火墙上配置各组件需要相互通信的端口号，在安全的
内部网络环境中可以关闭防火墙服务：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">disable</span> <span class="n">firewalld</span>
<span class="n">systemctl</span> <span class="n">stop</span> <span class="n">firewalld</span>
</pre></div>
</div>
<p>另外，建议在主机上禁用SELinux，让容器可以读取主机文件系统：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">setenforce</span> <span class="mi">0</span>
</pre></div>
</div>
<p>或修改系统文件/etc/sysconfig/selinux，将SELINUX=enforcing修改成SELINUX=disabled，然后重启Linux。</p>
</section>
<section id="kubeadmkubernetes">
<h2><a class="toc-backref" href="#id20">2.kubeadm快速安装kubernetes</a><a class="headerlink" href="#kubeadmkubernetes" title="Permalink to this headline">¶</a></h2>
<section id="master">
<h3><a class="toc-backref" href="#id21">2.1 单Master节点部署参考</a><a class="headerlink" href="#master" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://www.kuboard.cn/install/install-k8s.html#%E6%96%87%E6%A1%A3%E7%89%B9%E7%82%B9">https://www.kuboard.cn/install/install-k8s.html#%E6%96%87%E6%A1%A3%E7%89%B9%E7%82%B9</a></p>
<p><strong>kubeadm 快速安装kubernetes 1.20.4单机版</strong></p>
<p><a class="reference external" href="https://sre.ink/kubeadm-%e5%bf%ab%e9%80%9f%e5%ae%89%e8%a3%85kubernetes-1-20-4%e5%8d%95%e6%9c%ba%e7%89%88/">https://sre.ink/kubeadm-%e5%bf%ab%e9%80%9f%e5%ae%89%e8%a3%85kubernetes-1-20-4%e5%8d%95%e6%9c%ba%e7%89%88/</a></p>
</section>
<section id="id2">
<h3><a class="toc-backref" href="#id22">2.2 安装Kubernetes高可用</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://www.kuboard.cn/install/install-kubernetes.html#%E4%BB%8B%E7%BB%8D">https://www.kuboard.cn/install/install-kubernetes.html#%E4%BB%8B%E7%BB%8D</a></p>
</section>
</section>
<section id="id3">
<h2><a class="toc-backref" href="#id23">3. Kubeadm部署kubernetes</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>公司大部分线下测试环境均采用Kubeadm安装，这也是目前官方默认的安装方式，比二进制安装方式更加简单，可以让初学者快速上手并测试。目前GitHub上也有很多基于Ansible的自动化安装方式，但是为了更好地学习Kubernetes，还是建议体验一下Kubernetes的手动安装过程，以熟悉Kubernetes的各个组件。</p>
<section id="id4">
<h3><a class="toc-backref" href="#id24">3.1 基本环境配置</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<table class="docutils align-default">
<colgroup>
<col style="width: 30%" />
<col style="width: 39%" />
<col style="width: 30%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>主机名</p></th>
<th class="head"><p>IP地址</p></th>
<th class="head"><p>说明</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>k8s-master</p></td>
<td><p>172.16.60.236</p></td>
<td><p>k8s-master</p></td>
</tr>
<tr class="row-odd"><td><p>k8s-node1</p></td>
<td><p>172.16.60.178</p></td>
<td><p>k8s-node1</p></td>
</tr>
<tr class="row-even"><td><p>k8s-node2</p></td>
<td><p>172.16.60.226</p></td>
<td><p>k8s-node2</p></td>
</tr>
<tr class="row-odd"><td><p>k8s-node3</p></td>
<td><p>172.16.60.9</p></td>
<td><p>k8s-node3</p></td>
</tr>
</tbody>
</table>
</section>
<section id="id5">
<h3><a class="toc-backref" href="#id25">3.2 部署步骤</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>以下不做特殊说明默认所有机器都执行</p>
</div></blockquote>
<section id="id6">
<h4>准备工作<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<p>各节点通信采用主机名的方式，这种方式与IP地址相比较更具有扩展性。以下介绍具体的安装步骤。所有节点配置hosts，修改/etc/hosts如下：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 更新系统和软件包</span>
yum update

<span class="c1"># 设置主机名(master node 名字分开)</span>
hostnamectl set-hostname k8s-master

<span class="c1"># 同步时间</span>
systemctl restart chronyd

<span class="c1"># 添加host</span>
<span class="c1"># 以下ip是所有机器的内网ip</span>
cat &gt;&gt; /etc/hosts <span class="s">&lt;&lt;&#39;EOF&#39;</span>
<span class="s">172.16.60.236   k8s-master</span>
<span class="s">172.16.60.178   k8s-node1</span>
<span class="s">172.16.60.226   k8s-node2</span>
<span class="s">172.16.60.9     k8s-node3</span>
<span class="s">EOF</span>

cat &gt;&gt;/etc/resolv.conf <span class="s">&lt;&lt;&#39;EOF&#39;</span>
<span class="s">nameserver 8.8.8.8</span>
<span class="s">EOF</span>

<span class="c1"># 设置所有机器间无密码访问</span>
ssh-keygen -t rsa
<span class="k">for</span> i <span class="k">in</span> k8s-master k8s-node1 k8s-node2 k8s-node3<span class="p">;</span><span class="k">do</span> ssh-copy-id -i /root/.ssh/id_rsa.pub <span class="nv">$i</span><span class="p">;</span><span class="k">done</span>


<span class="c1"># 关闭防火墙和iptables</span>
systemctl stop firewalld.service
systemctl disable firewalld.service
systemctl stop iptables.service
systemctl disable iptables.service

<span class="c1"># 关闭SELinux</span>
setenforce <span class="m">0</span>
sed -i <span class="s2">&quot;s/SELINUX=enforcing/SELINUX=disabled/g&quot;</span> /etc/selinux/config

<span class="c1"># 关闭swap</span>
swapoff -a <span class="o">&amp;&amp;</span> sysctl -w vm.swappiness<span class="o">=</span><span class="m">0</span>
sed -i <span class="s1">&#39;/ swap / s/^\(.*\)$/#\1/g&#39;</span> /etc/fstab
</pre></div>
</div>
<p>注释swap挂载选项：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># grep &quot;swap&quot; /etc/fstab</span>
<span class="c1">#UUID=a5ace1f8-ddcd-434d-afef-b5a73c7ef8e8 swap                    swap    defaults        0 0</span>
</pre></div>
</div>
<p>所有节点同步时间。所有节点同步时间是必须的，并且需要加到开机自启动和计划任务中，如果节点时间不同步，会造成Etcd存储Kubernetes信息的键－值（key-value）数据库同步数据不正常，也会造成证书出现问题。时间同步配置如下：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>yum -y install ntp
ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
<span class="nb">echo</span> <span class="s2">&quot;Asia/Shanghai&quot;</span> &gt; /etc/timezone
ntpdate time2.aliyun.com
<span class="c1"># 加入计划任务</span>
crontab -l
*/5 * * * * ntpdate time2.aliyun.com

<span class="c1"># 加入开机自启动</span>
cat /etc/rc.local
ntpdate time2.aliyun.com


<span class="c1"># 将桥接的IPv4流量传递到iptables的链</span>
cat &gt; /etc/sysctl.d/k8s.conf <span class="s">&lt;&lt; EOF</span>
<span class="s">net.bridge.bridge-nf-call-ip6tables = 1</span>
<span class="s">net.bridge.bridge-nf-call-iptables = 1</span>
<span class="s">EOF</span>
sysctl --system  <span class="c1"># 生效</span>
</pre></div>
</div>
<p>所有节点配置limit：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ulimit</span> <span class="o">-</span><span class="n">SHn</span> <span class="mi">65535</span>
</pre></div>
</div>
<p>所有节点都配置国内仓库源</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>wget -O CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo

wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
</pre></div>
</div>
<section id="ipvs">
<h5>加载 ipvs 内核模块<a class="headerlink" href="#ipvs" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><p>安装 IPVS 模块</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>yum -y install ipvsadm ipset sysstat conntrack libseccomp
</pre></div>
</div>
<ul class="simple">
<li><p>设置开机加载配置文件</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>cat &gt;&gt;/etc/modules-load.d/ipvs.conf<span class="s">&lt;&lt;EOF</span>
<span class="s">ip_vs_dh</span>
<span class="s">ip_vs_ftp</span>
<span class="s">ip_vs</span>
<span class="s">ip_vs_lblc</span>
<span class="s">ip_vs_lblcr</span>
<span class="s">ip_vs_lc</span>
<span class="s">ip_vs_nq</span>
<span class="s">ip_vs_pe_sip</span>
<span class="s">ip_vs_rr</span>
<span class="s">ip_vs_sed</span>
<span class="s">ip_vs_sh</span>
<span class="s">ip_vs_wlc</span>
<span class="s">ip_vs_wrr</span>
<span class="s">nf_conntrack_ipv4</span>
<span class="s">EOF</span>
</pre></div>
</div>
<ul class="simple">
<li><p>设置开机加载 IPVS 模块</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 设置开机加载内核模块</span>
systemctl <span class="nb">enable</span> systemd-modules-load.service

<span class="c1"># 重启后检查 ipvs 模块是否加载</span>
lsmod <span class="p">|</span> grep -e ip_vs -e nf_conntrack_ipv4
</pre></div>
</div>
<ul class="simple">
<li><p>如果集群已经部署在了 iptables 模式下，可以通过下面命令修改，修改 mode
为 ipvs 重启集群即可。</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">edit</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="n">configmap</span> <span class="n">kube</span><span class="o">-</span><span class="n">proxy</span>
</pre></div>
</div>
</section>
<section id="docker">
<h5>安装docker<a class="headerlink" href="#docker" title="Permalink to this headline">¶</a></h5>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># master执行以下转到repo目录</span>
<span class="nb">cd</span> /etc/yum.repos.d/

<span class="c1"># master执行下载docker阿里云镜像</span>
wget http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

<span class="c1"># master同步到其他服务器</span>
<span class="o">[</span>root@k8s-master yum.repos.d<span class="o">]</span><span class="c1"># for i in k8s-master k8s-node1 k8s-node2 k8s-node3;do scp docker-ce.repo $i:/etc/yum.repos.d/;done</span>
docker-ce.repo                                                                                                             <span class="m">100</span>% <span class="m">2640</span>   <span class="m">162</span>.5KB/s   <span class="m">00</span>:00
docker-ce.repo                                                                                                             <span class="m">100</span>% <span class="m">2640</span>     <span class="m">3</span>.5MB/s   <span class="m">00</span>:00
docker-ce.repo                                                                                                             <span class="m">100</span>% <span class="m">2640</span>     <span class="m">3</span>.7MB/s   <span class="m">00</span>:00


<span class="c1"># 安装docker(各个都要装)</span>
yum -y install docker-ce

<span class="c1"># 修改配置</span>
nano /usr/lib/systemd/system/docker.service

<span class="c1"># master增加一行如下</span>
<span class="nv">ExecStartPost</span><span class="o">=</span>/usr/sbin/iptables -P FORWARD ACCEPT

<span class="c1"># 配置阿里云镜像加速</span>
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <span class="s">&lt;&lt;-&#39;EOF&#39;</span>
<span class="s">{</span>
<span class="s">  &quot;registry-mirrors&quot;: [&quot;https://25bxwt20.mirror.aliyuncs.com&quot;]</span>
<span class="s">}</span>
<span class="s">EOF</span>

<span class="c1"># 重启docker</span>
sudo systemctl daemon-reload
sudo systemctl restart docker
systemctl <span class="nb">enable</span> docker
systemctl restart docker
</pre></div>
</div>
</section>
<section id="kubeadm-kubectl-kubelet">
<h5>安装kubeadm, kubectl, kubelet<a class="headerlink" href="#kubeadm-kubectl-kubelet" title="Permalink to this headline">¶</a></h5>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># master执行以下</span>
cat &gt;&gt; /etc/yum.repos.d/kubernetes.repo <span class="s">&lt;&lt;&#39;EOF&#39;</span>
<span class="s">[kubernetes]</span>
<span class="s">name=Kubernetes Repository</span>
<span class="s">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span>
<span class="s">gpgcheck=1</span>
<span class="s">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span>
<span class="s">EOF</span>

<span class="c1"># master检查仓库</span>
yum repolist
yum list all <span class="p">|</span> grep <span class="s2">&quot;^kube&quot;</span>

<span class="c1"># master执行安装</span>
yum install kubeadm kubelet kubectl -y

<span class="c1"># 检查安装</span>
rpm -ql kubectl
rpm -ql kubeadm

<span class="c1"># master上把仓库拷贝过去</span>
<span class="nb">cd</span> /etc/yum.repos.d/
<span class="k">for</span> i <span class="k">in</span> k8s-master k8s-node1 k8s-node2 k8s-node3<span class="p">;</span><span class="k">do</span> scp  kubernetes.repo <span class="nv">$i</span>:/etc/yum.repos.d/


<span class="c1"># 所有node安装kubelet kubeadm</span>
yum install kubelet kubeadm -y

<span class="c1"># master和node执行以下</span>
systemctl <span class="nb">enable</span> kubelet.service

<span class="c1"># master查看所需的镜像</span>
kubeadm config images list

<span class="c1"># 所有机器都执行以下的拉取镜像的操作</span>
<span class="c1"># 由于kubeadm依赖国外的k8s.gcr.io的镜像，国内被墙所以这边的解决方案是下载国内的镜像重新打tag的方式</span>
cat &gt; images_pull_k8s.sh <span class="s">&lt;&lt;&#39;EOF&#39;</span>
<span class="s">#!/bin/bash</span>
<span class="s">k8s_Version=&quot;v1.18.3&quot;</span>

<span class="s">images=(</span>
<span class="s">    # 下面的镜像应该去除&quot;k8s.gcr.io/&quot;的前缀</span>
<span class="s">    kube-apiserver:${k8s_Version}</span>
<span class="s">    kube-controller-manager:${k8s_Version}</span>
<span class="s">    kube-scheduler:${k8s_Version}</span>
<span class="s">    kube-proxy:${k8s_Version}</span>
<span class="s">    pause:3.2</span>
<span class="s">    etcd:3.4.3-0</span>
<span class="s">    coredns:1.6.7</span>
<span class="s">)</span>

<span class="s">for imageName in ${images[@]} ; do</span>
<span class="s">    docker pull mirrorgcrio/$imageName</span>
<span class="s">    docker tag mirrorgcrio/$imageName k8s.gcr.io/$imageName</span>
<span class="s">    docker rmi mirrorgcrio/$imageName</span>
<span class="s">done</span>
<span class="s">EOF</span>

chmod <span class="m">755</span> images_pull_k8s.sh
./images_pull_k8s.sh
</pre></div>
</div>
<p>或者直接手动拉取镜像</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>docker pull mirrorgcrio/kube-apiserver:v1.18.3
docker pull mirrorgcrio/kube-controller-manager:v1.18.3
docker pull mirrorgcrio/kube-scheduler:v1.18.3
docker pull mirrorgcrio/kube-proxy:v1.18.3
docker pull mirrorgcrio/pause:3.2
docker pull mirrorgcrio/etcd:3.4.3-0
docker pull mirrorgcrio/coredns:1.6.7

docker tag mirrorgcrio/kube-apiserver:v1.18.3 k8s.gcr.io/kube-apiserver:v1.18.3
docker tag mirrorgcrio/kube-controller-manager:v1.18.3 k8s.gcr.io/kube-controller-manager:v1.18.3
docker tag mirrorgcrio/kube-scheduler:v1.18.3 k8s.gcr.io/kube-scheduler:v1.18.3
docker tag mirrorgcrio/kube-proxy:v1.18.3 k8s.gcr.io/kube-proxy:v1.18.3
docker tag mirrorgcrio/pause:3.2 k8s.gcr.io/pause:3.2
docker tag mirrorgcrio/etcd:3.4.3-0 k8s.gcr.io/etcd:3.4.3-0
docker tag mirrorgcrio/coredns:1.6.7 k8s.gcr.io/coredns:1.6.7

docker image rm mirrorgcrio/kube-apiserver:v1.18.3
docker image rm mirrorgcrio/kube-controller-manager:v1.18.3
docker image rm mirrorgcrio/kube-scheduler:v1.18.3
docker image rm mirrorgcrio/kube-proxy:v1.18.3
docker image rm mirrorgcrio/pause:3.2
docker image rm mirrorgcrio/etcd:3.4.3-0
docker image rm mirrorgcrio/coredns:1.6.7
</pre></div>
</div>
</section>
</section>
</section>
<section id="masterkubeadm">
<h3><a class="toc-backref" href="#id26">3.3 Master初始化kubeadm</a><a class="headerlink" href="#masterkubeadm" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>本小节的所有的操作，只在 Master 节点上进行</p>
</div></blockquote>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># master执行init初始化</span>
kubeadm init <span class="se">\</span>
--kubernetes-version<span class="o">=</span><span class="s2">&quot;v1.18.3&quot;</span> <span class="se">\</span>
--pod-network-cidr<span class="o">=</span><span class="s2">&quot;10.244.0.0/16&quot;</span> <span class="se">\</span>
--ignore-preflight-errors<span class="o">=</span><span class="s2">&quot;NumCPU&quot;</span>

<span class="c1"># 在当前用户家目录下创建.kube目录并配置访问集群的config 文件</span>
mkdir -p <span class="nv">$HOME</span>/.kube
sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config

<span class="c1"># 应用网络插件flannle</span>
<span class="o">[</span>root@k8s-master home<span class="o">]</span><span class="c1"># kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span>

<span class="c1"># 查看 kube-system 命名空间中运行的 pods</span>
kubectl get pods -n kube-system

<span class="c1"># 查看 k8s 集群组件的状态</span>
kubectl get ComponentStatus


<span class="c1"># 配置命令补全</span>
yum install -y bash-completion
<span class="nb">source</span> /usr/share/bash-completion/bash_completion
<span class="nb">source</span> &lt;<span class="o">(</span>kubectl completion bash<span class="o">)</span>
<span class="nb">echo</span> <span class="s2">&quot;source &lt;(kubectl completion bash)&quot;</span> &gt;&gt; ~/.bashrc
</pre></div>
</div>
</section>
<section id="node">
<h3><a class="toc-backref" href="#id27">3.4 node加入集群</a><a class="headerlink" href="#node" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@k8s-node1 home<span class="o">]</span><span class="c1"># kubeadm join 172.16.60.236:6443 --token 950v9y.z3lz25askvjw33ou \</span>
&gt;     --discovery-token-ca-cert-hash sha256:e84f8923f43878b530c6d5879c258ccdd5caec1d02ee8d89d1d75b9bdf4d753e
......
Run <span class="s1">&#39;kubectl get nodes&#39;</span> on the control-plane to see this node join the cluster
</pre></div>
</div>
<ul class="simple">
<li><p>如果初始化过程被中断可以使用下面命令来恢复</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubeadm</span> <span class="n">reset</span>
</pre></div>
</div>
<ul class="simple">
<li><p>下面是最后执行成功显示的结果，需要保存这个执行结果，以让 node
节点加入集群</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

You should now deploy a pod network to the cluster.
Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 172.16.100.9:6443 --token 2dyd69.hrfsjkkxs4stim7n \
    --discovery-token-ca-cert-hash sha256:4e30c1f41aefb177b708a404ccb7e818e31647c7dbdd2d42f6c5c9894b6f41e7
</pre></div>
</div>
</section>
<section id="join">
<h3><a class="toc-backref" href="#id28">3.5 获得 join命令参数</a><a class="headerlink" href="#join" title="Permalink to this headline">¶</a></h3>
<p><strong>在 master 节点上执行</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># 只在 master 节点执行
kubeadm token create --print-join-command


 如果已经忘记kubeadm join参数，可以在Master节点中用如下命令查询
$ kubeadm token create --print-join-command


可获取kubeadm join 命令及参数，如下所示

# kubeadm token create 命令的输出
kubeadm join apiserver.demo:6443 --token mpfjma.4vjjg8flqihor4vt     --discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303
</pre></div>
</div>
<blockquote>
<div><p>有效时间</p>
<p>该 token 的有效时间为 2 个小时，2小时内，您可以使用此 token
初始化任意数量的 worker 节点。</p>
</div></blockquote>
</section>
<section id="id7">
<h3><a class="toc-backref" href="#id29">3.6 查看部署状态</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># master查看node节点状态</span>
kubectl get nodes

<span class="c1"># master查看kube-system命名空间下的pod启动的状态</span>
kubectl get po -n kube-system

<span class="c1"># 如果有pod一直启动不起来，通过describe查看状态</span>
kubectl describe po/<span class="o">{</span>具体的pod名字<span class="o">}</span> -n kube-system
</pre></div>
</div>
</section>
<section id="calico">
<h3><a class="toc-backref" href="#id30">3.7 calico网络插件</a><a class="headerlink" href="#calico" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Kubernetes 容器组所在的网段，该网段安装完成后，由 kubernetes 创建，事先并不存在于您的物理网络中</span>
<span class="n">export</span> <span class="n">POD_SUBNET</span><span class="o">=</span><span class="mf">10.100</span><span class="o">.</span><span class="mf">0.1</span><span class="o">/</span><span class="mi">16</span>

<span class="c1"># 参考文档 https://docs.projectcalico.org/v3.9/getting-started/kubernetes/</span>
<span class="n">rm</span> <span class="o">-</span><span class="n">f</span> <span class="n">calico</span><span class="o">-</span><span class="mf">3.9</span><span class="o">.</span><span class="mf">2.</span><span class="n">yaml</span>
<span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">kuboard</span><span class="o">.</span><span class="n">cn</span><span class="o">/</span><span class="n">install</span><span class="o">-</span><span class="n">script</span><span class="o">/</span><span class="n">calico</span><span class="o">/</span><span class="n">calico</span><span class="o">-</span><span class="mf">3.9</span><span class="o">.</span><span class="mf">2.</span><span class="n">yaml</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s2">&quot;s#192\.168\.0\.0/16#$</span><span class="si">{POD_SUBNET}</span><span class="s2">#&quot;</span> <span class="n">calico</span><span class="o">-</span><span class="mf">3.9</span><span class="o">.</span><span class="mf">2.</span><span class="n">yaml</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">calico</span><span class="o">-</span><span class="mf">3.9</span><span class="o">.</span><span class="mf">2.</span><span class="n">yaml</span>

<span class="n">或者如下方式</span>
<span class="c1"># https://kubernetes.io/docs/concepts/cluster-administration/addons/</span>
<span class="c1"># https://docs.projectcalico.org/getting-started/kubernetes/self-managed-onprem/onpremises</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">docs</span><span class="o">.</span><span class="n">projectcalico</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">manifests</span><span class="o">/</span><span class="n">calico</span><span class="o">.</span><span class="n">yaml</span>
<span class="n">kubectl</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">|</span><span class="n">grep</span> <span class="n">calico</span>
</pre></div>
</div>
<p>最新calico网络插件安装方式</p>
<p><a class="reference external" href="https://www.wqblogs.com/2020/12/14/calico%E9%83%A8%E7%BD%B2/">https://www.wqblogs.com/2020/12/14/calico%E9%83%A8%E7%BD%B2/</a></p>
</section>
<section id="ingress-controller">
<h3><a class="toc-backref" href="#id31">3.8 Ingress Controller</a><a class="headerlink" href="#ingress-controller" title="Permalink to this headline">¶</a></h3>
<p><strong>安装</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 只在 master 节点执行</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">kuboard</span><span class="o">.</span><span class="n">cn</span><span class="o">/</span><span class="n">install</span><span class="o">-</span><span class="n">script</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mf">17.</span><span class="n">x</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">.</span><span class="n">yaml</span>
<span class="n">或者</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">kuboard</span><span class="o">.</span><span class="n">cn</span><span class="o">/</span><span class="n">install</span><span class="o">-</span><span class="n">script</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mf">19.</span><span class="n">x</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p><strong>卸载</strong></p>
<p>只在您想选择其他 Ingress Controller 的情况下卸载</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 只在 master 节点执行</span>
<span class="n">kubectl</span> <span class="n">delete</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">kuboard</span><span class="o">.</span><span class="n">cn</span><span class="o">/</span><span class="n">install</span><span class="o">-</span><span class="n">script</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="mf">19.</span><span class="n">x</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p><strong>定制化ingress</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 如果打算用于生产环境，请参考 https://github.com/nginxinc/kubernetes-ingress/blob/v1.5.5/docs/installation.md 并根据您自己的情况做进一步定制</span>
</pre></div>
</div>
<p>查看ingress运行状态</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@k8s</span><span class="o">-</span><span class="n">master</span> <span class="o">~</span><span class="p">]</span><span class="c1"># kubectl get pods --all-namespaces</span>
<span class="n">NAMESPACE</span>       <span class="n">NAME</span>                                       <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">kube</span><span class="o">-</span><span class="n">system</span>     <span class="n">calico</span><span class="o">-</span><span class="n">kube</span><span class="o">-</span><span class="n">controllers</span><span class="o">-</span><span class="mi">6</span><span class="n">c89d944d5</span><span class="o">-</span><span class="n">th2k7</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">3</span><span class="n">h25m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">system</span>     <span class="n">calico</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">j4g9n</span>                          <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">45</span><span class="n">m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">system</span>     <span class="n">calico</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">qt6sk</span>                          <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">3</span><span class="n">h25m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">system</span>     <span class="n">coredns</span><span class="o">-</span><span class="mi">59</span><span class="n">c898cd69</span><span class="o">-</span><span class="mi">2</span><span class="n">tnvl</span>                   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">1</span>          <span class="mi">3</span><span class="n">h25m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">system</span>     <span class="n">coredns</span><span class="o">-</span><span class="mi">59</span><span class="n">c898cd69</span><span class="o">-</span><span class="n">cdxxq</span>                   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">3</span><span class="n">h25m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">system</span>     <span class="n">etcd</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">master</span>                            <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">3</span><span class="n">h25m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">system</span>     <span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">master</span>                  <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">1</span>          <span class="mi">3</span><span class="n">h25m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">system</span>     <span class="n">kube</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="n">manager</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">master</span>         <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">6</span>          <span class="mi">3</span><span class="n">h25m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">system</span>     <span class="n">kube</span><span class="o">-</span><span class="n">proxy</span><span class="o">-</span><span class="n">ptd7x</span>                           <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">3</span><span class="n">h25m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">system</span>     <span class="n">kube</span><span class="o">-</span><span class="n">proxy</span><span class="o">-</span><span class="n">t97cs</span>                           <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">45</span><span class="n">m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">system</span>     <span class="n">kube</span><span class="o">-</span><span class="n">scheduler</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">master</span>                  <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">6</span>          <span class="mi">3</span><span class="n">h25m</span>
<span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span>   <span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">-</span><span class="n">fzntf</span>                        <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">6</span><span class="n">m21s</span>

<span class="p">[</span><span class="n">root</span><span class="nd">@k8s</span><span class="o">-</span><span class="n">master</span> <span class="o">~</span><span class="p">]</span><span class="c1"># kubectl get pod -n nginx-ingress</span>
<span class="n">NAME</span>                  <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">-</span><span class="n">fzntf</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">6</span><span class="n">m37s</span>
</pre></div>
</div>
</section>
<section id="metrics-server">
<h3><a class="toc-backref" href="#id32">3.9 Metrics-Server部署</a><a class="headerlink" href="#metrics-server" title="Permalink to this headline">¶</a></h3>
<p>在新版的Kubernetes中系统资源的采集均使用Metrics-server，可以通过Metrics采集节点和Pod的内存、磁盘、CPU和网络的使用率。</p>
<p>metrics-server是Kubernetes
官方集群资源利用率信息收集器，是Heapster瘦身后的替代品。
收集的是集群内由各个节点上kubelet暴露出来的利用率信息。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span><span class="o">/</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">svc-metrics-server.yaml</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">k8s</span><span class="o">-</span><span class="n">app</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">ports</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">https</span>
      <span class="n">port</span><span class="p">:</span> <span class="mi">443</span>
      <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
      <span class="n">targetPort</span><span class="p">:</span> <span class="mi">4443</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">k8s</span><span class="o">-</span><span class="n">app</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">role-metrics-server.yaml</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">k8s</span><span class="o">-</span><span class="n">app</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">ports</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">https</span>
      <span class="n">port</span><span class="p">:</span> <span class="mi">443</span>
      <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
      <span class="n">targetPort</span><span class="p">:</span> <span class="mi">4443</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">k8s</span><span class="o">-</span><span class="n">app</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@k8smaster1</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span><span class="p">]</span><span class="c1"># ^C</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@k8smaster1</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span><span class="p">]</span><span class="c1"># ^C</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@k8smaster1</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span><span class="p">]</span><span class="c1"># ^C</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@k8smaster1</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span><span class="p">]</span><span class="c1"># cat role-metrics-server.yaml</span>
<span class="o">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">rbac</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ClusterRole</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">k8s</span><span class="o">-</span><span class="n">app</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
    <span class="n">rbac</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">aggregate</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">admin</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span>
    <span class="n">rbac</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">aggregate</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">edit</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span>
    <span class="n">rbac</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">aggregate</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">view</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span>
  <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;system:aggregated-metrics-reader&#39;</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
<span class="n">rules</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">apiGroups</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">metrics</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span>
    <span class="n">resources</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">pods</span>
      <span class="o">-</span> <span class="n">nodes</span>
    <span class="n">verbs</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">get</span>
      <span class="o">-</span> <span class="nb">list</span>
      <span class="o">-</span> <span class="n">watch</span>

<span class="o">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">rbac</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ClusterRole</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">k8s</span><span class="o">-</span><span class="n">app</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
  <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;system:metrics-server&#39;</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
<span class="n">rules</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">apiGroups</span><span class="p">:</span>
      <span class="o">-</span> <span class="s1">&#39;&#39;</span>
    <span class="n">resources</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">pods</span>
      <span class="o">-</span> <span class="n">nodes</span>
      <span class="o">-</span> <span class="n">nodes</span><span class="o">/</span><span class="n">stats</span>
      <span class="o">-</span> <span class="n">namespaces</span>
      <span class="o">-</span> <span class="n">configmaps</span>
    <span class="n">verbs</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">get</span>
      <span class="o">-</span> <span class="nb">list</span>
      <span class="o">-</span> <span class="n">watch</span>

<span class="o">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">rbac</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ClusterRoleBinding</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">k8s</span><span class="o">-</span><span class="n">app</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
  <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;metrics-server:system:auth-delegator&#39;</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
<span class="n">roleRef</span><span class="p">:</span>
  <span class="n">apiGroup</span><span class="p">:</span> <span class="n">rbac</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span>
  <span class="n">kind</span><span class="p">:</span> <span class="n">ClusterRole</span>
  <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;system:auth-delegator&#39;</span>
<span class="n">subjects</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">kind</span><span class="p">:</span> <span class="n">ServiceAccount</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
    <span class="n">namespace</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>

<span class="o">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">rbac</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ClusterRoleBinding</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">k8s</span><span class="o">-</span><span class="n">app</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
  <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;system:metrics-server&#39;</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
<span class="n">roleRef</span><span class="p">:</span>
  <span class="n">apiGroup</span><span class="p">:</span> <span class="n">rbac</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span>
  <span class="n">kind</span><span class="p">:</span> <span class="n">ClusterRole</span>
  <span class="n">name</span><span class="p">:</span> <span class="s1">&#39;system:metrics-server&#39;</span>
<span class="n">subjects</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">kind</span><span class="p">:</span> <span class="n">ServiceAccount</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
    <span class="n">namespace</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>

<span class="o">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">rbac</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">RoleBinding</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">k8s</span><span class="o">-</span><span class="n">app</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">auth</span><span class="o">-</span><span class="n">reader</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
<span class="n">roleRef</span><span class="p">:</span>
  <span class="n">apiGroup</span><span class="p">:</span> <span class="n">rbac</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span>
  <span class="n">kind</span><span class="p">:</span> <span class="n">Role</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">extension</span><span class="o">-</span><span class="n">apiserver</span><span class="o">-</span><span class="n">authentication</span><span class="o">-</span><span class="n">reader</span>
<span class="n">subjects</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">kind</span><span class="p">:</span> <span class="n">ServiceAccount</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
    <span class="n">namespace</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>

<span class="o">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ServiceAccount</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">k8s</span><span class="o">-</span><span class="n">app</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>

<span class="o">---</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">deployment-api-metrics-server.yaml</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">apiregistration</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">APIService</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">k8s</span><span class="o">-</span><span class="n">app</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">v1beta1</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">group</span><span class="p">:</span> <span class="n">metrics</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span>
  <span class="n">groupPriorityMinimum</span><span class="p">:</span> <span class="mi">100</span>
  <span class="n">insecureSkipTLSVerify</span><span class="p">:</span> <span class="n">true</span>
  <span class="n">service</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
    <span class="n">namespace</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
  <span class="n">version</span><span class="p">:</span> <span class="n">v1beta1</span>
  <span class="n">versionPriority</span><span class="p">:</span> <span class="mi">100</span>

<span class="o">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">k8s</span><span class="o">-</span><span class="n">app</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">k8s</span><span class="o">-</span><span class="n">app</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
  <span class="n">strategy</span><span class="p">:</span>
    <span class="n">rollingUpdate</span><span class="p">:</span>
      <span class="n">maxUnavailable</span><span class="p">:</span> <span class="mi">0</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">k8s</span><span class="o">-</span><span class="n">app</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">containers</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">args</span><span class="p">:</span>
            <span class="o">-</span> <span class="s1">&#39;--cert-dir=/tmp&#39;</span>
            <span class="o">-</span> <span class="s1">&#39;--secure-port=4443&#39;</span>
            <span class="o">-</span> <span class="s1">&#39;--kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname&#39;</span>
            <span class="o">-</span> <span class="s1">&#39;--kubelet-use-node-status-port&#39;</span>
            <span class="o">-</span> <span class="s1">&#39;--kubelet-insecure-tls=true&#39;</span>
          <span class="n">image</span><span class="p">:</span> <span class="o">&gt;-</span>
            <span class="n">swr</span><span class="o">.</span><span class="n">cn</span><span class="o">-</span><span class="n">east</span><span class="o">-</span><span class="mf">2.</span><span class="n">myhuaweicloud</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">kuboard</span><span class="o">-</span><span class="n">dependency</span><span class="o">/</span><span class="n">metrics</span><span class="o">-</span><span class="n">server</span><span class="p">:</span><span class="n">v0</span><span class="o">.</span><span class="mf">4.1</span>
          <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
          <span class="n">livenessProbe</span><span class="p">:</span>
            <span class="n">failureThreshold</span><span class="p">:</span> <span class="mi">3</span>
            <span class="n">httpGet</span><span class="p">:</span>
              <span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">livez</span>
              <span class="n">port</span><span class="p">:</span> <span class="n">https</span>
              <span class="n">scheme</span><span class="p">:</span> <span class="n">HTTPS</span>
            <span class="n">periodSeconds</span><span class="p">:</span> <span class="mi">10</span>
          <span class="n">name</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
          <span class="n">ports</span><span class="p">:</span>
            <span class="o">-</span> <span class="n">containerPort</span><span class="p">:</span> <span class="mi">4443</span>
              <span class="n">name</span><span class="p">:</span> <span class="n">https</span>
              <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
          <span class="n">readinessProbe</span><span class="p">:</span>
            <span class="n">failureThreshold</span><span class="p">:</span> <span class="mi">3</span>
            <span class="n">httpGet</span><span class="p">:</span>
              <span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">readyz</span>
              <span class="n">port</span><span class="p">:</span> <span class="n">https</span>
              <span class="n">scheme</span><span class="p">:</span> <span class="n">HTTPS</span>
            <span class="n">periodSeconds</span><span class="p">:</span> <span class="mi">10</span>
          <span class="n">securityContext</span><span class="p">:</span>
            <span class="n">readOnlyRootFilesystem</span><span class="p">:</span> <span class="n">true</span>
            <span class="n">runAsNonRoot</span><span class="p">:</span> <span class="n">true</span>
            <span class="n">runAsUser</span><span class="p">:</span> <span class="mi">1000</span>
          <span class="n">volumeMounts</span><span class="p">:</span>
            <span class="o">-</span> <span class="n">mountPath</span><span class="p">:</span> <span class="o">/</span><span class="n">tmp</span>
              <span class="n">name</span><span class="p">:</span> <span class="n">tmp</span><span class="o">-</span><span class="nb">dir</span>
      <span class="n">nodeSelector</span><span class="p">:</span>
        <span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">os</span><span class="p">:</span> <span class="n">linux</span>
      <span class="n">priorityClassName</span><span class="p">:</span> <span class="n">system</span><span class="o">-</span><span class="n">cluster</span><span class="o">-</span><span class="n">critical</span>
      <span class="n">serviceAccountName</span><span class="p">:</span> <span class="n">metrics</span><span class="o">-</span><span class="n">server</span>
      <span class="n">volumes</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">emptyDir</span><span class="p">:</span> <span class="p">{}</span>
          <span class="n">name</span><span class="p">:</span> <span class="n">tmp</span><span class="o">-</span><span class="nb">dir</span>
</pre></div>
</div>
</section>
<section id="kubernetes-dashboard">
<h3><a class="toc-backref" href="#id33">3.10 Kubernetes Dashboard</a><a class="headerlink" href="#kubernetes-dashboard" title="Permalink to this headline">¶</a></h3>
<p><strong>安装</strong></p>
<p>执行如下命令，以安装 Kubernetes Dashboard</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta5/aio/deploy/recommended.yaml

// 可以直接下载
$ wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta8/aio/deploy/recommended.yaml
</pre></div>
</div>
<p>如果访问不了该 yaml 文件，请使用下面的命令，效果是等价的</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">kuboard</span><span class="o">.</span><span class="n">cn</span><span class="o">/</span><span class="n">install</span><span class="o">-</span><span class="n">script</span><span class="o">/</span><span class="n">k8s</span><span class="o">-</span><span class="n">dashboard</span><span class="o">/</span><span class="n">v2</span><span class="o">.</span><span class="mf">0.0</span><span class="o">-</span><span class="n">beta5</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p><strong>访问</strong></p>
<p>Kubernetes Dashboard 当前，只支持使用 Bearer Token登录。 由于 Kubernetes
Dashboard 默认部署时，只配置了最低权限的 RBAC。因此，我们要创建一个名为
<code class="docutils literal notranslate"><span class="pre">admin-user</span></code> 的 ServiceAccount，再创建一个
ClusterRolebinding，将其绑定到 Kubernetes 集群中默认初始化的
<code class="docutils literal notranslate"><span class="pre">cluster-admin</span></code> 这个 ClusterRole。</p>
<p>执行如下命令可创建 ServiceAccount 和 ClusterRoleBinding</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">kuboard</span><span class="o">.</span><span class="n">cn</span><span class="o">/</span><span class="n">install</span><span class="o">-</span><span class="n">script</span><span class="o">/</span><span class="n">k8s</span><span class="o">-</span><span class="n">dashboard</span><span class="o">/</span><span class="n">auth</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>获取Bearer Token</p>
<p>执行命令：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep admin-user | awk &#39;{print $1}&#39;)
</pre></div>
</div>
<p>因为Service是ClusterIP类型，为了方便使用，我们可通过<code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">--namespace=kubernetes-dashboard</span> <span class="pre">edit</span> <span class="pre">service</span> <span class="pre">kubernetes-dashboard</span></code>修改成NodePort类型</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spec</span><span class="p">:</span>
  <span class="n">clusterIP</span><span class="p">:</span> <span class="mf">10.96</span><span class="o">.</span><span class="mf">187.186</span>
  <span class="n">externalTrafficPolicy</span><span class="p">:</span> <span class="n">Cluster</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">nodePort</span><span class="p">:</span> <span class="mi">31966</span>
    <span class="n">port</span><span class="p">:</span> <span class="mi">443</span>
    <span class="n">protocol</span><span class="p">:</span> <span class="n">TCP</span>
    <span class="n">targetPort</span><span class="p">:</span> <span class="mi">8443</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">k8s</span><span class="o">-</span><span class="n">app</span><span class="p">:</span> <span class="n">kubernetes</span><span class="o">-</span><span class="n">dashboard</span>
  <span class="n">sessionAffinity</span><span class="p">:</span> <span class="kc">None</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">NodePort</span>        <span class="o">//</span><span class="n">修改这里</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@k8s</span><span class="o">-</span><span class="n">master</span> <span class="o">~</span><span class="p">]</span><span class="c1"># kubectl get service -n kubernetes-dashboard</span>
<span class="n">NAME</span>                        <span class="n">TYPE</span>        <span class="n">CLUSTER</span><span class="o">-</span><span class="n">IP</span>      <span class="n">EXTERNAL</span><span class="o">-</span><span class="n">IP</span>   <span class="n">PORT</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>         <span class="n">AGE</span>
<span class="n">dashboard</span><span class="o">-</span><span class="n">metrics</span><span class="o">-</span><span class="n">scraper</span>   <span class="n">ClusterIP</span>   <span class="mf">10.96</span><span class="o">.</span><span class="mf">205.156</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>        <span class="mi">8000</span><span class="o">/</span><span class="n">TCP</span>        <span class="mi">70</span><span class="n">m</span>
<span class="n">kubernetes</span><span class="o">-</span><span class="n">dashboard</span>        <span class="n">NodePort</span>    <span class="mf">10.96</span><span class="o">.</span><span class="mf">187.186</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>        <span class="mi">443</span><span class="p">:</span><span class="mi">31966</span><span class="o">/</span><span class="n">TCP</span>   <span class="mi">70</span><span class="n">m</span>
</pre></div>
</div>
<p>使用 Firefox 浏览器访问，并忽略 HTTPS 校验错误。</p>
<img alt="../_images/k8s-dashborad0001.png" src="../_images/k8s-dashborad0001.png" />
<p>给匿名用户授权</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl create clusterrolebinding test:anonymous --clusterrole=cluster-admin --user=system:anonymous
</pre></div>
</div>
</section>
<section id="kuboard-kubernetes">
<h3><a class="toc-backref" href="#id34">3.11 Kuboard Kubernetes</a><a class="headerlink" href="#kuboard-kubernetes" title="Permalink to this headline">¶</a></h3>
<p>Kubernetes 容器编排已越来越被大家关注，然而使用 Kubernetes
的门槛却依然很高，主要体现在这几个方面：</p>
<ul class="simple">
<li><p>集群的安装复杂，出错概率大</p></li>
<li><p>Kubernetes相较于容器化，引入了许多新的概念，学习难度高</p></li>
<li><p>需要手工编写 YAML 文件，难以在多环境下管理</p></li>
<li><p>缺少好的实战案例可以参考</p></li>
</ul>
<p>Kuboard，是一款免费的 Kubernetes 图形化管理工具，Kuboard
力图帮助用户快速在 Kubernetes 上落地微服务。</p>
<p>参考文献：</p>
<p><a class="reference external" href="https://www.cnblogs.com/xiao987334176/p/12060855.html">https://www.cnblogs.com/xiao987334176/p/12060855.html</a></p>
<p>在 K8S 中安装 Kuboard v3</p>
<p><a class="reference external" href="https://www.kuboard.cn/install/v3/install-in-k8s.html#%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4">https://www.kuboard.cn/install/v3/install-in-k8s.html#%E5%AE%89%E8%A3%85%E6%AD%A5%E9%AA%A4</a></p>
</section>
</section>
<section id="kubectl">
<h2><a class="toc-backref" href="#id35">4 kubectl管理工具</a><a class="headerlink" href="#kubectl" title="Permalink to this headline">¶</a></h2>
<section id="id8">
<h3><a class="toc-backref" href="#id36">4.1 kubectl管理工具远程连接集群</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>Kubectl客户端工具的主要功能是管理Kubernetes集群中的资源，使用kuberctl工具可以对资源进行创建、删除和更改等操作。</p>
<p>Kubectl工具默认连接本地apiserver127.0.0.1:8080，通过-s选项可以指定集群HTTP非安全IP地址和端口进行访问，命令如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">-</span><span class="n">s</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="o">-</span><span class="n">go</span><span class="o">.</span><span class="n">gitee</span><span class="o">.</span><span class="n">cc</span><span class="p">:</span><span class="mi">8080</span> <span class="n">get</span> <span class="n">node</span>
</pre></div>
</div>
<p>查看master上的kube-api server地址</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@k8s</span><span class="o">-</span><span class="n">m2</span> <span class="o">~</span><span class="p">]</span><span class="c1"># cat /etc/kubernetes/manifests/kube-apiserver.yaml |grep server</span>
    <span class="n">kubeadm</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="o">.</span><span class="n">advertise</span><span class="o">-</span><span class="n">address</span><span class="o">.</span><span class="n">endpoint</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="o">-</span><span class="n">go</span><span class="o">.</span><span class="n">gitee</span><span class="o">.</span><span class="n">cc</span><span class="p">:</span><span class="mi">8080</span>
    <span class="n">component</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span>
    <span class="o">-</span> <span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span>
    <span class="o">-</span> <span class="o">--</span><span class="n">etcd</span><span class="o">-</span><span class="n">certfile</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">apiserver</span><span class="o">-</span><span class="n">etcd</span><span class="o">-</span><span class="n">client</span><span class="o">.</span><span class="n">crt</span>
    <span class="o">-</span> <span class="o">--</span><span class="n">etcd</span><span class="o">-</span><span class="n">keyfile</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">apiserver</span><span class="o">-</span><span class="n">etcd</span><span class="o">-</span><span class="n">client</span><span class="o">.</span><span class="n">key</span>
    <span class="o">-</span> <span class="o">--</span><span class="n">etcd</span><span class="o">-</span><span class="n">servers</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">2379</span>
    <span class="o">-</span> <span class="o">--</span><span class="n">kubelet</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">certificate</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">apiserver</span><span class="o">-</span><span class="n">kubelet</span><span class="o">-</span><span class="n">client</span><span class="o">.</span><span class="n">crt</span>
    <span class="o">-</span> <span class="o">--</span><span class="n">kubelet</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">key</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">apiserver</span><span class="o">-</span><span class="n">kubelet</span><span class="o">-</span><span class="n">client</span><span class="o">.</span><span class="n">key</span>
    <span class="o">-</span> <span class="o">--</span><span class="n">tls</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">apiserver</span><span class="o">.</span><span class="n">crt</span>
    <span class="o">-</span> <span class="o">--</span><span class="n">tls</span><span class="o">-</span><span class="n">private</span><span class="o">-</span><span class="n">key</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">pki</span><span class="o">/</span><span class="n">apiserver</span><span class="o">.</span><span class="n">key</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">hub</span><span class="o">.</span><span class="n">gitee</span><span class="o">.</span><span class="n">cc</span><span class="o">/</span><span class="n">google_containers</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="p">:</span><span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span>
</pre></div>
</div>
<p>查看api-server的另一种方式</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># APISERVER=$(kubectl config view |grep server|cut -f 2- -d &quot;:&quot; | tr -d &quot; &quot;)</span>
<span class="c1"># echo $APISERVER</span>
</pre></div>
</div>
<blockquote>
<div><p>参考文献：</p>
<p><a class="reference external" href="https://my.oschina.net/u/1464083/blog/3065433">https://my.oschina.net/u/1464083/blog/3065433</a>
<a class="reference external" href="https://www.cnblogs.com/xiangsikai/p/11412864.html">https://www.cnblogs.com/xiangsikai/p/11412864.html</a></p>
</div></blockquote>
<p>创建ca证书和admin证书，admin证书用于客户端管理集群，所以需要将admin证书复制到客户端访问集群的节点上。
如果你是通过 kubeadm 安装的 Kubernetes，所有证书都存放在
/etc/kubernetes/pki 目录下。</p>
<p>参考文献中写了，需要生成admin.pem等证书文件最后合并成一个config文件，在此我使用之前生成的config文件。
直接从master上拷贝过去。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>scp /etc/kubernetes/admin.conf root@192.168.1.46:/root/.kube/

// 集群安装后一般admin.conf文件没有更改，更改后名称为config文件，下面示例为拷贝config文件
scp .kube/config root@192.168.1.40:~/
</pre></div>
</div>
<p>在客户端节点上进行如下操作：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@jenkins</span> <span class="o">~</span><span class="p">]</span><span class="c1"># mkdir /root/.kube/</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@jenkins</span> <span class="o">~</span><span class="p">]</span><span class="c1"># mv config /root/.kube/</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@jenkins</span> <span class="o">~</span><span class="p">]</span><span class="c1"># ll /root/.kube/config</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">5459</span> <span class="n">Dec</span> <span class="mi">29</span> <span class="mi">03</span><span class="p">:</span><span class="mi">35</span> <span class="o">/</span><span class="n">root</span><span class="o">/.</span><span class="n">kube</span><span class="o">/</span><span class="n">config</span>

<span class="p">[</span><span class="n">root</span><span class="nd">@jenkins</span> <span class="o">~</span><span class="p">]</span><span class="c1"># kubectl get nodes</span>
<span class="n">NAME</span>     <span class="n">STATUS</span>   <span class="n">ROLES</span>    <span class="n">AGE</span>   <span class="n">VERSION</span>
<span class="n">k8s</span><span class="o">-</span><span class="n">m1</span>   <span class="n">Ready</span>    <span class="n">master</span>   <span class="mi">63</span><span class="n">d</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>
<span class="n">k8s</span><span class="o">-</span><span class="n">m2</span>   <span class="n">Ready</span>    <span class="n">master</span>   <span class="mi">63</span><span class="n">d</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>
<span class="n">k8s</span><span class="o">-</span><span class="n">m3</span>   <span class="n">Ready</span>    <span class="n">master</span>   <span class="mi">63</span><span class="n">d</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>
<span class="n">k8s</span><span class="o">-</span><span class="n">n1</span>   <span class="n">Ready</span>    <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>   <span class="mi">63</span><span class="n">d</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">19.3</span>
<span class="n">k8s</span><span class="o">-</span><span class="n">n2</span>   <span class="n">Ready</span>    <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>   <span class="mi">63</span><span class="n">d</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">19.3</span>
<span class="n">k8s</span><span class="o">-</span><span class="n">w1</span>   <span class="n">Ready</span>    <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>   <span class="mi">63</span><span class="n">d</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>
<span class="n">k8s</span><span class="o">-</span><span class="n">w2</span>   <span class="n">Ready</span>    <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>   <span class="mi">63</span><span class="n">d</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>
<span class="n">k8s</span><span class="o">-</span><span class="n">w3</span>   <span class="n">Ready</span>    <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>   <span class="mi">63</span><span class="n">d</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>
<span class="n">k8s</span><span class="o">-</span><span class="n">w4</span>   <span class="n">Ready</span>    <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>   <span class="mi">63</span><span class="n">d</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>
<span class="n">k8s</span><span class="o">-</span><span class="n">w5</span>   <span class="n">Ready</span>    <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>   <span class="mi">63</span><span class="n">d</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>
<span class="n">k8s</span><span class="o">-</span><span class="n">w6</span>   <span class="n">Ready</span>    <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>   <span class="mi">63</span><span class="n">d</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>
<span class="n">k8s</span><span class="o">-</span><span class="n">w7</span>   <span class="n">Ready</span>    <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>   <span class="mi">63</span><span class="n">d</span>   <span class="n">v1</span><span class="o">.</span><span class="mf">18.2</span>
</pre></div>
</div>
<p><strong>注意 kubectl版本要和集群环境版本一致</strong></p>
<p>上面节点的介绍：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>k8s-m1、k8s-m2、k8s-m3                 #master节点，使用keepalived vip进行热备
k8s-n1、k8s-n2                         #node节点，对外映射发布服务，安装了ingress插件
k8s-w1~w7                             #worker节点，运行容器和存储镜像
</pre></div>
</div>
<section id="kubectlkubernetes">
<h4>4.1.1 kubectl连接多个kubernetes集群<a class="headerlink" href="#kubectlkubernetes" title="Permalink to this headline">¶</a></h4>
<p>具体步骤如下：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ ll ~/.kube/
-rw-r--r-- <span class="m">1</span> root root <span class="m">6546</span> Jun <span class="m">21</span> <span class="m">19</span>:23 kubectl-baseService.conf
-rw-r--r-- <span class="m">1</span> root root <span class="m">6546</span> Jun <span class="m">21</span> <span class="m">19</span>:23 kubectl-rake.conf

$ cat kubectl-rake.conf
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURuakNDQW9hZ0F3SUJBZ0lVRkdBNmlkZ0FSNXVwY3VUWXZMRkVKVjV2WW1nd0RRWUpLb1pJaHZjTkFRRUwKQlFBd1p6RUxNQWtHQTFVRUJoTUNRMDR4RURBT0JnTlZCQWdUQjBKbGFVcHBibWN4RURBT0JnTlZCQWNUQjBKbAphVXBwYm1jeERqQU1CZ05WQkFvVEJXcHdZV0Z6TVJRd0VnWURWUVFMRXd0amJHOTFaRzVoZEdsMlpURU9NQXdHCkExVUVBeE1GYW5CaFlYTXdIaGNOTWpFd05qSXhNRE14T0RBd1doY05NekV3TmpFNU1ETXhPREF3V2pCbk1Rc3cKQ1FZRFZRUUdFd0pEVGpFUU1BNEdBMVVFQ0JNSFFtVnBTbWx1WnpFUU1BNEdBMVVFQnhNSFFtVnBTbWx1WnpFTwpNQXdHQTFVRUNoTUZhbkJoWVhNeEZEQVNCZ05WQkFzVEMyTnNiM1ZrYm1GMGFYWmxNUTR3REFZRFZRUURFd1ZxCmNHRmhjekNDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUEFEQ0NBUW9DZ2dFQkFMcmo5SmcxaXZmRUI0TmUKaGRFQzAxdks0ZklydHlQclhmaytGbmJ5NldHSmsxMnN0RkFzM0ZIdzAvSWwwSU9ZNythRzZZTlo3SEVGUER1UQpPK0Z5eFhkQThpdUlYUW1ZYW1UM1k1aTQ3bVVWeDlWK2ZwZk9zUzUvSUVhUFNObmROVzN4cnkyLzNZaldpQnA5CmNhT3VOMXltQ1l6dnl5dGVPWXFQLzhpTHRDVXlEWmJsVkEzZFY4N0hnc2ErQWpYakVRbm01MS8zaFFiT1FxUisKRWpnZnI5Nm1MSmJpRUpacFJnWjJlTXNRLzNIbXVaeWs3ejRuQm5qcE1QaW10b1pUaTA5ZUxRQk9XTXRxSy9CZgp1cy8xZmxGS3V6dkRaWU02bHI5VHdhbFB1YjdUM2hSN05tSEhNS1U4NzhxUTNoNjErM0pTbktHYy9EeEVaL2sxCk9va0NXdWNDQXdFQUFhTkNNRUF3RGdZRFZSMFBBUUgvQkFRREFnRUdNQThHQTFVZEV3RUIvd1FGTUFNQkFmOHcKSFFZRFZSME9CQllFRk5kYTNjNFJQTTlwb3JiRUdJSlZuVmxqN2U0WU1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQgpBUUJRcWxqTFVSYndjSlZMbTZHU0JOL0dNM245bDJaaTBSVC9ETUpESzBEbjdmZlBybHVmY01uVjhFQmxPaGtYCllLUDhHNmRXbWdLSTFDTW5WNHZXRi9RRG8waGl1OGNGYXcyTS9kNmE0OFk2T0VKb0g1S3g5Wk5wT0p4NlNCSlcKMGdCRnJYaXlOVXZpVEJWWlFSbC9KU0g1cmRxMHI2b3FEbm0zalRQeE1YdTBLbXhzdU5YTS83YzZSaVZlODBDZwpseFdmZG5NbU9IVUI5UDU0c1JHMVFLdWNkTW1MYjZwbU05TG9WSzRibXNGOWpucUJwSDRlMnhabG1tc21uWFhzCmpYM0hNNi9LQitDRFRDSUZXKzE2ajlucmRJNmZKaXlkbHlUQWJoTUJEMTBHZ0hyUEg1Qk42T0F4a29rdkpDOVIKNGZZZDZERnByNm9yWHN6QWhkbTY4RFNFCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
    server: https://100.64.230.123:6443
  name: kubernetes
contexts:
- context:
.......

$ cat kubectl-baseService.conf
apiVersion: v1
clusters:
- cluster:
    client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUVWekNDQXorZ0F3SUJBZ0lVRDlQQ0l0Z0hRUCtEVE10U1NGV1lmVXFoR01Zd0RRWUpLb1pJaHZjTkFRRUwKQlFBd1p6RUxNQWtHQTFVRUJoTUNRMDR4RURBT0JnTlZCQWdUQjBKbGFVcHBibWN4RURBT0JnTlZCQWNUQjBKbAphVXBwYm1jeERqQU1CZ05WQkFvVEJXcHdZV0Z6TVJRd0VnWURWUVFMRXd0amJHOTFaRzVoZEdsMlpURU9NQXdHCkExVUVBeE1GYW5CaFlYTXdJQmNOTWpFd05qSXhNRE15TURBd1doZ1BNakV5TVRBMU1qZ3dNekl3TURCYU1JR2QKTVFzd0NRWURWUVFHRXdKRFRqRVFNQTRHQTFVRUNCTUhRbVZwU21sdVp6RVFNQTRHQTFVRUJ4TUhRbVZwU21sdQpaekVwTUNjR0ExVUVDaE1nWldSalpqa3laVGs0TmpoaU5EZ3hNbUV6TVROalpUQTFZbVprWWpBNFlXTXhGREFTCkJnTlZCQXNUQzJOc2IzVmtibUYwYVhabE1Ta3dKd1lEVlFRREV5QmxaR05tT1RKbE9UZzJPR0k
    .......
</pre></div>
</div>
<p>通过config信息，可以看到两个集群的cluster name，context
name，以及用户信息。</p>
<p>配置文件已准备好，下面开始变身了。文件合成：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> <span class="nv">$HOME</span>/.kube/
$ <span class="nv">KUBECONFIG</span><span class="o">=</span>kubectl-rake.conf:kubectl-baseService.conf kubectl config view --flatten &gt; <span class="nv">$HOME</span>/.kube/config
$ ll

-rw-r--r-- <span class="m">1</span> root root <span class="m">6546</span> Jun <span class="m">21</span> <span class="m">19</span>:32 config
-rw-r--r-- <span class="m">1</span> root root <span class="m">6546</span> Jun <span class="m">21</span> <span class="m">19</span>:23 kubectl-baseService.conf
-rw-r--r-- <span class="m">1</span> root root <span class="m">6546</span> Jun <span class="m">21</span> <span class="m">19</span>:23 kubectl-rake.conf
</pre></div>
</div>
<p>那么如何使用呢？</p>
<p>1、查看cluster name以及context name</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ kubectl config view
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: DATA+OMITTED
    server: https://100.64.230.127:6443
  name: kubernetes1
- cluster:
    certificate-authority-data: DATA+OMITTED
    server: https://100.64.230.123:6443
  name: kubernetes2
contexts:
- context:
    cluster: kubernetes
    user: edcf92e9868b4812a313ce05bfdb08ac
  name: edcf92e9868b4812a313ce05bfdb08ac@kubernetes1
- context:
    cluster: kubernetes
    user: edcf92e9868b4812a313ce05bfdb08ac
  name: edcf92e9868b4812a313ce05bfdb08ac@kubernetes2
current-context: edcf92e9868b4812a313ce05bfdb08ac@kubernetes
kind: Config
preferences: <span class="o">{}</span>
users:
- name: edcf92e9868b4812a313ce05bfdb08ac
  user:
    client-certificate-data: REDACTED
    client-key-data: REDACTED
</pre></div>
</div>
<p>2、查看当前使用的集群</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl config current-context
edcf92e9868b4812a313ce05bfdb08ac@kubernetes
</pre></div>
</div>
<p>3、修改当前使用的集群</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl config use-context edcf92e9868b4812a313ce05bfdb08ac@kubernetes1
Switched to context &quot;edcf92e9868b4812a313ce05bfdb08ac@kubernetes1&quot;.
</pre></div>
</div>
</section>
<section id="kubectlhelm">
<h4>4.1.2 kubectl、helm客户端配合多个配置接入<a class="headerlink" href="#kubectlhelm" title="Permalink to this headline">¶</a></h4>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ kubectl --kubeconfig<span class="o">=</span><span class="nv">$HOME</span>/.kube/new_ci_config get nodes
$ helm --kubeconfig<span class="o">=</span><span class="nv">$HOME</span>/.kube/new_ci_config list -A

<span class="c1"># helm使用客户端部署流程</span>

<span class="c1"># 卸载掉helm和namespaces</span>
$ /var/jenkins_home/bin/helm --kubeconfig<span class="o">=</span><span class="nv">$HOME</span>/.kube/new_ci_config uninstall -n ci-gitee-13994 ci-gitee-13994
$ /var/jenkins_home/bin/kubectl --kubeconfig<span class="o">=</span><span class="nv">$HOME</span>/.kube/new_ci_config delete ns ci-gitee-13994

<span class="c1"># 安装helm和namespaces</span>
$ /var/jenkins_home/bin/kubectl --kubeconfig<span class="o">=</span><span class="nv">$HOME</span>/.kube/new_ci_config get nodes
$ /var/jenkins_home/bin/kubectl --kubeconfig<span class="o">=</span><span class="nv">$HOME</span>/.kube/new_ci_config create ns ci-gitee-13994

<span class="c1"># 部署前使用--debug --dry-run进行测试</span>

/var/jenkins_home/bin/helm --kubeconfig<span class="o">=</span><span class="nv">$HOME</span>/.kube/new_ci_config uninstall -n ci-gitee-14019 ci-gitee-14019

/var/jenkins_home/bin/helm --kubeconfig<span class="o">=</span><span class="nv">$HOME</span>/.kube/new_ci_config install -f 14019values.yaml --debug --dry-run -n ci-gitee-14019 ci-gitee-14019 ./
/var/jenkins_home/bin/helm --kubeconfig<span class="o">=</span><span class="nv">$HOME</span>/.kube/new_ci_config install -f 14035values.yaml --debug --dry-run -n ci-gitee-14035 ci-gitee-14035 ./

<span class="c1"># 测试完毕，直接部署</span>
$ /var/jenkins_home/bin/helm --kubeconfig<span class="o">=</span><span class="nv">$HOME</span>/.kube/new_ci_config install -f 13994values.yaml -n ci-gitee-13994 ci-gitee-13994 ./
$ /var/jenkins_home/bin/helm --kubeconfig<span class="o">=</span><span class="nv">$HOME</span>/.kube/new_ci_config list -A

$ kubectl --kubeconfig<span class="o">=</span><span class="nv">$HOME</span>/.kube/kubectl-baseService.conf -n pipe-all <span class="nb">exec</span> -it gitee-ipipe-pipeline-fff7d59f6-665lb -- /bin/sh
$ helm --kubeconfig<span class="o">=</span><span class="nv">$HOME</span>/.kube/kubectl-baseService.conf list -A

$ helm --kubeconfig<span class="o">=</span><span class="nv">$HOME</span>/.kube/kubectl-baseService.conf -n pipe-all get pod
$ helm --kubeconfig<span class="o">=</span><span class="nv">$HOME</span>/.kube/kubectl-baseService.conf install ./redis -n redis redis
</pre></div>
</div>
<p>参考文献：</p>
<p><a class="reference external" href="http://www.manongjc.com/detail/12-dxwuzgmmmatvykr.html">http://www.manongjc.com/detail/12-dxwuzgmmmatvykr.html</a></p>
</section>
</section>
<section id="kubercthelm">
<h3><a class="toc-backref" href="#id37">4.2 在kuberct基础上安装helm</a><a class="headerlink" href="#kubercthelm" title="Permalink to this headline">¶</a></h3>
<p>直接拷贝heml二进制文件到远程机器上</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@ci</span><span class="o">-</span><span class="n">base</span> <span class="nb">bin</span><span class="p">]</span><span class="c1"># scp helm root@192.168.1.40:/usr/local/bin/</span>
<span class="n">root</span><span class="o">@</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">1.40</span><span class="s1">&#39;s password:</span>
<span class="n">helm</span>                                                                                                            <span class="mi">100</span><span class="o">%</span>   <span class="mi">39</span><span class="n">MB</span>   <span class="mf">8.4</span><span class="n">MB</span><span class="o">/</span><span class="n">s</span>   <span class="mi">00</span><span class="p">:</span><span class="mi">04</span>
</pre></div>
</div>
<p>或者下载方式</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>curl https://raw.githubusercontent.com/kubernetes/helm/master/scripts/get <span class="p">|</span> bash
<span class="c1"># 或者</span>
wget https://get.helm.sh/helm-v3.4.0-linux-amd64.tar.gz
tar -xf helm-v3.4.0-linux-amd64.tar.gz
mv linux-amd64/helm/usr/bin/
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@jenkins</span> <span class="o">~</span><span class="p">]</span><span class="c1"># helm version</span>
<span class="n">version</span><span class="o">.</span><span class="n">BuildInfo</span><span class="p">{</span><span class="n">Version</span><span class="p">:</span><span class="s2">&quot;v3.2.1&quot;</span><span class="p">,</span> <span class="n">GitCommit</span><span class="p">:</span><span class="s2">&quot;fe51cd1e31e6a202cba7dead9552a6d418ded79a&quot;</span><span class="p">,</span> <span class="n">GitTreeState</span><span class="p">:</span><span class="s2">&quot;clean&quot;</span><span class="p">,</span> <span class="n">GoVersion</span><span class="p">:</span><span class="s2">&quot;go1.13.10&quot;</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id9">
<h3><a class="toc-backref" href="#id38">4.3 kubectl命令补全</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>一般来说，命令补全是通过执行一个补全脚本的 shell 功能，补全脚本也是一个
shell 脚本，用于定义特定命令的补全功能。</p>
<p>kubectl 在 Bash 和 Zsh 下可以使用下面的命令自动生成并打印出补全脚本：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl completion bash
<span class="c1"># 或者</span>
$ kubectl completion zsh
</pre></div>
</div>
<p>理论上在合适的 shell 中 source 上面命令的输出就可以开启 kubectl
的命令补全功能了</p>
<p><strong>以Centos为例：</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl completion bash  &gt;&gt;/etc/profile
$ <span class="nb">source</span> /etc/profile
</pre></div>
</div>
<p>如果你想在linxu上自动补全kubenetes的命令，可以执行下列步骤：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ yum install -y bash-completion
$ <span class="nb">source</span> &lt;<span class="o">(</span>kubectl completion bash<span class="o">)</span>
$ <span class="nb">echo</span> <span class="s2">&quot;source &lt;(kubectl completion bash)&quot;</span> &gt;&gt; ~/.bashrc
</pre></div>
</div>
<p>参考文献：</p>
<p>Kubernetes 远程工具连接k8s集群</p>
<p><a class="reference external" href="https://www.cnblogs.com/xiangsikai/p/11412864.html">https://www.cnblogs.com/xiangsikai/p/11412864.html</a></p>
</section>
</section>
<section id="id10">
<h2><a class="toc-backref" href="#id39">5. 诊断分析</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
<section id="id11">
<h3><a class="toc-backref" href="#id40">5.1 查看日志</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<p>（1）使用journalctl查看服务日志</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@k8s</span><span class="o">-</span><span class="n">master</span> <span class="n">manifests</span><span class="p">]</span><span class="c1"># journalctl -u docker</span>
</pre></div>
</div>
<p>查看并追踪kubelet的日志：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">journalctl</span> <span class="o">-</span><span class="n">u</span> <span class="n">kubelet</span> <span class="o">-</span><span class="n">f</span>
</pre></div>
</div>
<p>（2）使用“kubectl logs”查看容器日志</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">logs</span> <span class="o">-</span><span class="n">f</span> <span class="n">etcd</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">master</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
</pre></div>
</div>
</section>
<section id="id12">
<h3><a class="toc-backref" href="#id41">5.2 查看资源详情和事件</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p>kubectl
describe命令用于查看一个或多个资源的详细情况，包括相关资源和事件，语法如下：</p>
<p>（1）查看节点</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">describe</span> <span class="n">nodes</span> <span class="n">k8s</span><span class="o">-</span><span class="n">master</span>
</pre></div>
</div>
<p>查看所有节点：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">describe</span> <span class="n">nodes</span>
</pre></div>
</div>
<p>查看指定节点以及事件：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">describe</span> <span class="n">nodes</span> <span class="n">k8s</span><span class="o">-</span><span class="n">node01</span> <span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">events</span>
</pre></div>
</div>
<p>2）查看Pod查看指定Pod：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">describe</span> <span class="n">pod</span> <span class="n">calico</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">j4g9n</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
</pre></div>
</div>
<p>查看指定文件描述的所有资源：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">describe</span> <span class="o">-</span><span class="n">f</span> <span class="n">teamcity</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<p>可以使用describe命令查看资源事件的类型，类型可以是deploy、rs和po。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">describe</span> <span class="n">po</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mi">2131232</span>
<span class="n">kubectl</span> <span class="n">describe</span> <span class="n">deploy</span><span class="o">/</span><span class="n">nginx</span>
<span class="n">kubectl</span> <span class="n">describe</span> <span class="n">rs</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mi">2131232</span>
<span class="n">kubectl</span> <span class="n">describe</span> <span class="n">svc</span>
<span class="n">kubectl</span> <span class="n">describe</span> <span class="n">svc</span> <span class="n">nginx</span><span class="o">-</span><span class="n">service</span>
</pre></div>
</div>
</section>
</section>
<section id="kubernetes-v1-19-0">
<h2><a class="toc-backref" href="#id42">6. Kubernetes v1.19.0 高可用安装部署</a><a class="headerlink" href="#kubernetes-v1-19-0" title="Permalink to this headline">¶</a></h2>
<p>参考文献：</p>
<p><a class="reference external" href="https://www.cloudcared.cn/3126.html">https://www.cloudcared.cn/3126.html</a></p>
<p><a class="reference external" href="https://gitee.com/hujianli94net/kainstall.git">https://gitee.com/hujianli94net/kainstall.git</a></p>
<p><a class="reference external" href="https://gitee.com/oschina/install-single-master-K8s.git">https://gitee.com/oschina/install-single-master-K8s.git</a></p>
</section>
<section id="nodenode">
<h2><a class="toc-backref" href="#id43">7. 移除node和重新加入node</a><a class="headerlink" href="#nodenode" title="Permalink to this headline">¶</a></h2>
<p><strong>Kubernetes Node的隔离与恢复</strong></p>
<p>在硬件升级、硬件维护等情况下，我们需要将某些Node进行隔离，脱离Kubernetes集群的调度范围。Kubernetes提供了一种机制，即可以将Node纳入调度范围，也可以将Node脱离调度范围。</p>
<p>使用kubectl cordon对某个Node进行隔离和恢复调度的操作。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1">#隔离</span>
$ kubectl cordon k8s-node1


<span class="c1">#恢复</span>
$ kubectl uncordon k8s-node1
</pre></div>
</div>
<p><strong>移除节点和加入节点操作</strong></p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="m">1</span>.查看当前所有node节点
$ sudo kubectl get no


<span class="m">2</span>.将我的节点标记为不可调度
$ kubectl cordon k8-w8


<span class="m">3</span>.排空节点以准备维护
$ kubectl drain my-node


<span class="m">4</span>.在master上移除节点
$ sudo kubectl delete node &lt;your-node&gt;


<span class="m">5</span>.在被删除节点&lt;node&gt;执行
$ kubeadm reset


<span class="m">6</span>.在master节点重新生成token
$ kubeadm token create --print-join-command
W0406 <span class="m">18</span>:46:41.609997   <span class="m">17201</span> configset.go:202<span class="o">]</span> WARNING: kubeadm cannot validate component configs <span class="k">for</span> API groups <span class="o">[</span>kubelet.config.k8s.io kubeproxy.config.k8s.io<span class="o">]</span>

kubeadm join kube-apiserver.gitee.cc:6443 --token vawvl2.521xl3jo2h2y2h4h     --discovery-token-ca-cert-hash sha256:31a7cc20f0c5471a525c43e530bd21360bd4d1a19fa9e96724ad811a295eebd5


<span class="m">7</span>.在被加入节点执行 kubeadm join
</pre></div>
</div>
<p>参考文献：</p>
<p><a class="reference external" href="https://www.orchome.com/1777">https://www.orchome.com/1777</a></p>
</section>
<section id="id13">
<h2><a class="toc-backref" href="#id44">8. 手动管理Node资源与节点</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h2>
<p>考虑到系统维护或硬件升级等原因，管理员有时候需要手动重启或下线某个工作节点，</p>
<p>安全的操作步骤是先手动禁止调度器继续向该节点调度新的Pod对象以封锁（cordon）该节点，</p>
<p>但封锁操作并不会影响节点上现有的Pod对象，接下来还需要正常逐出该节点上运行着的工作负载以“排空”（drain）该节点。</p>
<blockquote>
<div><p>注意</p>
<p>封锁工作节点对DaemonSet控制器创建的Pod对象无效。</p>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">封锁k8s</span><span class="o">-</span><span class="n">W1节点</span>
<span class="n">kubectl</span> <span class="n">cordon</span> <span class="n">k8s</span><span class="o">-</span><span class="n">w1</span>

<span class="o">//</span><span class="n">排空节点内的资源</span>
<span class="n">kubectl</span> <span class="n">drain</span> <span class="n">k8s</span><span class="o">-</span><span class="n">w1</span>
</pre></div>
</div>
<p>不过，仅期望封锁工作节点时，cordon命令显然更适用。随后，无论是运行cordon还是drain命令，若期望工作节点回归正常工作状态，都需要使用uncordo命令对节点进行解封。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">uncordo</span> <span class="n">k8s</span><span class="o">-</span><span class="n">w1</span>
</pre></div>
</div>
<p>需要注意的是，drain默认只能排空受控制器（如Deployment、DaemonSet或StatefulSet等）管理的Pod对象，而不受控于控制器的Pod（例如静态Pod）则会阻止命令的运行。</p>
<p>如果要忽略这种阻止操作，可以为drain附加–force选项，以清理系统级Pod对象。</p>
<section id="id14">
<h3><a class="toc-backref" href="#id45">8.1 节点维护和设置污点操作</a><a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#查看taint</span>
<span class="n">kubectl</span> <span class="n">describe</span> <span class="n">node</span> <span class="n">node1</span>


<span class="c1">#设置taint</span>
<span class="c1">#NoExecute不仅不会调度, 还会驱逐Node上已有的Pod</span>
<span class="n">kubectl</span> <span class="n">taint</span> <span class="n">node</span> <span class="n">node1</span> <span class="n">key1</span><span class="o">=</span><span class="n">value1</span><span class="p">:</span><span class="n">NoSchedule</span>
<span class="n">kubectl</span> <span class="n">taint</span> <span class="n">node</span> <span class="n">node1</span> <span class="n">key1</span><span class="o">=</span><span class="n">value1</span><span class="p">:</span><span class="n">NoExecute</span>
<span class="n">kubectl</span> <span class="n">taint</span> <span class="n">node</span> <span class="n">node1</span> <span class="n">key2</span><span class="o">=</span><span class="n">value2</span><span class="p">:</span><span class="n">NoSchedule</span>



<span class="c1">#删除taint</span>
<span class="n">kubectl</span> <span class="n">taint</span> <span class="n">node</span> <span class="n">node1</span> <span class="n">key1</span><span class="p">:</span><span class="n">NoSchedule</span><span class="o">-</span>  <span class="c1"># 这里的key可以不用指定value</span>
<span class="n">kubectl</span> <span class="n">taint</span> <span class="n">node</span> <span class="n">node1</span> <span class="n">key1</span><span class="p">:</span><span class="n">NoExecute</span><span class="o">-</span>
<span class="c1"># kubectl taint node node1 key1-  删除指定key所有的effect</span>
<span class="n">kubectl</span> <span class="n">taint</span> <span class="n">node</span> <span class="n">node1</span> <span class="n">key2</span><span class="p">:</span><span class="n">NoSchedule</span><span class="o">-</span>



<span class="n">kubectl</span> <span class="n">taint</span> <span class="n">node</span> <span class="n">k8s</span><span class="o">-</span><span class="n">m1</span> <span class="n">node</span><span class="o">-</span><span class="n">role</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">master</span><span class="o">-</span>   <span class="c1">#允许master调度</span>

<span class="n">kubectl</span> <span class="n">taint</span> <span class="n">nodes</span> <span class="n">master1</span> <span class="n">node</span><span class="o">-</span><span class="n">role</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">master</span><span class="o">=</span><span class="p">:</span><span class="n">NoSchedule</span> <span class="c1">#禁止master调度</span>

<span class="n">kubectl</span> <span class="n">describe</span> <span class="n">node</span> <span class="n">master</span> <span class="o">|</span><span class="n">grep</span> <span class="n">Taints</span> <span class="c1">#查看污点</span>



<span class="c1">#节点设置不可调度</span>
<span class="n">kubectl</span> <span class="n">taint</span> <span class="n">node</span> <span class="n">k8s</span><span class="o">-</span><span class="n">n1</span> <span class="n">GiteeCommonAddonsOnly</span><span class="p">:</span><span class="n">NoSchedule</span>

<span class="c1">#节点设置为可调度</span>
<span class="n">kubectl</span> <span class="n">taint</span> <span class="n">node</span> <span class="n">k8s</span><span class="o">-</span><span class="n">n1</span> <span class="n">GiteeCommonAddonsOnly</span><span class="o">=</span><span class="n">yes</span><span class="p">:</span><span class="n">NoSchedule</span><span class="o">-</span>


<span class="n">kubectl</span> <span class="n">cordon</span> <span class="n">my</span><span class="o">-</span><span class="n">node</span>                                                <span class="c1"># 将节点设置为不可调度</span>
<span class="n">kubectl</span> <span class="n">drain</span> <span class="n">my</span><span class="o">-</span><span class="n">node</span>                                                 <span class="c1"># 排空 my-node 以准备维护</span>
<span class="n">kubectl</span> <span class="n">uncordon</span> <span class="n">my</span><span class="o">-</span><span class="n">node</span>                                              <span class="c1"># 将节点标记为可调度</span>
<span class="n">kubectl</span> <span class="n">top</span> <span class="n">node</span> <span class="n">my</span><span class="o">-</span><span class="n">node</span>                                              <span class="c1"># 显示给定节点的指标</span>
<span class="n">kubectl</span> <span class="n">cluster</span><span class="o">-</span><span class="n">info</span>                                                  <span class="c1"># 显示 master 和 services 的地址</span>
<span class="n">kubectl</span> <span class="n">cluster</span><span class="o">-</span><span class="n">info</span> <span class="n">dump</span>                                             <span class="c1"># 将当前集群状态转储到标准输出</span>
<span class="n">kubectl</span> <span class="n">cluster</span><span class="o">-</span><span class="n">info</span> <span class="n">dump</span> <span class="o">--</span><span class="n">output</span><span class="o">-</span><span class="n">directory</span><span class="o">=/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">cluster</span><span class="o">-</span><span class="n">state</span>   <span class="c1"># 将当前集群状态转储到标准输出 to /path/to/cluster-state</span>

<span class="c1"># 如果具有该键和效果的污点已存在，则按指定替换其值。</span>
<span class="n">kubectl</span> <span class="n">taint</span> <span class="n">nodes</span> <span class="n">foo</span> <span class="n">dedicated</span><span class="o">=</span><span class="n">special</span><span class="o">-</span><span class="n">user</span><span class="p">:</span><span class="n">NoSchedule</span>
</pre></div>
</div>
<p>参考文献： <a class="reference external" href="https://www.cnblogs.com/weifeng1463/p/11810612.html">https://www.cnblogs.com/weifeng1463/p/11810612.html</a></p>
<p>Kubernetes 将Pod调度到Master节点</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>出于安全考虑，默认配置下Kubernetes不会将Pod调度到Master节点。如果希望将k8s-master也当作Node使用，可以执行如下命令：
kubectl taint node k8s-master node-role.kubernetes.io/master-



其中k8s-master是主机节点hostname如果要恢复Master Only状态，执行如下命令：
kubectl taint node k8s-master node-role.kubernetes.io/master=&quot;&quot;
</pre></div>
</div>
</section>
</section>
<section id="id15">
<h2><a class="toc-backref" href="#id46">9.集群扩容及缩容</a><a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h2>
<section id="id16">
<h3><a class="toc-backref" href="#id47">集群缩容</a><a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>master节点缩容</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@master01 ~<span class="o">]</span><span class="c1"># kubectl drain master03 --delete-emptydir-data --force --ignore-daemonsets</span>
<span class="o">[</span>root@master01 ~<span class="o">]</span><span class="c1"># kubectl delete node master03</span>

<span class="o">[</span>root@master03 ~<span class="o">]</span><span class="c1"># kubeadm reset -f &amp;&amp; rm -rf $HOME/.kube</span>
</pre></div>
</div>
<ul class="simple">
<li><p>worker节点缩容</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@master01 ~<span class="o">]</span><span class="c1"># kubectl drain worker04 --delete-emptydir-data --force --ignore-daemonsets</span>
<span class="o">[</span>root@master01 ~<span class="o">]</span><span class="c1"># kubectl delete node worker04</span>

<span class="o">[</span>root@worker04 ~<span class="o">]</span><span class="c1"># kubeadm reset -f &amp;&amp; rm -rf $HOME/.kube</span>
<span class="o">[</span>root@worker04 ~<span class="o">]</span><span class="c1"># rm -rf /etc/kubernetes/admin.conf /etc/kubernetes/kubelet.conf /etc/kubernetes/bootstrap-kubelet.conf /etc/kubernetes/controller-manager.conf /etc/kubernetes/scheduler.conf</span>
</pre></div>
</div>
</section>
</section>
<section id="id17">
<h2><a class="toc-backref" href="#id48">参考文献</a><a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://www.cnblogs.com/yangxiaochu/p/10683951.html">kubeadm安装k8s
1.13版本</a></p>
<p><a class="reference external" href="https://blog.csdn.net/baidu_33032485/article/details/113575192">基于Ubuntu Server 20.04 LTS 部署 kubernetes
1.20</a></p>
<p><a class="reference external" href="https://blog.csdn.net/happyworld1/article/details/106383464/">ubuntu18.04 kubeadm 安装kubernetes
v1.18.3</a></p>
<p><a class="reference external" href="https://www.cnblogs.com/superlinux/p/14961619.html">kubeadm部署高可用版Kubernetes1.21</a></p>
<p>K8S部署系列一-Ubuntu 20.0 K8S集群安装</p>
<p><a class="reference external" href="https://www.yuque.com/lizhiyong2000/gwgb6w/xfgh7n">https://www.yuque.com/lizhiyong2000/gwgb6w/xfgh7n</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="02.Kubernetes实战指南" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="02.Kubespray%E9%83%A8%E7%BD%B2k8s.html" class="btn btn-neutral float-right" title="Kubespray部署k8s" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, huxiaojian.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>