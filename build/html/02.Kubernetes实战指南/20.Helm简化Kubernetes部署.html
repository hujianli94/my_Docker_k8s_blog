<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Helm简化Kubernetes部署 &mdash; 运维开发修炼之路</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="03.Docker经典实例" href="../03.Docker%E7%BB%8F%E5%85%B8%E5%AE%9E%E4%BE%8B/index.html" />
    <link rel="prev" title="基于Docker+K8S+GitLab/SVN+Jenkins+Harbor持续集成交付环境" href="15.%E5%9F%BA%E4%BA%8EDocker%2BK8S%2BGitLabSVN%2BJenkins%2BHarbor%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E4%BA%A4%E4%BB%98%E7%8E%AF%E5%A2%83.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> 小健_Docker_K8s_Blog
            <img src="../_static/docker-k8s.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../01.Docker%E6%8A%80%E6%9C%AF%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E6%88%983%E7%89%88/index.html">01.Docker技术入门与实战3版</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">02.Kubernetes实战指南</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01.Kubernetes%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E6%8C%87%E5%8D%97.html">Kubernetes安装配置指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="02.Kubespray%E9%83%A8%E7%BD%B2k8s.html">Kubespray部署k8s</a></li>
<li class="toctree-l2"><a class="reference internal" href="03.Docker%E5%9F%BA%E7%A1%80.html">Docker基础</a></li>
<li class="toctree-l2"><a class="reference internal" href="04.Kubernetes%E5%9F%BA%E7%A1%80.html">Kubernetes基础</a></li>
<li class="toctree-l2"><a class="reference internal" href="05.Kubernetes%E7%9A%84%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1.html">Kubernetes的资源对象</a></li>
<li class="toctree-l2"><a class="reference internal" href="06.Serveice.html">Serveice</a></li>
<li class="toctree-l2"><a class="reference internal" href="07.Ingress.html">Ingress</a></li>
<li class="toctree-l2"><a class="reference internal" href="08.Kubernetest%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86.html">Kubernetest数据管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="09.kubernetes%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B.html">Kubernetes实战案例</a></li>
<li class="toctree-l2"><a class="reference internal" href="10.Kubernetes%E7%9B%91%E6%8E%A7.html">Kubernetes监控</a></li>
<li class="toctree-l2"><a class="reference internal" href="11.%E9%9B%86%E7%BE%A4%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F.html">集群日志系统</a></li>
<li class="toctree-l2"><a class="reference internal" href="12.%E4%BD%BF%E7%94%A8EFKLK%E6%90%AD%E5%BB%BAKubernetes%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E5%B7%A5%E5%85%B7%E6%A0%88.html">使用EFKLK搭建Kubernetes日志收集工具栈</a></li>
<li class="toctree-l2"><a class="reference internal" href="13.Kubernetes%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E4%BB%8EDocker%E5%88%87%E6%8D%A2%E6%88%90Containerd.html">Kubernetes容器运行时从Docker切换成Containerd</a></li>
<li class="toctree-l2"><a class="reference internal" href="14.%E6%95%B4%E7%90%86%E5%85%A8%E7%BD%91%E6%9C%80%E5%85%A8K8S%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7-%E5%B9%B3%E5%8F%B0.html">整理全网最全K8S集群管理工具-平台</a></li>
<li class="toctree-l2"><a class="reference internal" href="15.%E5%9F%BA%E4%BA%8EDocker%2BK8S%2BGitLabSVN%2BJenkins%2BHarbor%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E4%BA%A4%E4%BB%98%E7%8E%AF%E5%A2%83.html">基于Docker+K8S+GitLab/SVN+Jenkins+Harbor持续集成交付环境</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Helm简化Kubernetes部署</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#helm">Helm基础</a></li>
<li class="toctree-l3"><a class="reference internal" href="#helm-3-v3">Helm 3 v3 变化</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">Helm的核心术语</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#helm-3">Helm 3快速入门</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">安装</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">安装方式1</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">安装方式2</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#charts">查看Charts仓库信息</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">常见操作</a></li>
<li class="toctree-l3"><a class="reference internal" href="#stable-redisns-redis">安装stable/redis在ns=redis中</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">helm包检查项目</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">Helm安装和卸载</a></li>
<li class="toctree-l3"><a class="reference internal" href="#helmdemo">使用Helm部署Demo</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#chart">chart 的基本结构</a></li>
<li class="toctree-l4"><a class="reference internal" href="#helm-create">helm create</a></li>
<li class="toctree-l4"><a class="reference internal" href="#helm-package">helm package</a></li>
<li class="toctree-l4"><a class="reference internal" href="#helm-search">helm search</a></li>
<li class="toctree-l4"><a class="reference internal" href="#helm-inspect">helm inspect</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">Chart 模板示例</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">编写一个简单的 Chart 示例</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id13">Chart 模板开发指南</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id14">1 先创建模板</a></li>
<li class="toctree-l4"><a class="reference internal" href="#chart-yaml-values-yaml">2 修改 Chart.yaml，Values.yaml</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id21">3 模板和值</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id22">4. 自定义Charts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id25">5. 打包及分享</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#helm3-chart">Helm3 Chart多依赖微服务构建案例</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id26">1. 创建父chart</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id27">2. 创建子Chart</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id28">3.调试</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id34">4. 安装</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id36">5.优化</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id39">常见命令</a></li>
<li class="toctree-l3"><a class="reference internal" href="#helm3">Helm3内置对象</a></li>
<li class="toctree-l3"><a class="reference internal" href="#kubernetes-k8s-helm-efk">Kubernetes（k8s）Helm 部署 EFK 集群</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id40">搭建私有helm仓库及图形界面</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id41">参考文献</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../03.Docker%E7%BB%8F%E5%85%B8%E5%AE%9E%E4%BE%8B/index.html">03.Docker经典实例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04.Prometheus%E7%9B%91%E6%8E%A7%E8%BF%90%E7%BB%B4%E5%AE%9E%E6%88%98/index.html">04.Prometheus监控运维实战</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05.Kubernetes%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E8%B7%B5/index.html">05.Kubernetes入门到实践</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">小健_Docker_K8s_Blog</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">02.Kubernetes实战指南</a> &raquo;</li>
      <li>Helm简化Kubernetes部署</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/02.Kubernetes实战指南/20.Helm简化Kubernetes部署.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#helmkubernetes" id="id42">Helm简化Kubernetes部署</a></p>
<ul>
<li><p><a class="reference internal" href="#helm" id="id43">Helm基础</a></p></li>
<li><p><a class="reference internal" href="#helm-3-v3" id="id44">Helm 3 v3 变化</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id45">Helm的核心术语</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#helm-3" id="id46">Helm 3快速入门</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id47">安装</a></p>
<ul>
<li><p><a class="reference internal" href="#id3" id="id48">安装方式1</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id49">安装方式2</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#charts" id="id50">查看Charts仓库信息</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id51">常见操作</a></p></li>
<li><p><a class="reference internal" href="#stable-redisns-redis" id="id52">安装stable/redis在ns=redis中</a></p></li>
<li><p><a class="reference internal" href="#id6" id="id53">helm包检查项目</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id54">Helm安装和卸载</a></p></li>
<li><p><a class="reference internal" href="#helmdemo" id="id55">使用Helm部署Demo</a></p>
<ul>
<li><p><a class="reference internal" href="#chart" id="id56">chart 的基本结构</a></p></li>
<li><p><a class="reference internal" href="#helm-create" id="id57">helm create</a></p></li>
<li><p><a class="reference internal" href="#helm-package" id="id58">helm package</a></p></li>
<li><p><a class="reference internal" href="#helm-search" id="id59">helm search</a></p></li>
<li><p><a class="reference internal" href="#helm-inspect" id="id60">helm inspect</a></p></li>
<li><p><a class="reference internal" href="#id8" id="id61">Chart 模板示例</a></p></li>
<li><p><a class="reference internal" href="#id10" id="id62">编写一个简单的 Chart 示例</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id13" id="id63">Chart 模板开发指南</a></p>
<ul>
<li><p><a class="reference internal" href="#id14" id="id64">1 先创建模板</a></p></li>
<li><p><a class="reference internal" href="#chart-yaml-values-yaml" id="id65">2 修改 Chart.yaml，Values.yaml</a></p></li>
<li><p><a class="reference internal" href="#id21" id="id66">3 模板和值</a></p></li>
<li><p><a class="reference internal" href="#id22" id="id67">4. 自定义Charts</a></p></li>
<li><p><a class="reference internal" href="#id25" id="id68">5. 打包及分享</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#helm3-chart" id="id69">Helm3 Chart多依赖微服务构建案例</a></p>
<ul>
<li><p><a class="reference internal" href="#id26" id="id70">1. 创建父chart</a></p></li>
<li><p><a class="reference internal" href="#id27" id="id71">2. 创建子Chart</a></p></li>
<li><p><a class="reference internal" href="#id28" id="id72">3.调试</a></p></li>
<li><p><a class="reference internal" href="#id34" id="id73">4. 安装</a></p></li>
<li><p><a class="reference internal" href="#id36" id="id74">5.优化</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id39" id="id75">常见命令</a></p></li>
<li><p><a class="reference internal" href="#helm3" id="id76">Helm3内置对象</a></p></li>
<li><p><a class="reference internal" href="#kubernetes-k8s-helm-efk" id="id77">Kubernetes（k8s）Helm 部署 EFK 集群</a></p></li>
<li><p><a class="reference internal" href="#id40" id="id78">搭建私有helm仓库及图形界面</a></p></li>
<li><p><a class="reference internal" href="#id41" id="id79">参考文献</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="helmkubernetes">
<h1><a class="toc-backref" href="#id42">Helm简化Kubernetes部署</a><a class="headerlink" href="#helmkubernetes" title="Permalink to this headline">¶</a></h1>
<p>Helm是Kubernetes生态系统中的一个软件包管理工具，有点类似于Linux操作系统里面的“apt-get”和“yum”。</p>
<p>对Kubernetes集群进行部署应用时，我们将面临以下问题：</p>
<ul class="simple">
<li><p>如何管理、编辑和更新这些分散的Kubernetes应用配置文件。</p></li>
<li><p>如何把一套相关的配置文件作为一个应用进行管理。</p></li>
<li><p>如何分发和重用Kubernetes的应用配置。</p></li>
</ul>
<p>Helm的出现就是为了很好地解决上面这些问题。Helm
Chart是用来封装Kubernetes原生应用程序的一系列YAML文件。我们可以在部署应用的时候自定义应用程序的一些Metadata，以便于应用程序的分发。</p>
<p>对于应用发布者而言，可以通过Helm打包应用、管理应用依赖关系、管理应用版本并发布应用到软件仓库。</p>
<p>对于使用者而言，使用Helm后不需要编写复杂的应用部署文件，可以以简单的方式在Kubernetes上查找、安装、升级、回滚、卸载应用程序。</p>
<p>总之，Helm大大简化了应用管理的难度，其主要有以下优点：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>● 管理复杂应用,Charts能够描述哪怕是最复杂的程序结构，其提供了可重复使用的应用安装的定义。
● 易于更新升级,使用就地升级和自定义钩子来解决更新的难题。
● 易于共享。Charts无论是在私有服务器还是公共服务器上，都非常易于升级、共享和托管。
● 轻松回滚，可使用“helm rollback”命令轻松实现快速回滚。
</pre></div>
</div>
<section id="helm">
<h2><a class="toc-backref" href="#id43">Helm基础</a><a class="headerlink" href="#helm" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Helm</p></li>
</ul>
<p>Helm是一个命令行下的客户端工具，主要用于Kubernetes应用程序Chart的创建、打包、发布以及创建和管理本地和远程的Chart仓库。</p>
<ul class="simple">
<li><p>Tiller</p></li>
</ul>
<p>Tiller是Helm的服务端，部署在Kubernetes集群中。Tiller用于接收Helm的请求，并根据Chart生成Kubernetes的部署文件（Helm称为Release），然后提交给Kubernetes创建应用。Tiller还提供了Release的升级、删除、回滚等一系列功能。</p>
<ul class="simple">
<li><p>Chart</p></li>
</ul>
<p>Helm的软件包，采用TAR格式，类似于APT的DEB包或者YUM的RPM包，其包含了一组定义Kubernetes资源相关的YAML文件。</p>
<ul class="simple">
<li><p>Repository</p></li>
</ul>
<p>Helm的软件仓库，保存了一系列的Chart软件包，以供用户下载；并且提供了一个该Repository的Chart包清单文件，以供用户查询。Helm可以同时管理多个不同的Repository。</p>
<ul class="simple">
<li><p>Config</p></li>
</ul>
<p>应用程序实例化部署运行时的配置信息。</p>
<ul class="simple">
<li><p>Release</p></li>
</ul>
<p>使用helm
install命令在Kubernetes集群中部署的Chart称为Release。Helm中提到的Release和我们通常概念中的版本有所不同，这里的Release可以理解为Helm使用Chart包部署的一个应用实例。在同一个集群中，一个Chart可以使用不同的配置（Config）安装多次，每次安装都会创建一个Release。</p>
</section>
<section id="helm-3-v3">
<h2><a class="toc-backref" href="#id44">Helm 3 v3 变化</a><a class="headerlink" href="#helm-3-v3" title="Permalink to this headline">¶</a></h2>
<p>2019 年 11 月 13 日， Helm 团队发布 Helm v3 的第一个稳定版本。
该版本主要变化如下： 架构变化：</p>
<p><img alt="image0" src="../_images/k8s-helmv30001.png" /></p>
<ol class="arabic simple">
<li><p>最明显的变化是 Tiller 的删除</p></li>
<li><p>Release 名称可以在不同命名空间重用</p></li>
<li><p>支持将 Chart 推送至 Docker 镜像仓库中</p></li>
<li><p>使用 JSONSchema 验证 chart values</p></li>
<li><p>其他</p></li>
</ol>
<section id="id1">
<h3><a class="toc-backref" href="#id45">Helm的核心术语</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Helm将Kubernetes应用的相关配置组织为Charts，并通过它完成应用的常规管理操作。通常来说，使用Charts管理应用的流程包括从0开始创建Charts、将Charts及其相关的文件打包为归档格式、将Charts存储于仓库（repository）中并与之交互、在Kubernetes集群中安装或卸载Charts以及管理经Helm安装的应用的版本发行周期。因此，对Helm来说，它具有以下几个关键概念。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>·Charts：即一个Helm程序包，它包含了运行一个Kubernetes应用所需要的镜像、依赖关系和资源定义等，必要时还会包含Service的定义；它类似于APT的dpkg文件或者yum的rpm文件。

·Repository：Charts仓库，用于集中存储和分发Charts，类似于Perl的CPAN，或者Python的PyPI。

·Config：应用程序实例化安装运行时使用的配置信息。

·Release：应用程序实例化配置后运行于Kubernetes集群中的一个Charts实例；在同一个集群上，一个Charts可以使用不同的Config重复安装多次，每次安装都会创建一个新的Release。
</pre></div>
</div>
</section>
</section>
<section id="helm-3">
<h2><a class="toc-backref" href="#id46">Helm 3快速入门</a><a class="headerlink" href="#helm-3" title="Permalink to this headline">¶</a></h2>
<p>Helm的版本v2和版本v3目前处于维护当中，考虑了轻量、安全等特性，这里选择只介绍较新的版本v3的部署和使用，版本v2需要额外部署Tiller，而客户端的使用方法大多数都与版本v3相同。</p>
<p>Helm的每个发行版都提供了主流操作系统的专用版本，主要包括Linux、Mac
OS和Windows，用户安装前按需下载合用的平台上的相关发行版本即可。</p>
<p>Helm项目托管在GitHub之上，项目地址为https://github.com/kubernetes/helm
。</p>
</section>
<section id="id2">
<h2><a class="toc-backref" href="#id47">安装</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<section id="id3">
<h3><a class="toc-backref" href="#id48">安装方式1</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>下载最新的helm 3安装脚本</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
</pre></div>
</div>
<p>赋权并执行</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>chmod <span class="m">700</span> get_helm.sh <span class="o">&amp;&amp;</span> sh get_helm.sh
</pre></div>
</div>
<p>通过执行helm命令来验证helm安装。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm</span>
</pre></div>
</div>
<p>增加一个公有稳定版的helm的repo仓库</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>helm repo add stable https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts
</pre></div>
</div>
<p>让我们安装稳定的nginx 图表并测试设置</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm</span> <span class="n">install</span> <span class="n">nginx</span> <span class="n">stable</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span>
</pre></div>
</div>
<p>列出已安装的helm 图表</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm</span> <span class="n">ls</span>
</pre></div>
</div>
</section>
<section id="id4">
<h3><a class="toc-backref" href="#id49">安装方式2</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>安装helm-v3</p>
<p>使用一条命令安装helm</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">L</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">git</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">get_helm</span><span class="o">.</span><span class="n">sh</span> <span class="o">|</span> <span class="n">bash</span>
</pre></div>
</div>
<p>如果安装包无法下载，可以复制脚本输出的下载链接手动下载，然后解压复制到bin目录，如下所示：</p>
<p>Helm 客户端下载地址：<a class="reference external" href="https://github.com/helm/helm/releases">https://github.com/helm/helm/releases</a>
解压移动到/usr/bin/目录即可。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>wget https://get.helm.sh/helm-vv3.2.1-linux-amd64.tar.gz
tar zxvf helm-v3.2.1-linux-amd64.tar.gz
mv linux-amd64/helm /usr/bin/
</pre></div>
</div>
<p>设置helm自动补全</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s2">&quot;source &lt;(helm completion bash)&quot;</span> &gt;&gt;  ~/.bash_profile
<span class="nb">source</span>  ~/.bash_profile
</pre></div>
</div>
<blockquote>
<div><p><strong>helm3的安装和部署</strong></p>
<p>Kubernetes的包管理工具Helm3</p>
<p><a class="reference external" href="https://blog.csdn.net/qq_39680564/article/details/107201496">https://blog.csdn.net/qq_39680564/article/details/107201496</a></p>
</div></blockquote>
</section>
</section>
<section id="charts">
<h2><a class="toc-backref" href="#id50">查看Charts仓库信息</a><a class="headerlink" href="#charts" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@ci</span><span class="o">-</span><span class="n">base</span> <span class="n">home</span><span class="p">]</span><span class="c1"># helm repo list</span>
<span class="n">NAME</span>            <span class="n">URL</span>
<span class="n">ingress</span><span class="o">-</span><span class="n">nginx</span>   <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">github</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">ingress</span><span class="o">-</span><span class="n">nginx</span>
<span class="n">stable</span>          <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">mirror</span><span class="o">.</span><span class="n">azure</span><span class="o">.</span><span class="n">cn</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">charts</span>
<span class="n">aliyun</span>          <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">oss</span><span class="o">-</span><span class="n">cn</span><span class="o">-</span><span class="n">hangzhou</span><span class="o">.</span><span class="n">aliyuncs</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">charts</span>
</pre></div>
</div>
</section>
<section id="id5">
<h2><a class="toc-backref" href="#id51">常见操作</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>4.2  配置国内 t chart  仓库

 微软仓库（http://mirror.azure.cn/kubernetes/charts/）这个仓库推荐，基本上官网有的 chart 这里都有。

 阿里云仓库（https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts ）

 官方仓库（https://hub.kubeapps.com/charts/incubator）官方 chart 仓库，国内有点不好使。


#添加存储库
helm repo add stable http://mirror.azure.cn/kubernetes/charts
helm repo add aliyun https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts
helm repo update


#查看配置的存储库
helm repo list
helm search repo stable


#删除存储库：
helm repo remove aliyun


# 列出stable仓库中维护的所有Charts的列表
helm search repo

# 列出复合条件的Charts，过滤器查找
helm search repo redis
helm ls --all-namespaces



# 查看Charts的详细信息
[root@ci-base k8s_yaml]# helm show chart stable/redis
apiVersion: v1
appVersion: 4.0.8
description: Open source, advanced key-value store. It is often referred to as a data
  structure server since keys can contain strings, hashes, lists, sets and sorted
  sets.
home: http://redis.io/
icon: https://bitnami.com/assets/stacks/redis/img/redis-stack-220x234.png
keywords:
- redis
- keyvalue
- database
maintainers:
- email: containers@bitnami.com
  name: bitnami-bot
name: redis
sources:
- https://github.com/bitnami/bitnami-docker-redis
version: 1.1.15


[root@ci-base home]# helm inspect chart stable/redis
apiVersion: v1
appVersion: 5.0.7
deprecated: true
description: DEPRECATED Open source, advanced key-value store. It is often referred
  to as a data structure server since keys can contain strings, hashes, lists, sets
  and sorted sets.
home: http://redis.io/
icon: https://bitnami.com/assets/stacks/redis/img/redis-stack-220x234.png
keywords:
- redis
- keyvalue
- database
name: redis
sources:
- https://github.com/bitnami/bitnami-docker-redis
version: 10.5.7


#查看发布状态
# helm list
</pre></div>
</div>
</section>
<section id="stable-redisns-redis">
<h2><a class="toc-backref" href="#id52">安装stable/redis在ns=redis中</a><a class="headerlink" href="#stable-redisns-redis" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>//创建
helm search repo redis
kubectl create namespace redis
helm install chart stable/redis -n redis --dry-run
helm install chart stable/redis -n redis

Helm支持四种安装方法：

（1）安装仓库中的chart，例如helm install stable/nginx。

（2）通过tar包安装，例如helm install ./nginx-1.2.3.tgz。

（3）通过chart本地目录安装，例如helm install ./nginx。

（4）通过URL安装，例如helm install https://example.com/charts/nginx-1.2.3.tgz。



//查看创建的charts,查看所有ns
[root@ci-base home]# helm list --all-namespaces
NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION
chart           redis           1               2020-11-13 15:11:53.740004087 +0800 CST deployed        redis-10.5.7            5.0.7

//查看单个ns
[root@ci-base ~]# helm list -n ci-gitee-10523


//删除命名空间中的chart
[root@ci-base home]# helm -n redis uninstall chart
release &quot;chart&quot; uninstalled

[root@ci-base home]# helm list -A
NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># 安装stable/redis

//创建
[root@ci-base home]# helm install redis stable/redis

//指定value.yaml文件创建
helm install -f 12705values.yaml -n ci-gitee-12705 ci-gitee-12705 ./


//查看
[root@ci-base home]# helm list
NAME    NAMESPACE       REVISION        UPDATED                                 STATUS          CHART           APP VERSION
redis   default         1               2020-11-13 15:24:01.368251708 +0800 CST deployed        redis-10.5.7    5.0.7



//删除
[root@ci-base home]# helm uninstall redis
或者使用delete

[root@ci-base home]# helm delete redis
release &quot;redis&quot; uninstalled

[root@ci-base home]# helm list


# 回滚
helm rollback
//命令格式：
helm rollback &lt;RELEASE&gt; [REVISION] [flags]
[aiops@3 test]$ helm rollback helloworld 1


# 升级
helm upgrade

//命令语法：
helm uninstall RELEASE_NAME [flags]

# 获取指定Release变更历史
helm history

//获取某个release历史的安装更新记录
$ helm history helloworld


# helm pull
//从chart仓库中下载打包好的chart到本地存储
[aiops@3 test]$ helm pull stable/mysql
</pre></div>
</div>
</section>
<section id="id6">
<h2><a class="toc-backref" href="#id53">helm包检查项目</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># helm包检查项目</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@ci</span><span class="o">-</span><span class="n">base</span> <span class="o">~</span><span class="p">]</span><span class="c1"># helm list --all-namespaces</span>

<span class="o">//</span> <span class="n">查看Config</span><span class="o">-</span><span class="n">Map</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@ci</span><span class="o">-</span><span class="n">base</span> <span class="o">~</span><span class="p">]</span><span class="c1"># kubectl get cm -n ci-gitee-10523</span>

<span class="o">//</span> <span class="n">查看Deployment</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@ci</span><span class="o">-</span><span class="n">base</span> <span class="o">~</span><span class="p">]</span><span class="c1"># kubectl get Deployment -n ci-gitee-10523</span>

<span class="o">//</span> <span class="n">查看service</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@ci</span><span class="o">-</span><span class="n">base</span> <span class="o">~</span><span class="p">]</span><span class="c1"># kubectl get svc -n ci-gitee-10523</span>

<span class="o">//</span> <span class="n">查看ingress</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@ci</span><span class="o">-</span><span class="n">base</span> <span class="o">~</span><span class="p">]</span><span class="c1"># kubectl get Ingress -n ci-gitee-10523</span>

<span class="o">//</span> <span class="n">查看pod</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@ci</span><span class="o">-</span><span class="n">base</span> <span class="o">~</span><span class="p">]</span><span class="c1"># kubectl get pod -n ci-gitee-10523</span>

<span class="o">//</span> <span class="n">查看ReplicaSet</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@k8s</span><span class="o">-</span><span class="n">master</span> <span class="o">~</span><span class="p">]</span><span class="c1"># kubectl get rs -lapp=demo</span>

<span class="p">[</span><span class="n">root</span><span class="nd">@k8s</span><span class="o">-</span><span class="n">master</span> <span class="o">~</span><span class="p">]</span><span class="c1"># kubectl get rs -lapp=demo --show-labels</span>
<span class="n">NAME</span>                         <span class="n">DESIRED</span>   <span class="n">CURRENT</span>   <span class="n">READY</span>   <span class="n">AGE</span>   <span class="n">LABELS</span>
<span class="n">demo</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">68</span><span class="n">b59dd5b8</span>   <span class="mi">2</span>         <span class="mi">2</span>         <span class="mi">2</span>       <span class="mi">73</span><span class="n">m</span>   <span class="n">app</span><span class="o">=</span><span class="n">demo</span><span class="p">,</span><span class="n">pod</span><span class="o">-</span><span class="n">template</span><span class="o">-</span><span class="nb">hash</span><span class="o">=</span><span class="mi">68</span><span class="n">b59dd5b8</span>



<span class="c1"># 查看资源信息</span>
<span class="o">//</span> <span class="n">查看pod里面的容器</span>
<span class="n">kubectl</span> <span class="n">describe</span> <span class="o">-</span><span class="n">n</span> <span class="n">dev</span> <span class="n">pod</span> <span class="n">cigiteebe</span><span class="o">-</span><span class="mi">7</span><span class="n">c5b7486c</span><span class="o">-</span><span class="n">pc22z</span>
</pre></div>
</div>
</section>
<section id="id7">
<h2><a class="toc-backref" href="#id54">Helm安装和卸载</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># helm安装和卸载
[root@ci-base home]# helm install myapp --debug ./mychart --set service.type=NodePort
[root@ci-base home]# helm uninstall myapp


[root@ci-base home]# helm uninstall chart
[root@ci-base home]# helm list


# 删除命名空间ci-gitee-11856中的chart
helm uninstall -n ci-gitee-11856 ci-gitee-11856



#删除命名空间dev中的chart
helm uninstall -n dev dev


正确姿势
1、brew install helm
2、helm repo add stable http://mirror.azure.cn/kubernetes/charts/
3、helm repo update
4、helm install stable/xxx



helm install --name myapp --dry-run --debug ./mychart --set service.type=NodePort
helm install --name myapp --debug ./mychart --set service.type=NodePort
</pre></div>
</div>
</section>
<section id="helmdemo">
<h2><a class="toc-backref" href="#id55">使用Helm部署Demo</a><a class="headerlink" href="#helmdemo" title="Permalink to this headline">¶</a></h2>
<p>事实上，一个单独的Charts既能用于部署简单应用，例如一个memcached
Pod，也能部署复杂的应用，如由HTTP服务器、DB服务器、Cache服务器和应用程序服务器等共同组成的Web应用栈。</p>
<p>接下来我们基于以上认知和Demo配置来进行部署，流程如图</p>
<p><img alt="image1" src="../_images/k8s-helm0001.png" /></p>
<section id="chart">
<h3><a class="toc-backref" href="#id56">chart 的基本结构</a><a class="headerlink" href="#chart" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[root@ci-base helm]# helm create test
Creating test

[root@ci-base helm]# tree test/ -L 3
test/
├── charts
├── Chart.yaml
├── templates
│    ├── deployment.yaml
│    ├── _helpers.tpl
│    ├── hpa.yaml
│    ├── ingress.yaml
│    ├── NOTES.txt
│    ├── serviceaccount.yaml
│    ├── service.yaml
│    └── tests
│        └── test-connection.yaml
└── values.yaml
</pre></div>
</div>
<ul class="simple">
<li><p>charts 目录存放依赖的chart</p></li>
<li><p>Chart.yaml 包含Chart的基本信息，包括chart版本，名称等</p></li>
<li><p>templates 目录下存放应用一系列 k8s 资源的 yaml 模板</p></li>
<li><p>_helpers.tpl
此文件中定义一些可重用的模板片断，此文件中的定义在任何资源定义模板中可用</p></li>
<li><p>NOTES.txt 介绍chart 部署后的帮助信息，如何使用chart等</p></li>
<li><p>values.yaml 包含了必要的值定义（默认值）, 用于存储 templates
目录中模板文件中用到变量的值</p></li>
</ul>
</section>
<section id="helm-create">
<h3><a class="toc-backref" href="#id57">helm create</a><a class="headerlink" href="#helm-create" title="Permalink to this headline">¶</a></h3>
<p>创建一个 Chart 模板</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># helm create test</span>
<span class="n">Creating</span> <span class="n">test</span>
</pre></div>
</div>
</section>
<section id="helm-package">
<h3><a class="toc-backref" href="#id58">helm package</a><a class="headerlink" href="#helm-package" title="Permalink to this headline">¶</a></h3>
<p>打包一个 Chart 模板</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@ci</span><span class="o">-</span><span class="n">base</span> <span class="n">helm</span><span class="p">]</span><span class="c1"># helm package test</span>
<span class="n">Successfully</span> <span class="n">packaged</span> <span class="n">chart</span> <span class="ow">and</span> <span class="n">saved</span> <span class="n">it</span> <span class="n">to</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">k8s</span><span class="o">-</span><span class="n">example</span><span class="o">/</span><span class="n">helm</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="mf">0.1</span><span class="o">.</span><span class="mf">0.</span><span class="n">tgz</span>
</pre></div>
</div>
</section>
<section id="helm-search">
<h3><a class="toc-backref" href="#id59">helm search</a><a class="headerlink" href="#helm-search" title="Permalink to this headline">¶</a></h3>
<p>查找可用的 Chart 模板</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@ci</span><span class="o">-</span><span class="n">base</span> <span class="n">helm</span><span class="p">]</span><span class="c1"># helm search hub nginx</span>
<span class="n">URL</span>                                                     <span class="n">CHART</span> <span class="n">VERSION</span>   <span class="n">APP</span> <span class="n">VERSION</span>     <span class="n">DESCRIPTION</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">hub</span><span class="o">.</span><span class="n">helm</span><span class="o">.</span><span class="n">sh</span><span class="o">/</span><span class="n">charts</span><span class="o">/</span><span class="n">wiremind</span><span class="o">/</span><span class="n">nginx</span>               <span class="mf">2.1</span><span class="o">.</span><span class="mi">1</span>                           <span class="n">An</span> <span class="n">NGINX</span> <span class="n">HTTP</span> <span class="n">server</span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">hub</span><span class="o">.</span><span class="n">helm</span><span class="o">.</span><span class="n">sh</span><span class="o">/</span><span class="n">charts</span><span class="o">/</span><span class="n">bitnami</span><span class="o">/</span><span class="n">nginx</span>                <span class="mf">8.2</span><span class="o">.</span><span class="mi">3</span>           <span class="mf">1.19</span><span class="o">.</span><span class="mi">6</span>          <span class="n">Chart</span> <span class="k">for</span> <span class="n">the</span> <span class="n">nginx</span> <span class="n">server</span>
<span class="o">.........</span>
</pre></div>
</div>
</section>
<section id="helm-inspect">
<h3><a class="toc-backref" href="#id60">helm inspect</a><a class="headerlink" href="#helm-inspect" title="Permalink to this headline">¶</a></h3>
<p>查看指定 Chart 的基本信息</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@ci</span><span class="o">-</span><span class="n">base</span> <span class="n">helm</span><span class="p">]</span><span class="c1"># helm inspect chart test</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v2</span>
<span class="n">appVersion</span><span class="p">:</span> <span class="mf">1.16</span><span class="o">.</span><span class="mi">0</span>
<span class="n">description</span><span class="p">:</span> <span class="n">A</span> <span class="n">Helm</span> <span class="n">chart</span> <span class="k">for</span> <span class="n">Kubernetes</span>
<span class="n">name</span><span class="p">:</span> <span class="n">test</span>
<span class="nb">type</span><span class="p">:</span> <span class="n">application</span>
<span class="n">version</span><span class="p">:</span> <span class="mf">0.1</span><span class="o">.</span><span class="mi">0</span>
</pre></div>
</div>
</section>
<section id="id8">
<h3><a class="toc-backref" href="#id61">Chart 模板示例</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<section id="id9">
<h4>Chart 文件结构<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>wordpress
├── charts
├── Chart.yaml
├── README.md
├── requirements.lock
├── requirements.yaml
├── templates
│   ├── deployment.yaml
│   ├── externaldb-secrets.yaml
│   ├── _helpers.tpl
│   ├── ingress.yaml
│   ├── NOTES.txt
│   ├── pvc.yaml
│   ├── secrets.yaml
│   ├── svc.yaml
│   └── tls-secrets.yaml
└── values.yaml
</pre></div>
</div>
<p>一个 wordpress chart 如上（去除部分 test 和 charts 依赖），
基本结构由以下几个部分组成：</p>
<ul class="simple">
<li><p>charts 存放子Chart (Subchart) 的定义，Subchart 指的是当前 Chart
依赖的 Chart ， 在 requirements.yaml 中定义</p></li>
<li><p>Chart.yaml 包含 Chart 信息的 YAML 文件， 包括 Chart
的版本、名称等，在 DCE Helm 插件中还包含 Chart 的 <strong>团队授权</strong> 信息
和 <strong>是否公开</strong> 的信息</p></li>
<li><p>README.md 可选：Chart 的介绍信息等（该文件对于一个大型 Chart
来说十分重要）</p></li>
<li><p>Requirements.yaml 可选：列举当前 Chart 的需要依赖的 Chart</p></li>
<li><p>templates</p>
<ul>
<li><p>该目录下存放 Chart 所有的 K8s
资源定义模板，通常不同的资源放在不同的文件中，DCE Helm
插件中自定义模板的 K8s 资源统一放在 all_sources.yaml 文件中</p></li>
<li><p>_helpers.tpl ，
通常这个文件存放可重用的模板片段，该文件中的定义可以在 Chart
其它资源定义模板中使用</p></li>
<li><p>NOTES.txt，可选：一段简短使用说明的文本文件，用于安装 Release
后提示用户使用</p></li>
</ul>
</li>
<li><p>values.yaml 当前 Chart 的默认配置的值</p></li>
</ul>
<p>我们查看下使用 <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">create</span></code> 命令自动生成的 <code class="docutils literal notranslate"><span class="pre">templates/service.yaml</span></code>
文件。</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">include &quot;mychart.fullname&quot; .</span> <span class="p p-Indicator">}}</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="p p-Indicator">{{</span><span class="nv">- include &quot;mychart.labels&quot; . | nindent 4</span> <span class="p p-Indicator">}}</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">type</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.service.type</span> <span class="p p-Indicator">}}</span>
  <span class="nt">ports</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.service.port</span> <span class="p p-Indicator">}}</span>
      <span class="nt">targetPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
      <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="p p-Indicator">{{</span><span class="nv">- include &quot;mychart.selectorLabels&quot; . | nindent 4</span> <span class="p p-Indicator">}}</span>
</pre></div>
</div>
<p>可以看到其中有很多<code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">}}</span></code> 包围的字段，这是使用的 <a class="reference external" href="https://golang.org/pkg/text/template/">Go
template</a>
创建的自定义字段，其中 <code class="docutils literal notranslate"><span class="pre">mychart</span></code> 开头的都是在 <code class="docutils literal notranslate"><span class="pre">_helpers.tpl</span></code>
中生成的定义。</p>
</section>
</section>
<section id="id10">
<h3><a class="toc-backref" href="#id62">编写一个简单的 Chart 示例</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>本节以构建一个名称为 nginx-test Chart 为示例，来描述一个 chart
必要条件。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># helm create nginx-test</span>
<span class="n">Creating</span> <span class="n">nginx</span><span class="o">-</span><span class="n">test</span>
</pre></div>
</div>
<p>1、Chart.yaml 文件是 一个 chart 必要文件，
该文件可以简单包括以下字段（具体字段请参考<a class="reference external" href="https://links.jianshu.com/go?to=https%3A%2F%2Fhelm.sh%2F">Helm官网</a>)</p>
<section id="chart-yaml">
<h4>Chart.yaml文件组织格式<a class="headerlink" href="#chart-yaml" title="Permalink to this headline">¶</a></h4>
<p>Chart.yaml用于提供Charts相关的各种元数据，如名称、版本、关键词、维护者信息、使用的模板引擎等，它是一个Charts必备的核心文件，主要包含以下字段。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>·name：当前Charts的名称，必选字段。

·version：遵循语义化版本规范第2版的版本号，必选字段。

·description：当前项目的单语句描述信息，可选字段。

·keywords：当前项目的关键词列表，可选字段。

·home：当前项目的主页URL，可选字段。

·sources：当前项目用到的源码的来源URL列表，可选字段。

·maintainers：项目维护者信息，主要嵌套name、email和URL几个属性组成；可选字段。

·engine：模板引擎的名称，默认为gotpl，即go模板。

·icon：URL，指向当前项目的图标，SVG或PNG格式的图片；可选字段。

·appVersion：本项目用到的应用程序的版本号，可选字段，且不必为语义化版本。

·deprecated：当前Charts是否已废弃，可选字段，布尔型值。

·tillerVersion：当前Charts依赖的Tiller版本号，可以是语义化版本号的范围，如“&gt;2.4.0”；可选字段。
</pre></div>
</div>
<p>面的示例信息是redis
Charts中使用的Chart.yaml的内容，用户自行定义Charts编写相关文件时，要采用类似的文件格式：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">appVersion</span><span class="p">:</span> <span class="mf">4.0</span><span class="o">.</span><span class="mi">9</span>
<span class="n">description</span><span class="p">:</span> <span class="n">Open</span> <span class="n">source</span><span class="p">,</span> <span class="n">advanced</span> <span class="n">key</span><span class="o">-</span><span class="n">value</span> <span class="n">store</span><span class="o">.</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">often</span> <span class="n">referred</span>
  <span class="n">to</span> <span class="k">as</span> <span class="n">a</span> <span class="n">data</span> <span class="n">structure</span> <span class="n">server</span> <span class="n">since</span> <span class="n">keys</span> <span class="n">can</span> <span class="n">contain</span> <span class="n">strings</span><span class="p">,</span> <span class="n">hashes</span><span class="p">,</span>
  <span class="n">lists</span><span class="p">,</span> <span class="n">sets</span> <span class="ow">and</span> <span class="nb">sorted</span> <span class="n">sets</span><span class="o">.</span>
<span class="n">engine</span><span class="p">:</span> <span class="n">gotpl</span>
<span class="n">home</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">redis</span><span class="o">.</span><span class="n">io</span><span class="o">/</span>
<span class="n">icon</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">bitnami</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">assets</span><span class="o">/</span><span class="n">stacks</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">img</span><span class="o">/</span><span class="n">redis</span><span class="o">-</span><span class="n">stack</span><span class="o">-</span><span class="mi">220</span><span class="n">x234</span><span class="o">.</span><span class="n">png</span>
<span class="n">keywords</span><span class="p">:</span>
<span class="o">-</span> <span class="n">redis</span>
<span class="o">-</span> <span class="n">keyvalue</span>
<span class="o">-</span> <span class="n">database</span>
<span class="n">maintainers</span><span class="p">:</span>
<span class="o">-</span> <span class="n">email</span><span class="p">:</span> <span class="n">containers</span><span class="nd">@bitnami</span><span class="o">.</span><span class="n">com</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">bitnami</span><span class="o">-</span><span class="n">bot</span>
<span class="n">name</span><span class="p">:</span> <span class="n">redis</span>
<span class="n">sources</span><span class="p">:</span>
<span class="o">-</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">bitnami</span><span class="o">/</span><span class="n">bitnami</span><span class="o">-</span><span class="n">docker</span><span class="o">-</span><span class="n">redis</span>
<span class="n">version</span><span class="p">:</span> <span class="mf">3.3</span><span class="o">.</span><span class="mi">0</span>
</pre></div>
</div>
<p>nginx-test的Charts中使用的Chart.yaml的内容</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@ci</span><span class="o">-</span><span class="n">base</span> <span class="n">helm</span><span class="p">]</span><span class="c1"># cat nginx-test/Chart.yaml |grep -v &quot;^$&quot;|grep -v &quot;^#&quot;</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v2</span>
<span class="n">name</span><span class="p">:</span> <span class="n">nginx</span><span class="o">-</span><span class="n">test</span>
<span class="n">description</span><span class="p">:</span> <span class="n">A</span> <span class="n">Helm</span> <span class="n">chart</span> <span class="k">for</span> <span class="n">Kubernetes</span>
<span class="nb">type</span><span class="p">:</span> <span class="n">application</span>
<span class="n">version</span><span class="p">:</span> <span class="mf">0.1</span><span class="o">.</span><span class="mi">0</span>
<span class="n">appVersion</span><span class="p">:</span> <span class="mf">1.16</span><span class="o">.</span><span class="mi">0</span>
</pre></div>
</div>
</section>
<section id="id11">
<h4>Charts中的依赖关系<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<p>requirements.yaml文件</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>·name：被依赖的Charts的名称。

·version：被依赖的Charts的版本。

·repository：被依赖的Charts所属的仓库及其URL；如果是非官方的仓库，则需要先用helm repo add命令将其添加进本地可用仓库。

·alias：为被依赖的Charts创建一个别名，从而让当前Charts可以将所依赖的Charts对应到新名称，即别名；可选字段。

·tags：默认情况下所有的Charts都会被装载，若给定了tags，则仅装载那些匹配到的Charts。

·condition：类似于tags字段，但需要通过自定义的条件来指明要装载的charts。

·import-values：导入子Charts中的的值；被导入的值需要在子charts中导出。
</pre></div>
</div>
<p>如下所示的示例，是Wordpress Charts中定义的动态依赖关系：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dependencies</span><span class="p">:</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">mariadb</span>
  <span class="n">version</span><span class="p">:</span> <span class="mf">2.1</span><span class="o">.</span><span class="mi">1</span>
  <span class="n">repository</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">charts</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">googleapis</span><span class="o">.</span><span class="n">com</span><span class="o">/</span>
  <span class="n">condition</span><span class="p">:</span> <span class="n">mariadb</span><span class="o">.</span><span class="n">enabled</span>
  <span class="n">tags</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">wordpress</span><span class="o">-</span><span class="n">database</span>
</pre></div>
</div>
<p>一旦依赖关系文件配置完成，即可使用“helm dependency
update”命令更新依赖关系，并自动下载被依赖的Charts至charts/目录中。</p>
<p><strong>helm3
v2版本中。已经将依赖requirements.yaml去掉，默认requirements.yaml的内容直接写入Chart.yaml中。</strong></p>
</section>
<section id="id12">
<h4>Charts目录<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<p>若需要对依赖关系进行更多的控制，则所有被依赖到的Charts都能以手工方式直接复制到Charts目录中。一个被依赖到的Charts既可以是归档格式，也可以是展开的目录格式，不过，其名称不能以下划线（_）或点号（.）开头，此类文件会被Charts装载器自动忽略。</p>
<p>例如，Wordpress Charts依赖关系在其Charts目录中的反映类似如下所示：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>charts/
└── mariadb
    ├── Chart.yaml
    ├── README.md
    ├── templates
    │   ├── configmap.yaml
    │   ├── deployment.yaml
    │   ├── _helpers.tpl
    │   ├── NOTES.txt
    │   ├── pvc.yaml
    │   ├── secrets.yaml
    │   ├── svc.yaml
    │   ├── test-runner.yaml
    │   └── tests.yaml
    └── values.yaml
</pre></div>
</div>
<p>2、values.yaml 文件是 chart 的必要文件，以 nginx 为示例：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@ci</span><span class="o">-</span><span class="n">base</span> <span class="n">helm</span><span class="p">]</span><span class="c1"># cat nginx-test/values.yaml |grep -v &quot;^$&quot;|grep -v &quot;#&quot;</span>
<span class="n">replicaCount</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">image</span><span class="p">:</span>
  <span class="n">repository</span><span class="p">:</span> <span class="n">nginx</span>
  <span class="n">pullPolicy</span><span class="p">:</span> <span class="n">IfNotPresent</span>
  <span class="n">tag</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
<span class="n">imagePullSecrets</span><span class="p">:</span> <span class="p">[]</span>
<span class="n">nameOverride</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
<span class="n">fullnameOverride</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
<span class="n">serviceAccount</span><span class="p">:</span>
  <span class="n">create</span><span class="p">:</span> <span class="n">true</span>
  <span class="n">annotations</span><span class="p">:</span> <span class="p">{}</span>
  <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
<span class="n">podAnnotations</span><span class="p">:</span> <span class="p">{}</span>
<span class="n">podSecurityContext</span><span class="p">:</span> <span class="p">{}</span>
<span class="n">securityContext</span><span class="p">:</span> <span class="p">{}</span>
<span class="n">service</span><span class="p">:</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">ClusterIP</span>
  <span class="n">port</span><span class="p">:</span> <span class="mi">80</span>
<span class="n">ingress</span><span class="p">:</span>
  <span class="n">enabled</span><span class="p">:</span> <span class="n">false</span>
  <span class="n">annotations</span><span class="p">:</span> <span class="p">{}</span>
  <span class="n">hosts</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">host</span><span class="p">:</span> <span class="n">chart</span><span class="o">-</span><span class="n">example</span><span class="o">.</span><span class="n">local</span>
      <span class="n">paths</span><span class="p">:</span> <span class="p">[]</span>
  <span class="n">tls</span><span class="p">:</span> <span class="p">[]</span>
<span class="n">resources</span><span class="p">:</span> <span class="p">{}</span>
<span class="n">autoscaling</span><span class="p">:</span>
  <span class="n">enabled</span><span class="p">:</span> <span class="n">false</span>
  <span class="n">minReplicas</span><span class="p">:</span> <span class="mi">1</span>
  <span class="n">maxReplicas</span><span class="p">:</span> <span class="mi">100</span>
  <span class="n">targetCPUUtilizationPercentage</span><span class="p">:</span> <span class="mi">80</span>
<span class="n">nodeSelector</span><span class="p">:</span> <span class="p">{}</span>
<span class="n">tolerations</span><span class="p">:</span> <span class="p">[]</span>
<span class="n">affinity</span><span class="p">:</span> <span class="p">{}</span>
</pre></div>
</div>
<p>从示例中可以看出，values.yaml 中定义了一些当前chart 的一些默认值，用于
templates 下的 K8s 资源 yaml 渲染时填充默认值。</p>
<p>不过需要注意的是，<strong>如果使用 helm install 来部署一个 Release ,
可以通过下面命令指定一份yaml 文件作为填充值</strong>：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm</span> <span class="n">install</span> <span class="o">--</span><span class="n">values</span><span class="o">=</span><span class="n">myvals</span><span class="o">.</span><span class="n">yaml</span> <span class="n">nginx</span>
</pre></div>
</div>
<blockquote>
<div><p>注意：上面命令不要复制执行，执行会报错的。请根据实际情况执行！！！</p>
</div></blockquote>
<p>3、创建 templates 下的模板文件， 用于生成 Kubernetes 资源清单(manifests)
如下所示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cat nginx-test/templates/deployment.yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="p">{{</span> <span class="n">include</span> <span class="s2">&quot;nginx-test.fullname&quot;</span> <span class="o">.</span> <span class="p">}}</span>
  <span class="n">labels</span><span class="p">:</span>
<span class="o">...</span>
</pre></div>
</div>
<p>上面定义了 一个 deployments.yaml 和 service.yaml 资源文件，里面使用 {{
}} 符号的是 Go 模板语言的标准。其中可以通过：</p>
<ul class="simple">
<li><p>.Values 对象访问 values.yaml 文件的内容， 前面的dot(.)
表示从顶层命名空间开始，找到 Values 对象(下同)</p></li>
<li><p>.Release、.Chart 开头的预定义值可用于任何的模板中</p></li>
<li><p>.Chart 对象用来访问 Chart.yaml 文件的内容</p></li>
<li><p>.Release 对象是 Helm的内置对象之一， 使用 Helm 安装一个 release
时，由 Tiller 分配 release 的名称</p></li>
</ul>
<p>4、命名模板(_helper.tpl) ：可以从上面看到有 {{ template
“nginx-test.fullname” . }} 定义。该定义由 _helper.tpl
文件定义的字段来实现，比如下面一个 _helper.tpl :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cat nginx-test/templates/_helpers.tpl</span>
<span class="p">{{</span><span class="o">/*</span> <span class="n">vim</span><span class="p">:</span> <span class="nb">set</span> <span class="n">filetype</span><span class="o">=</span><span class="n">mustache</span><span class="p">:</span> <span class="o">*/</span><span class="p">}}</span>
<span class="p">{{</span><span class="o">/*</span>
<span class="n">Expand</span> <span class="n">the</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">chart</span><span class="o">.</span>
<span class="o">*/</span><span class="p">}}</span>
<span class="o">...</span>
</pre></div>
</div>
<p>该模板定义了
“nginx-test.name”、“nginx-test.fullname”、“nginx-test.chart”
等可重用模板部分，当模板引擎读取该文件时，它存储对
nginx-test.name等的引用， 直到调用 template “nginx-test.name”
为止。然后把值渲染到模板中。</p>
<p>注意 {{ template “nginx-test.chart” . }}
后面有个dot(.)，这是因为一个已命名的模板（用于创建 define)
被渲染时，它将接收由该 template
调用传入的范围（scope)。没有范围传入，在模板中无法访问任何内容，因此在：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>{{- define &quot;nginx-test.chart&quot; -}}
这里面的 .Chart 将无法访问，导致在模板中无法看到内容，因为这里值为空
{{- end -}}
</pre></div>
</div>
<p>因此在模板中将 范围(scope) 传入即可正常使用：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cat nginx-test/templates/service.yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="p">{{</span> <span class="n">include</span> <span class="s2">&quot;nginx-test.fullname&quot;</span> <span class="o">.</span> <span class="p">}}</span>
</pre></div>
</div>
<p>在末尾传递了 . 这样就可以使用 .Values 或者 .Chart 或其它范围(scope)</p>
<p>5、Chart 依赖（requirements.yaml)：比如 WordPress Chart 依赖于 mariadb
Chart， 下面是 WordPress 的依赖(requirements.yaml)：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dependencies</span><span class="p">:</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">mariadb</span>
  <span class="n">version</span><span class="p">:</span> <span class="mf">5.</span><span class="n">x</span><span class="o">.</span><span class="n">x</span>
  <span class="n">repository</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">charts</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">googleapis</span><span class="o">.</span><span class="n">com</span><span class="o">/</span>
  <span class="n">condition</span><span class="p">:</span> <span class="n">mariadb</span><span class="o">.</span><span class="n">enabled</span>
  <span class="n">tags</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">wordpress</span><span class="o">-</span><span class="n">database</span>
</pre></div>
</div>
<p>该文件列举当前 Chart 所有的 依赖（subchart)。有几个字段是必要的：</p>
<ul class="simple">
<li><p>name: 依赖 Chart 的名称（必要）</p></li>
<li><p>version: 依赖 Chart 的版本号（必要）</p></li>
<li><p>repository: 依赖 Chart 的存储库完整URL，必须通过 helm repo add 添加
repository（存储库）到本地</p></li>
</ul>
</section>
</section>
</section>
<section id="id13">
<h2><a class="toc-backref" href="#id63">Chart 模板开发指南</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h2>
<section id="id14">
<h3><a class="toc-backref" href="#id64">1 先创建模板</a><a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$  helm create mychart
Creating mychart
</pre></div>
</div>
<p>快速看一下目录 <code class="docutils literal notranslate"><span class="pre">mychart/templates/</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$  tree .
.
└── mychart
    ├── charts
    ├── Chart.yaml
    ├── templates
    │    ├── deployment.yaml
    │    ├── _helpers.tpl
    │    ├── hpa.yaml
    │    ├── ingress.yaml
    │    ├── NOTES.txt
    │    ├── serviceaccount.yaml
    │    ├── service.yaml
    │    └── tests
    │        └── test-connection.yaml
    └── values.yaml

4 directories, 10 files
</pre></div>
</div>
<p>看一下 <code class="docutils literal notranslate"><span class="pre">mychart/templates/</span></code> 目录，发现如下几个文件已经存在。</p>
<ul class="simple">
<li><p>NOTES.txt：chart 的 “帮助文本”。这会在用户运行 <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">install</span></code>
时显示给用户。</p></li>
<li><p>deployment.yaml：创建 Kubernetes
<a class="reference external" href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">deployment</a>
的基本 manifest</p></li>
<li><p>service.yaml：为 deployment 创建 service 端点 <a class="reference external" href="https://kubernetes.io/docs/concepts/services-networking/service/">service
endpoint</a>
的基本 manifest</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_helpers.tpl</span></code>：放置模板助手的地方，可以在整个 chart 中重复使用</p></li>
</ul>
<p>而我们要做的就是……
全部删除它们！这样我们就可以从头开始学习我们的教程。实际上，我们将创建自己的
NOTES.txt 和_helpers.tpl。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$  rm -rf mychart/templates/*.*
</pre></div>
</div>
<p>在编写生产级 chart 时，使用这些 chart
的基本版本可能非常有用。所以在你的日常 chart 制作中，可以不删除它们。</p>
<section id="id15">
<h4>1.1 第一个模板<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h4>
<p>我们要创建的第一个模板将是一个 ConfigMap。在 Kubernetes 中，ConfigMap
只是存储配置数据的地方。其他的东西，比如 Pod，可以访问 ConfigMap
中的数据。</p>
<p>由于 ConfigMaps 是基础资源，它们为我们提供了一个很好的起点。</p>
<p>我们首先创建一个名为 mychart/templates/configmap.yaml：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ConfigMap</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">mychart</span><span class="o">-</span><span class="n">configmap</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">myvalue</span><span class="p">:</span> <span class="s2">&quot;Hello World&quot;</span>
</pre></div>
</div>
<p><strong>提示：</strong> 模板名称不遵循严格的命名模式。但是，我们建议 <code class="docutils literal notranslate"><span class="pre">.yaml</span></code> 为
YAML 文件后缀，<code class="docutils literal notranslate"><span class="pre">.tpl</span></code> 为模板助手后缀。</p>
<p>上面的 YAML 文件是一个简单的
ConfigMap，具有最少的必要字段。由于该文件位于 <code class="docutils literal notranslate"><span class="pre">templates/</span></code>
目录中，因此将通过模板引擎发送。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$  helm install myapp ./mychart/ -n dev
NAME: myapp
LAST DEPLOYED: Fri Apr  9 13:54:30 2021
NAMESPACE: dev
STATUS: deployed
REVISION: 1
TEST SUITE: None
</pre></div>
</div>
<p>在上面的输出中，我们可以看到我们的 ConfigMap 已经创建。使用
Helm，我们可以检索版本并查看加载的实际模板。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$  helm get manifest myapp -n dev
---
# Source: mychart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: mychart-configmap
data:
  myvalue: &quot;Hello World&quot;
</pre></div>
</div>
<p>该 <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">get</span> <span class="pre">manifest</span></code> 命令获取 release
名称（full-coral）并打印出上传到服务器的所有 Kubernetes 资源。</p>
<p>每个文件都以 <code class="docutils literal notranslate"><span class="pre">---</span></code> 开始作为 YAML
文档的开始，然后是一个自动生成的注释行，告诉我们该模板文件生成的这个
YAML 文档。</p>
<p>删除 release：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$  helm delete myapp -n dev
</pre></div>
</div>
</section>
<section id="id16">
<h4>1.2 添加一个简单的模板调用<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h4>
<p>我们改一下 <code class="docutils literal notranslate"><span class="pre">configmap.yaml</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ConfigMap</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">configmap</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">myvalue</span><span class="p">:</span> <span class="s2">&quot;Hello World&quot;</span>
</pre></div>
</div>
<p>所以我们可以这样理解 <code class="docutils literal notranslate"><span class="pre">.Release.Name：</span></code>“从顶层命名空间开始，找到
Release 对象，然后在里面查找名为 <code class="docutils literal notranslate"><span class="pre">Name</span></code> 的对象”。</p>
<p>现在，当我们安装我们的资源时，我们会立即看到使用这个模板指令的结果:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$  helm install clunky-serval ./mychart -n dev
NAME: clunky-serval
LAST DEPLOYED: Fri Apr  9 14:02:25 2021
NAMESPACE: dev
STATUS: deployed
REVISION: 1
TEST SUITE: None
</pre></div>
</div>
<p>运行 helm get manifest clunky-serval 以查看整个生成的 YAML。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$  helm get manifest clunky-serval  -n dev
---
# Source: mychart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: clunky-serval-configmap
data:
  myvalue: &quot;Hello World&quot;
</pre></div>
</div>
<p>可以使用
<code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">install</span> <span class="pre">clunky-serval</span> <span class="pre">--debug</span> <span class="pre">--dry-run</span> <span class="pre">./mychart</span> <span class="pre">-n</span> <span class="pre">dev</span></code>。这会将
chart 发送到 Tiller 服务器，它将渲染模板。但不是安装
chart，它会将渲染模板返回，以便可以看到输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$  helm uninstall clunky-serval -n dev
release &quot;clunky-serval&quot; uninstalled

$  helm install clunky-serval --debug --dry-run ./mychart -n dev
install.go:159: [debug] Original chart version: &quot;&quot;
install.go:176: [debug] CHART PATH: /app/k8s_yaml/helm_example/mychart
---
# Source: mychart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: clunky-serval-configmap
data:
  myvalue: &quot;Hello World&quot;
</pre></div>
</div>
<p>使用 <code class="docutils literal notranslate"><span class="pre">--dry-run</span></code> 可以更容易地测试代码，但不能确保 Kubernetes
本身会接受生成的模板。</p>
</section>
</section>
<section id="chart-yaml-values-yaml">
<h3><a class="toc-backref" href="#id65">2 修改 Chart.yaml，Values.yaml</a><a class="headerlink" href="#chart-yaml-values-yaml" title="Permalink to this headline">¶</a></h3>
<section id="id17">
<h4>2.1 内置对象<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">Release</span></code> 是可以在模板中访问的顶级对象之一。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Release</span></code>：这个对象描述了 release 本身。它里面有几个对象：</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Release.Name</span></code>：release 名称</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Release.Time</span></code>：release 的时间</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Release.Namespace</span></code>：release 的 namespace（如果清单未覆盖）</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Release.Service</span></code>：release 服务的名称（始终是 <code class="docutils literal notranslate"><span class="pre">Tiller</span></code>）。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Release.Revision</span></code>：此 release 的修订版本号。它从 1 开始，每
<code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">upgrade</span></code> 一次增加一个。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Release.IsUpgrade</span></code>：如果当前操作是升级或回滚，则将其设置为
<code class="docutils literal notranslate"><span class="pre">true</span></code>。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Release.IsInstall</span></code>：如果当前操作是安装，则设置为 <code class="docutils literal notranslate"><span class="pre">true</span></code>。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Values</span></code>：从 <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>
文件和用户提供的文件传入模板的值。默认情况下，Values 是空的。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Chart</span></code>：<code class="docutils literal notranslate"><span class="pre">Chart.yaml</span></code> 文件的内容。任何数据 Chart.yaml
将在这里访问。例如 {{.Chart.Name}}-{{.Chart.Version}} 将打印出来
mychart-0.1.0。chart 指南中 <a class="reference external" href="https://github.com/kubernetes/helm/blob/master/docs/charts.md#the-chartyaml-file">Charts
Guide</a>
列出了可用字段</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Files</span></code>：这提供对 chart
中所有非特殊文件的访问。虽然无法使用它来访问模板，但可以使用它来访问
chart 中的其他文件。请参阅 “访问文件” 部分。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Files.Get</span></code>
是一个按名称获取文件的函数（<code class="docutils literal notranslate"><span class="pre">.Files.Get</span> <span class="pre">config.ini</span></code>）</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Files.GetBytes</span></code>
是将文件内容作为字节数组而不是字符串获取的函数。这对于像图片这样的东西很有用。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Capabilities</span></code>：这提供了关于 Kubernetes 集群支持的功能的信息。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Capabilities.APIVersions</span></code> 是一组版本信息。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Capabilities.APIVersions.Has</span> <span class="pre">$version</span></code>
指示是否在群集上启用版本（<code class="docutils literal notranslate"><span class="pre">batch/v1</span></code>）。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Capabilities.KubeVersion</span></code> 提供了查找 Kubernetes
版本的方法。它具有以下值：Major，Minor，GitVersion，GitCommit，GitTreeState，BuildDate，GoVersion，Compiler，和
Platform。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Capabilities.TillerVersion</span></code> 提供了查找 Tiller
版本的方法。它具有以下值：SemVer，GitCommit，和 GitTreeState。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Template</span></code>：包含有关正在执行的当前模板的信息</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Name</span></code>：到当前模板的 namespace 文件路径（例如
<code class="docutils literal notranslate"><span class="pre">mychart/templates/mytemplate.yaml</span></code>）</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BasePath</span></code>：当前 chart 模板目录的 namespace 路径（例如
mychart/templates）。</p></li>
</ul>
</section>
<section id="values">
<h4>2.2 values 文件<a class="headerlink" href="#values" title="Permalink to this headline">¶</a></h4>
<p>该对象提供对传入 chart 的值的访问。其内容来自四个来源：</p>
<ul class="simple">
<li><p>chart 中的 <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code> 文件</p></li>
<li><p>如果这是一个子 chart，来自父 chart 的 <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code> 文件</p></li>
<li><p>value 文件通过 helm install 或 helm upgrade 的 - f
标志传入文件（<code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">install</span> <span class="pre">-f</span> <span class="pre">myvals.yaml</span> <span class="pre">./mychart</span></code>）</p></li>
<li><p>通过 <code class="docutils literal notranslate"><span class="pre">--set</span></code>（例如 <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">install</span> <span class="pre">--set</span> <span class="pre">foo=bar</span> <span class="pre">./mychart</span></code>）</p></li>
</ul>
<p>我们编辑 <code class="docutils literal notranslate"><span class="pre">mychart/values.yaml</span></code>，然后来编辑我们的 <code class="docutils literal notranslate"><span class="pre">ConfigMap</span></code>
模板。</p>
<p>删除默认带的 values.yaml，我们只设置一个参数：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">favoriteDrink</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">coffee</span>
</pre></div>
</div>
<p>现在我们可以在模板中使用这个：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ConfigMap</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">configmap</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">myvalue</span><span class="p">:</span> <span class="s2">&quot;Hello World&quot;</span>
  <span class="n">drink</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">favoriteDrink</span><span class="p">}}</span>
</pre></div>
</div>
<p>注意我们在最后一行 {{ .Values.favoriteDrink}} 获取 <code class="docutils literal notranslate"><span class="pre">favoriteDrink</span></code>
的值。</p>
<p>让我们看看这是如何渲染的。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$  helm install myapp2021 --dry-run --debug ./mychart
install.go:159: [debug] Original chart version: &quot;&quot;
install.go:176: [debug] CHART PATH: /app/k8s_yaml/helm_example/mychart

NAME: myapp2021
LAST DEPLOYED: Fri Apr  9 14:11:16 2021
NAMESPACE: default
STATUS: pending-install
REVISION: 1
TEST SUITE: None
USER-SUPPLIED VALUES:
{}

COMPUTED VALUES:
favoriteDrink: coffee

HOOKS:
MANIFEST:
---
# Source: mychart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: myapp2021-configmap
data:
  myvalue: &quot;Hello World&quot;
  drink: coffee
</pre></div>
</div>
<p>由于 <code class="docutils literal notranslate"><span class="pre">favoriteDrink</span></code> 在默认 <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code> 文件中设置为
<code class="docutils literal notranslate"><span class="pre">coffee</span></code>，这就是模板中显示的值。我们可以轻松地在我们的 helm install
命令中通过加一个 <code class="docutils literal notranslate"><span class="pre">--set</span></code> 添标志来覆盖：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$  helm install myapp2021 --dry-run --debug --set favoriteDrink=slurm ./mychart
install.go:159: [debug] Original chart version: &quot;&quot;
install.go:176: [debug] CHART PATH: /app/k8s_yaml/helm_example/mychart

NAME: myapp2021
LAST DEPLOYED: Fri Apr  9 14:12:31 2021
NAMESPACE: default
STATUS: pending-install
REVISION: 1
TEST SUITE: None
USER-SUPPLIED VALUES:
favoriteDrink: slurm

COMPUTED VALUES:
favoriteDrink: slurm

HOOKS:
MANIFEST:
---
# Source: mychart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: myapp2021-configmap
data:
  myvalue: &quot;Hello World&quot;
  drink: slurm
</pre></div>
</div>
<p>由于 <code class="docutils literal notranslate"><span class="pre">--set</span></code> 比默认 <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>
文件具有更高的优先级，我们的模板生成 <code class="docutils literal notranslate"><span class="pre">drink:</span> <span class="pre">slurm</span></code>。</p>
<p>values 文件也可以包含更多结构化内容。例如，我们在 values.yaml
文件中可以创建 <code class="docutils literal notranslate"><span class="pre">favorite</span></code> 部分，然后在其中添加几个键：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">favorite</span><span class="p">:</span>
  <span class="n">drink</span><span class="p">:</span> <span class="n">coffee</span>
  <span class="n">food</span><span class="p">:</span> <span class="n">pizza</span>
</pre></div>
</div>
<p>现在我们稍微修改模板：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ConfigMap</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">configmap</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">myvalue</span><span class="p">:</span> <span class="s2">&quot;Hello World&quot;</span>
  <span class="n">drink</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">favorite</span><span class="o">.</span><span class="n">drink</span><span class="p">}}</span>
  <span class="n">food</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">favorite</span><span class="o">.</span><span class="n">food</span><span class="p">}}</span>
</pre></div>
</div>
<p>虽然以这种方式构建数据是可以的，但建议保持 value
树浅一些，平一些。当我们看看为子 chart
分配值时，我们将看到如何使用树结构来命名值。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$  helm install myapp2021 --dry-run --debug  ./mychart
---
# Source: mychart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: myapp2021-configmap
data:
  myvalue: &quot;Hello World&quot;
  drink: coffee
  food: pizza
</pre></div>
</div>
</section>
<section id="id18">
<h4>2.3 模板函数和管道<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h4>
<p><strong>使用quote函数</strong></p>
<p>我们使用管道（|）将 “参数”
发送给函数：<code class="docutils literal notranslate"><span class="pre">.Values.favorite.drink</span> <span class="pre">|</span> <span class="pre">quote</span></code>。使用管道，我们可以将几个功能链接在一起：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ConfigMap</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">configmap</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">myvalue</span><span class="p">:</span> <span class="s2">&quot;Hello World&quot;</span>
  <span class="n">drink</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">favorite</span><span class="o">.</span><span class="n">drink</span> <span class="o">|</span> <span class="n">quote</span><span class="p">}}</span>
  <span class="n">food</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">favorite</span><span class="o">.</span><span class="n">food</span> <span class="o">|</span> <span class="n">upper</span> <span class="o">|</span> <span class="n">quote</span><span class="p">}}</span>
</pre></div>
</div>
<p>当评估时，该模板将产生如下结果：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># Source: mychart/templates/configmap.yaml</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">trendsetting-p-configmap</span>
<span class="nt">data</span><span class="p">:</span>
  <span class="nt">myvalue</span><span class="p">:</span> <span class="s">&quot;Hello</span><span class="nv"> </span><span class="s">World&quot;</span>
  <span class="nt">drink</span><span class="p">:</span> <span class="s">&quot;coffee&quot;</span>
  <span class="nt">food</span><span class="p">:</span> <span class="s">&quot;PIZZA&quot;</span>
</pre></div>
</div>
<p>原来 <code class="docutils literal notranslate"><span class="pre">pizza</span></code> 现在已经转换为 <code class="docutils literal notranslate"><span class="pre">&quot;PIZZA&quot;</span></code>。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ConfigMap</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">configmap</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">myvalue</span><span class="p">:</span> <span class="s2">&quot;Hello World&quot;</span>
  <span class="n">drink</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">favorite</span><span class="o">.</span><span class="n">drink</span> <span class="o">|</span> <span class="n">repeat</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">quote</span><span class="p">}}</span>
  <span class="n">food</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">favorite</span><span class="o">.</span><span class="n">food</span> <span class="o">|</span> <span class="n">upper</span> <span class="o">|</span> <span class="n">quote</span><span class="p">}}</span>
</pre></div>
</div>
<p>该 repeat 函数将回送给定的字符串和给定的次数，所以我们将得到这个输出：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Source: mychart/templates/configmap.yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ConfigMap</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">melting</span><span class="o">-</span><span class="n">porcup</span><span class="o">-</span><span class="n">configmap</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">myvalue</span><span class="p">:</span> <span class="s2">&quot;Hello World&quot;</span>
  <span class="n">drink</span><span class="p">:</span> <span class="s2">&quot;coffeecoffeecoffeecoffeecoffee&quot;</span>
  <span class="n">food</span><span class="p">:</span> <span class="s2">&quot;PIZZA&quot;</span>
</pre></div>
</div>
<p><strong>使用 default 函数</strong></p>
<p>示例：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">drink</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">favorite</span><span class="o">.</span><span class="n">drink</span> <span class="o">|</span> <span class="n">default</span> <span class="s2">&quot;tea&quot;</span> <span class="o">|</span> <span class="n">quote</span><span class="p">}}</span>
</pre></div>
</div>
<p>现在，我们将从以下位置删除喜欢的饮料设置 values.yaml：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">favorite</span><span class="p">:</span>
  <span class="c1">#drink: coffee</span>
  <span class="nt">food</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pizza</span>
</pre></div>
</div>
<p>现在重新运行 <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">install</span> <span class="pre">--dry-run</span> <span class="pre">--debug</span> <span class="pre">./mychart</span></code> 会产生这个
YAML：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># Source: mychart/templates/configmap.yaml</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fair-worm-configmap</span>
<span class="nt">data</span><span class="p">:</span>
  <span class="nt">myvalue</span><span class="p">:</span> <span class="s">&quot;Hello</span><span class="nv"> </span><span class="s">World&quot;</span>
  <span class="nt">drink</span><span class="p">:</span> <span class="s">&quot;tea&quot;</span>
  <span class="nt">food</span><span class="p">:</span> <span class="s">&quot;PIZZA&quot;</span>
</pre></div>
</div>
<p><strong>运算符函数</strong></p>
<p>对于模板，运算符（eq，ne，lt，gt，and，or
等等）都是已实现的功能。在管道中，运算符可以用圆括号（<code class="docutils literal notranslate"><span class="pre">(</span></code> 和
<code class="docutils literal notranslate"><span class="pre">)</span></code>）分组。</p>
<p>将运算符放到声明的前面，后面跟着它的参数，就像使用函数一样。要多个运算符一起使用，将每个函数通过圆括号分隔。</p>
</section>
<section id="id19">
<h4>2.4 流程控制<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h4>
<p>控制结构（模板说法中称为
“动作”）为模板作者提供了控制模板生成流程的能力。Helm
的模板语言提供了以下控制结构：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">if/else</span></code> 用于创建条件块</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">with</span></code> 指定范围</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">range</span></code>，它提供了一个 “for each” 风格的循环</p></li>
</ul>
<p>除此之外，它还提供了一些声明和使用命名模板段的操作：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">define</span></code> 在模板中声明一个新的命名模板</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">template</span></code> 导入一个命名模板</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">block</span></code> 声明了一种特殊的可填写模板区域</p></li>
</ul>
<p>我们为 ConfigMap
添加一个简单的条件。如果饮料被设置为咖啡，我们将添加另一个设置：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ConfigMap</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">configmap</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">myvalue</span><span class="p">:</span> <span class="s2">&quot;Hello World&quot;</span>
  <span class="n">drink</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">favorite</span><span class="o">.</span><span class="n">drink</span> <span class="o">|</span> <span class="n">default</span> <span class="s2">&quot;tea&quot;</span> <span class="o">|</span> <span class="n">quote</span><span class="p">}}</span>
  <span class="n">food</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">favorite</span><span class="o">.</span><span class="n">food</span> <span class="o">|</span> <span class="n">upper</span> <span class="o">|</span> <span class="n">quote</span><span class="p">}}</span>
  <span class="p">{{</span><span class="k">if</span> <span class="ow">and</span> <span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">favorite</span><span class="o">.</span><span class="n">drink</span> <span class="p">(</span><span class="n">eq</span> <span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">favorite</span><span class="o">.</span><span class="n">drink</span> <span class="s2">&quot;coffee&quot;</span><span class="p">)</span> <span class="p">}}</span><span class="n">mug</span><span class="p">:</span> <span class="n">true</span><span class="p">{{</span> <span class="n">end</span> <span class="p">}}</span>
</pre></div>
</div>
<p>输出如下：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">$  helm install myapp2021 --dry-run --debug  ./mychart</span>
<span class="l l-Scalar l-Scalar-Plain"># Source</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">mychart/templates/configmap.yaml</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">myapp2021-configmap</span>
<span class="nt">data</span><span class="p">:</span>
  <span class="nt">myvalue</span><span class="p">:</span> <span class="s">&quot;Hello</span><span class="nv"> </span><span class="s">World&quot;</span>
  <span class="nt">drink</span><span class="p">:</span> <span class="s">&quot;coffee&quot;</span>
  <span class="nt">food</span><span class="p">:</span> <span class="s">&quot;PIZZA&quot;</span>
  <span class="nt">mug</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<p><strong>控制空格</strong></p>
<p>将空格替换为 <code class="docutils literal notranslate"><span class="pre">*</span></code>, 按照此规则将每个空格将被删除。一个在该行的末尾的
<code class="docutils literal notranslate"><span class="pre">*</span></code> 指示换行符将被移除</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ConfigMap</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">configmap</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">myvalue</span><span class="p">:</span> <span class="s2">&quot;Hello World&quot;</span>
  <span class="n">drink</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">favorite</span><span class="o">.</span><span class="n">drink</span> <span class="o">|</span> <span class="n">default</span> <span class="s2">&quot;tea&quot;</span> <span class="o">|</span> <span class="n">quote</span><span class="p">}}</span>
  <span class="n">food</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">favorite</span><span class="o">.</span><span class="n">food</span> <span class="o">|</span> <span class="n">upper</span> <span class="o">|</span> <span class="n">quote</span><span class="p">}}</span>
  <span class="p">{{</span><span class="o">-</span> <span class="k">if</span> <span class="n">eq</span> <span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">favorite</span><span class="o">.</span><span class="n">drink</span> <span class="s2">&quot;coffee&quot;</span><span class="p">}}</span>
  <span class="n">mug</span><span class="p">:</span> <span class="n">true</span>
  <span class="p">{{</span><span class="o">-</span> <span class="n">end</span><span class="p">}}</span>
</pre></div>
</div>
<p>牢记这一点，我们可以通过 Helm 运行我们的模板并查看结果：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Source: mychart/templates/configmap.yaml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ConfigMap</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">clunky</span><span class="o">-</span><span class="n">cat</span><span class="o">-</span><span class="n">configmap</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">myvalue</span><span class="p">:</span> <span class="s2">&quot;Hello World&quot;</span>
  <span class="n">drink</span><span class="p">:</span> <span class="s2">&quot;coffee&quot;</span>
  <span class="n">food</span><span class="p">:</span> <span class="s2">&quot;PIZZA&quot;</span>
  <span class="n">mug</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
<p><strong>使用 with 修改范围</strong></p>
<p>with
可以允许将当前范围（<code class="docutils literal notranslate"><span class="pre">.</span></code>）设置为特定的对象。例如，我们一直在使用的
<code class="docutils literal notranslate"><span class="pre">.Values.favorites</span></code>。让我们重写我们的 ConfigMap 来改变 <code class="docutils literal notranslate"><span class="pre">.</span></code>
范围来指向 <code class="docutils literal notranslate"><span class="pre">.Values.favorites</span></code>：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ConfigMap</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">configmap</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">myvalue</span><span class="p">:</span> <span class="s2">&quot;Hello World&quot;</span>
  <span class="p">{{</span><span class="o">-</span> <span class="k">with</span> <span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">favorite</span><span class="p">}}</span>
  <span class="n">drink</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">drink</span> <span class="o">|</span> <span class="n">default</span> <span class="s2">&quot;tea&quot;</span> <span class="o">|</span> <span class="n">quote</span><span class="p">}}</span>
  <span class="n">food</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">food</span> <span class="o">|</span> <span class="n">upper</span> <span class="o">|</span> <span class="n">quote</span><span class="p">}}</span>
  <span class="p">{{</span><span class="o">-</span> <span class="n">end</span><span class="p">}}</span>
</pre></div>
</div>
<p>注意，现在我们可以引用 <code class="docutils literal notranslate"><span class="pre">.drink</span></code> 和 <code class="docutils literal notranslate"><span class="pre">.food</span></code>
无需对其进行限定。这是因为该 <code class="docutils literal notranslate"><span class="pre">with</span></code> 声明设置 <code class="docutils literal notranslate"><span class="pre">.</span></code> 为指向
<code class="docutils literal notranslate"><span class="pre">.Values.favorite</span></code>。在 <code class="docutils literal notranslate"><span class="pre">{{end}}</span></code> 后 <code class="docutils literal notranslate"><span class="pre">.</span></code> 复位其先前的范围。</p>
<p><strong>循环range动作</strong></p>
<p>我们在我们的 <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code> 文件中添加一份披萨配料列表：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">favorite</span><span class="p">:</span>
  <span class="n">drink</span><span class="p">:</span> <span class="n">coffee</span>
  <span class="n">food</span><span class="p">:</span> <span class="n">pizza</span>
<span class="n">pizzaToppings</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">mushrooms</span>
  <span class="o">-</span> <span class="n">cheese</span>
  <span class="o">-</span> <span class="n">peppers</span>
  <span class="o">-</span> <span class="n">onions</span>
</pre></div>
</div>
<p>现在我们有一个列表（模板中称为
slice）pizzaToppings。我们可以修改我们的模板，将这个列表打印到我们的
ConfigMap 中：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ConfigMap</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">configmap</span>
<span class="n">data</span><span class="p">:</span>
  <span class="n">myvalue</span><span class="p">:</span> <span class="s2">&quot;Hello World&quot;</span>
  <span class="p">{{</span><span class="o">-</span> <span class="k">with</span> <span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">favorite</span><span class="p">}}</span>
  <span class="n">drink</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">drink</span> <span class="o">|</span> <span class="n">default</span> <span class="s2">&quot;tea&quot;</span> <span class="o">|</span> <span class="n">quote</span><span class="p">}}</span>
  <span class="n">food</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">food</span> <span class="o">|</span> <span class="n">upper</span> <span class="o">|</span> <span class="n">quote</span><span class="p">}}</span>
  <span class="p">{{</span><span class="o">-</span> <span class="n">end</span><span class="p">}}</span>
  <span class="n">toppings</span><span class="p">:</span> <span class="o">|-</span>
    <span class="p">{{</span><span class="o">-</span> <span class="nb">range</span> <span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">pizzaToppings</span><span class="p">}}</span>
    <span class="o">-</span> <span class="p">{{</span><span class="o">.</span> <span class="o">|</span> <span class="n">title</span> <span class="o">|</span> <span class="n">quote</span><span class="p">}}</span>
    <span class="p">{{</span><span class="o">-</span> <span class="n">end</span><span class="p">}}</span>
</pre></div>
</div>
<p>我们可以直接向管道发送 <code class="docutils literal notranslate"><span class="pre">.</span></code> 的值，所以当我们这样做时
<code class="docutils literal notranslate"><span class="pre">{{.</span> <span class="pre">|</span> <span class="pre">title</span> <span class="pre">|</span> <span class="pre">quote}}</span></code>，它会发送 <code class="docutils literal notranslate"><span class="pre">.</span></code> 到 title（标题 case
函数），然后发送到 <code class="docutils literal notranslate"><span class="pre">quote</span></code>。如果我们运行这个模板，输出将是：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$  helm install myapp2021 --dry-run --debug  ./mychart
---
# Source: mychart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: myapp2021-configmap
data:
  myvalue: &quot;Hello World&quot;
  drink: &quot;coffee&quot;
  food: &quot;PIZZA&quot;
  toppings: |-
    - &quot;Mushrooms&quot;
    - &quot;Cheese&quot;
    - &quot;Peppers&quot;
    - &quot;Onions&quot;
</pre></div>
</div>
<blockquote>
<div><p>YAML 中的 <code class="docutils literal notranslate"><span class="pre">|-</span></code>
标记表示一个多行字符串。这可以是一种有用的技术，用于在清单中嵌入大块数据，如此处所示。</p>
</div></blockquote>
</section>
<section id="id20">
<h4>2.5 变量<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h4>
<p>在 Helm 模板中，变量是对另一个对象的命名引用。它遵循这个形式
<code class="docutils literal notranslate"><span class="pre">$name</span></code>。变量被赋予一个特殊的赋值操作符：<code class="docutils literal notranslate"><span class="pre">:=</span></code>。我们可以使用变量重写上面的
Release.Name。</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-configmap</span>
<span class="nt">data</span><span class="p">:</span>
  <span class="nt">myvalue</span><span class="p">:</span> <span class="s">&quot;Hello</span><span class="nv"> </span><span class="s">World&quot;</span>
  <span class="p p-Indicator">{{</span><span class="nv">- $relname</span> <span class="p p-Indicator">:</span><span class="nv">= .Release.Name -</span><span class="p p-Indicator">}}</span>
  <span class="p p-Indicator">{{</span><span class="nv">- with .Values.favorite</span><span class="p p-Indicator">}}</span>
  <span class="nt">drink</span><span class="p">:</span> <span class="p p-Indicator">{{</span><span class="nv">.drink | default &quot;tea&quot; | quote</span><span class="p p-Indicator">}}</span>
  <span class="nt">food</span><span class="p">:</span> <span class="p p-Indicator">{{</span><span class="nv">.food | upper | quote</span><span class="p p-Indicator">}}</span>
  <span class="nt">release</span><span class="p">:</span> <span class="p p-Indicator">{{</span><span class="nv">$relname</span><span class="p p-Indicator">}}</span>
  <span class="p p-Indicator">{{</span><span class="nv">- end</span><span class="p p-Indicator">}}</span>
</pre></div>
</div>
<p>注意，在我们开始 <code class="docutils literal notranslate"><span class="pre">with</span></code> 块之前，我们赋值
<code class="docutils literal notranslate"><span class="pre">$relname</span> <span class="pre">:=</span></code>.Release.Name。现在在 <code class="docutils literal notranslate"><span class="pre">with</span></code> 块内部，<code class="docutils literal notranslate"><span class="pre">$relname</span></code>
变量仍然指向发布名称。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$  helm install myapp2021 --dry-run --debug  ./mychart
---
# Source: mychart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: myapp2021-configmap
data:
  myvalue: &quot;Hello World&quot;
  drink: &quot;coffee&quot;
  food: &quot;PIZZA&quot;
  release: myapp2021
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># mychart/values.yaml</span>
<span class="nt">favorite</span><span class="p">:</span>
  <span class="nt">drink</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">coffee</span>
  <span class="nt">food</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pizza</span>
<span class="nt">pizzaToppings</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">mushrooms</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">cheese</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">peppers</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">onions</span>
</pre></div>
</div>
<p>变量在 <code class="docutils literal notranslate"><span class="pre">range</span></code>
循环中特别有用。它们可以用于类似列表的对象以同时捕获索引和值：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>apiVersion: v1
kind: ConfigMap
metadata:
  name: {{.Release.Name}}-configmap
data:
  myvalue: &quot;Hello World&quot;
  {{- $relname := .Release.Name -}}
  {{- with .Values.favorite}}
  drink: {{.drink | default &quot;tea&quot; | quote}}
  food: {{.food | upper | quote}}
  release: {{$relname}}
  {{- end}}
  toppings: |-
    {{- range $index, $topping := .Values.pizzaToppings}}
      {{$index}}: {{ $topping }}
    {{- end}}
</pre></div>
</div>
<p>注意，<code class="docutils literal notranslate"><span class="pre">range</span></code>
首先是变量，然后是赋值运算符，然后是列表。这将分配整数索引（从零开始）给
<code class="docutils literal notranslate"><span class="pre">$index</span></code>，值给 <code class="docutils literal notranslate"><span class="pre">$topping</span></code>。运行它将产生：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$  helm install myapp2021 --dry-run --debug  ./mychart
---
# Source: mychart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: myapp2021-configmap
data:
  myvalue: &quot;Hello World&quot;
  drink: &quot;coffee&quot;
  food: &quot;PIZZA&quot;
  release: myapp2021
  toppings: |-
      0: mushrooms
      1: cheese
      2: peppers
      3: onions
</pre></div>
</div>
<p>对于同时具有键和值的数据结构，我们可以使用 <code class="docutils literal notranslate"><span class="pre">range</span></code>
来获得两者。例如，我们可以对 <code class="docutils literal notranslate"><span class="pre">.Values.favorite</span></code> 像这样循环：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>apiVersion: v1
kind: ConfigMap
metadata:
  name: {{.Release.Name}}-configmap
data:
  myvalue: &quot;Hello World&quot;
  {{- range $key, $val := .Values.favorite}}
  {{$key}}: {{ $val | quote }}
  {{- end}}
</pre></div>
</div>
<p>现在在第一次迭代中，<code class="docutils literal notranslate"><span class="pre">$key</span></code> 是 <code class="docutils literal notranslate"><span class="pre">drink</span></code>，<code class="docutils literal notranslate"><span class="pre">$val</span></code> 是
<code class="docutils literal notranslate"><span class="pre">coffee</span></code>，第二次，<code class="docutils literal notranslate"><span class="pre">$key</span></code> 是 food，<code class="docutils literal notranslate"><span class="pre">$val</span></code> 会
pizza。运行上面的代码会生成下面这个：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$  helm install myapp2021 --dry-run --debug  ./mychart
HOOKS:
MANIFEST:
---
# Source: mychart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: myapp2021-configmap
data:
  myvalue: &quot;Hello World&quot;
  drink: &quot;coffee&quot;
  food: &quot;pizza&quot;
</pre></div>
</div>
</section>
</section>
<section id="id21">
<h3><a class="toc-backref" href="#id66">3 模板和值</a><a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h3>
<p>在 templates 目录下创建部署镜像所需要的 yaml 文件，并变量引用 yaml
里经常变动的字段</p>
<p>Helm
Charts模板（template）遵循Go模板语言格式，并支持50种以上的来自Spring库的模板函数附件，以及为数不少的其他专用函数。所有的模板文件都存储于Templates目录中，在当前Charts被Helm引用时，此目录中的所有模板文件都会传递给模板引擎进行处理。</p>
<p>模板文件中用到的值（value）有如下两种提供方式。</p>
<ul class="simple">
<li><p>通过Charts的values.yaml文件提供，通常用于提供默认值。</p></li>
<li><p>在运行“helm
install”命令时传递包含所需要的自定义值的YAML文件；此处传递的值会覆盖默认值。</p></li>
</ul>
<p>下面的示例是Wordpress Charts中Deployment模板文件的部分内容：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">extensions</span><span class="o">/</span><span class="n">v1beta1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="p">{{</span> <span class="n">template</span> <span class="s2">&quot;fullname&quot;</span> <span class="o">.</span> <span class="p">}}</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="p">{{</span> <span class="n">template</span> <span class="s2">&quot;fullname&quot;</span> <span class="o">.</span> <span class="p">}}</span>
    <span class="n">chart</span><span class="p">:</span> <span class="s2">&quot;{{ .Chart.Name }}-{{ .Chart.Version }}&quot;</span>
    <span class="n">release</span><span class="p">:</span> <span class="s2">&quot;{{ .Release.Name }}&quot;</span>
    <span class="n">heritage</span><span class="p">:</span> <span class="s2">&quot;{{ .Release.Service }}&quot;</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="mi">1</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">app</span><span class="p">:</span> <span class="p">{{</span> <span class="n">template</span> <span class="s2">&quot;fullname&quot;</span> <span class="o">.</span> <span class="p">}}</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">containers</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="p">{{</span> <span class="n">template</span> <span class="s2">&quot;fullname&quot;</span> <span class="o">.</span> <span class="p">}}</span>
        <span class="n">image</span><span class="p">:</span> <span class="s2">&quot;{{ .Values.image }}&quot;</span>
        <span class="n">imagePullPolicy</span><span class="p">:</span> <span class="p">{{</span> <span class="n">default</span> <span class="s2">&quot;&quot;</span> <span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">imagePullPolicy</span> <span class="o">|</span> <span class="n">quote</span> <span class="p">}}</span>
</pre></div>
</div>
<p>而在values.yaml一类的文件中定义值（value）时，既可以将它们定义为全局作用域，也可以定义为仅供Charts目录下的某个Charts所使用。一般来说，上级Charts可访问下级Charts中的值，但下级Charts不能访问其上级Charts的值。</p>
<p>如下面示例中的内容，其中title属于全局作用域，max_connections和password则仅属于mysql
Charts，port仅属于apache Charts：</p>
<p><code class="docutils literal notranslate"><span class="pre">values.yaml</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">title</span><span class="p">:</span> <span class="s2">&quot;My WordPress Site&quot;</span> <span class="c1"># Sent to the WordPress template</span>

<span class="n">mysql</span><span class="p">:</span>
  <span class="n">max_connections</span><span class="p">:</span> <span class="mi">100</span> <span class="c1"># Sent to MySQL</span>
  <span class="n">password</span><span class="p">:</span> <span class="s2">&quot;secret&quot;</span>

<span class="n">apache</span><span class="p">:</span>
  <span class="n">port</span><span class="p">:</span> <span class="mi">8080</span> <span class="c1"># Passed to Apache</span>
</pre></div>
</div>
<blockquote>
<div><p>参考文献：<a class="reference external" href="https://blog.csdn.net/qq_39680564/article/details/107388151">https://blog.csdn.net/qq_39680564/article/details/107388151</a></p>
</div></blockquote>
</section>
<section id="id22">
<h3><a class="toc-backref" href="#id67">4. 自定义Charts</a><a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h3>
<section id="id23">
<h4>4.1 生成一个空Charts<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h4>
<p>下面的命令会于命令执行的当前目录中创建一个名为demoapp的子目录作为Charts存储路径：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm</span> <span class="n">create</span> <span class="n">demoapp</span>

<span class="c1"># 创建namespace</span>
<span class="n">kubectl</span> <span class="n">create</span> <span class="n">namespace</span> <span class="n">demoapp</span>
</pre></div>
</div>
<p>此命令会初始化出一个空的Charts目录结构，它有着所需要的各个核心文件：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$  tree demoapp
demoapp
├── Chart.yaml
├── demoapp-values.yaml
├── README.md
├── templates
│    ├── deployment.yaml
│    ├── _helpers.tpl
│    ├── hpa.yaml
│    ├── ingress.yaml
│    ├── NOTES.txt
│    ├── NOTES.txt.bak
│    ├── serviceaccount.yaml
│    ├── service.yaml
│    └── tests
│        └── test-connection.yaml
└── values.yaml
</pre></div>
</div>
</section>
<section id="id24">
<h4>4.2 修改Charts以部署自定义服务<a class="headerlink" href="#id24" title="Permalink to this headline">¶</a></h4>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>apiVersion: v2
name: demoapp
description: A kubernetes-natvie application demo.

type: application

version: <span class="m">0</span>.1.0

appVersion: <span class="m">1</span>.0.0

maintainers:
  - name: MageEdu
    email: mage@magedu.com
    url: http://www.magedu.com
</pre></div>
</div>
<p>修改values.yaml文件为demo-app.yaml内容如下：</p>
<p>cp -rf values.yaml demoapp-values.yaml</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>replicaCount: <span class="m">1</span>

image:
  repository: ikubernetes/demoapp
  pullPolicy: IfNotPresent
  tag: <span class="s2">&quot;v1.0&quot;</span>

imagePullSecrets: <span class="o">[]</span>
nameOverride: <span class="s2">&quot;&quot;</span>
fullnameOverride: <span class="s2">&quot;&quot;</span>

serviceAccount:
  create: <span class="nb">false</span>
  annotations: <span class="o">{}</span>
  name: <span class="s2">&quot;&quot;</span>

podAnnotations: <span class="o">{}</span>

podSecurityContext: <span class="o">{}</span>

securityContext: <span class="o">{}</span>

<span class="c1"># service</span>
service:
  type: ClusterIP
  port: <span class="m">80</span>

<span class="c1"># ingress</span>
ingress:
  enabled: <span class="nb">true</span>
  annotations:
    kubernetes.io/ingress.class: <span class="s2">&quot;nginx&quot;</span>
  hosts:
    - host: helm-demoapp.runjs.cn
      paths:
        - /
  tls: <span class="o">[]</span>

resources: <span class="o">{}</span>

autoscaling:
  enabled: <span class="nb">false</span>
  minReplicas: <span class="m">1</span>
  maxReplicas: <span class="m">100</span>
  targetCPUUtilizationPercentage: <span class="m">80</span>

nodeSelector: <span class="o">{}</span>

tolerations: <span class="o">[]</span>

affinity: <span class="o">{}</span>
</pre></div>
</div>
<p>templates/service.yaml</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>apiVersion: v1
kind: Service
metadata:
  name: <span class="o">{{</span> include <span class="s2">&quot;demoapp.fullname&quot;</span> . <span class="o">}}</span>
  labels:
    <span class="o">{{</span>- include <span class="s2">&quot;demoapp.labels&quot;</span> . <span class="p">|</span> nindent <span class="m">4</span> <span class="o">}}</span>
spec:
  type: <span class="o">{{</span> .Values.service.type <span class="o">}}</span>
  ports:
    - port: <span class="o">{{</span> .Values.service.port <span class="o">}}</span>
      targetPort: http
      protocol: TCP
      name: http
  selector:
    <span class="o">{{</span>- include <span class="s2">&quot;demoapp.selectorLabels&quot;</span> . <span class="p">|</span> nindent <span class="m">4</span> <span class="o">}}</span>
</pre></div>
</div>
<p>templates/deployment.yaml</p>
<p>创建了一个pod中2个containers。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>apiVersion: apps/v1
kind: Deployment
metadata:
  name: <span class="o">{{</span> include <span class="s2">&quot;demoapp.fullname&quot;</span> . <span class="o">}}</span>
  labels:
    <span class="o">{{</span>- include <span class="s2">&quot;demoapp.labels&quot;</span> . <span class="p">|</span> nindent <span class="m">4</span> <span class="o">}}</span>
spec:
<span class="o">{{</span>- <span class="k">if</span> not .Values.autoscaling.enabled <span class="o">}}</span>
  replicas: <span class="o">{{</span> .Values.replicaCount <span class="o">}}</span>
<span class="o">{{</span>- end <span class="o">}}</span>
  selector:
    matchLabels:
      <span class="o">{{</span>- include <span class="s2">&quot;demoapp.selectorLabels&quot;</span> . <span class="p">|</span> nindent <span class="m">6</span> <span class="o">}}</span>
  template:
    metadata:
    <span class="o">{{</span>- with .Values.podAnnotations <span class="o">}}</span>
      annotations:
        <span class="o">{{</span>- toYaml . <span class="p">|</span> nindent <span class="m">8</span> <span class="o">}}</span>
    <span class="o">{{</span>- end <span class="o">}}</span>
      labels:
        <span class="o">{{</span>- include <span class="s2">&quot;demoapp.selectorLabels&quot;</span> . <span class="p">|</span> nindent <span class="m">8</span> <span class="o">}}</span>
    spec:
      <span class="o">{{</span>- with .Values.imagePullSecrets <span class="o">}}</span>
      imagePullSecrets:
        <span class="o">{{</span>- toYaml . <span class="p">|</span> nindent <span class="m">8</span> <span class="o">}}</span>
      <span class="o">{{</span>- end <span class="o">}}</span>
      serviceAccountName: <span class="o">{{</span> include <span class="s2">&quot;demoapp.serviceAccountName&quot;</span> . <span class="o">}}</span>
      securityContext:
        <span class="o">{{</span>- toYaml .Values.podSecurityContext <span class="p">|</span> nindent <span class="m">8</span> <span class="o">}}</span>
      containers:
        - name: <span class="o">{{</span> .Chart.Name <span class="o">}}</span>
          securityContext:
            <span class="o">{{</span>- toYaml .Values.securityContext <span class="p">|</span> nindent <span class="m">12</span> <span class="o">}}</span>
          image: <span class="s2">&quot;{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}&quot;</span>
          imagePullPolicy: <span class="o">{{</span> .Values.image.pullPolicy <span class="o">}}</span>
          ports:
            - name: http
              containerPort: <span class="m">80</span>
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /
              port: http
          readinessProbe:
            httpGet:
              path: /
              port: http
          resources:
            <span class="o">{{</span>- toYaml .Values.resources <span class="p">|</span> nindent <span class="m">12</span> <span class="o">}}</span>

        - name: wget
          image: registry.cn-hangzhou.aliyuncs.com/aliacs-app-catalog/busybox:1.30.1
          command: <span class="o">[</span><span class="s1">&#39;wget&#39;</span><span class="o">]</span>
          args: <span class="o">[</span><span class="s1">&#39;{{ include &quot;demoapp.fullname&quot; . }}:{{ .Values.service.port }}&#39;</span><span class="o">]</span>
      <span class="o">{{</span>- with .Values.nodeSelector <span class="o">}}</span>
      nodeSelector:
        <span class="o">{{</span>- toYaml . <span class="p">|</span> nindent <span class="m">8</span> <span class="o">}}</span>
      <span class="o">{{</span>- end <span class="o">}}</span>
      <span class="o">{{</span>- with .Values.affinity <span class="o">}}</span>
      affinity:
        <span class="o">{{</span>- toYaml . <span class="p">|</span> nindent <span class="m">8</span> <span class="o">}}</span>
      <span class="o">{{</span>- end <span class="o">}}</span>
      <span class="o">{{</span>- with .Values.tolerations <span class="o">}}</span>
      tolerations:
        <span class="o">{{</span>- toYaml . <span class="p">|</span> nindent <span class="m">8</span> <span class="o">}}</span>
      <span class="o">{{</span>- end <span class="o">}}</span>
</pre></div>
</div>
<p>templates/hpa.yaml 保持默认，无需修改</p>
<p>templates/NOTES.txt 保持默认，无需修改，部署后的访问方式，和提示信息</p>
<p>templates/serviceaccount.yaml 保持默认，无需修改</p>
<p>templates/_helpers.tpl 保持默认，无需修改</p>
<p>templates/ingress.yaml如下</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">{{</span>- <span class="k">if</span> .Values.ingress.enabled -<span class="o">}}</span>
<span class="o">{{</span>- <span class="nv">$fullName</span> :<span class="o">=</span> include <span class="s2">&quot;demoapp.fullname&quot;</span> . -<span class="o">}}</span>
<span class="o">{{</span>- <span class="nv">$svcPort</span> :<span class="o">=</span> .Values.service.port -<span class="o">}}</span>
<span class="o">{{</span>- <span class="k">if</span> semverCompare <span class="s2">&quot;&gt;=1.14-0&quot;</span> .Capabilities.KubeVersion.GitVersion -<span class="o">}}</span>
apiVersion: networking.k8s.io/v1beta1
<span class="o">{{</span>- <span class="k">else</span> -<span class="o">}}</span>
apiVersion: extensions/v1beta1
<span class="o">{{</span>- end <span class="o">}}</span>
kind: Ingress
metadata:
  name: <span class="o">{{</span> <span class="nv">$fullName</span> <span class="o">}}</span>
  labels:
    <span class="o">{{</span>- include <span class="s2">&quot;demoapp.labels&quot;</span> . <span class="p">|</span> nindent <span class="m">4</span> <span class="o">}}</span>
  <span class="o">{{</span>- with .Values.ingress.annotations <span class="o">}}</span>
  annotations:
    <span class="o">{{</span>- toYaml . <span class="p">|</span> nindent <span class="m">4</span> <span class="o">}}</span>
  <span class="o">{{</span>- end <span class="o">}}</span>
spec:
  <span class="o">{{</span>- <span class="k">if</span> .Values.ingress.tls <span class="o">}}</span>
  tls:
    <span class="o">{{</span>- range .Values.ingress.tls <span class="o">}}</span>
    - hosts:
        <span class="o">{{</span>- range .hosts <span class="o">}}</span>
        - <span class="o">{{</span> . <span class="p">|</span> quote <span class="o">}}</span>
        <span class="o">{{</span>- end <span class="o">}}</span>
      secretName: <span class="o">{{</span> .secretName <span class="o">}}</span>
    <span class="o">{{</span>- end <span class="o">}}</span>
  <span class="o">{{</span>- end <span class="o">}}</span>
  rules:
    <span class="o">{{</span>- range .Values.ingress.hosts <span class="o">}}</span>
    - host: <span class="o">{{</span> .host <span class="p">|</span> quote <span class="o">}}</span>
      http:
        paths:
          <span class="o">{{</span>- range .paths <span class="o">}}</span>
          - path: <span class="o">{{</span> . <span class="o">}}</span>
            backend:
              serviceName: <span class="o">{{</span> <span class="nv">$fullName</span> <span class="o">}}</span>
              servicePort: <span class="o">{{</span> <span class="nv">$svcPort</span> <span class="o">}}</span>
          <span class="o">{{</span>- end <span class="o">}}</span>
    <span class="o">{{</span>- end <span class="o">}}</span>
  <span class="o">{{</span>- end <span class="o">}}</span>
</pre></div>
</div>
<p>通过“helm lint”命令确认修改后的Charts是否遵循最佳实践且模板格式良好：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm lint <span class="nv">demoapp</span>
<span class="o">==</span>&gt; Linting demoapp
<span class="o">[</span>INFO<span class="o">]</span> Chart.yaml: icon is recommended

<span class="m">1</span> chart<span class="o">(</span>s<span class="o">)</span> linted, <span class="m">0</span> chart<span class="o">(</span>s<span class="o">)</span> failed
</pre></div>
</div>
<p>多数情况下，“helm
lint”命令报告的错误信息，根据其错误提示中的行号信息即能定位出错误所在。确保一切问题都得以解决之后，即可通过“helm
install”命令调试运行以查看由Charts定义的容器化应用是否能够正确部署：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm install demoapp --debug ./demoapp --dry-run -n demoapp --set service.type<span class="o">=</span>NodePort
</pre></div>
</div>
<p>确认上述命令输出信息无误后，移除命令中的“–dry-run”选项后再次运行命令即可完成应用的部署</p>
<p>通过-f选项将该文件附加于helm
install命令即可将其合并到Chart默认的值文件上，例如下面的命令基于自定义的demoapp
Chart创建了第二个实例，它通过Ingress将服务发布到集群之外。</p>
<p>使用demoapp-values.yaml模板进行部署</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm install demoapp ./demoapp --debug -n demoapp -f ./demoapp/demoapp-values.yaml
</pre></div>
</div>
<p>查看deployment、pod、service、ingress等信息</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ kubectl get deployment,pod,svc,ingress -n demoapp
NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/demoapp   <span class="m">1</span>/1     <span class="m">1</span>            <span class="m">1</span>           2m47s

NAME                           READY   STATUS    RESTARTS   AGE
pod/demoapp-7b97fd699c-55l4w   <span class="m">1</span>/1     Running   <span class="m">0</span>          2m47s

NAME              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
service/demoapp   ClusterIP   <span class="m">10</span>.105.213.227   &lt;none&gt;        <span class="m">80</span>/TCP    2m47s

NAME                         CLASS    HOSTS                   ADDRESS   PORTS   AGE
ingress.extensions/demoapp   &lt;none&gt;   helm-demoapp.runjs.cn             <span class="m">80</span>      2m47s
</pre></div>
</div>
<p><img alt="image2" src="../_images/helm-demoapp001.png" /></p>
</section>
</section>
<section id="id25">
<h3><a class="toc-backref" href="#id68">5. 打包及分享</a><a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h3>
<p>测试完成的自定义Chart可打包后存储在目标仓库仅供自己或有限范围内的用户使用，也可按需公开回馈到社区之中。helm
package命令基于众多选项提供了灵活的打包机制，如下的命令就会先更新依赖关系再进行打包操作。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm package CI-gitee-helm/
Successfully packaged chart and saved it to: /data/jenkins/gitee_workspace_parallel/gitee-ci-3.0.0.tgz
</pre></div>
</div>
<p>将该仓库添加至本地helm命令的可用列表中。</p>
<p><img alt="image3" src="../_images/helm2021-push001.png" /></p>
<p>该类Chart的仓库地址为https://hub.xxxx.xxx/chartrepo/&lt;PROJECT&gt;</p>
<p>该类Chart的仓库地址为http://hub.gitee.cc/chartrepo/gitee-helm</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm repo add gitee-helm http://hub.gitee.cc/chartrepo/gitee-helm
<span class="s2">&quot;gitee-helm&quot;</span> has been added to your repositories
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm repo list
NAME            URL
ingress-nginx   https://kubernetes.github.io/ingress-nginx
stable          https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts
cilium          https://helm.cilium.io/
gitee-helm      http://hub.gitee.cc/chartrepo/gitee-helm
</pre></div>
</div>
<p>接下来，我们可以直接点击如图中的“上传”按钮在Web
GUI中完成Chart上传，也可以为helm添加向仓库推送Chart的push插件，以便直接通过命令行完成Chart上传。Helm的插件管理子命令为plugin，下面的命令就用于安装push插件。</p>
<p>helm(3.0.3)现在默认不支持推送到charts库，需要安装插件helm-push</p>
<p><a class="reference external" href="https://github.com/chartmuseum/helm-push">https://github.com/chartmuseum/helm-push</a></p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm plugin install https://github.com/chartmuseum/helm-push
Downloading and installing helm-push v0.9.0 ...
https://github.com/chartmuseum/helm-push/releases/download/v0.9.0/helm-push_0.9.0_linux_amd64.tar.gz
Installed plugin: push
</pre></div>
</div>
<p>这里最好本地配置一下 github 的 dns 地址，不然可能会出现链接超时的现象</p>
<p>安装好插件之后，就可以push charts 到 harbor 里面了</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm push gitee-ci-3.0.0.tgz gitee-helm --username xxx --password xxxxx
Pushing gitee-ci-3.0.0.tgz to gitee-helm...
Done.
</pre></div>
</div>
<p>出现以上就说明 push 成功了</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 更新</span>
$ helm repo update

<span class="c1"># 下载</span>
$ helm pull gitee-helm/gitee-ci
</pre></div>
</div>
<blockquote>
<div><p>參考文献</p>
<p><a class="reference external" href="https://blog.51cto.com/u_13812615/2523543">https://blog.51cto.com/u_13812615/2523543</a></p>
</div></blockquote>
</section>
</section>
<section id="helm3-chart">
<h2><a class="toc-backref" href="#id69">Helm3 Chart多依赖微服务构建案例</a><a class="headerlink" href="#helm3-chart" title="Permalink to this headline">¶</a></h2>
<section id="id26">
<h3><a class="toc-backref" href="#id70">1. 创建父chart</a><a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h3>
<p>创建一个前端<code class="docutils literal notranslate"><span class="pre">Vue</span></code>作为父<code class="docutils literal notranslate"><span class="pre">Chart</span></code>。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ helm create vue
</pre></div>
</div>
<p>当前的 <code class="docutils literal notranslate"><span class="pre">Chart</span></code> 结构如下：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ tree vue/
vue/
├── charts
├── Chart.yaml
├── templates
│    ├── deployment.yaml
│    ├── _helpers.tpl
│    ├── hpa.yaml
│    ├── ingress.yaml
│    ├── NOTES.txt
│    ├── serviceaccount.yaml
│    ├── service.yaml
│    └── tests
│        └── test-connection.yaml
└── values.yaml
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">charts</span></code>：目录用于存放其他依赖的chart（我们称之为子chart）。</p>
<p><code class="docutils literal notranslate"><span class="pre">Chart.yaml</span></code>：文件包含chart的说明。</p>
<p><code class="docutils literal notranslate"><span class="pre">templates</span></code>：目录用于放置模板文件。是所有资源的位置，我们可以看到很多kubernetes的资源文件都在这里存放。</p>
<p><code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>：文件对模板也很重要。该文件包含 chart
默认值。这些值可能在用户在 helm install 或 helm upgrade 期间被覆盖。</p>
<p><strong>templates目录中的文件：</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>`deployment.yaml`：创建Kubernetes工作负载的基本文件。

`_helpers.tpl`：放置模板的地方，该文件中定义模版可以在整个chart中重复使用。

`hpa.yaml`：HPA配置文件。

`ingress.yaml`：负载均衡配置文件。

`NOTES.txt`：chart的 “帮助文本”。这会在用户运行helm install时显示给用户。

`serviceaccount.yaml`：serviceaccount配置文件。

`service.yaml`：服务发现的配置文件。

`ests/test-connection.yaml`：用于测试chart安装后的测试pod。
</pre></div>
</div>
</section>
<section id="id27">
<h3><a class="toc-backref" href="#id71">2. 创建子Chart</a><a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h3>
<p>创建<code class="docutils literal notranslate"><span class="pre">eureka</span></code>注册中心、<code class="docutils literal notranslate"><span class="pre">oauth2</span></code>鉴权中心和一个<code class="docutils literal notranslate"><span class="pre">MS</span></code>微服务，作为子<code class="docutils literal notranslate"><span class="pre">Chart</span></code>。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> vue/charts/

$ helm create eureka <span class="se">\</span>
&gt; <span class="o">&amp;&amp;</span> helm create oauth2 <span class="se">\</span>
&gt; <span class="o">&amp;&amp;</span> helm create ms <span class="se">\</span>
&gt; <span class="o">&amp;&amp;</span> helm create ws
</pre></div>
</div>
<p>现在当前目录我们一共有五个待调试的<code class="docutils literal notranslate"><span class="pre">Chart</span></code>。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vue          ---父chart
eureka       ---子chart
oauth2       ---子chart
ms           ---子chart
ws           ---子chart
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[root@ci-base helm]# tree vue/
vue/
├── charts
     ├── eureka
│    │    ├── charts
│    │    ├── Chart.yaml
│    │    ├── templates
│    │    │    ├── deployment.yaml
│    │    │    ├── _helpers.tpl
│    │    │    ├── hpa.yaml
│    │    │    ├── ingress.yaml
│    │    │    ├── NOTES.txt
│    │    │    ├── serviceaccount.yaml
│    │    │    ├── service.yaml
│    │    │    └── tests
│    │    │        └── test-connection.yaml
│    │    └── values.yaml
│    ├── ms
│    │    ├── charts
│    │    ├── Chart.yaml
│    │    ├── templates
│    │    │    ├── deployment.yaml
│    │    │    ├── _helpers.tpl
│    │    │    ├── hpa.yaml
│    │    │    ├── ingress.yaml
│    │    │    ├── NOTES.txt
│    │    │    ├── serviceaccount.yaml
│    │    │    ├── service.yaml
│    │    │    └── tests
│    │    │        └── test-connection.yaml
│    │    └── values.yaml
│    ├── oauth2
│    │    ├── charts
│    │    ├── Chart.yaml
│    │    ├── templates
│    │    │    ├── deployment.yaml
│    │    │    ├── _helpers.tpl
│    │    │    ├── hpa.yaml
│    │    │    ├── ingress.yaml
│    │    │    ├── NOTES.txt
│    │    │    ├── serviceaccount.yaml
│    │    │    ├── service.yaml
│    │    │    └── tests
│    │    │        └── test-connection.yaml
│    │    └── values.yaml
│    └── ws
│        ├── charts
│        ├── Chart.yaml
│        ├── templates
│        │    ├── deployment.yaml
│        │    ├── _helpers.tpl
│        │    ├── hpa.yaml
│        │    ├── ingress.yaml
│        │    ├── NOTES.txt
│        │    ├── serviceaccount.yaml
│        │    ├── service.yaml
│        │    └── tests
│        │        └── test-connection.yaml
│        └── values.yaml
├── Chart.yaml
├── templates
│    ├── deployment.yaml
│    ├── _helpers.tpl
│    ├── hpa.yaml
│    ├── ingress.yaml
│    ├── NOTES.txt
│    ├── serviceaccount.yaml
│    ├── service.yaml
│    └── tests
│        └── test-connection.yaml
└── values.yaml
</pre></div>
</div>
</section>
<section id="id28">
<h3><a class="toc-backref" href="#id72">3.调试</a><a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h3>
<section id="id29">
<h4>3.1 调试父Chart<a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h4>
<p><strong>首先删除``Chart``中无用的文件，所有文件根据自己需求创建。</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>rm -rf vue/values.yaml  vue/templates/*
</pre></div>
</div>
<section id="namespace">
<h5>3.1.1 创建命名空间<code class="docutils literal notranslate"><span class="pre">namespace</span></code>模版文件<a class="headerlink" href="#namespace" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>文件中定义如下（每个值后续都会用到，这里统一写完）：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">$ cat vue/values.yaml</span>
<span class="l l-Scalar l-Scalar-Plain">nameSpace</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">microservice</span>
<span class="nt">secretsName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysecret</span>
<span class="nt">imageCredentials</span><span class="p">:</span>
  <span class="nt">registry</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http://192.168.1.40</span>
  <span class="nt">username</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">admin</span>
  <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Yidongjituan123</span>
<span class="nt">replicaCount</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nt">image</span><span class="p">:</span>
  <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.1.40/xzzyy/vue-saas</span>
  <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">95e740c61bd7f9b4b3be62f819d00f90fe10ac24</span>
<span class="nt">service</span><span class="p">:</span>
  <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">40099</span>
</pre></div>
</div>
<p>创建<code class="docutils literal notranslate"><span class="pre">namespace</span></code>模版文件。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vim vue/templates/namespace.yaml
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Namespace</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.nameSpace</span> <span class="p p-Indicator">}}</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.nameSpace</span> <span class="p p-Indicator">}}</span>
</pre></div>
</div>
</section>
<section id="secrets">
<h5>3.1.2 创建镜像仓库<code class="docutils literal notranslate"><span class="pre">secrets</span></code>模版文件<a class="headerlink" href="#secrets" title="Permalink to this headline">¶</a></h5>
<p>镜像拉的secrets实质上是注册，用户名和密码的组合。在正在部署的应用程序中可能需要它们，但要创建它们需要多次运行
base64。我们可以编写一个模板来组合Docker配置文件，以用作Secret的有效载体。这里是一个例子：</p>
<p>我们定义我们的帮助模板如下：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vim vue/templates/_helpers.tpl
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{{</span><span class="o">-</span> <span class="n">define</span> <span class="s2">&quot;imagePullSecret&quot;</span><span class="p">}}</span>
<span class="p">{{</span><span class="o">-</span> <span class="n">printf</span> <span class="s2">&quot;{</span><span class="se">\&quot;</span><span class="s2">auths</span><span class="se">\&quot;</span><span class="s2">: {</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">: {</span><span class="se">\&quot;</span><span class="s2">auth</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">}}}&quot;</span> <span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">imageCredentials</span><span class="o">.</span><span class="n">registry</span> <span class="p">(</span><span class="n">printf</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">imageCredentials</span><span class="o">.</span><span class="n">username</span> <span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">imageCredentials</span><span class="o">.</span><span class="n">password</span> <span class="o">|</span> <span class="n">b64enc</span><span class="p">)</span> <span class="o">|</span> <span class="n">b64enc</span> <span class="p">}}</span>
<span class="p">{{</span><span class="o">-</span> <span class="n">end</span><span class="p">}}</span>
</pre></div>
</div>
<p>创建<code class="docutils literal notranslate"><span class="pre">secrets</span></code>模版文件。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vim vue/templates/secrets.yaml
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Secret</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.secretsName</span> <span class="p p-Indicator">}}</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.nameSpace</span> <span class="p p-Indicator">}}</span>
<span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kubernetes.io/dockerconfigjson</span>
<span class="nt">data</span><span class="p">:</span>
  <span class="nt">.dockerconfigjson</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">template &quot;imagePullSecret&quot; .</span> <span class="p p-Indicator">}}</span>
</pre></div>
</div>
</section>
<section id="deployment">
<h5>3.1.3 创建工作负载<code class="docutils literal notranslate"><span class="pre">deployment</span></code>模版文件<a class="headerlink" href="#deployment" title="Permalink to this headline">¶</a></h5>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vim vue/templates/deployment.yaml
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.nameSpace</span> <span class="p p-Indicator">}}</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">replicas</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.replicaCount</span> <span class="p p-Indicator">}}</span>
  <span class="nt">strategy</span><span class="p">:</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
    <span class="nt">rollingUpdate</span><span class="p">:</span>
      <span class="nt">maxSurge</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
      <span class="nt">maxUnavailable</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">matchLabels</span><span class="p">:</span>
      <span class="nt">app</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
  <span class="nt">template</span><span class="p">:</span>
    <span class="nt">metadata</span><span class="p">:</span>
      <span class="nt">labels</span><span class="p">:</span>
        <span class="nt">app</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
    <span class="nt">spec</span><span class="p">:</span>
      <span class="nt">restartPolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Always</span>
      <span class="nt">imagePullSecrets</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.secretsName</span> <span class="p p-Indicator">}}</span>
      <span class="nt">containers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
        <span class="nt">image</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">.Values.image.repository</span><span class="nv"> </span><span class="s">}}:{{</span><span class="nv"> </span><span class="s">.Values.image.tag</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="nt">imagePullPolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Always</span>
        <span class="nt">ports</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
          <span class="nt">containerPort</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.service.port</span> <span class="p p-Indicator">}}</span>
          <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
        <span class="nt">startupProbe</span><span class="p">:</span>
          <span class="nt">httpGet</span><span class="p">:</span>
            <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/</span>
            <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
          <span class="nt">failureThreshold</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
          <span class="nt">periodSeconds</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
        <span class="nt">livenessProbe</span><span class="p">:</span>
          <span class="nt">httpGet</span><span class="p">:</span>
            <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/</span>
            <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
          <span class="nt">initialDelaySeconds</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
          <span class="nt">failureThreshold</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
          <span class="nt">periodSeconds</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
        <span class="nt">readinessProbe</span><span class="p">:</span>
          <span class="nt">httpGet</span><span class="p">:</span>
            <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/</span>
            <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
          <span class="nt">initialDelaySeconds</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
          <span class="nt">failureThreshold</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
          <span class="nt">periodSeconds</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
</pre></div>
</div>
</section>
<section id="service">
<h5>3.1.4 创建服务发现<code class="docutils literal notranslate"><span class="pre">service</span></code>模版文件<a class="headerlink" href="#service" title="Permalink to this headline">¶</a></h5>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vim vue/templates/service.yaml
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.nameSpace</span> <span class="p p-Indicator">}}</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">NodePort</span>
  <span class="nt">ports</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.service.port</span> <span class="p p-Indicator">}}</span>
    <span class="nt">targetPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
    <span class="nt">nodePort</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.service.port</span> <span class="p p-Indicator">}}</span>
    <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
</pre></div>
</div>
<p>使用<code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">install</span> <span class="pre">--dry-run</span> <span class="pre">demo</span> <span class="pre">vue/</span></code>可对模版进行渲染预览，如渲染不成功，根据提示修改即可。</p>
<p>渲染后的样式：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">NAME</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">demo</span>
<span class="nt">LAST DEPLOYED</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Thu Jul 23 16:06:25 2020</span>
<span class="nt">NAMESPACE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="nt">STATUS</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pending-install</span>
<span class="nt">REVISION</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nt">TEST SUITE</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">None</span>
<span class="nt">HOOKS</span><span class="p">:</span>
<span class="nt">MANIFEST</span><span class="p">:</span>
<span class="nn">---</span>
<span class="c1"># Source: vue/templates/namespace.yaml</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Namespace</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">microservice</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">microservice</span>
<span class="nn">---</span>
<span class="c1"># Source: vue/templates/secrets.yaml</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Secret</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysecret</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">microservice</span>
<span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kubernetes.io/dockerconfigjson</span>
<span class="nt">data</span><span class="p">:</span>
  <span class="nt">.dockerconfigjson</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">eyJhdXRocyI6IHsiaHR0cDovLzE5Mi4xNjguMS40MCI6IHsiYXV0aCI6ICJZV1J0YVc0NldXbGtiMjVuYW1sMGRXRnVNVEl6In19fQ==</span>
<span class="nn">---</span>
<span class="c1"># Source: vue/templates/deployment.yaml</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vue</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">microservice</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">replicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="nt">strategy</span><span class="p">:</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
    <span class="nt">rollingUpdate</span><span class="p">:</span>
      <span class="nt">maxSurge</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
      <span class="nt">maxUnavailable</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">matchLabels</span><span class="p">:</span>
      <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vue</span>
  <span class="nt">template</span><span class="p">:</span>
    <span class="nt">metadata</span><span class="p">:</span>
      <span class="nt">labels</span><span class="p">:</span>
        <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vue</span>
    <span class="nt">spec</span><span class="p">:</span>
      <span class="nt">restartPolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Always</span>
      <span class="nt">imagePullSecrets</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysecret</span>
      <span class="nt">containers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vue</span>
        <span class="nt">image</span><span class="p">:</span> <span class="s">&quot;192.168.1.40/xzzyy/vue-saas:95e740c61bd7f9b4b3be62f819d00f90fe10ac24&quot;</span>
        <span class="nt">imagePullPolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Always</span>
        <span class="nt">ports</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
          <span class="nt">containerPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">40099</span>
<span class="l l-Scalar l-Scalar-Plain">......</span>
</pre></div>
</div>
</section>
</section>
<section id="id30">
<h4>3.2 调试子Chart<a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h4>
<p>由于父Chart已经创建完成namespace、secrets，子Chart无需再次创建。删除无用文件。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> vue/charts/
rm -rf eureka/values.yaml eureka/templates/* <span class="se">\</span>
&gt; <span class="o">&amp;&amp;</span> rm -rf oauth2/values.yaml oauth2/templates/* <span class="se">\</span>
&gt; <span class="o">&amp;&amp;</span>  rm -rf ms/values.yaml ms/templates/* <span class="se">\</span>
&gt; <span class="o">&amp;&amp;</span>  rm -rf ws/values.yaml ws/templates/*
</pre></div>
</div>
<section id="configmap">
<h5>3.2.1 创建配置映射configmap模版文件<a class="headerlink" href="#configmap" title="Permalink to this headline">¶</a></h5>
<p>使用configmap统一管理Spring
Boot的配置文件。只需要创建一个configmap，然后将四个配置文件以键值对的方式存入该configmap，以便引用。</p>
<p>values.yaml文件中定义如下（每个值后续都会用到，这里统一写完）：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vim eureka/values.yaml
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">configmapName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">demo-config</span>
<span class="nt">nameSpace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">microservice</span>
<span class="nt">secretsName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysecret</span>
<span class="nt">replicaCount</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nt">image</span><span class="p">:</span>
  <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.1.40/xzzyy/eureka</span>
  <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bff976dda6786a2b593ccf5a76bd2e1cf670e615</span>
<span class="nt">service</span><span class="p">:</span>
  <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">40000</span>
</pre></div>
</div>
<p>创建<code class="docutils literal notranslate"><span class="pre">configmap</span></code>模版文件。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vim eureka/templates/configmap.yaml
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.configmapName</span> <span class="p p-Indicator">}}</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.nameSpace</span> <span class="p p-Indicator">}}</span>
<span class="nt">data</span><span class="p">:</span>
<span class="p p-Indicator">{{</span> <span class="nv">(.Files.Glob &quot;config/*&quot;).AsConfig | indent 2</span> <span class="p p-Indicator">}}</span>
</pre></div>
</div>
<p>使用引用静态文件的方式，直接引入配置文件内容，经过这种方式会创建四个键值对，键为配置名称，值为配置文件内容。不过需要提前将配置文件放入<code class="docutils literal notranslate"><span class="pre">Chart</span></code>的根目录，如下：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>eureka/
├── charts
├── Chart.yaml
├── config
│   ├── eureka.yml
│   ├── ms.yml
│   ├── oauth2.yml
│   └── ws.yml
├── templates
│   ├── configmap.yaml
│   ├── deployment.yaml
│   └── service.yaml
└── values.yaml
</pre></div>
</div>
<p>编写完之后可以通过<code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">install</span> <span class="pre">--dry-run</span> <span class="pre">confimap</span> <span class="pre">eureka/</span></code>验证模版正确性。</p>
</section>
<section id="deployment-1">
<span id="id31"></span><h5>3.2.2 创建工作负载<code class="docutils literal notranslate"><span class="pre">deployment</span></code>模版文件<a class="headerlink" href="#deployment-1" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><p>eureka</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vim eureka/templates/deployment.yaml
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.nameSpace</span> <span class="p p-Indicator">}}</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">replicas</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.replicaCount</span> <span class="p p-Indicator">}}</span>
  <span class="nt">strategy</span><span class="p">:</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
    <span class="nt">rollingUpdate</span><span class="p">:</span>
      <span class="nt">maxSurge</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
      <span class="nt">maxUnavailable</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">matchLabels</span><span class="p">:</span>
      <span class="nt">app</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
  <span class="nt">template</span><span class="p">:</span>
    <span class="nt">metadata</span><span class="p">:</span>
      <span class="nt">labels</span><span class="p">:</span>
        <span class="nt">app</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
    <span class="nt">spec</span><span class="p">:</span>
      <span class="nt">restartPolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Always</span>
      <span class="nt">imagePullSecrets</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.secretsName</span> <span class="p p-Indicator">}}</span>
      <span class="nt">containers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
        <span class="nt">image</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">.Values.image.repository</span><span class="nv"> </span><span class="s">}}:{{</span><span class="nv"> </span><span class="s">.Values.image.tag</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="nt">imagePullPolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Always</span>
        <span class="nt">ports</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
          <span class="nt">containerPort</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.service.port</span> <span class="p p-Indicator">}}</span>
          <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
        <span class="nt">startupProbe</span><span class="p">:</span>
          <span class="nt">tcpSocket</span><span class="p">:</span>
            <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
          <span class="nt">initialDelaySeconds</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
          <span class="nt">failureThreshold</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
          <span class="nt">periodSeconds</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
        <span class="nt">readinessProbe</span><span class="p">:</span>
          <span class="nt">tcpSocket</span><span class="p">:</span>
            <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
          <span class="nt">failureThreshold</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
          <span class="nt">periodSeconds</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
        <span class="nt">livenessProbe</span><span class="p">:</span>
          <span class="nt">tcpSocket</span><span class="p">:</span>
            <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
          <span class="nt">failureThreshold</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
          <span class="nt">periodSeconds</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
        <span class="nt">resources</span><span class="p">:</span>
          <span class="nt">limits</span><span class="p">:</span>
            <span class="nt">cpu</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
            <span class="nt">memory</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2Gi</span>
          <span class="nt">requests</span><span class="p">:</span>
            <span class="nt">cpu</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
            <span class="nt">memory</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1Gi</span>
        <span class="nt">volumeMounts</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config-volume</span>
            <span class="nt">mountPath</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/config</span>
      <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config-volume</span>
        <span class="nt">configMap</span><span class="p">:</span>
          <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.configmapName</span> <span class="p p-Indicator">}}</span>
          <span class="nt">items</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="nt">key</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">.yml</span>
            <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bootstrap.yml</span>
</pre></div>
</div>
<ul class="simple">
<li><p>oauth2</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>内容。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vim oauth2/values.yaml
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">secretsName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysecret</span>
<span class="nt">configmapName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">demo-config</span>
<span class="nt">nameSpace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">microservice</span>
<span class="nt">replicaCount</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nt">image</span><span class="p">:</span>
  <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.1.40/xzzyy/oauth2</span>
  <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bff976dda6786a2b593ccf5a76bd2e1cf670e615</span>
<span class="nt">service</span><span class="p">:</span>
  <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">40001</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">deployment.yaml</span></code>内容</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vim oauth2/templates/deployment.yaml
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.nameSpace</span> <span class="p p-Indicator">}}</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">replicas</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.replicaCount</span> <span class="p p-Indicator">}}</span>
  <span class="nt">strategy</span><span class="p">:</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
    <span class="nt">rollingUpdate</span><span class="p">:</span>
      <span class="nt">maxSurge</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
      <span class="nt">maxUnavailable</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">matchLabels</span><span class="p">:</span>
      <span class="nt">app</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
  <span class="nt">template</span><span class="p">:</span>
    <span class="nt">metadata</span><span class="p">:</span>
      <span class="nt">labels</span><span class="p">:</span>
        <span class="nt">app</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
    <span class="nt">spec</span><span class="p">:</span>
      <span class="nt">restartPolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Always</span>
      <span class="nt">imagePullSecrets</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.secretsName</span> <span class="p p-Indicator">}}</span>
      <span class="nt">containers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
        <span class="nt">image</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">.Values.image.repository</span><span class="nv"> </span><span class="s">}}:{{</span><span class="nv"> </span><span class="s">.Values.image.tag</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="nt">imagePullPolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Always</span>
        <span class="nt">ports</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
          <span class="nt">containerPort</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.service.port</span> <span class="p p-Indicator">}}</span>
          <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
        <span class="nt">startupProbe</span><span class="p">:</span>
          <span class="nt">tcpSocket</span><span class="p">:</span>
            <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
          <span class="nt">initialDelaySeconds</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
          <span class="nt">failureThreshold</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
          <span class="nt">periodSeconds</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
        <span class="nt">readinessProbe</span><span class="p">:</span>
          <span class="nt">tcpSocket</span><span class="p">:</span>
            <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
          <span class="nt">failureThreshold</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
          <span class="nt">periodSeconds</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
        <span class="nt">livenessProbe</span><span class="p">:</span>
          <span class="nt">tcpSocket</span><span class="p">:</span>
            <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
          <span class="nt">failureThreshold</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
          <span class="nt">periodSeconds</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
        <span class="nt">resources</span><span class="p">:</span>
          <span class="nt">limits</span><span class="p">:</span>
            <span class="nt">cpu</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
            <span class="nt">memory</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2Gi</span>
          <span class="nt">requests</span><span class="p">:</span>
            <span class="nt">cpu</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
            <span class="nt">memory</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1Gi</span>
        <span class="nt">volumeMounts</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config-volume</span>
            <span class="nt">mountPath</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/config</span>
      <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config-volume</span>
        <span class="nt">configMap</span><span class="p">:</span>
          <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.configmapName</span> <span class="p p-Indicator">}}</span>
          <span class="nt">items</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="nt">key</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">.yml</span>
            <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bootstrap.yml</span>
</pre></div>
</div>
<ul class="simple">
<li><p>ws</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>内容</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vim ws/values.yaml
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">secretsName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysecret</span>
<span class="nt">configmapName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">demo-config</span>
<span class="nt">nameSpace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">microservice</span>
<span class="nt">replicaCount</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nt">image</span><span class="p">:</span>
  <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.1.40/xzzyy/doctor-ws</span>
  <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bff976dda6786a2b593ccf5a76bd2e1cf670e615</span>
<span class="nt">service</span><span class="p">:</span>
  <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">40002</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">deployment.yaml</span></code>内容</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vim ws/templates/deployment.yaml
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.nameSpace</span> <span class="p p-Indicator">}}</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">replicas</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.replicaCount</span> <span class="p p-Indicator">}}</span>
  <span class="nt">strategy</span><span class="p">:</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
    <span class="nt">rollingUpdate</span><span class="p">:</span>
      <span class="nt">maxSurge</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
      <span class="nt">maxUnavailable</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">matchLabels</span><span class="p">:</span>
      <span class="nt">app</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
  <span class="nt">template</span><span class="p">:</span>
    <span class="nt">metadata</span><span class="p">:</span>
      <span class="nt">labels</span><span class="p">:</span>
        <span class="nt">app</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
    <span class="nt">spec</span><span class="p">:</span>
      <span class="nt">restartPolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Always</span>
      <span class="nt">imagePullSecrets</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.secretsName</span> <span class="p p-Indicator">}}</span>
      <span class="nt">containers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
        <span class="nt">image</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">.Values.image.repository</span><span class="nv"> </span><span class="s">}}:{{</span><span class="nv"> </span><span class="s">.Values.image.tag</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="nt">imagePullPolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Always</span>
        <span class="nt">ports</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
          <span class="nt">containerPort</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.service.port</span> <span class="p p-Indicator">}}</span>
          <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
        <span class="nt">startupProbe</span><span class="p">:</span>
          <span class="nt">httpGet</span><span class="p">:</span>
            <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/doc.html</span>
            <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
          <span class="nt">initialDelaySeconds</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
          <span class="nt">failureThreshold</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
          <span class="nt">periodSeconds</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
        <span class="nt">livenessProbe</span><span class="p">:</span>
          <span class="nt">httpGet</span><span class="p">:</span>
            <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/doc.html</span>
            <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
          <span class="nt">failureThreshold</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
          <span class="nt">periodSeconds</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
        <span class="nt">readinessProbe</span><span class="p">:</span>
          <span class="nt">httpGet</span><span class="p">:</span>
            <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/doc.html</span>
            <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
          <span class="nt">failureThreshold</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
          <span class="nt">periodSeconds</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
        <span class="nt">resources</span><span class="p">:</span>
          <span class="nt">limits</span><span class="p">:</span>
            <span class="nt">cpu</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
            <span class="nt">memory</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2Gi</span>
          <span class="nt">requests</span><span class="p">:</span>
            <span class="nt">cpu</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
            <span class="nt">memory</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1Gi</span>
        <span class="nt">volumeMounts</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config-volume</span>
          <span class="nt">mountPath</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/config</span>
      <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config-volume</span>
        <span class="nt">configMap</span><span class="p">:</span>
          <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.configmapName</span> <span class="p p-Indicator">}}</span>
          <span class="nt">items</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="nt">key</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">.yml</span>
            <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bootstrap.yml</span>
</pre></div>
</div>
<ul class="simple">
<li><p>ms</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>内容</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vim ms/values.yaml
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">secretsName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysecret</span>
<span class="nt">configmapName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">demo-config</span>
<span class="nt">nameSpace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">microservice</span>
<span class="nt">replicaCount</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nt">image</span><span class="p">:</span>
  <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.1.40/xzzyy/online-registration-ms</span>
  <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bff976dda6786a2b593ccf5a76bd2e1cf670e615</span>
<span class="nt">service</span><span class="p">:</span>
  <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">40003</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">deployment.yaml</span></code>内容</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vim ms/templates/deployment.yaml
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.nameSpace</span> <span class="p p-Indicator">}}</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">replicas</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.replicaCount</span> <span class="p p-Indicator">}}</span>
  <span class="nt">strategy</span><span class="p">:</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
    <span class="nt">rollingUpdate</span><span class="p">:</span>
      <span class="nt">maxSurge</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
      <span class="nt">maxUnavailable</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">matchLabels</span><span class="p">:</span>
      <span class="nt">app</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
  <span class="nt">template</span><span class="p">:</span>
    <span class="nt">metadata</span><span class="p">:</span>
      <span class="nt">labels</span><span class="p">:</span>
        <span class="nt">app</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
    <span class="nt">spec</span><span class="p">:</span>
      <span class="nt">restartPolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Always</span>
      <span class="nt">imagePullSecrets</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.secretsName</span> <span class="p p-Indicator">}}</span>
      <span class="nt">containers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
        <span class="nt">image</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">.Values.image.repository</span><span class="nv"> </span><span class="s">}}:{{</span><span class="nv"> </span><span class="s">.Values.image.tag</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="nt">imagePullPolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Always</span>
        <span class="nt">ports</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
          <span class="nt">containerPort</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.service.port</span> <span class="p p-Indicator">}}</span>
          <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
        <span class="nt">startupProbe</span><span class="p">:</span>
          <span class="nt">httpGet</span><span class="p">:</span>
            <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/doc.html</span>
            <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
          <span class="nt">initialDelaySeconds</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
          <span class="nt">failureThreshold</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
          <span class="nt">periodSeconds</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
        <span class="nt">livenessProbe</span><span class="p">:</span>
          <span class="nt">httpGet</span><span class="p">:</span>
            <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/doc.html</span>
            <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
          <span class="nt">failureThreshold</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
          <span class="nt">periodSeconds</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
        <span class="nt">readinessProbe</span><span class="p">:</span>
          <span class="nt">httpGet</span><span class="p">:</span>
            <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/doc.html</span>
            <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
          <span class="nt">failureThreshold</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
          <span class="nt">periodSeconds</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
        <span class="nt">resources</span><span class="p">:</span>
          <span class="nt">limits</span><span class="p">:</span>
            <span class="nt">cpu</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
            <span class="nt">memory</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2Gi</span>
          <span class="nt">requests</span><span class="p">:</span>
            <span class="nt">cpu</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
            <span class="nt">memory</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1Gi</span>
        <span class="nt">volumeMounts</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config-volume</span>
          <span class="nt">mountPath</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/config</span>
      <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">config-volume</span>
        <span class="nt">configMap</span><span class="p">:</span>
          <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.configmapName</span> <span class="p p-Indicator">}}</span>
          <span class="nt">items</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="nt">key</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">.yml</span>
            <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bootstrap.yml</span>
</pre></div>
</div>
</section>
<section id="service-1">
<span id="id32"></span><h5>3.2.3 创建服务发现<code class="docutils literal notranslate"><span class="pre">service</span></code>模版文件<a class="headerlink" href="#service-1" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><p>eureka</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vim eureka/templates/service.yaml
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.nameSpace</span> <span class="p p-Indicator">}}</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">NodePort</span>
  <span class="nt">ports</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.service.port</span> <span class="p p-Indicator">}}</span>
    <span class="nt">targetPort</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.service.port</span> <span class="p p-Indicator">}}</span>
    <span class="nt">nodePort</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.service.port</span> <span class="p p-Indicator">}}</span>
    <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>oauth2</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vim oauth2/templates/service.yaml
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.nameSpace</span> <span class="p p-Indicator">}}</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">NodePort</span>
  <span class="nt">ports</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.service.port</span> <span class="p p-Indicator">}}</span>
    <span class="nt">targetPort</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.service.port</span> <span class="p p-Indicator">}}</span>
    <span class="nt">nodePort</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.service.port</span> <span class="p p-Indicator">}}</span>
    <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>ws</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vim ws/templates/service.yaml
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.nameSpace</span> <span class="p p-Indicator">}}</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">NodePort</span>
  <span class="nt">ports</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.service.port</span> <span class="p p-Indicator">}}</span>
    <span class="nt">targetPort</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.service.port</span> <span class="p p-Indicator">}}</span>
    <span class="nt">nodePort</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.service.port</span> <span class="p p-Indicator">}}</span>
    <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>ms</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vim ms/templates/service.yaml
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.nameSpace</span> <span class="p p-Indicator">}}</span>
  <span class="nt">labels</span><span class="p">:</span>
    <span class="nt">name</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">NodePort</span>
  <span class="nt">ports</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.service.port</span> <span class="p p-Indicator">}}</span>
    <span class="nt">targetPort</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.service.port</span> <span class="p p-Indicator">}}</span>
    <span class="nt">nodePort</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Values.service.port</span> <span class="p p-Indicator">}}</span>
    <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TCP</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">app</span><span class="p">:</span> <span class="p p-Indicator">{{</span> <span class="nv">.Chart.Name</span> <span class="p p-Indicator">}}</span>
</pre></div>
</div>
<p>通过<code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">install</span> <span class="pre">--dry-run</span> <span class="pre">demo</span> <span class="pre">xxxx/</span></code>验证每个<code class="docutils literal notranslate"><span class="pre">Chart</span></code>的正确性。</p>
</section>
</section>
<section id="id33">
<h4>3.3 联合调试父子Chart<a class="headerlink" href="#id33" title="Permalink to this headline">¶</a></h4>
<p><strong>保证每个Chart都可以``–dry-run``渲染成功，然后就可以开始进行联调试</strong></p>
<p>首先修改父<code class="docutils literal notranslate"><span class="pre">Chart</span></code>的<code class="docutils literal notranslate"><span class="pre">Chart.yaml</span></code>文件，添加依赖关系。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vim vue/Chart.yaml
</pre></div>
</div>
<p>追加如下内容，<code class="docutils literal notranslate"><span class="pre">file://</span></code>是针对<code class="docutils literal notranslate"><span class="pre">Chart.yaml</span></code>的相对路径，也可以写远程<code class="docutils literal notranslate"><span class="pre">repo</span></code>库的地址，这里是本地调试没有用到。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dependencies</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">eureka</span>
    <span class="n">repository</span><span class="p">:</span> <span class="n">file</span><span class="p">:</span><span class="o">//../</span><span class="n">eureka</span><span class="o">/</span>
    <span class="n">version</span><span class="p">:</span> <span class="mf">0.1</span><span class="o">.</span><span class="mi">0</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">oauth2</span>
    <span class="n">repository</span><span class="p">:</span> <span class="n">file</span><span class="p">:</span><span class="o">//../</span><span class="n">oauth2</span><span class="o">/</span>
    <span class="n">version</span><span class="p">:</span> <span class="mf">0.1</span><span class="o">.</span><span class="mi">0</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">ws</span>
    <span class="n">repository</span><span class="p">:</span> <span class="n">file</span><span class="p">:</span><span class="o">//../</span><span class="n">ws</span><span class="o">/</span>
    <span class="n">version</span><span class="p">:</span> <span class="mf">0.1</span><span class="o">.</span><span class="mi">0</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">ms</span>
    <span class="n">repository</span><span class="p">:</span> <span class="n">file</span><span class="p">:</span><span class="o">//../</span><span class="n">ms</span><span class="o">/</span>
    <span class="n">version</span><span class="p">:</span> <span class="mf">0.1</span><span class="o">.</span><span class="mi">0</span>
</pre></div>
</div>
<p>然后使用<code class="docutils literal notranslate"><span class="pre">dependency</span> <span class="pre">update</span></code>参数，构建<code class="docutils literal notranslate"><span class="pre">chart</span></code>依赖。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>root@harbor ~<span class="o">]</span><span class="c1"># helm dependency update vue/</span>
Hang tight <span class="k">while</span> we grab the latest from your chart repositories...
...Successfully got an update from the <span class="s2">&quot;myrepo&quot;</span> chart repository
Update Complete. ⎈Happy Helming!⎈
Saving <span class="m">4</span> charts
Deleting outdated charts
</pre></div>
</div>
<p>最终父<code class="docutils literal notranslate"><span class="pre">Chart</span></code>目录结构</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>vue/
├── Chart.lock
├── charts
│   ├── eureka-0.1.0.tgz
│   ├── ms-0.1.0.tgz
│   ├── oauth2-0.1.0.tgz
│   └── ws-0.1.0.tgz
├── Chart.yaml
├── templates
│   ├── deployment.yaml
│   ├── _helpers.tpl
│   ├── namespace.yaml
│   ├── secrets.yaml
│   └── service.yaml
└── values.yaml
</pre></div>
</div>
</section>
</section>
<section id="id34">
<span id="id35"></span><h3><a class="toc-backref" href="#id73">4. 安装</a><a class="headerlink" href="#id34" title="Permalink to this headline">¶</a></h3>
<p>直接使用<code class="docutils literal notranslate"><span class="pre">helm</span></code>本地安装父<code class="docutils literal notranslate"><span class="pre">Chart</span></code>即可</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>helm install demo vue/
</pre></div>
</div>
<p>查看安装的chart</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ helm list
NAME                        NAMESPACE   REVISION    UPDATED                                 STATUS      CHART           APP VERSION
demo                        default     <span class="m">1</span>           <span class="m">2020</span>-07-23 <span class="m">17</span>:18:14.746382646 +0800 CST deployed    vue-0.
</pre></div>
</div>
<p>查看部署的deployment</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ kubectl get deployments.apps -n microservice
NAME     READY   UP-TO-DATE   AVAILABLE   AGE
eureka   <span class="m">1</span>/1     <span class="m">1</span>            <span class="m">1</span>           43s
ms       <span class="m">1</span>/1     <span class="m">1</span>            <span class="m">1</span>           43s
oauth2   <span class="m">1</span>/1     <span class="m">1</span>            <span class="m">1</span>           43s
vue      <span class="m">1</span>/1     <span class="m">1</span>            <span class="m">1</span>           43s
ws       <span class="m">1</span>/1     <span class="m">1</span>            <span class="m">1</span>           43s
</pre></div>
</div>
</section>
<section id="id36">
<h3><a class="toc-backref" href="#id74">5.优化</a><a class="headerlink" href="#id36" title="Permalink to this headline">¶</a></h3>
<p>述步骤完成的多依赖构建，已经满足一键部署多个服务的需求了，但是通过实际操作下来，会发现一些问题：</p>
<p>每个子chart中都有相同的values值。例如：secretsName、configmapName、nameSpace。
有很多模版都是相同的。例如：deployment.yaml、service.yaml。</p>
<p>如果有二三十个微服务后端的话，会有一大部分时间在做重复工作。所以我们就在想能不能复用这些常量和模版。</p>
<section id="id37">
<h4>5.1 全局常量<a class="headerlink" href="#id37" title="Permalink to this headline">¶</a></h4>
<p>可以修改父Chart的values.yaml，追加一个global值，将所有子Chart会用到的值设置为全局常量。</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">imageCredentials</span><span class="p">:</span>
  <span class="nt">registry</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http://192.168.1.40</span>
  <span class="nt">username</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">admin</span>
  <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Yidongjituan123</span>
<span class="nt">replicaCount</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nt">image</span><span class="p">:</span>
  <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.1.40/xzzyy/vue-saas</span>
  <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">95e740c61bd7f9b4b3be62f819d00f90fe10ac24</span>
<span class="nt">service</span><span class="p">:</span>
  <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">40099</span>

<span class="nt">global</span><span class="p">:</span>
  <span class="nt">nameSpace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">microservice</span>
  <span class="nt">secretsName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysecret</span>
  <span class="nt">configmapName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">demo-config</span>
</pre></div>
</div>
<p>此值可供所有<code class="docutils literal notranslate"><span class="pre">chart</span></code>使用，使用方式：<code class="docutils literal notranslate"><span class="pre">.Values.global.nameSpace</span></code>、<code class="docutils literal notranslate"><span class="pre">.Values.global.secretsName</span></code>等等。
这样我们就无需在每个子<code class="docutils literal notranslate"><span class="pre">Chart</span></code>的<code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>中重复定义这些值了，只需修改一下模版中的使用方式即可。</p>
</section>
<section id="id38">
<h4>5.2 共享常量<a class="headerlink" href="#id38" title="Permalink to this headline">¶</a></h4>
<p>父<code class="docutils literal notranslate"><span class="pre">Chart</span></code>的<code class="docutils literal notranslate"><span class="pre">values.yaml</span></code>，增加以下内容，注意节点的名字必须是子<code class="docutils literal notranslate"><span class="pre">chart</span></code>名。</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">imageCredentials</span><span class="p">:</span>
  <span class="nt">registry</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">http://192.168.1.40</span>
  <span class="nt">username</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">admin</span>
  <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Yidongjituan123</span>
<span class="nt">replicaCount</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nt">image</span><span class="p">:</span>
  <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.1.40/xzzyy/vue-saas</span>
  <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">95e740c61bd7f9b4b3be62f819d00f90fe10ac24</span>
<span class="nt">service</span><span class="p">:</span>
  <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">40099</span>
<span class="nt">global</span><span class="p">:</span>
  <span class="nt">nameSpace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">microservice</span>
  <span class="nt">secretsName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysecret</span>
  <span class="nt">configmapName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">demo-config</span>

<span class="nt">eureka</span><span class="p">:</span>
  <span class="nt">replicaCount</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="nt">image</span><span class="p">:</span>
    <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.1.40/xzzyy/eureka</span>
    <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bff976dda6786a2b593ccf5a76bd2e1cf670e615</span>
  <span class="nt">service</span><span class="p">:</span>
    <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">40000</span>

<span class="nt">oauth2</span><span class="p">:</span>
  <span class="nt">replicaCount</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="nt">image</span><span class="p">:</span>
    <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.1.40/xzzyy/oauth2</span>
    <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bff976dda6786a2b593ccf5a76bd2e1cf670e615</span>
  <span class="nt">service</span><span class="p">:</span>
    <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">40001</span>

<span class="nt">ws</span><span class="p">:</span>
  <span class="nt">replicaCount</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="nt">image</span><span class="p">:</span>
    <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.1.40/xzzyy/doctor-ws</span>
    <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bff976dda6786a2b593ccf5a76bd2e1cf670e615</span>
  <span class="nt">service</span><span class="p">:</span>
    <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">40002</span>

<span class="nt">ms</span><span class="p">:</span>
  <span class="nt">replicaCount</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="nt">image</span><span class="p">:</span>
    <span class="nt">repository</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.1.40/xzzyy/online-registration-ms</span>
    <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bff976dda6786a2b593ccf5a76bd2e1cf670e615</span>
  <span class="nt">service</span><span class="p">:</span>
    <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">40003</span>
</pre></div>
</div>
<p>在eureka的模板里就可以通过{{ .Values.replicaCount }}
来引用。当Helm发现节点名是子chart名时，它会自动引用这个常量到子chart的values.yaml中。
因此，在oauth2中，你也可以通过{{ .Values.image.repository }}
来访问这个常量。</p>
<p>如果出现父Chart与子Chart中都定义了相同的values值，那么helm会以父Chart为准，覆盖子Chart中相同的值。</p>
<blockquote>
<div><p>参考文献：</p>
<p><a class="reference external" href="https://blog.csdn.net/qq_39680564/article/details/107516510">https://blog.csdn.net/qq_39680564/article/details/107516510</a></p>
</div></blockquote>
<p>模板文件参考</p>
<p>_helpers.tpl</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>{{/* vim: set filetype=mustache: */}}
{{/*
Expand the name of the chart.
展开chart的名称。
*/}}
{{- define &quot;vue.name&quot; -}}
{{- default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix &quot;-&quot; }}
{{- end }}

{{/*
Create a default fully qualified app name.
We truncate at 63 chars because some Kubernetes name fields are limited to this (by the DNS naming spec).
If release name contains chart name it will be used as a full name.

创建一个默认的完全限定应用名称。
我们截断为 63 个字符，因为某些 Kubernetes 名称字段仅限于此（受 DNS 命名规范）。
如果发布名称包含chart名称，它将用作全名。
*/}}
{{- define &quot;vue.fullname&quot; -}}
{{- if .Values.fullnameOverride }}
{{- .Values.fullnameOverride | trunc 63 | trimSuffix &quot;-&quot; }}
{{- else }}
{{- $name := default .Chart.Name .Values.nameOverride }}
{{- if contains $name .Release.Name }}
{{- .Release.Name | trunc 63 | trimSuffix &quot;-&quot; }}
{{- else }}
{{- printf &quot;%s-%s&quot; .Release.Name $name | trunc 63 | trimSuffix &quot;-&quot; }}
{{- end }}
{{- end }}
{{- end }}

{{/*
Create chart name and version as used by the chart label.
创建chart标签使用的chart名称和版本。
*/}}
{{- define &quot;vue.chart&quot; -}}
{{- printf &quot;%s-%s&quot; .Chart.Name .Chart.Version | replace &quot;+&quot; &quot;_&quot; | trunc 63 | trimSuffix &quot;-&quot; }}
{{- end }}

{{/*
Common labels
常用标签
*/}}
{{- define &quot;vue.labels&quot; -}}
helm.sh/chart: {{ include &quot;vue.chart&quot; . }}
{{ include &quot;vue.selectorLabels&quot; . }}
{{- if .Chart.AppVersion }}
app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
{{- end }}
app.kubernetes.io/managed-by: {{ .Release.Service }}
{{- end }}

{{/*
Selector labels
选择器标签
*/}}
{{- define &quot;vue.selectorLabels&quot; -}}
app.kubernetes.io/name: {{ include &quot;vue.name&quot; . }}
app.kubernetes.io/instance: {{ .Release.Name }}
{{- end }}

{{/*
Create the name of the service account to use
创建要使用的服务帐户的名称
*/}}
{{- define &quot;vue.serviceAccountName&quot; -}}
{{- if .Values.serviceAccount.create }}
{{- default (include &quot;vue.fullname&quot; .) .Values.serviceAccount.name }}
{{- else }}
{{- default &quot;default&quot; .Values.serviceAccount.name }}
{{- end }}
{{- end }}
</pre></div>
</div>
</section>
</section>
</section>
<section id="id39">
<h2><a class="toc-backref" href="#id75">常见命令</a><a class="headerlink" href="#id39" title="Permalink to this headline">¶</a></h2>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 基于本地Chart目录部署</span>
$ helm install -f values.yaml -n ci-gitee-nginx ci-gitee-nginx ./

<span class="c1"># 删除release</span>
$ helm uninstall -n ci-gitee-nginx ci-gitee-nginx
$ helm delete -n ci-gitee-nginx ci-gitee-nginx

<span class="c1"># 查看版本历史</span>
$ helm <span class="nb">history</span> -n ci-gitee-nginx ci-gitee-nginx

<span class="c1"># 下载Chart</span>
$ helm fetch xinlin/k8sapp

<span class="c1"># 基于本地Chart目录部署</span>
$ helm install ./k8sapp

<span class="c1"># 安装本地 chart</span>
$ helm install -f myvalues.yaml myredis ./redis

<span class="c1"># 检查charts的依赖及模板配置是否正确</span>
$ helm lint example/


为了检测生成的清单，但并不安装到chart，可以将 --debug 和 --dry-run组合使用。

如果设置了—verify，chart必须有出处文件，且出处文件必须传递所有的验证步骤。

有五种不同的方式来标识需要安装的chart：

<span class="m">1</span>.通过chart引用： helm install mymaria example/mariadb

<span class="m">2</span>.通过chart包： helm install mynginx ./nginx-1.2.3.tgz

<span class="m">3</span>.通过未打包chart目录的路径： helm install mynginx ./nginx

<span class="m">4</span>.通过URL绝对路径： helm install mynginx https://example.com/charts/nginx-1.2.3.tgz

<span class="m">5</span>.通过chart引用和仓库url： helm install —repo https://example.com/charts/ mynginx nginx


<span class="c1"># 指定变量</span>
$ helm install --set <span class="nv">name</span><span class="o">=</span>prod myredis ./redis

<span class="c1"># 指定变量的值为 string 类型</span>
$ helm install --set-string <span class="nv">long_int</span><span class="o">=</span><span class="m">1234567890</span> myredis ./redis

<span class="c1"># 指定引用的文件地址</span>
$ helm install --set-file <span class="nv">my_script</span><span class="o">=</span>dothings.sh myredis ./redis

<span class="c1"># 同时指定多个变量</span>
$ helm install --set <span class="nv">foo</span><span class="o">=</span>bar --set <span class="nv">foo</span><span class="o">=</span>newbar  myredis ./redis

<span class="c1"># 卸载helm安装包</span>
$ helm uninstall demoapp -n demoapp

<span class="c1"># 打包</span>
$ helm package nginx_text

<span class="c1"># 运行一个测试容器，访问helm测试</span>
$ kubectl run busybox --rm -ti --image<span class="o">=</span>busybox /bin/sh

<span class="c1"># 搜索</span>
$ helm search k8sapp

<span class="c1"># 启动本地仓库服务</span>
$ helm serve


<span class="c1"># 查看所有namespaces中部署的release</span>
$ helm list --all-namespaces

<span class="c1"># 查看某Release的相关状态信息</span>
$  helm status ci-gitee-release -n ci-gitee-release
NAME: ci-gitee-release
LAST DEPLOYED: Thu Apr  <span class="m">8</span> <span class="m">10</span>:46:33 <span class="m">2021</span>
NAMESPACE: ci-gitee-release
STATUS: deployed
REVISION: <span class="m">1</span>
TEST SUITE: None

<span class="c1"># 查看由Charts定义的容器化应用是否能够正确部署，调试</span>
$ helm install demoapp --debug ./demoapp --dry-run -n demoapp --set service.type<span class="o">=</span>NodePort
</pre></div>
</div>
<p>参考文献：</p>
<p>Helm v3 安装使用</p>
<p><a class="reference external" href="https://cooting.cn/archives/150.html">https://cooting.cn/archives/150.html</a></p>
</section>
<section id="helm3">
<h2><a class="toc-backref" href="#id76">Helm3内置对象</a><a class="headerlink" href="#helm3" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://www.akiraka.net/kubernetes/helm/1268.html">https://www.akiraka.net/kubernetes/helm/1268.html</a></p>
</section>
<section id="kubernetes-k8s-helm-efk">
<h2><a class="toc-backref" href="#id77">Kubernetes（k8s）Helm 部署 EFK 集群</a><a class="headerlink" href="#kubernetes-k8s-helm-efk" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://zhuanlan.zhihu.com/p/113629660">https://zhuanlan.zhihu.com/p/113629660</a></p>
</section>
<section id="id40">
<h2><a class="toc-backref" href="#id78">搭建私有helm仓库及图形界面</a><a class="headerlink" href="#id40" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://www.jianshu.com/p/18478cf7a37f">https://www.jianshu.com/p/18478cf7a37f</a></p>
</section>
<section id="id41">
<h2><a class="toc-backref" href="#id79">参考文献</a><a class="headerlink" href="#id41" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>玩K8S不得不会的HELM</p>
<p><a class="reference external" href="https://juejin.cn/post/6844904081366974472?share_token=1630eaaf-71c5-4203-8e65-9ff1cbee7570">https://juejin.cn/post/6844904081366974472?share_token=1630eaaf-71c5-4203-8e65-9ff1cbee7570</a></p>
<p><a class="reference external" href="https://www.cnblogs.com/99jianshao/p/15024952.html">https://www.cnblogs.com/99jianshao/p/15024952.html</a></p>
</div></blockquote>
<blockquote>
<div><p>Helm 用户指南 <a class="reference external" href="https://whmzsu.github.io/helm-doc-zh-cn/">https://whmzsu.github.io/helm-doc-zh-cn/</a></p>
<p><a class="reference external" href="https://blog.csdn.net/weixin_36938307/article/details/105245770">https://blog.csdn.net/weixin_36938307/article/details/105245770</a></p>
<p><a class="reference external" href="https://www.cnblogs.com/xiao987334176/p/12752783.html">https://www.cnblogs.com/xiao987334176/p/12752783.html</a></p>
<p><a class="reference external" href="https://jimmysong.io/kubernetes-handbook/practice/helm.html">https://jimmysong.io/kubernetes-handbook/practice/helm.html</a></p>
</div></blockquote>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="15.%E5%9F%BA%E4%BA%8EDocker%2BK8S%2BGitLabSVN%2BJenkins%2BHarbor%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E4%BA%A4%E4%BB%98%E7%8E%AF%E5%A2%83.html" class="btn btn-neutral float-left" title="基于Docker+K8S+GitLab/SVN+Jenkins+Harbor持续集成交付环境" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../03.Docker%E7%BB%8F%E5%85%B8%E5%AE%9E%E4%BE%8B/index.html" class="btn btn-neutral float-right" title="03.Docker经典实例" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, huxiaojian.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>