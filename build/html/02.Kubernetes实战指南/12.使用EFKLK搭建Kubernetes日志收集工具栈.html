<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>使用EFKLK搭建Kubernetes日志收集工具栈 &mdash; 运维开发修炼之路</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Kubernetes容器运行时从Docker切换成Containerd" href="13.Kubernetes%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E4%BB%8EDocker%E5%88%87%E6%8D%A2%E6%88%90Containerd.html" />
    <link rel="prev" title="集群日志系统" href="11.%E9%9B%86%E7%BE%A4%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> 小健_Docker_K8s_Blog
            <img src="../_static/docker-k8s.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../01.Docker%E6%8A%80%E6%9C%AF%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E6%88%983%E7%89%88/index.html">01.Docker技术入门与实战3版</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">02.Kubernetes实战指南</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01.Kubernetes%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E6%8C%87%E5%8D%97.html">Kubernetes安装配置指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="02.Kubespray%E9%83%A8%E7%BD%B2k8s.html">Kubespray部署k8s</a></li>
<li class="toctree-l2"><a class="reference internal" href="03.Docker%E5%9F%BA%E7%A1%80.html">Docker基础</a></li>
<li class="toctree-l2"><a class="reference internal" href="04.Kubernetes%E5%9F%BA%E7%A1%80.html">Kubernetes基础</a></li>
<li class="toctree-l2"><a class="reference internal" href="05.Kubernetes%E7%9A%84%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1.html">Kubernetes的资源对象</a></li>
<li class="toctree-l2"><a class="reference internal" href="06.Serveice.html">Serveice</a></li>
<li class="toctree-l2"><a class="reference internal" href="07.Ingress.html">Ingress</a></li>
<li class="toctree-l2"><a class="reference internal" href="08.Kubernetest%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86.html">Kubernetest数据管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="09.kubernetes%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B.html">Kubernetes实战案例</a></li>
<li class="toctree-l2"><a class="reference internal" href="10.Kubernetes%E7%9B%91%E6%8E%A7.html">Kubernetes监控</a></li>
<li class="toctree-l2"><a class="reference internal" href="11.%E9%9B%86%E7%BE%A4%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F.html">集群日志系统</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">使用EFKLK搭建Kubernetes日志收集工具栈</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#elasticsearch">1. 安装 Elasticsearch 集群</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">1.1 环境准备</a></li>
<li class="toctree-l4"><a class="reference internal" href="#es">1.2 安装ES集群</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#kibana">2. 安装Kibana</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fluentd">3. 部署Fluentd</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">3.1 工作原理</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">3.2 配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">3.3 安装</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#kafka">4. 安装 Kafka</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fluentd-kafka">5. Fluentd 配置 Kafka</a></li>
<li class="toctree-l3"><a class="reference internal" href="#logstash">6. 安装 Logstash</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">参考文献</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="13.Kubernetes%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E4%BB%8EDocker%E5%88%87%E6%8D%A2%E6%88%90Containerd.html">Kubernetes容器运行时从Docker切换成Containerd</a></li>
<li class="toctree-l2"><a class="reference internal" href="14.%E6%95%B4%E7%90%86%E5%85%A8%E7%BD%91%E6%9C%80%E5%85%A8K8S%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7-%E5%B9%B3%E5%8F%B0.html">整理全网最全K8S集群管理工具-平台</a></li>
<li class="toctree-l2"><a class="reference internal" href="20.Helm%E7%AE%80%E5%8C%96Kubernetes%E9%83%A8%E7%BD%B2.html">Helm简化Kubernetes部署</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../03.Docker%E7%BB%8F%E5%85%B8%E5%AE%9E%E4%BE%8B/index.html">03.Docker经典实例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04.Prometheus%E7%9B%91%E6%8E%A7%E8%BF%90%E7%BB%B4%E5%AE%9E%E6%88%98/index.html">04.Prometheus监控运维实战</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05.Kubernetes%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E8%B7%B5/index.html">05.Kubernetes入门到实践</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">小健_Docker_K8s_Blog</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">02.Kubernetes实战指南</a> &raquo;</li>
      <li>使用EFKLK搭建Kubernetes日志收集工具栈</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/02.Kubernetes实战指南/12.使用EFKLK搭建Kubernetes日志收集工具栈.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#efklkkubernetes" id="id9">使用EFKLK搭建Kubernetes日志收集工具栈</a></p>
<ul>
<li><p><a class="reference internal" href="#elasticsearch" id="id10">1. 安装 Elasticsearch 集群</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id11">1.1 环境准备</a></p></li>
<li><p><a class="reference internal" href="#es" id="id12">1.2 安装ES集群</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#kibana" id="id13">2. 安装Kibana</a></p></li>
<li><p><a class="reference internal" href="#fluentd" id="id14">3. 部署Fluentd</a></p>
<ul>
<li><p><a class="reference internal" href="#id2" id="id15">3.1 工作原理</a></p></li>
<li><p><a class="reference internal" href="#id3" id="id16">3.2 配置</a></p></li>
<li><p><a class="reference internal" href="#id7" id="id17">3.3 安装</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#kafka" id="id18">4. 安装 Kafka</a></p></li>
<li><p><a class="reference internal" href="#fluentd-kafka" id="id19">5. Fluentd 配置 Kafka</a></p></li>
<li><p><a class="reference internal" href="#logstash" id="id20">6. 安装 Logstash</a></p></li>
<li><p><a class="reference internal" href="#id8" id="id21">参考文献</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="efklkkubernetes">
<h1><a class="toc-backref" href="#id9">使用EFKLK搭建Kubernetes日志收集工具栈</a><a class="headerlink" href="#efklkkubernetes" title="Permalink to this headline">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">Elasticsearch</span></code>
是一个实时的、分布式的可扩展的搜索引擎，允许进行全文、结构化搜索，它通常用于索引和搜索大量日志数据，也可用于搜索许多不同类型的文档。</p>
<p>Elasticsearch 通常与 <code class="docutils literal notranslate"><span class="pre">Kibana</span></code> 一起部署，Kibana 是 Elasticsearch
的一个功能强大的数据可视化 Dashboard，Kibana 允许你通过 web 界面来浏览
Elasticsearch 日志数据。</p>
<p><code class="docutils literal notranslate"><span class="pre">Fluentd</span></code>是一个流行的开源数据收集器，我们将在 Kubernetes
集群节点上安装
Fluentd，通过获取容器日志文件、过滤和转换日志数据，然后将数据传递到
Elasticsearch 集群，在该集群中对其进行索引和存储。</p>
<p>我们先来配置启动一个可扩展的 Elasticsearch 集群，然后在 Kubernetes
集群中创建一个 Kibana 应用，最后通过 DaemonSet 来运行
Fluentd，以便它在每个 Kubernetes 工作节点上都可以运行一个 Pod。</p>
<blockquote>
<div><p>如果你了解 EFK 的基本原理，只是为了测试可以直接使用 Kubernetes
官方提供的 addon 插件的资源清单，</p>
<p>地址：<a class="reference external" href="https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/">https://github.com/kubernetes/kubernetes/blob/master/cluster/addons/fluentd-elasticsearch/</a>，直接安装即可。</p>
</div></blockquote>
<section id="elasticsearch">
<h2><a class="toc-backref" href="#id10">1. 安装 Elasticsearch 集群</a><a class="headerlink" href="#elasticsearch" title="Permalink to this headline">¶</a></h2>
<p>在创建 Elasticsearch
集群之前，我们先创建一个命名空间，我们将在其中安装所有日志相关的资源对象。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">create</span> <span class="n">ns</span> <span class="n">logging</span>
</pre></div>
</div>
<section id="id1">
<h3><a class="toc-backref" href="#id11">1.1 环境准备</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>ElasticSearch 安装有最低安装要求，如果安装后 Pod
无法正常启动，请检查是否符合最低要求的配置，要求如下：</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>节点名称</p></th>
<th class="head"><p>节点类型</p></th>
<th class="head"><p>CPU 配置</p></th>
<th class="head"><p>Memory 配置</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>k8s-master</p></td>
<td><p>master</p></td>
<td><p>4C</p></td>
<td><p>4Gi</p></td>
</tr>
<tr class="row-odd"><td><p>k8s-node-2-12</p></td>
<td><p>worker</p></td>
<td><p>8C</p></td>
<td><p>8Gi</p></td>
</tr>
<tr class="row-even"><td><p>k8s-node-2-13</p></td>
<td><p>worker</p></td>
<td><p>8C</p></td>
<td><p>8Gi</p></td>
</tr>
<tr class="row-odd"><td><p>k8s-node-2-14</p></td>
<td><p>worker</p></td>
<td><p>8C</p></td>
<td><p>8Gi</p></td>
</tr>
</tbody>
</table>
<p>es集群要求</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 43%" />
<col style="width: 24%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>ElasticSearch节点</p></th>
<th class="head"><p>CPU最小要求</p></th>
<th class="head"><p>Memory 最小要求</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>elasticsearch-master</p></td>
<td><p>&gt;2核</p></td>
<td><p>&gt;2Gi</p></td>
</tr>
<tr class="row-odd"><td><p>elasticsearch-data</p></td>
<td><p>&gt;1核</p></td>
<td><p>&gt;2Gi</p></td>
</tr>
<tr class="row-even"><td><p>elasticsearch-client</p></td>
<td><p>&gt;1核</p></td>
<td><p>&gt;2Gi</p></td>
</tr>
</tbody>
</table>
<p>这里我们要安装的 ES 集群环境信息如下所示：</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 17%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>集群名称</p></th>
<th class="head"><p>节点类型</p></th>
<th class="head"><p>副本数目</p></th>
<th class="head"><p>存储大小</p></th>
<th class="head"><p>网络模式</p></th>
<th class="head"><p>描述</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>elast
icsearch</p></td>
<td><p>master</p></td>
<td><p>3</p></td>
<td><p>5G</p></td>
<td><p>C
lusterIP</p></td>
<td><p>主节点
，用于控
制ES集群</p></td>
</tr>
<tr class="row-odd"><td><p>elast
icsearch</p></td>
<td><p>Data</p></td>
<td><p>3</p></td>
<td><p>50G</p></td>
<td><p>C
lusterIP</p></td>
<td><p>数据节点
，用于存
储ES数据</p></td>
</tr>
<tr class="row-even"><td><p>elast
icsearch</p></td>
<td><p>Client</p></td>
<td><p>2</p></td>
<td><p>无</p></td>
<td><p>NodePort</p></td>
<td><p>负责处理
用户请求
，实现请
求转发，
负载均衡</p></td>
</tr>
</tbody>
</table>
<p>这里我们使用一个 NFS 类型的 StorageClass
来做持久化存储，当然如果你是线上环境建议使用 Local PV 或者 Ceph RBD
之类的存储来持久化 Elasticsearch 的数据。</p>
<p><strong>安装nfs-storageClass存储</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm</span> <span class="n">repo</span> <span class="n">add</span> <span class="n">azure</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">mirror</span><span class="o">.</span><span class="n">azure</span><span class="o">.</span><span class="n">cn</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">charts</span><span class="o">/</span>
<span class="n">helm</span> <span class="n">repo</span> <span class="n">update</span>

<span class="c1"># 或者下载到本地再安装</span>
<span class="n">helm</span> <span class="n">pull</span> <span class="n">azure</span><span class="o">/</span><span class="n">nfs</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">provisioner</span>
<span class="n">tar</span> <span class="n">xvf</span> <span class="n">nfs</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">provisioner</span><span class="o">-*.</span><span class="n">tgz</span>

<span class="n">kubectl</span> <span class="n">create</span> <span class="n">ns</span> <span class="n">nfs</span>

<span class="n">helm</span> <span class="n">install</span> <span class="n">efk</span><span class="o">-</span><span class="n">nfs</span><span class="o">-</span><span class="n">storage</span> <span class="o">-</span><span class="n">n</span> <span class="n">nfs</span> \
<span class="o">--</span><span class="nb">set</span> <span class="n">nfs</span><span class="o">.</span><span class="n">server</span><span class="o">=</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">1.46</span> \
<span class="o">--</span><span class="nb">set</span> <span class="n">nfs</span><span class="o">.</span><span class="n">path</span><span class="o">=/</span><span class="n">efk</span>  \
<span class="o">--</span><span class="nb">set</span> <span class="n">storageClass</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="n">efk</span><span class="o">-</span><span class="n">nfs</span><span class="p">,</span><span class="n">storageClass</span><span class="o">.</span><span class="n">reclaimPolicy</span><span class="o">=</span><span class="n">Retain</span> \
<span class="o">--</span><span class="nb">set</span> <span class="n">storageClass</span><span class="o">.</span><span class="n">defaultClass</span><span class="o">=</span><span class="n">true</span> \
<span class="n">nfs</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">provisioner</span>
</pre></div>
</div>
<p>此外由于 ElasticSearch 7.x 版本默认安装了 <code class="docutils literal notranslate"><span class="pre">X-Pack</span></code>
插件，并且部分功能免费，需要我们配置一些安全证书文件。</p>
<p><strong>1、生成证书文件</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># 运行容器生成证书
$ docker run --name elastic-certs -i -w /app elasticsearch:7.12.0 /bin/sh -c  \
  &quot;elasticsearch-certutil ca --out /app/elastic-stack-ca.p12 --pass &#39;&#39; &amp;&amp; \
    elasticsearch-certutil cert --name security-master --dns \
    security-master --ca /app/elastic-stack-ca.p12 --pass &#39;&#39; --ca-pass &#39;&#39; --out /app/elastic-certificates.p12&quot;

# 从容器中将生成的证书拷贝出来
$ docker cp elastic-certs:/app/elastic-certificates.p12 .

# 删除容器
$ docker rm -f elastic-certs

# 将 pcks12 中的信息分离出来，写入文件
$ openssl pkcs12 -nodes -passin pass:&#39;&#39; -in elastic-certificates.p12 -out elastic-certificate.pem
</pre></div>
</div>
<p><strong>2、添加证书到 Kubernetes</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># 添加证书
$ kubectl create secret -n logging generic elastic-certs --from-file=elastic-certificates.p12

# 设置集群用户名密码
$ kubectl create secret -n logging generic elastic-auth --from-literal=username=elastic --from-literal=password=oschina
</pre></div>
</div>
</section>
<section id="es">
<h3><a class="toc-backref" href="#id12">1.2 安装ES集群</a><a class="headerlink" href="#es" title="Permalink to this headline">¶</a></h3>
<p>首先添加 ELastic 的 Helm 仓库：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm</span> <span class="n">repo</span> <span class="n">add</span> <span class="n">elastic</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">helm</span><span class="o">.</span><span class="n">elastic</span><span class="o">.</span><span class="n">co</span>
<span class="n">helm</span> <span class="n">repo</span> <span class="n">update</span>
</pre></div>
</div>
<p>ElaticSearch 安装需要安装三次，分别安装 Master、Data、Client 节点，</p>
<ul class="simple">
<li><p>Master 节点负责集群间的管理工作；</p></li>
<li><p>Data 节点负责存储数据；</p></li>
<li><p>Client 节点负责代理 ElasticSearch Cluster 集群，负载均衡。</p></li>
</ul>
<p>首先使用 <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">pull</span></code> 拉取 Chart 并解压：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm</span> <span class="n">pull</span> <span class="n">elastic</span><span class="o">/</span><span class="n">elasticsearch</span> <span class="o">--</span><span class="n">untar</span> <span class="o">--</span><span class="n">version</span> <span class="mf">7.12</span><span class="o">.</span><span class="mi">0</span>
<span class="n">cd</span> <span class="n">elasticsearch</span>
</pre></div>
</div>
<p>在 Chart 目录下面创建用于 Master 节点安装配置的 values 文件：</p>
<p><code class="docutils literal notranslate"><span class="pre">values-master.yaml</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># values-master.yaml</span>
<span class="c1">## 设置集群名称</span>
<span class="n">clusterName</span><span class="p">:</span> <span class="s2">&quot;elasticsearch&quot;</span>
<span class="c1">## 设置节点名称</span>
<span class="n">nodeGroup</span><span class="p">:</span> <span class="s2">&quot;master&quot;</span>

<span class="c1">## 设置角色</span>
<span class="n">roles</span><span class="p">:</span>
  <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
  <span class="n">ingest</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span>
  <span class="n">data</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span>

<span class="c1"># ============镜像配置============</span>
<span class="c1">## 指定镜像与镜像版本</span>
<span class="n">image</span><span class="p">:</span> <span class="s2">&quot;elasticsearch&quot;</span>
<span class="n">imageTag</span><span class="p">:</span> <span class="s2">&quot;7.12.0&quot;</span>
<span class="c1">## 副本数</span>
<span class="n">replicas</span><span class="p">:</span> <span class="mi">3</span>

<span class="c1"># ============资源配置============</span>
<span class="c1">## JVM 配置参数</span>
<span class="n">esJavaOpts</span><span class="p">:</span> <span class="s2">&quot;-Xmx1g -Xms1g&quot;</span>
<span class="c1">## 部署资源配置(生成环境一定要设置大些)</span>
<span class="n">resources</span><span class="p">:</span>
  <span class="n">requests</span><span class="p">:</span>
    <span class="n">cpu</span><span class="p">:</span> <span class="s2">&quot;2000m&quot;</span>
    <span class="n">memory</span><span class="p">:</span> <span class="s2">&quot;2Gi&quot;</span>
  <span class="n">limits</span><span class="p">:</span>
    <span class="n">cpu</span><span class="p">:</span> <span class="s2">&quot;2000m&quot;</span>
    <span class="n">memory</span><span class="p">:</span> <span class="s2">&quot;2Gi&quot;</span>
<span class="c1">## 数据持久卷配置</span>
<span class="n">persistence</span><span class="p">:</span>
  <span class="n">enabled</span><span class="p">:</span> <span class="n">true</span>
<span class="c1">## 存储数据大小配置</span>
<span class="n">volumeClaimTemplate</span><span class="p">:</span>
  <span class="n">storageClassName</span><span class="p">:</span> <span class="n">nfs</span><span class="o">-</span><span class="n">storage</span>
  <span class="n">accessModes</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;ReadWriteOnce&quot;</span><span class="p">]</span>
  <span class="n">resources</span><span class="p">:</span>
    <span class="n">requests</span><span class="p">:</span>
      <span class="n">storage</span><span class="p">:</span> <span class="mi">50</span><span class="n">Gi</span>

<span class="c1"># ============安全配置============</span>
<span class="c1">## 设置协议，可配置为 http、https</span>
<span class="n">protocol</span><span class="p">:</span> <span class="n">http</span>
<span class="c1">## 证书挂载配置，这里我们挂入上面创建的证书</span>
<span class="n">secretMounts</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">elastic</span><span class="o">-</span><span class="n">certs</span>
    <span class="n">secretName</span><span class="p">:</span> <span class="n">elastic</span><span class="o">-</span><span class="n">certs</span>
    <span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">certs</span>

<span class="c1">## 允许您在/usr/share/elasticsearch/config/中添加任何自定义配置文件,例如 elasticsearch.yml</span>
<span class="c1">## ElasticSearch 7.x 默认安装了 x-pack 插件，部分功能免费，这里我们配置下</span>
<span class="c1">## 下面注掉的部分为配置 https 证书，配置此部分还需要配置 helm 参数 protocol 值改为 https</span>
<span class="n">esConfig</span><span class="p">:</span>
  <span class="n">elasticsearch</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span> <span class="o">|</span>
    <span class="n">xpack</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">xpack</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">ssl</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">xpack</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">ssl</span><span class="o">.</span><span class="n">verification_mode</span><span class="p">:</span> <span class="n">certificate</span>
    <span class="n">xpack</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">ssl</span><span class="o">.</span><span class="n">keystore</span><span class="o">.</span><span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">elastic</span><span class="o">-</span><span class="n">certificates</span><span class="o">.</span><span class="n">p12</span>
    <span class="n">xpack</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">ssl</span><span class="o">.</span><span class="n">truststore</span><span class="o">.</span><span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">elastic</span><span class="o">-</span><span class="n">certificates</span><span class="o">.</span><span class="n">p12</span>
    <span class="c1"># xpack.security.http.ssl.enabled: true</span>
    <span class="c1"># xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12</span>
    <span class="c1"># xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12</span>
<span class="c1">## 环境变量配置，这里引入上面设置的用户名、密码 secret 文件</span>
<span class="n">extraEnvs</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">ELASTIC_USERNAME</span>
    <span class="n">valueFrom</span><span class="p">:</span>
      <span class="n">secretKeyRef</span><span class="p">:</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">elastic</span><span class="o">-</span><span class="n">auth</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">username</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">ELASTIC_PASSWORD</span>
    <span class="n">valueFrom</span><span class="p">:</span>
      <span class="n">secretKeyRef</span><span class="p">:</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">elastic</span><span class="o">-</span><span class="n">auth</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">password</span>

<span class="c1"># ============调度配置============</span>
<span class="c1">## 设置调度策略</span>
<span class="c1">## - hard：只有当有足够的节点时 Pod 才会被调度，并且它们永远不会出现在同一个节点上</span>
<span class="c1">## - soft：尽最大努力调度</span>
<span class="n">antiAffinity</span><span class="p">:</span> <span class="s2">&quot;soft&quot;</span>
<span class="n">tolerations</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">operator</span><span class="p">:</span> <span class="s2">&quot;Exists&quot;</span> <span class="c1">##容忍全部污点</span>
</pre></div>
</div>
<p>然后创建用于 Data 节点安装的 values 文件：</p>
<p><code class="docutils literal notranslate"><span class="pre">values-data.yaml</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># values-data.yaml</span>
<span class="c1"># ============设置集群名称============</span>
<span class="c1">## 设置集群名称</span>
<span class="n">clusterName</span><span class="p">:</span> <span class="s2">&quot;elasticsearch&quot;</span>
<span class="c1">## 设置节点名称</span>
<span class="n">nodeGroup</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span>
<span class="c1">## 设置角色</span>
<span class="n">roles</span><span class="p">:</span>
  <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span>
  <span class="n">ingest</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
  <span class="n">data</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>

<span class="c1"># ============镜像配置============</span>
<span class="c1">## 指定镜像与镜像版本</span>
<span class="n">image</span><span class="p">:</span> <span class="s2">&quot;elasticsearch&quot;</span>
<span class="n">imageTag</span><span class="p">:</span> <span class="s2">&quot;7.12.0&quot;</span>
<span class="c1">## 副本数(建议设置为3，我这里资源不足只用了1个副本)</span>
<span class="n">replicas</span><span class="p">:</span> <span class="mi">1</span>

<span class="c1"># ============资源配置============</span>
<span class="c1">## JVM 配置参数</span>
<span class="n">esJavaOpts</span><span class="p">:</span> <span class="s2">&quot;-Xmx1g -Xms1g&quot;</span>
<span class="c1">## 部署资源配置(生成环境一定要设置大些)</span>
<span class="n">resources</span><span class="p">:</span>
  <span class="n">requests</span><span class="p">:</span>
    <span class="n">cpu</span><span class="p">:</span> <span class="s2">&quot;1000m&quot;</span>
    <span class="n">memory</span><span class="p">:</span> <span class="s2">&quot;2Gi&quot;</span>
  <span class="n">limits</span><span class="p">:</span>
    <span class="n">cpu</span><span class="p">:</span> <span class="s2">&quot;1000m&quot;</span>
    <span class="n">memory</span><span class="p">:</span> <span class="s2">&quot;2Gi&quot;</span>
<span class="c1">## 数据持久卷配置</span>
<span class="n">persistence</span><span class="p">:</span>
  <span class="n">enabled</span><span class="p">:</span> <span class="n">true</span>
<span class="c1">## 存储数据大小配置</span>
<span class="n">volumeClaimTemplate</span><span class="p">:</span>
  <span class="n">storageClassName</span><span class="p">:</span> <span class="n">nfs</span><span class="o">-</span><span class="n">storage</span>
  <span class="n">accessModes</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;ReadWriteOnce&quot;</span><span class="p">]</span>
  <span class="n">resources</span><span class="p">:</span>
    <span class="n">requests</span><span class="p">:</span>
      <span class="n">storage</span><span class="p">:</span> <span class="mi">200</span><span class="n">Gi</span>

<span class="c1"># ============安全配置============</span>
<span class="c1">## 设置协议，可配置为 http、https</span>
<span class="n">protocol</span><span class="p">:</span> <span class="n">http</span>
<span class="c1">## 证书挂载配置，这里我们挂入上面创建的证书</span>
<span class="n">secretMounts</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">elastic</span><span class="o">-</span><span class="n">certs</span>
    <span class="n">secretName</span><span class="p">:</span> <span class="n">elastic</span><span class="o">-</span><span class="n">certs</span>
    <span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">certs</span>
<span class="c1">## 允许您在/usr/share/elasticsearch/config/中添加任何自定义配置文件,例如 elasticsearch.yml</span>
<span class="c1">## ElasticSearch 7.x 默认安装了 x-pack 插件，部分功能免费，这里我们配置下</span>
<span class="c1">## 下面注掉的部分为配置 https 证书，配置此部分还需要配置 helm 参数 protocol 值改为 https</span>
<span class="n">esConfig</span><span class="p">:</span>
  <span class="n">elasticsearch</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span> <span class="o">|</span>
    <span class="n">xpack</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">xpack</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">ssl</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">xpack</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">ssl</span><span class="o">.</span><span class="n">verification_mode</span><span class="p">:</span> <span class="n">certificate</span>
    <span class="n">xpack</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">ssl</span><span class="o">.</span><span class="n">keystore</span><span class="o">.</span><span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">elastic</span><span class="o">-</span><span class="n">certificates</span><span class="o">.</span><span class="n">p12</span>
    <span class="n">xpack</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">ssl</span><span class="o">.</span><span class="n">truststore</span><span class="o">.</span><span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">elastic</span><span class="o">-</span><span class="n">certificates</span><span class="o">.</span><span class="n">p12</span>
    <span class="c1"># xpack.security.http.ssl.enabled: true</span>
    <span class="c1"># xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12</span>
    <span class="c1"># xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12</span>
<span class="c1">## 环境变量配置，这里引入上面设置的用户名、密码 secret 文件</span>
<span class="n">extraEnvs</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">ELASTIC_USERNAME</span>
    <span class="n">valueFrom</span><span class="p">:</span>
      <span class="n">secretKeyRef</span><span class="p">:</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">elastic</span><span class="o">-</span><span class="n">auth</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">username</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">ELASTIC_PASSWORD</span>
    <span class="n">valueFrom</span><span class="p">:</span>
      <span class="n">secretKeyRef</span><span class="p">:</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">elastic</span><span class="o">-</span><span class="n">auth</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">password</span>

<span class="c1"># ============调度配置============</span>
<span class="c1">## 设置调度策略</span>
<span class="c1">## - hard：只有当有足够的节点时 Pod 才会被调度，并且它们永远不会出现在同一个节点上</span>
<span class="c1">## - soft：尽最大努力调度</span>
<span class="n">antiAffinity</span><span class="p">:</span> <span class="s2">&quot;soft&quot;</span>
<span class="c1">## 容忍配置</span>
<span class="n">tolerations</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">operator</span><span class="p">:</span> <span class="s2">&quot;Exists&quot;</span> <span class="c1">##容忍全部污点</span>
</pre></div>
</div>
<p>最后一个是用于创建 Client 节点的 values 文件：</p>
<p><code class="docutils literal notranslate"><span class="pre">values-client.yaml</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># values-client.yaml</span>
<span class="c1"># ============设置集群名称============</span>
<span class="c1">## 设置集群名称</span>
<span class="n">clusterName</span><span class="p">:</span> <span class="s2">&quot;elasticsearch&quot;</span>
<span class="c1">## 设置节点名称</span>
<span class="n">nodeGroup</span><span class="p">:</span> <span class="s2">&quot;client&quot;</span>
<span class="c1">## 设置角色</span>
<span class="n">roles</span><span class="p">:</span>
  <span class="n">master</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span>
  <span class="n">ingest</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span>
  <span class="n">data</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span>

<span class="c1"># ============镜像配置============</span>
<span class="c1">## 指定镜像与镜像版本</span>
<span class="n">image</span><span class="p">:</span> <span class="s2">&quot;elasticsearch&quot;</span>
<span class="n">imageTag</span><span class="p">:</span> <span class="s2">&quot;7.12.0&quot;</span>
<span class="c1">## 副本数</span>
<span class="n">replicas</span><span class="p">:</span> <span class="mi">1</span>

<span class="c1"># ============资源配置============</span>
<span class="c1">## JVM 配置参数</span>
<span class="n">esJavaOpts</span><span class="p">:</span> <span class="s2">&quot;-Xmx1g -Xms1g&quot;</span>
<span class="c1">## 部署资源配置(生成环境一定要设置大些)</span>
<span class="n">resources</span><span class="p">:</span>
  <span class="n">requests</span><span class="p">:</span>
    <span class="n">cpu</span><span class="p">:</span> <span class="s2">&quot;1000m&quot;</span>
    <span class="n">memory</span><span class="p">:</span> <span class="s2">&quot;1Gi&quot;</span>
  <span class="n">limits</span><span class="p">:</span>
    <span class="n">cpu</span><span class="p">:</span> <span class="s2">&quot;1000m&quot;</span>
    <span class="n">memory</span><span class="p">:</span> <span class="s2">&quot;2Gi&quot;</span>
<span class="c1">## 数据持久卷配置</span>
<span class="n">persistence</span><span class="p">:</span>
  <span class="n">enabled</span><span class="p">:</span> <span class="n">false</span>

<span class="c1"># ============安全配置============</span>
<span class="c1">## 设置协议，可配置为 http、https</span>
<span class="n">protocol</span><span class="p">:</span> <span class="n">http</span>
<span class="c1">## 证书挂载配置，这里我们挂入上面创建的证书</span>
<span class="n">secretMounts</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">elastic</span><span class="o">-</span><span class="n">certs</span>
    <span class="n">secretName</span><span class="p">:</span> <span class="n">elastic</span><span class="o">-</span><span class="n">certs</span>
    <span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">certs</span>
<span class="c1">## 允许您在/usr/share/elasticsearch/config/中添加任何自定义配置文件,例如 elasticsearch.yml</span>
<span class="c1">## ElasticSearch 7.x 默认安装了 x-pack 插件，部分功能免费，这里我们配置下</span>
<span class="c1">## 下面注掉的部分为配置 https 证书，配置此部分还需要配置 helm 参数 protocol 值改为 https</span>
<span class="n">esConfig</span><span class="p">:</span>
  <span class="n">elasticsearch</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span> <span class="o">|</span>
    <span class="n">xpack</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">xpack</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">ssl</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">xpack</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">ssl</span><span class="o">.</span><span class="n">verification_mode</span><span class="p">:</span> <span class="n">certificate</span>
    <span class="n">xpack</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">ssl</span><span class="o">.</span><span class="n">keystore</span><span class="o">.</span><span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">elastic</span><span class="o">-</span><span class="n">certificates</span><span class="o">.</span><span class="n">p12</span>
    <span class="n">xpack</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">ssl</span><span class="o">.</span><span class="n">truststore</span><span class="o">.</span><span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">elastic</span><span class="o">-</span><span class="n">certificates</span><span class="o">.</span><span class="n">p12</span>
    <span class="c1"># xpack.security.http.ssl.enabled: true</span>
    <span class="c1"># xpack.security.http.ssl.truststore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12</span>
    <span class="c1"># xpack.security.http.ssl.keystore.path: /usr/share/elasticsearch/config/certs/elastic-certificates.p12</span>
<span class="c1">## 环境变量配置，这里引入上面设置的用户名、密码 secret 文件</span>
<span class="n">extraEnvs</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">ELASTIC_USERNAME</span>
    <span class="n">valueFrom</span><span class="p">:</span>
      <span class="n">secretKeyRef</span><span class="p">:</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">elastic</span><span class="o">-</span><span class="n">auth</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">username</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">ELASTIC_PASSWORD</span>
    <span class="n">valueFrom</span><span class="p">:</span>
      <span class="n">secretKeyRef</span><span class="p">:</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">elastic</span><span class="o">-</span><span class="n">auth</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">password</span>

<span class="c1"># ============Service 配置============</span>
<span class="n">service</span><span class="p">:</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">NodePort</span>
  <span class="n">nodePort</span><span class="p">:</span> <span class="s2">&quot;30200&quot;</span>
</pre></div>
</div>
<p>现在用上面的 values 文件来安装：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 安装 master 节点</span>
<span class="n">helm</span> <span class="n">install</span> <span class="n">es</span><span class="o">-</span><span class="n">master</span> <span class="o">-</span><span class="n">f</span> <span class="n">values</span><span class="o">-</span><span class="n">master</span><span class="o">.</span><span class="n">yaml</span> <span class="o">--</span><span class="n">namespace</span> <span class="n">logging</span> <span class="o">.</span>

<span class="c1"># 安装 data 节点</span>
<span class="n">helm</span> <span class="n">install</span> <span class="n">es</span><span class="o">-</span><span class="n">data</span> <span class="o">-</span><span class="n">f</span> <span class="n">values</span><span class="o">-</span><span class="n">data</span><span class="o">.</span><span class="n">yaml</span> <span class="o">--</span><span class="n">namespace</span> <span class="n">logging</span> <span class="o">.</span>

<span class="c1"># 安装 client 节点</span>
<span class="n">helm</span> <span class="n">install</span> <span class="n">es</span><span class="o">-</span><span class="n">client</span> <span class="o">-</span><span class="n">f</span> <span class="n">values</span><span class="o">-</span><span class="n">client</span><span class="o">.</span><span class="n">yaml</span> <span class="o">--</span><span class="n">namespace</span> <span class="n">logging</span> <span class="o">.</span>
</pre></div>
</div>
</section>
</section>
<section id="kibana">
<h2><a class="toc-backref" href="#id13">2. 安装Kibana</a><a class="headerlink" href="#kibana" title="Permalink to this headline">¶</a></h2>
<p>Elasticsearch 集群安装完成后接下来配置安装 Kibana</p>
<p>使用 <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">pull</span></code> 命令拉取 Kibana Chart 包并解压：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm</span> <span class="n">pull</span> <span class="n">elastic</span><span class="o">/</span><span class="n">kibana</span> <span class="o">--</span><span class="n">untar</span> <span class="o">--</span><span class="n">version</span> <span class="mf">7.12</span><span class="o">.</span><span class="mi">0</span>
<span class="n">cd</span> <span class="n">kibana</span>
</pre></div>
</div>
<p>创建用于安装 Kibana 的 values 文件：</p>
<p><code class="docutils literal notranslate"><span class="pre">values-prod.yaml</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># values-prod.yaml</span>
<span class="c1">## 指定镜像与镜像版本</span>
<span class="n">image</span><span class="p">:</span> <span class="s2">&quot;kibana&quot;</span>
<span class="n">imageTag</span><span class="p">:</span> <span class="s2">&quot;7.12.0&quot;</span>

<span class="c1">## 配置 ElasticSearch 地址</span>
<span class="n">elasticsearchHosts</span><span class="p">:</span> <span class="s2">&quot;http://elasticsearch-client:9200&quot;</span>

<span class="c1"># ============环境变量配置============</span>
<span class="c1">## 环境变量配置，这里引入上面设置的用户名、密码 secret 文件</span>
<span class="n">extraEnvs</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;ELASTICSEARCH_USERNAME&quot;</span>
    <span class="n">valueFrom</span><span class="p">:</span>
      <span class="n">secretKeyRef</span><span class="p">:</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">elastic</span><span class="o">-</span><span class="n">auth</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">username</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="s2">&quot;ELASTICSEARCH_PASSWORD&quot;</span>
    <span class="n">valueFrom</span><span class="p">:</span>
      <span class="n">secretKeyRef</span><span class="p">:</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">elastic</span><span class="o">-</span><span class="n">auth</span>
        <span class="n">key</span><span class="p">:</span> <span class="n">password</span>

<span class="c1"># ============资源配置============</span>
<span class="n">resources</span><span class="p">:</span>
  <span class="n">requests</span><span class="p">:</span>
    <span class="n">cpu</span><span class="p">:</span> <span class="s2">&quot;200m&quot;</span>
    <span class="n">memory</span><span class="p">:</span> <span class="s2">&quot;500m&quot;</span>
  <span class="n">limits</span><span class="p">:</span>
    <span class="n">cpu</span><span class="p">:</span> <span class="s2">&quot;500m&quot;</span>
    <span class="n">memory</span><span class="p">:</span> <span class="s2">&quot;1Gi&quot;</span>

<span class="c1"># ============配置 Kibana 参数============</span>
<span class="c1">## kibana 配置中添加语言配置，设置 kibana 为中文</span>
<span class="n">kibanaConfig</span><span class="p">:</span>
  <span class="n">kibana</span><span class="o">.</span><span class="n">yml</span><span class="p">:</span> <span class="o">|</span>
    <span class="n">i18n</span><span class="o">.</span><span class="n">locale</span><span class="p">:</span> <span class="s2">&quot;zh-CN&quot;</span>

<span class="c1"># ============Service 配置============</span>
<span class="n">service</span><span class="p">:</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">NodePort</span>
  <span class="n">nodePort</span><span class="p">:</span> <span class="s2">&quot;30601&quot;</span>
</pre></div>
</div>
<p>使用上面的配置直接安装即可：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm</span> <span class="n">install</span> <span class="n">kibana</span> <span class="o">-</span><span class="n">f</span> <span class="n">values</span><span class="o">-</span><span class="n">prod</span><span class="o">.</span><span class="n">yaml</span> <span class="o">--</span><span class="n">namespace</span> <span class="n">logging</span> <span class="o">.</span>
</pre></div>
</div>
<p>下面是安装完成后的 ES 集群和 Kibana 资源：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># kubectl get pod -n logging</span>
<span class="n">NAME</span>                             <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">elasticsearch</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="mi">0</span>           <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">44</span><span class="n">m</span>
<span class="n">elasticsearch</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="mi">0</span>             <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">45</span><span class="n">m</span>
<span class="n">elasticsearch</span><span class="o">-</span><span class="n">master</span><span class="o">-</span><span class="mi">0</span>           <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">38</span><span class="n">m</span>
<span class="n">elasticsearch</span><span class="o">-</span><span class="n">master</span><span class="o">-</span><span class="mi">1</span>           <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">38</span><span class="n">m</span>
<span class="n">elasticsearch</span><span class="o">-</span><span class="n">master</span><span class="o">-</span><span class="mi">2</span>           <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">38</span><span class="n">m</span>
<span class="n">kibana</span><span class="o">-</span><span class="n">kibana</span><span class="o">-</span><span class="mi">785</span><span class="n">f84bc84</span><span class="o">-</span><span class="mi">2</span><span class="n">ld59</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">9</span><span class="n">m39s</span>

<span class="c1"># kubectl get svc -n logging</span>
<span class="n">NAME</span>                            <span class="n">TYPE</span>        <span class="n">CLUSTER</span><span class="o">-</span><span class="n">IP</span>      <span class="n">EXTERNAL</span><span class="o">-</span><span class="n">IP</span>   <span class="n">PORT</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>                         <span class="n">AGE</span>
<span class="n">elasticsearch</span><span class="o">-</span><span class="n">client</span>            <span class="n">NodePort</span>    <span class="mf">10.102</span><span class="o">.</span><span class="mf">19.132</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>        <span class="mi">9200</span><span class="p">:</span><span class="mi">30200</span><span class="o">/</span><span class="n">TCP</span><span class="p">,</span><span class="mi">9300</span><span class="p">:</span><span class="mi">30415</span><span class="o">/</span><span class="n">TCP</span>   <span class="mi">45</span><span class="n">m</span>
<span class="n">elasticsearch</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="n">headless</span>   <span class="n">ClusterIP</span>   <span class="kc">None</span>            <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>        <span class="mi">9200</span><span class="o">/</span><span class="n">TCP</span><span class="p">,</span><span class="mi">9300</span><span class="o">/</span><span class="n">TCP</span>               <span class="mi">45</span><span class="n">m</span>
<span class="n">elasticsearch</span><span class="o">-</span><span class="n">data</span>              <span class="n">ClusterIP</span>   <span class="mf">10.98</span><span class="o">.</span><span class="mf">192.155</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>        <span class="mi">9200</span><span class="o">/</span><span class="n">TCP</span><span class="p">,</span><span class="mi">9300</span><span class="o">/</span><span class="n">TCP</span>               <span class="mi">46</span><span class="n">m</span>
<span class="n">elasticsearch</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">headless</span>     <span class="n">ClusterIP</span>   <span class="kc">None</span>            <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>        <span class="mi">9200</span><span class="o">/</span><span class="n">TCP</span><span class="p">,</span><span class="mi">9300</span><span class="o">/</span><span class="n">TCP</span>               <span class="mi">46</span><span class="n">m</span>
<span class="n">elasticsearch</span><span class="o">-</span><span class="n">master</span>            <span class="n">ClusterIP</span>   <span class="mf">10.102</span><span class="o">.</span><span class="mf">195.24</span>   <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>        <span class="mi">9200</span><span class="o">/</span><span class="n">TCP</span><span class="p">,</span><span class="mi">9300</span><span class="o">/</span><span class="n">TCP</span>               <span class="mi">39</span><span class="n">m</span>
<span class="n">elasticsearch</span><span class="o">-</span><span class="n">master</span><span class="o">-</span><span class="n">headless</span>   <span class="n">ClusterIP</span>   <span class="kc">None</span>            <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>        <span class="mi">9200</span><span class="o">/</span><span class="n">TCP</span><span class="p">,</span><span class="mi">9300</span><span class="o">/</span><span class="n">TCP</span>               <span class="mi">39</span><span class="n">m</span>
<span class="n">kibana</span><span class="o">-</span><span class="n">kibana</span>                   <span class="n">NodePort</span>    <span class="mf">10.108</span><span class="o">.</span><span class="mf">125.5</span>    <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>        <span class="mi">5601</span><span class="p">:</span><span class="mi">30601</span><span class="o">/</span><span class="n">TCP</span>                  <span class="mi">10</span><span class="n">m</span>
</pre></div>
</div>
<p>上面我们安装 Kibana 的时候指定了 30601 的 NodePort
端口，所以我们可以从任意节点 <code class="docutils literal notranslate"><span class="pre">http://IP:30601</span></code> 来访问 Kibana。</p>
<img alt="../_images/image-20220329105330039.png" src="../_images/image-20220329105330039.png" />
<p>我们可以看到会跳转到登录页面，让我们输出用户名、密码，这里我们输入上面配置的用户名
elastic、密码 oschina进行登录。</p>
<p>登录成功后点击自己浏览，进入如下所示的 Kibana 主页：</p>
<img alt="../_images/image-20220415145800939.png" src="../_images/image-20220415145800939.png" />
<img alt="../_images/image-20220329110220805.png" src="../_images/image-20220329110220805.png" />
</section>
<section id="fluentd">
<h2><a class="toc-backref" href="#id14">3. 部署Fluentd</a><a class="headerlink" href="#fluentd" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">Fluentd</span></code> 是一个高效的日志聚合器，是用 Ruby
编写的，并且可以很好地扩展。对于大部分企业来说，Fluentd
足够高效并且消耗的资源相对较少，另外一个工具<code class="docutils literal notranslate"><span class="pre">Fluent-bit</span></code>更轻量级，占用资源更少，但是插件相对
Fluentd 来说不够丰富，所以整体来说，Fluentd
更加成熟，使用更加广泛，所以我们这里也同样使用 Fluentd
来作为日志收集工具。</p>
<section id="id2">
<h3><a class="toc-backref" href="#id15">3.1 工作原理</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Fluentd
通过一组给定的数据源抓取日志数据，处理后（转换成结构化的数据格式）将它们转发给其他服务，比如
Elasticsearch、对象存储等等。Fluentd 支持超过 300
个日志存储和分析服务，所以在这方面是非常灵活的。主要运行步骤如下：</p>
<ul class="simple">
<li><p>首先 Fluentd 从多个日志源获取数据</p></li>
<li><p>结构化并且标记这些数据</p></li>
<li><p>然后根据匹配的标签将数据发送到多个目标服务去</p></li>
</ul>
<p>fluentd 架构</p>
<img alt="../_images/image-20220329111052727.png" src="../_images/image-20220329111052727.png" />
</section>
<section id="id3">
<h3><a class="toc-backref" href="#id16">3.2 配置</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>一般来说我们是通过一个配置文件来告诉 Fluentd
如何采集、处理数据的，下面简单和大家介绍下 Fluentd 的配置方法。</p>
<section id="id4">
<h4>日志源配置<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>比如我们这里为了收集 Kubernetes
节点上的所有容器日志，就需要做如下的日志源配置：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;source&gt;
  @id fluentd-containers.log
  @type tail                             # Fluentd 内置的输入方式，其原理是不停地从源文件中获取新的日志。
  path /var/log/containers/*.log         # 挂载的服务器Docker容器日志地址
  pos_file /var/log/es-containers.log.pos
  tag raw.kubernetes.*                   # 设置日志标签
  read_from_head true
  &lt;parse&gt;                                # 多行格式化成JSON
    @type multi_format                   # 使用 multi-format-parser 解析器插件
    &lt;pattern&gt;
      format json                        # JSON 解析器
      time_key time                      # 指定事件时间的时间字段
      time_format %Y-%m-%dT%H:%M:%S.%NZ  # 时间格式
    &lt;/pattern&gt;
    &lt;pattern&gt;
      format /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr) [^ ]* (?&lt;log&gt;.*)$/
      time_format %Y-%m-%dT%H:%M:%S.%N%:z
    &lt;/pattern&gt;
  &lt;/parse&gt;
&lt;/source&gt;
</pre></div>
</div>
<p>上面配置部分参数说明如下：</p>
<ul class="simple">
<li><p>id：表示引用该日志源的唯一标识符，该标识可用于进一步过滤和路由结构化日志数据</p></li>
<li><p>type：Fluentd 内置的指令，<code class="docutils literal notranslate"><span class="pre">tail</span></code> 表示 Fluentd
从上次读取的位置通过 tail 不断获取数据，另外一个是 <code class="docutils literal notranslate"><span class="pre">http</span></code>
表示通过一个 GET 请求来收集数据。</p></li>
<li><p>path：<code class="docutils literal notranslate"><span class="pre">tail</span></code> 类型下的特定参数，告诉 Fluentd 采集
<code class="docutils literal notranslate"><span class="pre">/var/log/containers</span></code> 目录下的所有日志，这是 docker 在 Kubernetes
节点上用来存储运行容器 stdout 输出日志数据的目录。</p></li>
<li><p>pos_file：检查点，如果 Fluentd
程序重新启动了，它将使用此文件中的位置来恢复日志数据收集。</p></li>
<li><p>tag：用来将日志源与目标或者过滤器匹配的自定义字符串，Fluentd
匹配源/目标标签来路由日志数据。</p></li>
</ul>
</section>
<section id="id5">
<h4>路由配置<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p>上面是日志源的配置，接下来看看如何将日志数据发送到 Elasticsearch：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">match</span> <span class="o">**&gt;</span>
  <span class="nd">@id</span> <span class="n">elasticsearch</span>
  <span class="nd">@type</span> <span class="n">elasticsearch</span>
  <span class="nd">@log_level</span> <span class="n">info</span>
  <span class="n">include_tag_key</span> <span class="n">true</span>
  <span class="n">type_name</span> <span class="n">fluentd</span>
  <span class="n">host</span> <span class="s2">&quot;#</span><span class="si">{ENV[&#39;OUTPUT_HOST&#39;]}</span><span class="s2">&quot;</span>
  <span class="n">port</span> <span class="s2">&quot;#</span><span class="si">{ENV[&#39;OUTPUT_PORT&#39;]}</span><span class="s2">&quot;</span>
  <span class="n">logstash_format</span> <span class="n">true</span>
  <span class="o">&lt;</span><span class="n">buffer</span><span class="o">&gt;</span>
    <span class="nd">@type</span> <span class="n">file</span>
    <span class="n">path</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">fluentd</span><span class="o">-</span><span class="n">buffers</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">buffer</span>
    <span class="n">flush_mode</span> <span class="n">interval</span>
    <span class="n">retry_type</span> <span class="n">exponential_backoff</span>
    <span class="n">flush_thread_count</span> <span class="mi">2</span>
    <span class="n">flush_interval</span> <span class="mi">5</span><span class="n">s</span>
    <span class="n">retry_forever</span>
    <span class="n">retry_max_interval</span> <span class="mi">30</span>
    <span class="n">chunk_limit_size</span> <span class="s2">&quot;#</span><span class="si">{ENV[&#39;OUTPUT_BUFFER_CHUNK_LIMIT&#39;]}</span><span class="s2">&quot;</span>
    <span class="n">queue_limit_length</span> <span class="s2">&quot;#</span><span class="si">{ENV[&#39;OUTPUT_BUFFER_QUEUE_LIMIT&#39;]}</span><span class="s2">&quot;</span>
    <span class="n">overflow_action</span> <span class="n">block</span>
  <span class="o">&lt;/</span><span class="n">buffer</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">match</span><span class="o">&gt;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>match：标识一个目标标签，后面是一个匹配日志源的正则表达式，我们这里想要捕获所有的日志并将它们发送给
Elasticsearch，所以需要配置成<code class="docutils literal notranslate"><span class="pre">**</span></code>。</p></li>
<li><p>id：目标的一个唯一标识符。</p></li>
<li><p>type：支持的输出插件标识符，我们这里要输出到
Elasticsearch，所以配置成 elasticsearch，这是 Fluentd
的一个内置插件。</p></li>
<li><p>log_level：指定要捕获的日志级别，我们这里配置成
<code class="docutils literal notranslate"><span class="pre">info</span></code>，表示任何该级别或者该级别以上（INFO、WARNING、ERROR）的日志都将被路由到
Elsasticsearch。</p></li>
<li><p>host/port：定义 Elasticsearch 的地址，也可以配置认证信息，我们的
Elasticsearch 不需要认证，所以这里直接指定 host 和 port 即可。</p></li>
<li><p>logstash_format：Elasticsearch 服务对日志数据构建反向索引进行搜索，将
logstash_format 设置为 <code class="docutils literal notranslate"><span class="pre">true</span></code>，Fluentd 将会以 logstash
格式来转发结构化的日志数据。</p></li>
<li><p>Buffer：Fluentd
允许在目标不可用时进行缓存，比如，如果网络出现故障或者 Elasticsearch
不可用的时候。缓冲区配置也有助于降低磁盘的 IO。</p></li>
</ul>
</section>
<section id="id6">
<h4>过滤<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<p>由于 Kubernetes
集群中应用太多，也还有很多历史数据，所以我们可以只将某些应用的日志进行收集，比如我们只采集具有
<code class="docutils literal notranslate"><span class="pre">logging=true</span></code> 这个 Label 标签的 Pod 日志，这个时候就需要使用
filter，如下所示：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># 删除无用的属性
&lt;filter kubernetes.**&gt;
  @type record_transformer
  remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash
&lt;/filter&gt;
# 只保留具有logging=true标签的Pod日志
&lt;filter kubernetes.**&gt;
  @id filter_log
  @type grep
  &lt;regexp&gt;
    key $.kubernetes.labels.logging
    pattern ^true$
  &lt;/regexp&gt;
&lt;/filter&gt;
</pre></div>
</div>
</section>
</section>
<section id="id7">
<h3><a class="toc-backref" href="#id17">3.3 安装</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>要收集 Kubernetes 集群的日志，直接用 DasemonSet 控制器来部署 Fluentd
应用，这样，它就可以从 Kubernetes
节点上采集日志，确保在集群中的每个节点上始终运行一个 Fluentd
容器。当然可以直接使用 Helm
来进行一键安装，为了能够了解更多实现细节，我们这里还是采用手动方法来进行安装。</p>
<p>首先，我们通过 ConfigMap 对象来指定 Fluentd
配置文件，新建<code class="docutils literal notranslate"><span class="pre">fluentd-configmap.yaml</span></code>文件，文件内容如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kind: ConfigMap
apiVersion: v1
metadata:
  name: fluentd-conf
  namespace: logging
data:
  # 容器日志
  containers.input.conf: |-
    &lt;source&gt;
      @id fluentd-containers.log
      @type tail                              # Fluentd 内置的输入方式，其原理是不停地从源文件中获取新的日志
      path /var/log/containers/*.log          # Docker 容器日志路径
      pos_file /var/log/es-containers.log.pos  # 记录读取的位置
      tag raw.kubernetes.*                    # 设置日志标签
      read_from_head true                     # 从头读取
      &lt;parse&gt;                                 # 多行格式化成JSON
        # 可以使用我们介绍过的 multiline 插件实现多行日志
        @type multi_format                    # 使用 multi-format-parser 解析器插件
        &lt;pattern&gt;
          format json                         # JSON解析器
          time_key time                       # 指定事件时间的时间字段
          time_format %Y-%m-%dT%H:%M:%S.%NZ   # 时间格式
        &lt;/pattern&gt;
        &lt;pattern&gt;
          format /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr) [^ ]* (?&lt;log&gt;.*)$/
          time_format %Y-%m-%dT%H:%M:%S.%N%:z
        &lt;/pattern&gt;
      &lt;/parse&gt;
    &lt;/source&gt;

    # 在日志输出中检测异常(多行日志)，并将其作为一条日志转发
    # https://github.com/GoogleCloudPlatform/fluent-plugin-detect-exceptions
    &lt;match raw.kubernetes.**&gt;           # 匹配tag为raw.kubernetes.**日志信息
      @id raw.kubernetes
      @type detect_exceptions           # 使用detect-exceptions插件处理异常栈信息
      remove_tag_prefix raw             # 移除 raw 前缀
      message log
      multiline_flush_interval 5
    &lt;/match&gt;

    &lt;filter **&gt;  # 拼接日志
      @id filter_concat
      @type concat                # Fluentd Filter 插件，用于连接多个日志中分隔的多行日志
      key message
      multiline_end_regexp /\n$/  # 以换行符“\n”拼接
      separator &quot;&quot;
    &lt;/filter&gt;

    # 添加 Kubernetes metadata 数据
    &lt;filter kubernetes.**&gt;
      @id filter_kubernetes_metadata
      @type kubernetes_metadata
    &lt;/filter&gt;

    # 修复 ES 中的 JSON 字段
    # 插件地址：https://github.com/repeatedly/fluent-plugin-multi-format-parser
    &lt;filter kubernetes.**&gt;
      @id filter_parser
      @type parser                # multi-format-parser多格式解析器插件
      key_name log                # 在要解析的日志中指定字段名称
      reserve_data true           # 在解析结果中保留原始键值对
      remove_key_name_field true  # key_name 解析成功后删除字段
      &lt;parse&gt;
        @type multi_format
        &lt;pattern&gt;
          format json
        &lt;/pattern&gt;
        &lt;pattern&gt;
          format none
        &lt;/pattern&gt;
      &lt;/parse&gt;
    &lt;/filter&gt;

    # 删除一些多余的属性
    &lt;filter kubernetes.**&gt;
      @type record_transformer
      remove_keys $.docker.container_id,$.kubernetes.container_image_id,$.kubernetes.pod_id,$.kubernetes.namespace_id,$.kubernetes.master_url,$.kubernetes.labels.pod-template-hash
    &lt;/filter&gt;

    # 只保留具有logging=true标签的Pod日志
    &lt;filter kubernetes.**&gt;
      @id filter_log
      @type grep
      &lt;regexp&gt;
        key $.kubernetes.labels.logging
        pattern ^true$
      &lt;/regexp&gt;
    &lt;/filter&gt;

  ###### 监听配置，一般用于日志聚合用 ######
  forward.input.conf: |-
    # 监听通过TCP发送的消息
    &lt;source&gt;
      @id forward
      @type forward
    &lt;/source&gt;

  output.conf: |-
    &lt;match **&gt;
      @id elasticsearch
      @type elasticsearch
      @log_level info
      include_tag_key true
      host elasticsearch-client
      port 9200
      user elastic # FLUENT_ELASTICSEARCH_USER | FLUENT_ELASTICSEARCH_PASSWORD
      password oschina
      logstash_format true
      logstash_prefix k8s
      request_timeout 30s
      &lt;buffer&gt;
        @type file
        path /var/log/fluentd-buffers/kubernetes.system.buffer
        flush_mode interval
        retry_type exponential_backoff
        flush_thread_count 2
        flush_interval 5s
        retry_forever
        retry_max_interval 30
        chunk_limit_size 2M
        queue_limit_length 8
        overflow_action block
      &lt;/buffer&gt;
    &lt;/match&gt;
</pre></div>
</div>
<p>上面配置文件中我们只配置了 docker
容器日志目录，收集到数据经过处理后发送到 <code class="docutils literal notranslate"><span class="pre">elasticsearch-client:9200</span></code>
服务。</p>
<p>然后新建一个<code class="docutils literal notranslate"><span class="pre">fluentd-daemonset.yaml</span></code>的文件，文件内容如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ServiceAccount</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">fluentd</span><span class="o">-</span><span class="n">es</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">logging</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">k8s</span><span class="o">-</span><span class="n">app</span><span class="p">:</span> <span class="n">fluentd</span><span class="o">-</span><span class="n">es</span>
    <span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">cluster</span><span class="o">-</span><span class="n">service</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
    <span class="n">addonmanager</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">mode</span><span class="p">:</span> <span class="n">Reconcile</span>
<span class="o">---</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ClusterRole</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">rbac</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">fluentd</span><span class="o">-</span><span class="n">es</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">k8s</span><span class="o">-</span><span class="n">app</span><span class="p">:</span> <span class="n">fluentd</span><span class="o">-</span><span class="n">es</span>
    <span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">cluster</span><span class="o">-</span><span class="n">service</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
    <span class="n">addonmanager</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">mode</span><span class="p">:</span> <span class="n">Reconcile</span>
<span class="n">rules</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">apiGroups</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;&quot;</span>
    <span class="n">resources</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;namespaces&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;pods&quot;</span>
    <span class="n">verbs</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;get&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;watch&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;list&quot;</span>
<span class="o">---</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ClusterRoleBinding</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">rbac</span><span class="o">.</span><span class="n">authorization</span><span class="o">.</span><span class="n">k8s</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">fluentd</span><span class="o">-</span><span class="n">es</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">k8s</span><span class="o">-</span><span class="n">app</span><span class="p">:</span> <span class="n">fluentd</span><span class="o">-</span><span class="n">es</span>
    <span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">cluster</span><span class="o">-</span><span class="n">service</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
    <span class="n">addonmanager</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">mode</span><span class="p">:</span> <span class="n">Reconcile</span>
<span class="n">subjects</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">kind</span><span class="p">:</span> <span class="n">ServiceAccount</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">fluentd</span><span class="o">-</span><span class="n">es</span>
    <span class="n">namespace</span><span class="p">:</span> <span class="n">logging</span>
    <span class="n">apiGroup</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
<span class="n">roleRef</span><span class="p">:</span>
  <span class="n">kind</span><span class="p">:</span> <span class="n">ClusterRole</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">fluentd</span><span class="o">-</span><span class="n">es</span>
  <span class="n">apiGroup</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
<span class="o">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">DaemonSet</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">fluentd</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">logging</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="n">fluentd</span>
    <span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">cluster</span><span class="o">-</span><span class="n">service</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="n">fluentd</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">app</span><span class="p">:</span> <span class="n">fluentd</span>
        <span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">cluster</span><span class="o">-</span><span class="n">service</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">tolerations</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">key</span><span class="p">:</span> <span class="n">node</span><span class="o">-</span><span class="n">role</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">master</span>
          <span class="n">effect</span><span class="p">:</span> <span class="n">NoSchedule</span>
      <span class="n">serviceAccountName</span><span class="p">:</span> <span class="n">fluentd</span><span class="o">-</span><span class="n">es</span>
      <span class="n">containers</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">fluentd</span>
          <span class="n">image</span><span class="p">:</span> <span class="n">quay</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">fluentd_elasticsearch</span><span class="o">/</span><span class="n">fluentd</span><span class="p">:</span><span class="n">v3</span><span class="o">.</span><span class="mf">2.0</span>
          <span class="n">volumeMounts</span><span class="p">:</span>
            <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">fluentconfig</span>
              <span class="n">mountPath</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fluent</span><span class="o">/</span><span class="n">config</span><span class="o">.</span><span class="n">d</span>
            <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">varlog</span>
              <span class="n">mountPath</span><span class="p">:</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span>
            <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">varlibdockercontainers</span>
              <span class="n">mountPath</span><span class="p">:</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">containers</span>
              <span class="n">readOnly</span><span class="p">:</span> <span class="n">true</span>
      <span class="n">nodeSelector</span><span class="p">:</span>
        <span class="n">beta</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">fluentd</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="n">ready</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
      <span class="n">terminationGracePeriodSeconds</span><span class="p">:</span> <span class="mi">30</span>
      <span class="n">volumes</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">fluentconfig</span>
          <span class="n">configMap</span><span class="p">:</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">fluentd</span><span class="o">-</span><span class="n">conf</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">varlog</span>
          <span class="n">hostPath</span><span class="p">:</span>
            <span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">varlibdockercontainers</span>
          <span class="n">hostPath</span><span class="p">:</span>
            <span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">containers</span>
</pre></div>
</div>
<p>我们将上面创建的 fluentd-config 这个 ConfigMap 对象通过 volumes 挂载到了
Fluentd
容器中，另外为了能够灵活控制哪些节点的日志可以被收集，所以我们这里还添加了一个
nodSelector 属性：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nodeSelector</span><span class="p">:</span>
  <span class="n">beta</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">fluentd</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="n">ready</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
</pre></div>
</div>
<p>意思就是要想采集节点的日志，那么我们就需要给节点打上上面的标签。</p>
<p>!!! info “提示”
如果你需要在其他节点上采集日志，则需要给对应节点打上标签，使用如下命令：<code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">label</span> <span class="pre">nodes</span> <span class="pre">node名</span> <span class="pre">beta.kubernetes.io/fluentd-ds-ready=true</span></code>。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">label</span> <span class="n">nodes</span> <span class="n">giteego</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">n1</span> <span class="n">beta</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">fluentd</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="n">ready</span><span class="o">=</span><span class="n">true</span>
<span class="n">kubectl</span> <span class="n">label</span> <span class="n">nodes</span> <span class="n">giteego</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">n2</span> <span class="n">beta</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">fluentd</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="n">ready</span><span class="o">=</span><span class="n">true</span>
<span class="n">kubectl</span> <span class="n">label</span> <span class="n">nodes</span> <span class="n">giteego</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">n3</span> <span class="n">beta</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">fluentd</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="n">ready</span><span class="o">=</span><span class="n">true</span>
<span class="n">kubectl</span> <span class="n">label</span> <span class="n">nodes</span> <span class="n">giteego</span><span class="o">-</span><span class="n">k8s</span><span class="o">-</span><span class="n">n4</span> <span class="n">beta</span><span class="o">.</span><span class="n">kubernetes</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">fluentd</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="n">ready</span><span class="o">=</span><span class="n">true</span>
</pre></div>
</div>
<p>另外由于我们的集群使用的是 kubeadm 搭建的，默认情况下 master
节点有污点，所以如果要想也收集 master 节点的日志，则需要添加上容忍：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tolerations</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">operator</span><span class="p">:</span> <span class="n">Exists</span>
</pre></div>
</div>
<blockquote>
<div><p>另外需要注意的地方是，如果更改了 docker 的根目录，则在 volumes 和
volumeMount 里面都需要更改，保持一致</p>
</div></blockquote>
<p>分别创建上面的 ConfigMap 对象和 DaemonSet：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl create -f fluentd-configmap.yaml
configmap &quot;fluentd-conf&quot; created

$ kubectl create -f fluentd-daemonset.yaml
serviceaccount &quot;fluentd-es&quot; created
clusterrole.rbac.authorization.k8s.io &quot;fluentd-es&quot; created
clusterrolebinding.rbac.authorization.k8s.io &quot;fluentd-es&quot; created
daemonset.apps &quot;fluentd&quot; created
</pre></div>
</div>
<p>创建完成后，查看对应的 Pods 列表，检查是否部署成功：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl get pods -n logging
NAME                             READY   STATUS    RESTARTS   AGE
elasticsearch-client-0           1/1     Running   0          98m
elasticsearch-data-0             1/1     Running   0          99m
elasticsearch-master-0           1/1     Running   0          92m
elasticsearch-master-1           1/1     Running   0          92m
elasticsearch-master-2           1/1     Running   0          92m
fluentd-5mqjr                    1/1     Running   0          6m58s
fluentd-7pzm8                    1/1     Running   0          6m58s
fluentd-c9ppc                    1/1     Running   0          6m58s
fluentd-d8dvr                    1/1     Running   0          6m58s
fluentd-ms7br                    1/1     Running   0          6m58s
fluentd-qtspb                    1/1     Running   0          6m58s
fluentd-tp9fj                    1/1     Running   0          6m58s
fluentd-wfv8q                    1/1     Running   0          6m58s
kibana-kibana-785f84bc84-2ld59   1/1     Running   0          63m
</pre></div>
</div>
<p>Fluentd 启动成功后，这个时候就可以发送日志到 ES
了，但是我们这里是过滤了只采集具有 <code class="docutils literal notranslate"><span class="pre">logging=true</span></code> 标签的 Pod
日志，所以现在还没有任何数据会被采集。</p>
<p>下面我们部署一个简单的测试应用，
新建<code class="docutils literal notranslate"><span class="pre">counter.yaml</span></code>文件，文件内容如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">counter</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">logging</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span> <span class="c1"># 一定要具有该标签才会被采集</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">containers</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">count</span>
      <span class="n">image</span><span class="p">:</span> <span class="n">busybox</span>
      <span class="n">args</span><span class="p">:</span>
        <span class="p">[</span>
          <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sh</span><span class="p">,</span>
          <span class="o">-</span><span class="n">c</span><span class="p">,</span>
          <span class="s1">&#39;i=0; while true; do echo &quot;$i: $(date)&quot;; i=$((i+1)); sleep 1; done&#39;</span><span class="p">,</span>
        <span class="p">]</span>
</pre></div>
</div>
<p>该 Pod 只是简单将日志信息打印到 <code class="docutils literal notranslate"><span class="pre">stdout</span></code>，所以正常来说 Fluentd
会收集到这个日志数据，在 Kibana 中也就可以找到对应的日志数据了，使用
kubectl 工具创建该 Pod：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl create -f counter.yaml
$ kubectl get pod
NAME                                      READY   STATUS    RESTARTS   AGE
counter                                   1/1     Running   0          29s
</pre></div>
</div>
<p>Pod 创建并运行后，回到 Kibana Dashboard 页面，点击左侧最下面的
<code class="docutils literal notranslate"><span class="pre">Management</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">Stack</span> <span class="pre">Management</span></code>，进入管理页面，点击左侧
<code class="docutils literal notranslate"><span class="pre">Kibana</span></code> 下面的 <code class="docutils literal notranslate"><span class="pre">索引模式</span></code>，点击 <code class="docutils literal notranslate"><span class="pre">创建索引模式</span></code>
开始导入索引数据：</p>
<img alt="../_images/image-20220329114730133.png" src="../_images/image-20220329114730133.png" />
<p>在这里可以配置我们需要的 Elasticsearch 索引，前面 Fluentd
配置文件中我们采集的日志使用的是 logstash 格式，定义了一个 <code class="docutils literal notranslate"><span class="pre">k8s</span></code>
的前缀，所以这里只需要在文本框中输入 <code class="docutils literal notranslate"><span class="pre">k8s-*</span></code> 即可匹配到 Elasticsearch
集群中采集的 Kubernetes 集群日志数据，然后点击下一步，进入以下页面</p>
<img alt="../_images/image-20220329133742477.png" src="../_images/image-20220329133742477.png" />
<p>在该页面中配置使用哪个字段按时间过滤日志数据，在下拉列表中，选择<code class="docutils literal notranslate"><span class="pre">&#64;timestamp</span></code>字段，然后点击
<code class="docutils literal notranslate"><span class="pre">创建索引模式</span></code>，创建完成后，点击左侧导航菜单中的
<code class="docutils literal notranslate"><span class="pre">Discover</span></code>，然后就可以看到一些直方图和最近采集到的日志数据了：</p>
<img alt="../_images/image-20220329134634317.png" src="../_images/image-20220329134634317.png" />
<p>我们也可以通过其他元数据来过滤日志数据，比如您可以单击任何日志条目以查看其他元数据，如容器名称，Kubernetes
节点，命名空间等。</p>
</section>
</section>
<section id="kafka">
<h2><a class="toc-backref" href="#id18">4. 安装 Kafka</a><a class="headerlink" href="#kafka" title="Permalink to this headline">¶</a></h2>
<p>对于大规模集群来说，日志数据量是非常巨大的，如果直接通过 Fluentd
将日志打入 Elasticsearch，对 ES
来说压力是非常巨大的，我们可以在中间加一层消息中间件来缓解 ES
的压力，一般情况下我们会使用 Kafka，然后可以直接使用
<code class="docutils literal notranslate"><span class="pre">kafka-connect-elasticsearch</span></code> 这样的工具将数据直接打入
ES，也可以在加一层 Logstash 去消费 Kafka 的数据，然后通过 Logstash
把数据存入 ES，这里我们来使用 Logstash 这种模式来对日志收集进行优化。</p>
<p>首先在 Kubernetes 集群中安装 Kafka，同样这里使用 Helm 进行安装：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm repo add bitnami https://charts.bitnami.com/bitnami
$ helm repo update
</pre></div>
</div>
<p>首先使用 <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">pull</span></code> 拉取 Chart 并解压：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm pull bitnami/kafka --untar --version <span class="m">12</span>.17.5
$ <span class="nb">cd</span> kafka
</pre></div>
</div>
<p>这里面我们指定使用一个 <code class="docutils literal notranslate"><span class="pre">StorageClass</span></code> 来提供持久化存储，在 Chart
目录下面创建用于安装的 values 文件：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># values-prod.yaml</span>
<span class="c1">## Persistence parameters</span>
<span class="c1">##</span>
<span class="nt">persistence</span><span class="p">:</span>
  <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">storageClass</span><span class="p">:</span> <span class="s">&quot;efk-nfs&quot;</span>
  <span class="nt">accessModes</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
  <span class="nt">size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5Gi</span>
  <span class="c1">## Mount point for persistence</span>
  <span class="nt">mountPath</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/bitnami/kafka</span>

<span class="c1"># 配置zk volumes</span>
<span class="nt">zookeeper</span><span class="p">:</span>
  <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">persistence</span><span class="p">:</span>
    <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="nt">storageClass</span><span class="p">:</span> <span class="s">&quot;efk-nfs&quot;</span>
    <span class="nt">accessModes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
    <span class="nt">size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8Gi</span>
</pre></div>
</div>
<p>直接使用上面的 values 文件安装 kafka：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm install kafka -f values-prod.yaml --namespace logging .
Release <span class="s2">&quot;kafka&quot;</span> does not exist. Installing it now.
NAME: kafka
LAST DEPLOYED: Tue Apr <span class="m">27</span> <span class="m">18</span>:46:01 <span class="m">2021</span>
NAMESPACE: logging
STATUS: deployed
REVISION: <span class="m">1</span>
TEST SUITE: None
NOTES:
** Please be patient <span class="k">while</span> the chart is being deployed **

Kafka can be accessed by consumers via port <span class="m">9092</span> on the following DNS name from within your cluster:

    kafka.logging.svc.cluster.local

Each Kafka broker can be accessed by producers via port <span class="m">9092</span> on the following DNS name<span class="o">(</span>s<span class="o">)</span> from within your cluster:

    kafka-0.kafka-headless.logging.svc.cluster.local:9092

To create a pod that you can use as a Kafka client run the following commands:

    kubectl run kafka-client --restart<span class="o">=</span><span class="s1">&#39;Never&#39;</span> --image docker.io/bitnami/kafka:2.8.0-debian-10-r0 --namespace logging --command -- sleep infinity
    kubectl <span class="nb">exec</span> --tty -i kafka-client --namespace logging -- bash

    PRODUCER:
        kafka-console-producer.sh <span class="se">\</span>

            --broker-list kafka-0.kafka-headless.logging.svc.cluster.local:9092 <span class="se">\</span>
            --topic <span class="nb">test</span>

    CONSUMER:
        kafka-console-consumer.sh <span class="se">\</span>

            --bootstrap-server kafka.logging.svc.cluster.local:9092 <span class="se">\</span>
            --topic <span class="nb">test</span> <span class="se">\</span>
            --from-beginning
</pre></div>
</div>
<p>安装完成后我们可以使用上面的提示来检查 Kafka 是否正常运行：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ kubectl get pods -n logging -l app.kubernetes.io/instance<span class="o">=</span>kafka
NAME                READY   STATUS    RESTARTS   AGE
kafka-0             <span class="m">1</span>/1     Running   <span class="m">0</span>          43m
kafka-zookeeper-0   <span class="m">1</span>/1     Running   <span class="m">0</span>          43m
</pre></div>
</div>
<p>用下面的命令创建一个 Kafka 的测试客户端 Pod：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ kubectl run kafka-client --restart<span class="o">=</span><span class="s1">&#39;Never&#39;</span> --image docker.io/bitnami/kafka:2.8.0-debian-10-r0 --namespace logging --command -- sleep infinity
pod/kafka-client created
</pre></div>
</div>
<p>然后启动一个终端进入容器内部生产消息：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 生产者</span>
$ kubectl <span class="nb">exec</span> --tty -i kafka-client --namespace logging -- bash
I have no name!@kafka-client:/$ kafka-console-producer.sh --broker-list kafka-0.kafka-headless.logging.svc.cluster.local:9092 --topic <span class="nb">test</span>
&gt;hello kafka on k8s
&gt;
</pre></div>
</div>
<p>启动另外一个终端进入容器内部消费消息：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 消费者</span>
$ kubectl <span class="nb">exec</span> --tty -i kafka-client --namespace logging -- bash
I have no name!@kafka-client:/$ kafka-console-consumer.sh --bootstrap-server kafka.logging.svc.cluster.local:9092 --topic <span class="nb">test</span> --from-beginning
hello kafka on k8s
</pre></div>
</div>
<p>如果在消费端看到了生产的消息数据证明我们的 Kafka 已经运行成功了。</p>
</section>
<section id="fluentd-kafka">
<h2><a class="toc-backref" href="#id19">5. Fluentd 配置 Kafka</a><a class="headerlink" href="#fluentd-kafka" title="Permalink to this headline">¶</a></h2>
<p>现在有了 Kafka，我们就可以将 Fluentd 的日志数据输出到 Kafka 了，只需要将
Fluentd 配置中的 <code class="docutils literal notranslate"><span class="pre">&lt;match&gt;</span></code> 更改为使用 Kafka 插件即可，但是在 Fluentd
中输出到 Kafka，需要使用到 <code class="docutils literal notranslate"><span class="pre">fluent-plugin-kafka</span></code>
插件，所以需要我们自定义下 Docker 镜像，最简单的做法就是在上面 Fluentd
镜像的基础上新增 kafka 插件即可，Dockerfile 文件如下所示：</p>
<p><code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FROM</span> <span class="n">quay</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">fluentd_elasticsearch</span><span class="o">/</span><span class="n">fluentd</span><span class="p">:</span><span class="n">v3</span><span class="o">.</span><span class="mf">2.0</span>
<span class="n">RUN</span> <span class="n">echo</span> <span class="s2">&quot;source &#39;https://mirrors.tuna.tsinghua.edu.cn/rubygems/&#39;&quot;</span> <span class="o">&gt;</span> <span class="n">Gemfile</span> <span class="o">&amp;&amp;</span> <span class="n">gem</span> <span class="n">install</span> <span class="n">bundler</span>
<span class="n">RUN</span> <span class="n">gem</span> <span class="n">install</span> <span class="n">fluent</span><span class="o">-</span><span class="n">plugin</span><span class="o">-</span><span class="n">kafka</span> <span class="o">-</span><span class="n">v</span> <span class="mf">0.16</span><span class="o">.</span><span class="mi">1</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">document</span>
</pre></div>
</div>
<p>使用上面的 <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> 文件构建一个 Docker
镜像即可，我这里构建过后的镜像名为
<code class="docutils literal notranslate"><span class="pre">registry.cn-hangzhou.aliyuncs.com/hu_k8s/fluent-plugin-kafka-0.16.1</span></code>。接下来替换
Fluentd 的 Configmap 对象中的 <code class="docutils literal notranslate"><span class="pre">&lt;match&gt;</span></code> 部分，如下所示：</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># fluentd-configmap.yaml</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fluentd-conf</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">logging</span>
<span class="nt">data</span><span class="p">:</span>
  <span class="l l-Scalar l-Scalar-Plain">.....</span>
  <span class="l l-Scalar l-Scalar-Plain">output.conf</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|-</span>
    <span class="no">&lt;match **&gt;</span>
      <span class="no">@id kafka</span>
      <span class="no">@type kafka2</span>
      <span class="no">@log_level info</span>
      <span class="no"># list of seed brokers</span>
      <span class="no">brokers kafka-0.kafka-headless.logging.svc.cluster.local:9092</span>
      <span class="no">use_event_time true</span>
      <span class="no"># topic settings</span>
      <span class="no">topic_key k8slog</span>
      <span class="no">default_topic messages  # 注意，kafka中消费使用的是这个topic</span>
      <span class="no"># buffer settings</span>
      <span class="no">&lt;buffer k8slog&gt;</span>
        <span class="no">@type file</span>
        <span class="no">path /var/log/td-agent/buffer/td</span>
        <span class="no">flush_interval 3s</span>
      <span class="no">&lt;/buffer&gt;</span>
      <span class="no"># data type settings</span>
      <span class="no">&lt;format&gt;</span>
        <span class="no">@type json</span>
      <span class="no">&lt;/format&gt;</span>
      <span class="no"># producer settings</span>
      <span class="no">required_acks -1</span>
      <span class="no">compression_codec gzip</span>
    <span class="no">&lt;/match&gt;</span>
</pre></div>
</div>
<blockquote>
<div><p>注意：node节点会创建一个/var/log/td-agent/buffer/td目录。此目录数据很大，考虑到磁盘空间的问题，可以将buffer
settings为memory的方式</p>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">output</span><span class="o">.</span><span class="n">conf</span><span class="p">:</span> <span class="o">|-</span>
  <span class="o">&lt;</span><span class="n">match</span> <span class="o">**&gt;</span>
    <span class="nd">@id</span> <span class="n">kafka</span>
    <span class="nd">@type</span> <span class="n">kafka2</span>
    <span class="nd">@log_level</span> <span class="n">info</span>
    <span class="c1"># list of seed brokers</span>
    <span class="n">brokers</span> <span class="n">kafka</span><span class="o">-</span><span class="mf">0.</span><span class="n">kafka</span><span class="o">-</span><span class="n">headless</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">svc</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">local</span><span class="p">:</span><span class="mi">9092</span>
    <span class="n">use_event_time</span> <span class="n">true</span>
    <span class="c1"># topic settings</span>
    <span class="n">topic_key</span> <span class="n">k8slog</span>
    <span class="n">default_topic</span> <span class="n">messages</span>  <span class="c1"># 注意，kafka中消费使用的是这个topic</span>
    <span class="c1"># buffer settings</span>
    <span class="o">&lt;</span><span class="n">buffer</span> <span class="n">k8slog</span><span class="o">&gt;</span>
      <span class="nd">@type</span> <span class="n">memory</span>
      <span class="n">path</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">td</span><span class="o">-</span><span class="n">agent</span><span class="o">/</span><span class="n">buffer</span><span class="o">/</span><span class="n">td</span>
      <span class="n">flush_interval</span> <span class="mi">3</span><span class="n">s</span>
    <span class="o">&lt;/</span><span class="n">buffer</span><span class="o">&gt;</span>
    <span class="c1"># data type settings</span>
    <span class="o">&lt;</span><span class="nb">format</span><span class="o">&gt;</span>
      <span class="nd">@type</span> <span class="n">json</span>
    <span class="o">&lt;/</span><span class="nb">format</span><span class="o">&gt;</span>
    <span class="c1"># producer settings</span>
    <span class="n">required_acks</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">compression_codec</span> <span class="n">gzip</span>
  <span class="o">&lt;/</span><span class="n">match</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>然后替换运行的 Fluentd 镜像：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># fluentd-daemonset.yaml</span>
<span class="n">image</span><span class="p">:</span> <span class="n">registry</span><span class="o">.</span><span class="n">cn</span><span class="o">-</span><span class="n">hangzhou</span><span class="o">.</span><span class="n">aliyuncs</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">hu_k8s</span><span class="o">/</span><span class="n">fluent</span><span class="o">-</span><span class="n">plugin</span><span class="o">-</span><span class="n">kafka</span><span class="o">-</span><span class="mf">0.16</span><span class="o">.</span><span class="mi">1</span>
</pre></div>
</div>
<p>直接更新 Fluentd 的 Configmap 与 DaemonSet 资源对象即可：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ kubectl apply -f fluentd-configmap.yaml
$ kubectl apply -f fluentd-daemonset.yaml
</pre></div>
</div>
<p>更新成功后我们可以使用上面的测试 Kafka 客户端来验证是否有日志数据：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ kubectl <span class="nb">exec</span> --tty -i kafka-client --namespace logging -- bash
I have no name!@kafka-client:/$ kafka-console-consumer.sh --bootstrap-server kafka.logging.svc.cluster.local:9092 --topic messages --from-beginning
<span class="o">{</span><span class="s2">&quot;stream&quot;</span>:<span class="s2">&quot;stdout&quot;</span>,<span class="s2">&quot;docker&quot;</span>:<span class="o">{}</span>,<span class="s2">&quot;kubernetes&quot;</span>:<span class="o">{</span><span class="s2">&quot;container_name&quot;</span>:<span class="s2">&quot;count&quot;</span>,<span class="s2">&quot;namespace_name&quot;</span>:<span class="s2">&quot;default&quot;</span>,<span class="s2">&quot;pod_name&quot;</span>:<span class="s2">&quot;counter&quot;</span>,<span class="s2">&quot;container_image&quot;</span>:<span class="s2">&quot;busybox:latest&quot;</span>,<span class="s2">&quot;host&quot;</span>:<span class="s2">&quot;node1&quot;</span>,<span class="s2">&quot;labels&quot;</span>:<span class="o">{</span><span class="s2">&quot;logging&quot;</span>:<span class="s2">&quot;true&quot;</span><span class="o">}}</span>,<span class="s2">&quot;message&quot;</span>:<span class="s2">&quot;43883: Tue Apr 27 12:16:30 UTC 2021\n&quot;</span><span class="o">}</span>
......
</pre></div>
</div>
</section>
<section id="logstash">
<h2><a class="toc-backref" href="#id20">6. 安装 Logstash</a><a class="headerlink" href="#logstash" title="Permalink to this headline">¶</a></h2>
<p>虽然数据从 Kafka 到 Elasticsearch
的方式多种多样，我们这里还是采用更加流行的 Logstash
方案，上面我们已经将日志从 Fluentd 采集输出到 Kafka
中去了，接下来我们使用 Logstash 来连接 Kafka 与 Elasticsearch
间的日志数据。</p>
<p>首先使用 <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">pull</span></code> 拉取 Chart 并解压：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm pull elastic/logstash --untar --version <span class="m">7</span>.12.0
$ <span class="nb">cd</span> logstash
</pre></div>
</div>
<p>同样在 Chart 根目录下面创建用于安装的 Values 文件，如下所示：</p>
<p><code class="docutils literal notranslate"><span class="pre">values-prod.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># values-prod.yaml</span>
<span class="nt">fullnameOverride</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">logstash</span>

<span class="nt">persistence</span><span class="p">:</span>
  <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="nt">logstashConfig</span><span class="p">:</span>
  <span class="nt">logstash.yml</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">http.host: 0.0.0.0</span>
    <span class="no"># 如果启用了xpack，需要做如下配置</span>
    <span class="no">xpack.monitoring.enabled: true</span>
    <span class="no">xpack.monitoring.elasticsearch.hosts: [&quot;http://elasticsearch-client:9200&quot;]</span>
    <span class="no">xpack.monitoring.elasticsearch.username: &quot;elastic&quot;</span>
    <span class="no">xpack.monitoring.elasticsearch.password: &quot;oschina2022qazwsx&quot;</span>

<span class="c1"># 要注意下格式</span>
<span class="nt">logstashPipeline</span><span class="p">:</span>
  <span class="nt">logstash.conf</span><span class="p">:</span> <span class="p p-Indicator">|</span>
    <span class="no">input { kafka { bootstrap_servers =&gt; &quot;kafka-0.kafka-headless.logging.svc.cluster.local:9092&quot; codec =&gt; json consumer_threads =&gt; 3 topics =&gt; [&quot;messages&quot;] } }</span>
    <span class="no">filter {}  # 过滤配置（比如可以删除key、添加geoip等等）</span>
    <span class="no">output { elasticsearch { hosts =&gt; [ &quot;elasticsearch-client:9200&quot; ] user =&gt; &quot;elastic&quot; password =&gt; &quot;oschina2022qazwsx&quot; index =&gt; &quot;logstash-k8s-%{+YYYY.MM.dd}&quot; } stdout { codec =&gt; rubydebug } }</span>

<span class="nt">volumeClaimTemplate</span><span class="p">:</span>
  <span class="nt">accessModes</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;ReadWriteOnce&quot;</span><span class="p p-Indicator">]</span>
  <span class="nt">storageClassName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">efk-nfs</span>
  <span class="nt">resources</span><span class="p">:</span>
    <span class="nt">requests</span><span class="p">:</span>
      <span class="nt">storage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10Gi</span>
</pre></div>
</div>
<p>其中最重要的就是通过 <code class="docutils literal notranslate"><span class="pre">logstashPipeline</span></code> 配置 logstash
数据流的处理配置，通过 <code class="docutils literal notranslate"><span class="pre">input</span></code> 指定日志源 kafka 的配置，通过
<code class="docutils literal notranslate"><span class="pre">output</span></code> 输出到 Elasticsearch，同样直接使用上面的 Values 文件安装
logstash 即可：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ helm upgrade --install logstash -f values-prod.yaml --namespace logging .
Release <span class="s2">&quot;logstash&quot;</span> does not exist. Installing it now.
NAME: logstash
LAST DEPLOYED: Tue Apr <span class="m">27</span> <span class="m">20</span>:22:45 <span class="m">2021</span>
NAMESPACE: logging
STATUS: deployed
REVISION: <span class="m">1</span>
TEST SUITE: None
NOTES:
<span class="m">1</span>. Watch all cluster members come up.
  $ kubectl get pods --namespace<span class="o">=</span>logging -l <span class="nv">app</span><span class="o">=</span>logstash -w
</pre></div>
</div>
<p>安装启动完成后可以查看 logstash 的日志：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ kubectl get pods --namespace<span class="o">=</span>logging -l <span class="nv">app</span><span class="o">=</span>logstash
NAME         READY   STATUS    RESTARTS   AGE
logstash-0   <span class="m">1</span>/1     Running   <span class="m">0</span>          2m8s

$ kubectl logs -f logstash-0 -n logging
......
<span class="o">{</span>
<span class="s2">&quot;docker&quot;</span> <span class="o">=</span>&gt; <span class="o">{}</span>,
<span class="s2">&quot;stream&quot;</span> <span class="o">=</span>&gt; <span class="s2">&quot;stdout&quot;</span>,
<span class="s2">&quot;message&quot;</span> <span class="o">=</span>&gt; <span class="s2">&quot;46921: Tue Apr 27 13:07:15 UTC 2021\n&quot;</span>,
<span class="s2">&quot;kubernetes&quot;</span> <span class="o">=</span>&gt; <span class="o">{</span>
            <span class="s2">&quot;host&quot;</span> <span class="o">=</span>&gt; <span class="s2">&quot;node1&quot;</span>,
          <span class="s2">&quot;labels&quot;</span> <span class="o">=</span>&gt; <span class="o">{</span>
    <span class="s2">&quot;logging&quot;</span> <span class="o">=</span>&gt; <span class="s2">&quot;true&quot;</span>
<span class="o">}</span>,
        <span class="s2">&quot;pod_name&quot;</span> <span class="o">=</span>&gt; <span class="s2">&quot;counter&quot;</span>,
<span class="s2">&quot;container_image&quot;</span> <span class="o">=</span>&gt; <span class="s2">&quot;busybox:latest&quot;</span>,
  <span class="s2">&quot;container_name&quot;</span> <span class="o">=</span>&gt; <span class="s2">&quot;count&quot;</span>,
  <span class="s2">&quot;namespace_name&quot;</span> <span class="o">=</span>&gt; <span class="s2">&quot;default&quot;</span>
<span class="o">}</span>,
<span class="s2">&quot;@timestamp&quot;</span> <span class="o">=</span>&gt; <span class="m">2021</span>-04-27T13:07:15.761Z,
<span class="s2">&quot;@version&quot;</span> <span class="o">=</span>&gt; <span class="s2">&quot;1&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>由于我们启用了 debug 日志调试，所以我们可以在 logstash
的日志中看到我们采集的日志消息，到这里证明我们的日志数据就获取成功了。</p>
<p>现在我们可以登录到 Kibana 可以看到有如下所示的索引数据了。</p>
<p>然后同样创建索引模式，匹配上面的索引即可。</p>
</section>
<section id="id8">
<h2><a class="toc-backref" href="#id21">参考文献</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://mp.weixin.qq.com/s/lPeYavvFJ6GdivkT0iwTGw">https://mp.weixin.qq.com/s/lPeYavvFJ6GdivkT0iwTGw</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="11.%E9%9B%86%E7%BE%A4%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F.html" class="btn btn-neutral float-left" title="集群日志系统" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="13.Kubernetes%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E4%BB%8EDocker%E5%88%87%E6%8D%A2%E6%88%90Containerd.html" class="btn btn-neutral float-right" title="Kubernetes容器运行时从Docker切换成Containerd" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, huxiaojian.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>