<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>搭建一个Web应用栈 &mdash; 运维开发修炼之路</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Docker高级网络实战" href="20.Docker%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E5%AE%9E%E6%88%98.html" />
    <link rel="prev" title="Docker三剑客之Docker-Machine" href="18.Docker%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8BDocker-Machine.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> 小健_Docker_K8s_Blog
            <img src="../_static/docker-k8s.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">01.Docker技术入门与实战3版</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01.%E5%88%9D%E8%AF%86Docker%E4%B8%8E%E5%AE%B9%E5%99%A8.html">初识Docker与容器</a></li>
<li class="toctree-l2"><a class="reference internal" href="02.Docker%E9%95%9C%E5%83%8F%E7%9A%84%E4%BD%BF%E7%94%A8.html">Docker镜像的使用</a></li>
<li class="toctree-l2"><a class="reference internal" href="03.%E6%93%8D%E4%BD%9CDocker%E5%AE%B9%E5%99%A8.html">操作Docker容器</a></li>
<li class="toctree-l2"><a class="reference internal" href="04.%E8%AE%BF%E9%97%AEDocker%E4%BB%93%E5%BA%93.html">访问Docker仓库</a></li>
<li class="toctree-l2"><a class="reference internal" href="05.%E6%90%AD%E5%BB%BA%E6%9C%AC%E5%9C%B0%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93.html">搭建本地私有仓库</a></li>
<li class="toctree-l2"><a class="reference internal" href="06.Docker%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86.html">Docker数据管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="07.Docker%E4%BD%BF%E7%94%A8%E7%BD%91%E7%BB%9C.html">Docker使用网络</a></li>
<li class="toctree-l2"><a class="reference internal" href="08.%E4%BD%BF%E7%94%A8Dockerfile%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F.html">使用Dockerfile创建镜像</a></li>
<li class="toctree-l2"><a class="reference internal" href="09.%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B.html">实战案例</a></li>
<li class="toctree-l2"><a class="reference internal" href="10.Docker%E6%A0%B8%E5%BF%83%E5%AE%9E%E7%8E%B0%E6%8A%80%E6%9C%AF.html">Docker核心实现技术</a></li>
<li class="toctree-l2"><a class="reference internal" href="11.%E9%85%8D%E7%BD%AE%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93.html">配置私有仓库</a></li>
<li class="toctree-l2"><a class="reference internal" href="12.%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E4%B8%8E%E9%85%8D%E7%BD%AE.html">安全防护与配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="13.%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E5%8A%9F%E8%83%BD.html">高级网络功能</a></li>
<li class="toctree-l2"><a class="reference internal" href="14.libnetwork%E6%8F%92%E4%BB%B6%E5%8C%96%E7%BD%91%E7%BB%9C%E5%8A%9F%E8%83%BD.html">libnetwork插件化网络功能</a></li>
<li class="toctree-l2"><a class="reference internal" href="15.Etcd%E9%AB%98%E5%8F%AF%E7%94%A8%E7%9A%84%E9%94%AE%E5%80%BC%E6%95%B0%E6%8D%AE%E5%BA%93.html">Etcd高可用的键值数据库</a></li>
<li class="toctree-l2"><a class="reference internal" href="16.Docker%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8BDocker-Compose.html">Docker三剑客之Docker-Compose</a></li>
<li class="toctree-l2"><a class="reference internal" href="17.Docker%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8BDocker-Swarm.html">Docker三剑客之Docker-Swarm</a></li>
<li class="toctree-l2"><a class="reference internal" href="18.Docker%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8BDocker-Machine.html">Docker三剑客之Docker-Machine</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">搭建一个Web应用栈</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">1.获取应用栈各节点所需的镜像</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">2. 启动各个栈节点</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">3.应用栈容器节点配置</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#redis-master">Redis Master配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="#app-django">APP容器节点（Django）的配置</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#haproxy">4.Haproxy容器节点配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">5.应用访问测试</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="20.Docker%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E5%AE%9E%E6%88%98.html">Docker高级网络实战</a></li>
<li class="toctree-l2"><a class="reference internal" href="21.%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0.html">服务发现</a></li>
<li class="toctree-l2"><a class="reference internal" href="22.Mesos-%E4%BC%98%E7%A7%80%E7%9A%84%E9%9B%86%E7%BE%A4%E8%B5%84%E6%BA%90%E8%B0%83%E5%BA%A6%E5%B9%B3%E5%8F%B0.html">Mesos—优秀的集群资源调度平台</a></li>
<li class="toctree-l2"><a class="reference internal" href="23.Kubernetes-%E7%94%9F%E4%BA%A7%E7%BA%A7%E5%AE%B9%E5%99%A8%E9%9B%86%E7%BE%A4%E5%B9%B3%E5%8F%B0.html">Kubernetes-生产级容器集群平台</a></li>
<li class="toctree-l2"><a class="reference internal" href="24.%E5%85%B6%E4%BB%96%E7%9B%B8%E5%85%B3%E9%A1%B9%E7%9B%AE.html">其他相关项目</a></li>
<li class="toctree-l2"><a class="reference internal" href="25.%E9%99%84%E5%BD%95.html">附录</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../02.Kubernetes%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97/index.html">02.Kubernetes实战指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03.Docker%E7%BB%8F%E5%85%B8%E5%AE%9E%E4%BE%8B/index.html">03.Docker经典实例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../04.Prometheus%E7%9B%91%E6%8E%A7%E8%BF%90%E7%BB%B4%E5%AE%9E%E6%88%98/index.html">04.Prometheus监控运维实战</a></li>
<li class="toctree-l1"><a class="reference internal" href="../05.Kubernetes%E5%85%A5%E9%97%A8%E5%88%B0%E5%AE%9E%E8%B7%B5/index.html">05.Kubernetes入门到实践</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">小健_Docker_K8s_Blog</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">01.Docker技术入门与实战3版</a> &raquo;</li>
      <li>搭建一个Web应用栈</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/01.Docker技术入门与实战3版/19.搭建一个Web应用栈.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#web" id="id6">搭建一个Web应用栈</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id7">1.获取应用栈各节点所需的镜像</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id8">2. 启动各个栈节点</a></p></li>
<li><p><a class="reference internal" href="#id3" id="id9">3.应用栈容器节点配置</a></p>
<ul>
<li><p><a class="reference internal" href="#redis-master" id="id10">Redis Master配置</a></p></li>
<li><p><a class="reference internal" href="#app-django" id="id11">APP容器节点（Django）的配置</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#haproxy" id="id12">4.Haproxy容器节点配置</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id13">5.应用访问测试</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="web">
<h1><a class="toc-backref" href="#id6">搭建一个Web应用栈</a><a class="headerlink" href="#web" title="Permalink to this headline">¶</a></h1>
<p>搭建一个包含6个节点的Docker应用栈,包括一个代理节点，两个web应用节点，一个主数据库节点，
两个从数据库节点。</p>
<p>应用栈具体结构图，如下</p>
<img alt="../_images/docker_web_stack.PNG" src="../_images/docker_web_stack.PNG" />
<section id="id1">
<h2><a class="toc-backref" href="#id7">1.获取应用栈各节点所需的镜像</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 配置一个加速器</span>
<span class="n">curl</span> <span class="o">-</span><span class="n">sSL</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">get</span><span class="o">.</span><span class="n">daocloud</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">daotools</span><span class="o">/</span><span class="n">set_mirror</span><span class="o">.</span><span class="n">sh</span> <span class="o">|</span> <span class="n">sh</span> <span class="o">-</span><span class="n">s</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">f1361db2</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">daocloud</span><span class="o">.</span><span class="n">io</span>

<span class="c1"># 从Docker Hub获取Haproxy、Redis、Django的镜像。</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">ubuntu</span><span class="p">:</span><span class="mf">14.04</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">haproxy</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">redis</span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">django</span>
</pre></div>
</div>
<p>查看镜像一切就绪</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@docker</span><span class="o">-</span><span class="n">test</span> <span class="n">centos</span><span class="p">]</span><span class="c1"># docker images</span>
<span class="n">REPOSITORY</span>          <span class="n">TAG</span>                 <span class="n">IMAGE</span> <span class="n">ID</span>            <span class="n">CREATED</span>             <span class="n">SIZE</span>
<span class="n">docker</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">redis</span>     <span class="n">latest</span>              <span class="mi">9</span><span class="n">b188f5fb1e6</span>        <span class="mi">6</span> <span class="n">days</span> <span class="n">ago</span>          <span class="mf">98.2</span> <span class="n">MB</span>
<span class="n">docker</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">haproxy</span>   <span class="n">latest</span>              <span class="n">ecca7e36582a</span>        <span class="mi">11</span> <span class="n">days</span> <span class="n">ago</span>         <span class="mf">92.3</span> <span class="n">MB</span>
<span class="n">docker</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">ubuntu</span>    <span class="mf">14.04</span>               <span class="mf">6e4</span><span class="n">f1fe62ff1</span>        <span class="mi">2</span> <span class="n">weeks</span> <span class="n">ago</span>         <span class="mi">197</span> <span class="n">MB</span>
<span class="n">docker</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">django</span>    <span class="n">latest</span>              <span class="n">eb40dcf64078</span>        <span class="mi">3</span> <span class="n">years</span> <span class="n">ago</span>         <span class="mi">436</span> <span class="n">MB</span>
</pre></div>
</div>
</section>
<section id="id2">
<h2><a class="toc-backref" href="#id8">2. 启动各个栈节点</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>· 启动redis-Master容器节点
· 两个redis-Slave容器节点启动时链接到redis-master
· 两个APP容器节点启动时链接到redis-master
· HAProxy容器节点启动时链接到两个APP节点
· 说明：为了能够从外网访问应用栈，并通过HAProxy节点访问应用栈中的APP，启动HAProxy节点时必须使用 -p参数将端口暴露给主机
</pre></div>
</div>
<p>启动Redis容器（创建容器）</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">it</span> <span class="o">--</span><span class="n">name</span> <span class="n">redis</span><span class="o">-</span><span class="n">master</span> <span class="n">redis</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">it</span> <span class="o">--</span><span class="n">name</span> <span class="n">redis</span><span class="o">-</span><span class="n">slave1</span> <span class="o">--</span><span class="n">link</span> <span class="n">redis</span><span class="o">-</span><span class="n">master</span><span class="p">:</span><span class="n">master</span> <span class="n">redis</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">it</span> <span class="o">--</span><span class="n">name</span> <span class="n">redis</span><span class="o">-</span><span class="n">slave2</span> <span class="o">--</span><span class="n">link</span> <span class="n">redis</span><span class="o">-</span><span class="n">master</span><span class="p">:</span><span class="n">master</span> <span class="n">redis</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
</pre></div>
</div>
<p>· 说明：启动之后不要exit退出，使用ctrl+p,ctrl+q退出，（容器不关闭）</p>
<p>查看已启动的容器 docker ps</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@docker</span><span class="o">-</span><span class="n">test</span> <span class="n">centos</span><span class="p">]</span><span class="c1"># docker ps</span>
<span class="n">CONTAINER</span> <span class="n">ID</span>        <span class="n">IMAGE</span>               <span class="n">COMMAND</span>                  <span class="n">CREATED</span>              <span class="n">STATUS</span>              <span class="n">PORTS</span>               <span class="n">NAMES</span>
<span class="mi">7033</span><span class="n">abd05eed</span>        <span class="n">redis</span>               <span class="s2">&quot;docker-entrypoint...&quot;</span>   <span class="mi">38</span> <span class="n">seconds</span> <span class="n">ago</span>       <span class="n">Up</span> <span class="mi">37</span> <span class="n">seconds</span>       <span class="mi">6379</span><span class="o">/</span><span class="n">tcp</span>            <span class="n">redis</span><span class="o">-</span><span class="n">slave2</span>
<span class="mf">6e8923271</span><span class="n">c96</span>        <span class="n">redis</span>               <span class="s2">&quot;docker-entrypoint...&quot;</span>   <span class="n">About</span> <span class="n">a</span> <span class="n">minute</span> <span class="n">ago</span>   <span class="n">Up</span> <span class="n">About</span> <span class="n">a</span> <span class="n">minute</span>   <span class="mi">6379</span><span class="o">/</span><span class="n">tcp</span>            <span class="n">redis</span><span class="o">-</span><span class="n">slave1</span>
<span class="mi">301</span><span class="n">c0e670ab2</span>        <span class="n">redis</span>               <span class="s2">&quot;docker-entrypoint...&quot;</span>   <span class="n">About</span> <span class="n">a</span> <span class="n">minute</span> <span class="n">ago</span>   <span class="n">Up</span> <span class="n">About</span> <span class="n">a</span> <span class="n">minute</span>   <span class="mi">6379</span><span class="o">/</span><span class="n">tcp</span>            <span class="n">redis</span><span class="o">-</span><span class="n">master</span>
</pre></div>
</div>
<p>启动Django容器</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">it</span> <span class="o">--</span><span class="n">name</span> <span class="n">APP1</span> <span class="o">--</span><span class="n">link</span> <span class="n">redis</span><span class="o">-</span><span class="n">master</span><span class="p">:</span><span class="n">db</span> <span class="o">-</span><span class="n">v</span> <span class="o">~/</span><span class="n">Projects</span><span class="o">/</span><span class="n">Django</span><span class="o">/</span><span class="n">APP1</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">app</span> <span class="n">django</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">it</span> <span class="o">--</span><span class="n">name</span> <span class="n">APP2</span> <span class="o">--</span><span class="n">link</span> <span class="n">redis</span><span class="o">-</span><span class="n">master</span><span class="p">:</span><span class="n">db</span> <span class="o">-</span><span class="n">v</span> <span class="o">~/</span><span class="n">Projects</span><span class="o">/</span><span class="n">Django</span><span class="o">/</span><span class="n">APP2</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">app</span> <span class="n">django</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>

<span class="n">root</span><span class="nd">@b9032e85813f</span><span class="p">:</span><span class="o">/</span><span class="c1"># [root@docker-test centos]# docker ps</span>
<span class="n">CONTAINER</span> <span class="n">ID</span>        <span class="n">IMAGE</span>               <span class="n">COMMAND</span>                  <span class="n">CREATED</span>              <span class="n">STATUS</span>              <span class="n">PORTS</span>               <span class="n">NAMES</span>
<span class="n">b9032e85813f</span>        <span class="n">django</span>              <span class="s2">&quot;/bin/bash&quot;</span>              <span class="mi">46</span> <span class="n">seconds</span> <span class="n">ago</span>       <span class="n">Up</span> <span class="mi">45</span> <span class="n">seconds</span>                           <span class="n">APP2</span>
<span class="mi">91</span><span class="n">df41a13751</span>        <span class="n">django</span>              <span class="s2">&quot;/bin/bash&quot;</span>              <span class="n">About</span> <span class="n">a</span> <span class="n">minute</span> <span class="n">ago</span>   <span class="n">Up</span> <span class="n">About</span> <span class="n">a</span> <span class="n">minute</span>                       <span class="n">APP1</span>
<span class="mi">7033</span><span class="n">abd05eed</span>        <span class="n">redis</span>               <span class="s2">&quot;docker-entrypoint...&quot;</span>   <span class="mi">2</span> <span class="n">minutes</span> <span class="n">ago</span>        <span class="n">Up</span> <span class="mi">2</span> <span class="n">minutes</span>        <span class="mi">6379</span><span class="o">/</span><span class="n">tcp</span>            <span class="n">redis</span><span class="o">-</span><span class="n">slave2</span>
<span class="mf">6e8923271</span><span class="n">c96</span>        <span class="n">redis</span>               <span class="s2">&quot;docker-entrypoint...&quot;</span>   <span class="mi">3</span> <span class="n">minutes</span> <span class="n">ago</span>        <span class="n">Up</span> <span class="mi">3</span> <span class="n">minutes</span>        <span class="mi">6379</span><span class="o">/</span><span class="n">tcp</span>            <span class="n">redis</span><span class="o">-</span><span class="n">slave1</span>
<span class="mi">301</span><span class="n">c0e670ab2</span>        <span class="n">redis</span>               <span class="s2">&quot;docker-entrypoint...&quot;</span>   <span class="mi">3</span> <span class="n">minutes</span> <span class="n">ago</span>        <span class="n">Up</span> <span class="mi">3</span> <span class="n">minutes</span>        <span class="mi">6379</span><span class="o">/</span><span class="n">tcp</span>            <span class="n">redis</span><span class="o">-</span><span class="n">master</span>
</pre></div>
</div>
<p>启动HAProxy容器</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>docker run -it --name HAProxy --link APP1:APP1 --link APP2:APP2 -p 6301:6301 -v ~/Projects/HAProxy:/tmp haproxy /bin/bash

每个容器启动时都分配了一个终端，在 /bin/bash下
所有容器信息如下：

[root@docker-test centos]# docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS                    NAMES
0971025923a2        haproxy             &quot;/docker-entrypoin...&quot;   21 seconds ago       Up 20 seconds       0.0.0.0:6301-&gt;6301/tcp   HAProxy
b9032e85813f        django              &quot;/bin/bash&quot;              About a minute ago   Up About a minute                            APP2
91df41a13751        django              &quot;/bin/bash&quot;              2 minutes ago        Up 2 minutes                                 APP1
7033abd05eed        redis               &quot;docker-entrypoint...&quot;   3 minutes ago        Up 3 minutes        6379/tcp                 redis-slave2
6e8923271c96        redis               &quot;docker-entrypoint...&quot;   4 minutes ago        Up 4 minutes        6379/tcp                 redis-slave1
301c0e670ab2        redis               &quot;docker-entrypoint...&quot;   4 minutes ago        Up 4 minutes        6379/tcp                 redis-master
</pre></div>
</div>
</section>
<section id="id3">
<h2><a class="toc-backref" href="#id9">3.应用栈容器节点配置</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>volume应用说明</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>· 在应用栈的个容器节点都启动后，需要对他们进行配置和修改，以便使他们实现特定功能和通信协作，在linux系统下，可以利用volume来实现文件的创建（利用-v 参数挂载volume,在主机和容器间共享数据，这样就可以直接在主机上创建和编辑相关启动配置文件）
· 查看volume挂载情况 docker inspect -f&#39;{{.Mounts}}&#39;+容器名或id
· 示例:docker inspect -format&#39;{{.Mounts}}&#39; redis-master
· 显示出来的为


[root@docker-test centos]# docker inspect -f&#39;{{.Mounts}}&#39; redis-master
[{volume 21965b817d218f079101e22b7ed7bd33a53f32dbafeebb343d433fc28215aa5d /var/lib/docker/volumes/21965b817d218f079101e22b7ed7bd33a53f32dbafeebb343d433
fc28215aa5d/_data /data local  true }]
</pre></div>
</div>
<p>· 可以看出，redis-master的volume
在宿主机上为目录/var/lib/docker/volumes/5920a23b5e230a449230bbd4807912793bbc3bab0a05ae085ff95423301f0d6c/_data，在容器中为/data
  · 在宿主机上创建redis的启动配置文件redis.conf</p>
<section id="redis-master">
<h3><a class="toc-backref" href="#id10">Redis Master配置</a><a class="headerlink" href="#redis-master" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 是否作为守护进程运行，生产环境用yes</span>
<span class="n">daemonize</span> <span class="n">yes</span>

<span class="c1"># 如果作为守护进程运行的话，redis会把pid打印到这个文件</span>
<span class="c1"># 主要多实例的时候需要写成不同的文件</span>
<span class="n">pidfile</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">redis</span><span class="o">.</span><span class="n">pid</span>

<span class="c1"># redis监听的端口，注意多实例的情况</span>
<span class="n">port</span> <span class="mi">6379</span>

<span class="c1"># 允许访问redis的ip</span>
<span class="c1"># 测试环境注释该选项，生产环境把所有允许访问的ip都打一次</span>
<span class="c1"># bind xxx.xxx.xxx.xxx</span>

<span class="c1"># 关闭无消息的客户端的间隔，0为关闭该功能</span>
<span class="n">timeout</span> <span class="mi">0</span>

<span class="c1"># 对客户端发送ACK信息，linux中单位为秒</span>
<span class="n">tcp</span><span class="o">-</span><span class="n">keepalive</span> <span class="mi">0</span>

<span class="c1"># 数据库的数量，我们的游戏建议为1，然后多开实例</span>
<span class="n">databases</span> <span class="mi">1</span>

<span class="c1">################################################################################</span>
<span class="c1">#                              redis 的持久化配置                                #</span>
<span class="c1">################################################################################</span>

<span class="c1"># save 间隔 最小更新操作</span>
<span class="c1"># 900秒（15分钟）之后，且至少1次变更</span>
<span class="c1"># 300秒（5分钟）之后，且至少10次变更</span>
<span class="c1"># 60秒之后，且至少10000次变更</span>
<span class="c1"># 如果完全作为缓存开启把save全删了</span>

<span class="c1"># save 900 1</span>
<span class="c1"># save 300 10</span>
<span class="c1"># save 60 2000</span>

<span class="c1"># 持久化失败以后，redis是否停止</span>
<span class="n">stop</span><span class="o">-</span><span class="n">writes</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">bgsave</span><span class="o">-</span><span class="n">error</span> <span class="n">no</span>

<span class="c1"># 持久化的时候是否运行对字符串对象进行压缩，算法为LZF</span>
<span class="n">rdbcompression</span> <span class="n">yes</span>

<span class="c1"># 文件末尾是否包含一个CRC64的校验和</span>
<span class="n">rdbchecksum</span> <span class="n">yes</span>

<span class="c1"># 是否开启主从同步</span>
<span class="c1"># slaveof master 6379</span>
<span class="c1"># redis存储数据的文件，注意多实例的时候该不同名字或者用不同的工作目录</span>
<span class="n">dbfilename</span> <span class="n">dump</span><span class="o">.</span><span class="n">rdb</span>

<span class="c1"># redis的工作目录，注意多实例的时候该不同名字或者用不同的工作目录</span>
<span class="c1"># 建议用不同的工作目录</span>
<span class="c1">#唐永光改这里改了好多次</span>
<span class="nb">dir</span> <span class="o">./</span>


<span class="c1">################################################################################</span>
<span class="c1">#                                 redis 的限制                                  #</span>
<span class="c1">################################################################################</span>


<span class="n">maxmemory</span> <span class="mi">2</span><span class="n">gb</span>



<span class="n">maxmemory</span><span class="o">-</span><span class="n">policy</span> <span class="n">allkeys</span><span class="o">-</span><span class="n">lru</span>

<span class="c1"># LRU和最小TTL算法的实现都不是很精确，但是很接近（为了省内存），所以你可以用样例做测试。</span>
<span class="c1"># 例如：默认Redis会检查三个key然后取最旧的那个，你可以通过下面的配置项来设置样本的个数。</span>
<span class="c1">#</span>
<span class="c1"># maxmemory-samples 3</span>

<span class="c1">################################################################################</span>
<span class="c1">#                               redis 的累加模式                                 #</span>
<span class="c1">################################################################################</span>

<span class="c1"># 默认情况下，Redis是异步的把数据导出到磁盘上。这种情况下，当Redis挂掉的时候，最新的数据就丢了。</span>
<span class="c1"># 如果不希望丢掉任何一条数据的话就该用纯累加模式：一旦开启这个模式，Redis会把每次写入的数据在接收</span>
<span class="c1"># 后都写入 appendonly.aof 文件。</span>
<span class="c1"># 每次启动时Redis都会把这个文件的数据读入内存里。</span>
<span class="c1">#</span>
<span class="c1"># 注意，异步导出的数据库文件和纯累加文件可以并存（你得把上面所有&quot;save&quot;设置都注释掉，关掉导出机制）。</span>
<span class="c1"># 如果纯累加模式开启了，那么Redis会在启动时载入日志文件而忽略导出的 dump.rdb 文件。</span>
<span class="c1">#</span>
<span class="c1"># 重要：查看 BGREWRITEAOF 来了解当累加日志文件太大了之后，怎么在后台重新处理这个日志文件。</span>
<span class="n">appendonly</span> <span class="n">no</span>

<span class="c1"># 纯累加文件名字（默认：&quot;appendonly.aof&quot;）</span>
<span class="c1"># appendfilename appendonly.aof</span>

<span class="c1"># 纯累加文件的flush频率</span>
<span class="c1"># always    -&gt;  每次写入都flush，最安全，资源开销最大</span>
<span class="c1"># everysec  -&gt;  每秒 (推荐)</span>
<span class="c1"># no        -&gt;  由系统确定</span>

<span class="c1"># appendfsync always</span>
<span class="n">appendfsync</span> <span class="n">everysec</span>


<span class="c1">################################################################################</span>
<span class="c1">#                                redis 的高级配置                                #</span>
<span class="c1">################################################################################</span>

<span class="c1"># 如果hash中的数量超出hash-max-ziplist-entries，或者value的长度超出</span>
<span class="c1"># hash-max-ziplist-value，将改成保存dict，否则以ziphash的方式存储以节省空间。以下同理。</span>
<span class="nb">hash</span><span class="o">-</span><span class="nb">max</span><span class="o">-</span><span class="n">ziplist</span><span class="o">-</span><span class="n">entries</span> <span class="mi">64</span>
<span class="nb">hash</span><span class="o">-</span><span class="nb">max</span><span class="o">-</span><span class="n">ziplist</span><span class="o">-</span><span class="n">value</span> <span class="mi">128</span>

<span class="nb">list</span><span class="o">-</span><span class="nb">max</span><span class="o">-</span><span class="n">ziplist</span><span class="o">-</span><span class="n">entries</span> <span class="mi">64</span>
<span class="nb">list</span><span class="o">-</span><span class="nb">max</span><span class="o">-</span><span class="n">ziplist</span><span class="o">-</span><span class="n">value</span> <span class="mi">128</span>

<span class="nb">set</span><span class="o">-</span><span class="nb">max</span><span class="o">-</span><span class="n">intset</span><span class="o">-</span><span class="n">entries</span> <span class="mi">64</span>

<span class="n">zset</span><span class="o">-</span><span class="nb">max</span><span class="o">-</span><span class="n">ziplist</span><span class="o">-</span><span class="n">entries</span> <span class="mi">64</span>
<span class="n">zset</span><span class="o">-</span><span class="nb">max</span><span class="o">-</span><span class="n">ziplist</span><span class="o">-</span><span class="n">value</span> <span class="mi">128</span>

<span class="c1"># 是否resize hash? 如果你设置成no需要在源码做一定的修改以防止有人进行hash攻击</span>
<span class="n">activerehashing</span> <span class="n">yes</span>

<span class="c1">################################################################################</span>
<span class="c1">#                              redis 的其他配置文件                               #</span>
<span class="c1">################################################################################</span>

<span class="c1"># 日志配置</span>
<span class="c1"># include /etc/redis/log.conf</span>

<span class="c1"># 主从配置</span>
<span class="c1"># include /etc/redis/slave.conf</span>

<span class="c1"># 安全配置</span>
<span class="c1"># include /etc/redis/security.conf</span>

<span class="c1"># LUA配置</span>
<span class="c1"># include /etc/redis/lua.conf</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>· 容器启动之后，执行进入容器内部 docker attach 容器名称或id
· 容器没启动，执行直接进入容器终端docker exec -it redis-master /bin/bash
· 进入到容器内部的共享目录/data下执行 cp redis.conf /usr/local/bin
· 进入容器工作目录 cd /usr/local/bin可ls查看有没有相关的redis.conf文件
· 启动redis : redis-server redis.conf
· 退出大多用ctrl+p+q或exit
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@docker</span><span class="o">-</span><span class="n">test</span> <span class="n">_data</span><span class="p">]</span><span class="c1"># docker attach 301c0</span>
<span class="n">root</span><span class="o">@</span><span class="mi">301</span><span class="n">c0e670ab2</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="c1"># cd /data/</span>
<span class="n">root</span><span class="o">@</span><span class="mi">301</span><span class="n">c0e670ab2</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="c1"># cp redis.conf /usr/local/bin</span>
<span class="n">root</span><span class="o">@</span><span class="mi">301</span><span class="n">c0e670ab2</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="c1"># ls</span>
<span class="n">docker</span><span class="o">-</span><span class="n">entrypoint</span><span class="o">.</span><span class="n">sh</span>  <span class="n">gosu</span>  <span class="n">redis</span><span class="o">-</span><span class="n">benchmark</span>  <span class="n">redis</span><span class="o">-</span><span class="n">check</span><span class="o">-</span><span class="n">aof</span>  <span class="n">redis</span><span class="o">-</span><span class="n">check</span><span class="o">-</span><span class="n">rdb</span>  <span class="n">redis</span><span class="o">-</span><span class="n">cli</span>  <span class="n">redis</span><span class="o">-</span><span class="n">sentinel</span>  <span class="n">redis</span><span class="o">-</span><span class="n">server</span>  <span class="n">redis</span><span class="o">.</span><span class="n">conf</span>

<span class="n">root</span><span class="o">@</span><span class="mi">301</span><span class="n">c0e670ab2</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="c1"># redis-server redis.conf</span>
<span class="mi">32</span><span class="p">:</span><span class="n">C</span> <span class="mi">09</span> <span class="n">Jan</span> <span class="mi">2020</span> <span class="mi">03</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mf">02.699</span> <span class="c1"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span>
<span class="mi">32</span><span class="p">:</span><span class="n">C</span> <span class="mi">09</span> <span class="n">Jan</span> <span class="mi">2020</span> <span class="mi">03</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mf">02.700</span> <span class="c1"># Redis version=5.0.7, bits=64, commit=00000000, modified=0, pid=32, just started</span>
<span class="mi">32</span><span class="p">:</span><span class="n">C</span> <span class="mi">09</span> <span class="n">Jan</span> <span class="mi">2020</span> <span class="mi">03</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mf">02.700</span> <span class="c1"># Configuration loaded</span>
</pre></div>
</div>
<p>说明1：redis-master数据库节点只要redis-conf文件配置对，放在共享目录里，就不需要在主机里执行cp操作，只有进入容器中才用得到cp操作</p>
<p>说明2： 说明：配置文件里需要修改的是 daemonize yes
注意是将no修改为yes，使Redis在容器前端运行，在前端运行时无法进行其他操作，可以再开一个终端
。 pidfile /var/run/redis.pid</p>
<section id="redis-slave1redis-slave">
<h4>Redis slave1和redis slave从数据库容器节点配置<a class="headerlink" href="#redis-slave1redis-slave" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>redisslave从数据库容器节点配置与主数据库配置类似，先 docker inspect -f&#39;{{.Mounts}}&#39;+容器名或id 查看volume中主机与容器之间的共享位置是什么，然后再进入主机上的容器共享数据位置创建启动配置文件redis.conf
</pre></div>
</div>
<p>· 查看redis-slave1在主机上的共享目录位置</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">inspect</span> <span class="o">-</span><span class="n">f</span> <span class="s1">&#39;{{.Mounts}}&#39;</span> <span class="n">redis</span><span class="o">-</span><span class="n">slave1</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>· 进入共享目录位置cd /var/lib/docker/volumes/ee46cfb08cd17109f0b723f2171ab70808a4add91fa94b017b5e5c85959b031c/_data
· 创建从数据库配置文件vim redis.conf（配置文件里的内容为主数据库里的内容）
· 修改配置1：daemonize yes 注意是将no修改为yes，使Redis在容器前端运行，在前端运行时无法进行其他操作，可以再开一个终端。
· 修改配置2：pidfile /var/run/redis.pid
· 修改配置3：slaveof master 6379（文件中没有，自己添加进去）
· 进入redis-slave1容器终端docker attach redis-slave1
· 将redis.conf文件cp到容器的执行目录cp redis.conf /usr/local/bin
· 进入到 cd /usr/local/bin
· 执行redis-slave1启动命令redis-server redis.conf
</pre></div>
</div>
<p>· 此时可以查看redis-slave1中的信息 redis-cli</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="o">@</span><span class="mf">6e8923271</span><span class="n">c96</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="c1"># redis-cli info</span>
<span class="c1"># Server</span>
<span class="n">redis_version</span><span class="p">:</span><span class="mf">5.0</span><span class="o">.</span><span class="mi">7</span>
<span class="o">.......</span>
<span class="c1"># Replication</span>
<span class="n">role</span><span class="p">:</span><span class="n">slave</span>
<span class="n">master_host</span><span class="p">:</span><span class="n">master</span>
<span class="n">master_port</span><span class="p">:</span><span class="mi">6379</span>
</pre></div>
</div>
</section>
<section id="id4">
<h4>主数据库容器节点测试<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>· 进入redis-master主容器节点存储数据 docker exec -it redis-master /bin/bash
· redis-cli
· set master test#存数据
· get master#查看数据
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[root@docker-test _data]# docker exec -it redis-master /bin/bash
root@301c0e670ab2:/data# redis-cli
127.0.0.1:6379&gt; set master test
OK
127.0.0.1:6379&gt; get master
&quot;test&quot;



[root@docker-test _data]# docker exec -it redis-slave1 /bin/bash
root@6e8923271c96:/data# redis-cli
127.0.0.1:6379&gt; get master
&quot;test&quot;


此时主数据库存的数据，从数据库已经同步到了!
</pre></div>
</div>
<p>redis-slave2的配置同上</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@docker</span><span class="o">-</span><span class="n">test</span> <span class="n">_data</span><span class="p">]</span><span class="c1"># docker attach redis-slave2</span>
<span class="n">root</span><span class="o">@</span><span class="mi">7033</span><span class="n">abd05eed</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="c1"># ls</span>
<span class="n">redis</span><span class="o">.</span><span class="n">conf</span>
<span class="n">root</span><span class="o">@</span><span class="mi">7033</span><span class="n">abd05eed</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="c1"># cp redis.conf /usr/local/bin/</span>
<span class="n">root</span><span class="o">@</span><span class="mi">7033</span><span class="n">abd05eed</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="c1"># cd /usr/local/bin/</span>
<span class="n">root</span><span class="o">@</span><span class="mi">7033</span><span class="n">abd05eed</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="c1"># redis-server redis.conf</span>
<span class="mi">10</span><span class="p">:</span><span class="n">C</span> <span class="mi">09</span> <span class="n">Jan</span> <span class="mi">2020</span> <span class="mi">03</span><span class="p">:</span><span class="mi">08</span><span class="p">:</span><span class="mf">59.145</span> <span class="c1"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span>
<span class="mi">10</span><span class="p">:</span><span class="n">C</span> <span class="mi">09</span> <span class="n">Jan</span> <span class="mi">2020</span> <span class="mi">03</span><span class="p">:</span><span class="mi">08</span><span class="p">:</span><span class="mf">59.145</span> <span class="c1"># Redis version=5.0.7, bits=64, commit=00000000, modified=0, pid=10, just started</span>
<span class="mi">10</span><span class="p">:</span><span class="n">C</span> <span class="mi">09</span> <span class="n">Jan</span> <span class="mi">2020</span> <span class="mi">03</span><span class="p">:</span><span class="mi">08</span><span class="p">:</span><span class="mf">59.145</span> <span class="c1"># Configuration loaded</span>
<span class="n">root</span><span class="o">@</span><span class="mi">7033</span><span class="n">abd05eed</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="c1">#</span>
<span class="n">root</span><span class="o">@</span><span class="mi">7033</span><span class="n">abd05eed</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="c1"># redis-cli info</span>
<span class="c1"># Server</span>
<span class="n">redis_version</span><span class="p">:</span><span class="mf">5.0</span><span class="o">.</span><span class="mi">7</span>
<span class="n">redis_git_sha1</span><span class="p">:</span><span class="mi">00000000</span>
<span class="n">redis_git_dirty</span><span class="p">:</span><span class="mi">0</span>
<span class="o">......</span>

<span class="c1"># Replication</span>
<span class="n">role</span><span class="p">:</span><span class="n">slave</span>
<span class="n">master_host</span><span class="p">:</span><span class="n">master</span>
<span class="n">master_port</span><span class="p">:</span><span class="mi">6379</span>
</pre></div>
</div>
</section>
</section>
<section id="app-django">
<h3><a class="toc-backref" href="#id11">APP容器节点（Django）的配置</a><a class="headerlink" href="#app-django" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>· Django容器启动后，需要利用Django框架，开发一个简单的Web程序。为了访问数据库，需要在容器中安装Python的Redis支持包
· 进入Django容器内部docker exec -it APP1 /bin/bash
· 更新匹配并安装Python语言的Redis支持包:
· pip install --upgrade pip
· pip install redis
测试是否安装成功（分部执行）

&gt;&gt;&gt; import redis
&gt;&gt;&gt; print(redis.__file__)
/usr/local/lib/python3.4/site-packages/redis/__init__.py
&gt;&gt;&gt; exit()
</pre></div>
</div>
<p>创建APP</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>在容器中操作APP1
在容器的volume目录/usr/src/app下，执行 如下命令
临时关闭selinux
setenforce 0

· cd /usr/src/app/
· mkdir dockerweb
· cd dockerweb
· django-admin.py startproject redisweb
· cd redisweb
· python manage.py startapp helloworld
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>在容器中创建APP后，切换到宿主机的volume目录~/Projects/Django/App1下：
cd ~/Projects/Django/APP1
cd dockerweb/redisweb/helloworld/
ls
</pre></div>
</div>
<p>修改vim views.py内容如下（此views.py内容为APP11里的内容）</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@docker</span><span class="o">-</span><span class="n">test</span> <span class="n">helloworld</span><span class="p">]</span><span class="c1"># cat views.py</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>

<span class="c1"># Create your views here.</span>
<span class="kn">import</span> <span class="nn">redis</span>


<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">red</span> <span class="o">=</span> <span class="s1">&#39;APP1&lt;br&gt;Redis数据库记录：&lt;br&gt;&lt;table border=&quot;1&quot;&gt;&#39;</span>

    <span class="c1"># 如果设置过Redis密码请在参数中加上password=&#39;你的密码&#39;,</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">ConnectionPool</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">connection_pool</span><span class="o">=</span><span class="n">pool</span><span class="p">)</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">pipeline</span><span class="p">()</span>
    <span class="n">pipe_size</span> <span class="o">=</span> <span class="mi">100000</span>

    <span class="nb">len</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">key_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nb">print</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">pipeline</span><span class="p">())</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="n">key_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">pipe</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span> <span class="o">&lt;</span> <span class="n">pipe_size</span><span class="p">:</span>
            <span class="nb">len</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">key_list</span><span class="p">,</span> <span class="n">pipe</span><span class="o">.</span><span class="n">execute</span><span class="p">()):</span>
                <span class="nb">print</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">len</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">key_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">key_list</span><span class="p">,</span> <span class="n">pipe</span><span class="o">.</span><span class="n">execute</span><span class="p">()):</span>
        <span class="n">red</span> <span class="o">=</span> <span class="n">red</span> <span class="o">+</span> <span class="s1">&#39;&lt;tr&gt;&lt;td&gt;</span><span class="si">%s</span><span class="s1">&lt;/td&gt;&lt;td&gt;</span><span class="si">%s</span><span class="s1">&lt;/td&gt;&lt;/tr&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">v</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>

    <span class="n">red</span> <span class="o">=</span> <span class="n">red</span> <span class="o">+</span> <span class="s1">&#39;&lt;/table&gt;&#39;</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">red</span><span class="p">)</span>
</pre></div>
</div>
<p>此views.py为APP2的内容：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#APP2的内容</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>

<span class="c1"># Create your views here.</span>
<span class="kn">import</span> <span class="nn">redis</span>

<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">requset</span><span class="p">):</span>
    <span class="nb">str</span><span class="o">=</span><span class="n">redis</span><span class="o">.</span><span class="vm">__file__</span>
    <span class="nb">str</span><span class="o">+=</span><span class="s2">&quot;&lt;br&gt;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
    <span class="nb">str</span><span class="o">+=</span><span class="p">(</span><span class="s2">&quot;Set Hi &lt;br&gt;&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;Hi&#39;</span><span class="p">,</span> <span class="s1">&#39;HelloWorld-APP1&#39;</span><span class="p">)</span>
    <span class="nb">str</span><span class="o">+=</span><span class="p">(</span><span class="s2">&quot;Get Hi: </span><span class="si">%s</span><span class="s2"> &lt;br&gt;&quot;</span> <span class="o">%</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Hi&#39;</span><span class="p">))</span>
    <span class="nb">str</span><span class="o">+=</span><span class="p">(</span><span class="s2">&quot;Redis Info: &lt;br&gt;&quot;</span><span class="p">)</span>
    <span class="nb">str</span><span class="o">+=</span><span class="p">(</span><span class="s2">&quot;Key: Info Value&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
        <span class="nb">str</span><span class="o">+=</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&lt;br&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</pre></div>
</div>
<p>·
注意，连接Redis数据库时，使用–link参数创建db连接来代替具体的IP地址；同理，对于APP2，使用想要的db连接即可。</p>
<p>· 接下来，修改redisweb项目的配置文件vim
settings.py，添加新建的helloworld应用：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># cd ../redisweb
# ls
__init__.py  __pycache__  settings.py  urls.py  wsgi.py
# vim settings.py

在settings.py文件中的INSTALLED_APPS选项下添加helloworld， 将ALLOWED_HOSTS = []修改为ALLOWED_HOSTS = [&#39;*&#39;] ：


# Application definition
ALLOWED_HOSTS = [&quot;*&quot;]

INSTALLED_APPS = [
    &#39;django.contrib.admin&#39;,
    &#39;django.contrib.auth&#39;,
    &#39;django.contrib.contenttypes&#39;,
    &#39;django.contrib.sessions&#39;,
    &#39;django.contrib.messages&#39;,
    &#39;django.contrib.staticfiles&#39;,
    &#39;helloworld&#39;,
]
</pre></div>
</div>
<p>·最后，修改同目录下的redisweb项目的模板文件urls.py，它将设置访问应用的URL模式，并为URL模式调用的视图函数之间的映射表：
vim urls.py</p>
<p>·
在url.py文件中，引入helloworld应用的hello视图，并为hello视图添加一个urlpatterns变量。修改后的urls.py文件如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@docker</span><span class="o">-</span><span class="n">test</span> <span class="n">redisweb</span><span class="p">]</span><span class="c1"># cat urls.py</span>
<span class="sd">&quot;&quot;&quot;redisweb URL Configuration</span>

<span class="sd">The `urlpatterns` list routes URLs to views. For more information please see:</span>
<span class="sd">    https://docs.djangoproject.com/en/1.10/topics/http/urls/</span>
<span class="sd">Examples:</span>
<span class="sd">Function views</span>
<span class="sd">    1. Add an import:  from my_app import views</span>
<span class="sd">    2. Add a URL to urlpatterns:  url(r&#39;^$&#39;, views.home, name=&#39;home&#39;)</span>
<span class="sd">Class-based views</span>
<span class="sd">    1. Add an import:  from other_app.views import Home</span>
<span class="sd">    2. Add a URL to urlpatterns:  url(r&#39;^$&#39;, Home.as_view(), name=&#39;home&#39;)</span>
<span class="sd">Including another URLconf</span>
<span class="sd">    1. Import the include() function: from django.conf.urls import url, include</span>
<span class="sd">    2. Add a URL to urlpatterns:  url(r&#39;^blog/&#39;, include(&#39;blog.urls&#39;))</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^helloworld$/&#39;</span><span class="p">,</span> <span class="n">hello</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
<p>·在容器的主机修改完这几个文件之后再进入容器，在目录/usr/src/app/dockerweb/redisweb下完成项目的生成：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># docker exec -it APP1 /bin/bash</span>
<span class="c1"># cd /usr/src/app/dockerweb/redisweb/</span>
<span class="c1"># python manage.py makemigrations</span>
<span class="c1"># python manage.py migrate</span>


<span class="n">root</span><span class="o">@</span><span class="mi">34</span><span class="n">f153ac72a3</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">dockerweb</span><span class="o">/</span><span class="n">redisweb</span><span class="c1"># python manage.py migrate</span>
<span class="n">Operations</span> <span class="n">to</span> <span class="n">perform</span><span class="p">:</span>
  <span class="n">Apply</span> <span class="nb">all</span> <span class="n">migrations</span><span class="p">:</span> <span class="n">admin</span><span class="p">,</span> <span class="n">auth</span><span class="p">,</span> <span class="n">contenttypes</span><span class="p">,</span> <span class="n">sessions</span>
<span class="n">Running</span> <span class="n">migrations</span><span class="p">:</span>
  <span class="n">Applying</span> <span class="n">contenttypes</span><span class="o">.</span><span class="mi">0001</span><span class="n">_initial</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">auth</span><span class="o">.</span><span class="mi">0001</span><span class="n">_initial</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">admin</span><span class="o">.</span><span class="mi">0001</span><span class="n">_initial</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">admin</span><span class="o">.</span><span class="mi">0002</span><span class="n">_logentry_remove_auto_add</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">contenttypes</span><span class="o">.</span><span class="mi">0002</span><span class="n">_remove_content_type_name</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">auth</span><span class="o">.</span><span class="mi">0002</span><span class="n">_alter_permission_name_max_length</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">auth</span><span class="o">.</span><span class="mi">0003</span><span class="n">_alter_user_email_max_length</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">auth</span><span class="o">.</span><span class="mi">0004</span><span class="n">_alter_user_username_opts</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">auth</span><span class="o">.</span><span class="mi">0005</span><span class="n">_alter_user_last_login_null</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">auth</span><span class="o">.</span><span class="mi">0006</span><span class="n">_require_contenttypes_0002</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">auth</span><span class="o">.</span><span class="mi">0007</span><span class="n">_alter_validators_add_error_messages</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">auth</span><span class="o">.</span><span class="mi">0008</span><span class="n">_alter_user_username_max_length</span><span class="o">...</span> <span class="n">OK</span>
  <span class="n">Applying</span> <span class="n">sessions</span><span class="o">.</span><span class="mi">0001</span><span class="n">_initial</span><span class="o">...</span> <span class="n">OK</span>
</pre></div>
</div>
<p>· APP1容器的配置已经完成，同理配置APP2。至此应用栈APP节点配置完成。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>app2上也要安装
· pip install --upgrade pip
· pip install redis
</pre></div>
</div>
<p>容器节点（Django）的配置的说明：创建配置文件是在容器内，但文件的配置是在主机上，编译运行又是在各个容器中各自进行</p>
<p>启动APP1和APP2</p>
<p>在启动App的Web服务器时，可以指定服务器的端口和IP地址。
为了通过HAProxy容器节点接受外网所有的公共IP地址访问，实现均衡负载，需要指定服务器的IP地址和端口。</p>
<p>对App1使用8001端口，App2使用8002端口，同时，都是用0.0.0.0地址。
启动服务器的过程如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@docker</span><span class="o">-</span><span class="n">test</span> <span class="n">redisweb</span><span class="p">]</span><span class="c1"># docker exec -it APP1 /bin/bash</span>
<span class="n">root</span><span class="o">@</span><span class="mi">34</span><span class="n">f153ac72a3</span><span class="p">:</span><span class="o">/</span><span class="c1"># cd /usr/src/app/dockerweb/redisweb/</span>
<span class="n">root</span><span class="o">@</span><span class="mi">34</span><span class="n">f153ac72a3</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">dockerweb</span><span class="o">/</span><span class="n">redisweb</span><span class="c1"># python manage.py runserver 0.0.0.0:8001</span>
<span class="n">Performing</span> <span class="n">system</span> <span class="n">checks</span><span class="o">...</span>

<span class="n">System</span> <span class="n">check</span> <span class="n">identified</span> <span class="n">no</span> <span class="n">issues</span> <span class="p">(</span><span class="mi">0</span> <span class="n">silenced</span><span class="p">)</span><span class="o">.</span>
<span class="n">January</span> <span class="mi">09</span><span class="p">,</span> <span class="mi">2020</span> <span class="o">-</span> <span class="mi">05</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">03</span>
<span class="n">Django</span> <span class="n">version</span> <span class="mf">1.10</span><span class="o">.</span><span class="mi">4</span><span class="p">,</span> <span class="n">using</span> <span class="n">settings</span> <span class="s1">&#39;redisweb.settings&#39;</span>
<span class="n">Starting</span> <span class="n">development</span> <span class="n">server</span> <span class="n">at</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">8001</span><span class="o">/</span>
<span class="n">Quit</span> <span class="n">the</span> <span class="n">server</span> <span class="k">with</span> <span class="n">CONTROL</span><span class="o">-</span><span class="n">C</span><span class="o">.</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@docker</span><span class="o">-</span><span class="n">test</span> <span class="n">redisweb</span><span class="p">]</span><span class="c1">#</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@docker</span><span class="o">-</span><span class="n">test</span> <span class="n">redisweb</span><span class="p">]</span><span class="c1">#</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@docker</span><span class="o">-</span><span class="n">test</span> <span class="n">redisweb</span><span class="p">]</span><span class="c1"># docker exec -it APP2 /bin/bash</span>
<span class="n">root</span><span class="o">@</span><span class="mi">93259</span><span class="n">a17e4f8</span><span class="p">:</span><span class="o">/</span><span class="c1"># cd /usr/src/app/dockerweb/redisweb/</span>
<span class="n">root</span><span class="o">@</span><span class="mi">93259</span><span class="n">a17e4f8</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">dockerweb</span><span class="o">/</span><span class="n">redisweb</span><span class="c1"># python manage.py runserver 0.0.0.0:8002</span>
<span class="n">Performing</span> <span class="n">system</span> <span class="n">checks</span><span class="o">...</span>

<span class="n">System</span> <span class="n">check</span> <span class="n">identified</span> <span class="n">no</span> <span class="n">issues</span> <span class="p">(</span><span class="mi">0</span> <span class="n">silenced</span><span class="p">)</span><span class="o">.</span>
<span class="n">January</span> <span class="mi">09</span><span class="p">,</span> <span class="mi">2020</span> <span class="o">-</span> <span class="mi">05</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">38</span>
<span class="n">Django</span> <span class="n">version</span> <span class="mf">1.10</span><span class="o">.</span><span class="mi">4</span><span class="p">,</span> <span class="n">using</span> <span class="n">settings</span> <span class="s1">&#39;redisweb.settings&#39;</span>
<span class="n">Starting</span> <span class="n">development</span> <span class="n">server</span> <span class="n">at</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">8002</span><span class="o">/</span>
<span class="n">Quit</span> <span class="n">the</span> <span class="n">server</span> <span class="k">with</span> <span class="n">CONTROL</span><span class="o">-</span><span class="n">C</span><span class="o">.</span>
</pre></div>
</div>
<p>至此，APP节点启动完毕更多app可按照上面配置。</p>
</section>
</section>
<section id="haproxy">
<h2><a class="toc-backref" href="#id12">4.Haproxy容器节点配置</a><a class="headerlink" href="#haproxy" title="Permalink to this headline">¶</a></h2>
<p>·
说明：所有对应用栈的访问均通过HAproxy负载均衡代理容器节点实现负载均衡，使外网能够访问到app节点</p>
<p>haproxy文件配置</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>· 启动时挂载的volume将HAproxy的启动配置文件复制到容器中，在宿主机的volumes目录~/Projects/HAProxy/下
· cd ~/Projects/HAProxy/
· vim haproxy.cfg（其中的代码如下）
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@docker</span><span class="o">-</span><span class="n">test</span> <span class="n">HAProxy</span><span class="p">]</span><span class="c1"># cat haproxy.cfg</span>
<span class="k">global</span>
    <span class="n">log</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>   <span class="n">local0</span>
    <span class="n">maxconn</span> <span class="mi">4096</span>
    <span class="n">chroot</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span>
    <span class="n">daemon</span>
    <span class="n">nbproc</span>  <span class="mi">4</span>
    <span class="n">pidfile</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">haproxy</span><span class="o">.</span><span class="n">pid</span>


<span class="n">defaults</span>
    <span class="n">log</span>     <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>   <span class="n">local3</span>
    <span class="n">mode</span>    <span class="n">http</span>
    <span class="n">option</span>  <span class="n">dontlognull</span>
    <span class="n">option</span>  <span class="n">redispatch</span>
    <span class="n">retries</span> <span class="mi">2</span>
    <span class="n">maxconn</span> <span class="mi">2000</span>
    <span class="n">balance</span> <span class="n">roundrobin</span>
    <span class="n">timeout</span> <span class="n">connect</span> <span class="mi">5000</span><span class="n">ms</span>
    <span class="n">timeout</span> <span class="n">client</span>  <span class="mi">50000</span><span class="n">ms</span>
    <span class="n">timeout</span> <span class="n">server</span>  <span class="mi">50000</span><span class="n">ms</span>

<span class="n">listen</span> <span class="n">redis_proxy</span>
    <span class="n">bind</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">6301</span>
    <span class="n">stats</span> <span class="n">enable</span>
    <span class="n">bind</span><span class="o">-</span><span class="n">process</span>    <span class="mi">2</span>            <span class="c1">#让它跑在两颗CPU上</span>
    <span class="n">stats</span> <span class="n">uri</span> <span class="o">/</span><span class="n">haproxy</span><span class="o">-</span><span class="n">stats</span>
    <span class="n">stats</span> <span class="n">auth</span> <span class="n">phil</span><span class="p">:</span><span class="n">NRG93012</span>
        <span class="n">server</span> <span class="n">APP1</span> <span class="n">APP1</span><span class="p">:</span><span class="mi">8001</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
        <span class="n">server</span> <span class="n">APP2</span> <span class="n">APP2</span><span class="p">:</span><span class="mi">8002</span> <span class="n">check</span> <span class="n">inter</span> <span class="mi">2000</span> <span class="n">rise</span> <span class="mi">2</span> <span class="n">fall</span> <span class="mi">5</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@docker</span><span class="o">-</span><span class="n">test</span> <span class="n">HAProxy</span><span class="p">]</span><span class="c1"># docker inspect -f &#39;{{.Mounts}}&#39; HAProxy</span>
<span class="p">[{</span><span class="n">bind</span>  <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">Projects</span><span class="o">/</span><span class="n">HAProxy</span> <span class="o">/</span><span class="n">tmp</span>   <span class="n">true</span> <span class="n">rprivate</span><span class="p">}]</span>
</pre></div>
</div>
<p>·
随后，进入容器的volume目录/tmp下，将Haproxy的启动配置文件复制到HAproxy的工作目录~/Projects/HAProxy/：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@docker</span><span class="o">-</span><span class="n">test</span> <span class="n">HAProxy</span><span class="p">]</span><span class="c1"># docker exec -it HAProxy /bin/bash</span>
<span class="n">root</span><span class="o">@</span><span class="mi">9</span><span class="n">ec53e72ee17</span><span class="p">:</span><span class="o">/</span><span class="c1"># cd tmp/</span>
<span class="n">root</span><span class="o">@</span><span class="mi">9</span><span class="n">ec53e72ee17</span><span class="p">:</span><span class="o">/</span><span class="n">tmp</span><span class="c1"># cp haproxy.cfg /usr/local/sbin/</span>
<span class="n">root</span><span class="o">@</span><span class="mi">9</span><span class="n">ec53e72ee17</span><span class="p">:</span><span class="o">/</span><span class="n">tmp</span><span class="c1"># cd /usr/local/sbin/</span>
<span class="n">root</span><span class="o">@</span><span class="mi">9</span><span class="n">ec53e72ee17</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="c1"># ls</span>
<span class="n">haproxy</span>  <span class="n">haproxy</span><span class="o">.</span><span class="n">cfg</span>
<span class="n">root</span><span class="o">@</span><span class="mi">9</span><span class="n">ec53e72ee17</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="c1"># haproxy -f haproxy.cfg</span>
</pre></div>
</div>
</section>
<section id="id5">
<h2><a class="toc-backref" href="#id13">5.应用访问测试</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>在浏览器中输入IP地址:6301/helloworld即可看到App的views，刷新页面可以看到两个不同的页面，也可以改一下app的名字就可以专门访问不同的app了。
说明：下面第一张图为APP1的视图，第二张为APP2的视图</p>
<p>APP1 <img alt="image1" src="../_images/docker_web_app1.PNG" /></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>root@93259a17e4f8:/# [root@docker-test redisweb]# docker exec -it APP1 /bin/bash
root@34f153ac72a3:/# ps aux
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root       169  0.2  1.4 110256 26472 ?        S+   05:33   0:00 python manage.py runserver 0.0.0.0:8001
root       171  3.6  1.6 263624 30148 ?        Sl+  05:33   0:09 /usr/local/bin/python manage.py runserver 0.0.0.0:8001
root       175  1.3  0.1  21940  2064 ?        Ss   05:37   0:00 /bin/bash
root       180  0.0  0.0  19176  1296 ?        R+   05:37   0:00 ps aux
root@34f153ac72a3:/# kill -9 171
</pre></div>
</div>
<p>APP1出现故障后，APP2的界面 <img alt="image2" src="../_images/docker_web_app2.PNG" /></p>
<p>访问IP地址:6301/haproxy-stats可以查看HAProxy当前状态</p>
<p>参考文献</p>
<p><a class="reference external" href="https://blog.csdn.net/qq_44098729/article/details/103432681">https://blog.csdn.net/qq_44098729/article/details/103432681</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="18.Docker%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8BDocker-Machine.html" class="btn btn-neutral float-left" title="Docker三剑客之Docker-Machine" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="20.Docker%E9%AB%98%E7%BA%A7%E7%BD%91%E7%BB%9C%E5%AE%9E%E6%88%98.html" class="btn btn-neutral float-right" title="Docker高级网络实战" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, huxiaojian.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>