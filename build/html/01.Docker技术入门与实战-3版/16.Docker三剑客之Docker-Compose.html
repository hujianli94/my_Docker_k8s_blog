

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Docker三剑客之Docker-Compose &mdash; 运维开发修炼之路</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'1.0.0',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Docker三剑客之Docker-Swarm" href="17.Docker三剑客之Docker-Swarm.html" />
    <link rel="prev" title="Etcd高可用的键值数据库" href="15.Etcd高可用的键值数据库.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> 小健_Docker_K8s_Blog
          

          
            
            <img src="../_static/docker-k8s.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">01.Docker技术入门与实战-第3版</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01.初识Docker与容器.html">初识Docker与容器</a></li>
<li class="toctree-l2"><a class="reference internal" href="02.Docker镜像的使用.html">Docker镜像的使用</a></li>
<li class="toctree-l2"><a class="reference internal" href="03.操作Docker容器.html">操作Docker容器</a></li>
<li class="toctree-l2"><a class="reference internal" href="04.访问Docker仓库.html">访问Docker仓库</a></li>
<li class="toctree-l2"><a class="reference internal" href="05.搭建本地私有仓库.html">搭建本地私有仓库</a></li>
<li class="toctree-l2"><a class="reference internal" href="06.Docker数据管理.html">Docker数据管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="07.Docker使用网络.html">Docker使用网络</a></li>
<li class="toctree-l2"><a class="reference internal" href="08.使用Dockerfile创建镜像.html">使用Dockerfile创建镜像</a></li>
<li class="toctree-l2"><a class="reference internal" href="09.实战案例.html">实战案例</a></li>
<li class="toctree-l2"><a class="reference internal" href="10.Docker核心实现技术.html">Docker核心实现技术</a></li>
<li class="toctree-l2"><a class="reference internal" href="11.配置私有仓库.html">配置私有仓库</a></li>
<li class="toctree-l2"><a class="reference internal" href="12.安全防护与配置.html">安全防护与配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="13.高级网络功能.html">高级网络功能</a></li>
<li class="toctree-l2"><a class="reference internal" href="14.libnetwork插件化网络功能.html">libnetwork插件化网络功能</a></li>
<li class="toctree-l2"><a class="reference internal" href="15.Etcd高可用的键值数据库.html">Etcd高可用的键值数据库</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Docker三剑客之Docker-Compose</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">简介</a></li>
<li class="toctree-l3"><a class="reference internal" href="#docker-compose">Docker Compose常见场景</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">安装与卸载</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pip">1.pip安装</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">2.二进制包</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">3.容器中执行</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">4.卸载</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#compose">Compose模板文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">Compose命令说明</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id7">Compose命令使用说明如下</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#docker-compose-yml">docker-compose.yml文件配置项</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">Compose环境变量</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compose-web">Compose应用案例一：Web负载均衡</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#web">1.web子目录</a></li>
<li class="toctree-l4"><a class="reference internal" href="#haproxy">2.haproxy目录</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#compose-spark">Compose应用案例二：大数据Spark集群</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compose-lnmp">Compose应用案例三：一键部署LNMP</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compose-nginxtomcat">Compose应用案例四： 一键部署Nginx代理Tomcat集群</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compose-wordpress">Compose应用案例六-WordPress部署</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compose-django">Compose应用案例七：Django框架部署</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compose-flask-redis">compose应用案例八：Flask框架部署，将数值记入Redis</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id9">参考资料</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id10">本章小结</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="17.Docker三剑客之Docker-Swarm.html">Docker三剑客之Docker-Swarm</a></li>
<li class="toctree-l2"><a class="reference internal" href="18.Docker三剑客之Docker-Machine.html">Docker三剑客之Docker-Machine</a></li>
<li class="toctree-l2"><a class="reference internal" href="19.搭建一个Web应用栈.html">搭建一个Web应用栈</a></li>
<li class="toctree-l2"><a class="reference internal" href="20.Docker高级网络实战.html">Docker高级网络实战</a></li>
<li class="toctree-l2"><a class="reference internal" href="21.服务发现.html">服务发现</a></li>
<li class="toctree-l2"><a class="reference internal" href="22.Mesos-优秀的集群资源调度平台.html">Mesos—优秀的集群资源调度平台</a></li>
<li class="toctree-l2"><a class="reference internal" href="23.Kubernetes-生产级容器集群平台.html">Kubernetes-生产级容器集群平台</a></li>
<li class="toctree-l2"><a class="reference internal" href="24.其他相关项目.html">其他相关项目</a></li>
<li class="toctree-l2"><a class="reference internal" href="25.附录.html">附录</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../02.Kubernetes实战指南/index.html">02.Kubernetes实战指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../03.Docker经典实例/index.html">03.Docker经典实例</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">小健_Docker_K8s_Blog</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">01.Docker技术入门与实战-第3版</a> &raquo;</li>
        
      <li>Docker三剑客之Docker-Compose</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/01.Docker技术入门与实战-3版/16.Docker三剑客之Docker-Compose.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#dockerdocker-compose" id="id11">Docker三剑客之Docker-Compose</a><ul>
<li><a class="reference internal" href="#id1" id="id12">简介</a></li>
<li><a class="reference internal" href="#docker-compose" id="id13">Docker Compose常见场景</a></li>
<li><a class="reference internal" href="#id2" id="id14">安装与卸载</a><ul>
<li><a class="reference internal" href="#pip" id="id15">1.pip安装</a></li>
<li><a class="reference internal" href="#id3" id="id16">2.二进制包</a></li>
<li><a class="reference internal" href="#id4" id="id17">3.容器中执行</a></li>
<li><a class="reference internal" href="#id5" id="id18">4.卸载</a></li>
</ul>
</li>
<li><a class="reference internal" href="#compose" id="id19">Compose模板文件</a></li>
<li><a class="reference internal" href="#id6" id="id20">Compose命令说明</a><ul>
<li><a class="reference internal" href="#id7" id="id21">Compose命令使用说明如下</a></li>
</ul>
</li>
<li><a class="reference internal" href="#docker-compose-yml" id="id22">docker-compose.yml文件配置项</a></li>
<li><a class="reference internal" href="#id8" id="id23">Compose环境变量</a></li>
<li><a class="reference internal" href="#compose-web" id="id24">Compose应用案例一：Web负载均衡</a><ul>
<li><a class="reference internal" href="#web" id="id25">1.web子目录</a></li>
<li><a class="reference internal" href="#haproxy" id="id26">2.haproxy目录</a></li>
</ul>
</li>
<li><a class="reference internal" href="#compose-spark" id="id27">Compose应用案例二：大数据Spark集群</a></li>
<li><a class="reference internal" href="#compose-lnmp" id="id28">Compose应用案例三：一键部署LNMP</a></li>
<li><a class="reference internal" href="#compose-nginxtomcat" id="id29">Compose应用案例四： 一键部署Nginx代理Tomcat集群</a></li>
<li><a class="reference internal" href="#compose-wordpress" id="id30">Compose应用案例六-WordPress部署</a></li>
<li><a class="reference internal" href="#compose-django" id="id31">Compose应用案例七：Django框架部署</a></li>
<li><a class="reference internal" href="#compose-flask-redis" id="id32">compose应用案例八：Flask框架部署，将数值记入Redis</a></li>
<li><a class="reference internal" href="#id9" id="id33">参考资料</a><ul>
<li><a class="reference internal" href="#id10" id="id34">本章小结</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="dockerdocker-compose">
<h1><a class="toc-backref" href="#id11">Docker三剑客之Docker-Compose</a><a class="headerlink" href="#dockerdocker-compose" title="Permalink to this headline">¶</a></h1>
<p>Compose项目是Docker官方的开源项目，负责实现对基于Docker容器的多应用服务的快速编排。从功能上看，跟OpenStack中的Heat十分类似。其代码目前在<a class="reference external" href="https://github.com/docker/compose">https://github.com/docker/compose</a>
上开源。</p>
<div class="figure">
<img alt="" src="../_images/docker_compose00001.png" />
</div>
<div class="section" id="id1">
<h2><a class="toc-backref" href="#id12">简介</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>Compose定位是“定义和运行多个Docker容器的应用”，其前身是开源项目Fig，目前仍然兼容Fig格式的模板文件。</p>
<p>通过第一部分中的介绍，读者已经知道使用一个Dockerfile模板文件，可以让用户很方便地定义一个单独的应用容器。然而，在日常工作中，经常会碰到需要多个容器相互配合来完成某项任务的情况。例如要实现一个Web项目，除了Web服务容器本身，往往还需要再加上后端的数据库服务容器，甚至还包括前端的负载均衡容器等。</p>
<p>Compose恰好满足了这样的需求。它允许用户通过一个单独的docker-compose.yml模板文件（YAML格式）来定义一组相关联的应用容器为一个服务栈（stack）。</p>
<p>Compose中有几个重要的概念：</p>
<p>·任务（task）：一个容器被称为一个任务。任务拥有独一无二的ID，在同一个服务中的多个任务序号依次递增。</p>
<p>·服务（service）：某个相同应用镜像的容器副本集合，一个服务可以横向扩展为多个容器实例。</p>
<p>·服务栈（stack）：由多个服务组成，相互配合完成特定业务，如Web应用服务、数据库服务共同构成Web服务栈，一般由一个docker-compose.yml文件定义。</p>
<p>Compose的默认管理对象是服务栈，通过子命令对栈中的多个服务进行便捷的生命周期管理。</p>
<p>Compose项目由Python编写，实现上调用了Docker服务提供的API来对容器进行管理。因此，只要所操作的平台支持Docker
API，就可以在其上利用Compose来进行编排管理。</p>
</div>
<div class="section" id="docker-compose">
<h2><a class="toc-backref" href="#id13">Docker Compose常见场景</a><a class="headerlink" href="#docker-compose" title="Permalink to this headline">¶</a></h2>
<p>（1）开发或本地环境运行多个服务。</p>
<p>Compose命令行工具可用于创建环境并与之交互。比如通过Compose文件，配置所有应用程序的服务依赖（数据库、消息队列、高速缓存、Web服务的API等），然后使用单个命令（docker-compose
up）为每个依赖项创建和启动一个或多个容器，使整个程序能够正常运行起来。</p>
<p>（2）自动化测试环境。任何持续部署或持续集成过程的一个重要部分都是自动化测试套件。自动化端到端测试需要一个运行测试的环境。Compose提供了一种方便的方法来创建和销毁隔离的测试环境。我们只需要通过Compose文件即可定义完整环境，并且可以在几个命令中创建和销毁这些环境。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 执行compose启动命令</span>
<span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">up</span> <span class="o">-</span><span class="n">d</span>

<span class="c1"># 执行自动化测试脚本</span>
<span class="o">./</span><span class="n">run_tests</span>

<span class="c1"># 执行compose销毁命令</span>
<span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">down</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id14">安装与卸载</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>Compose目前支持Linux和Mac
OS平台，两者的安装过程大同小异。安装Compose之前，要先安装Docker引擎，请参考第一部分中章节，在此不再赘述。</p>
<p>Compose可以通过Python的pip工具进行安装，可以直接下载编译好的二进制文件使用，甚至直接运行在Docker容器中。前两种方式是传统方式，适合本地环境下安装使用；最后一种方式则不破坏系统环境，更适合云计算场景。</p>
<div class="section" id="pip">
<h3><a class="toc-backref" href="#id15">1.pip安装</a><a class="headerlink" href="#pip" title="Permalink to this headline">¶</a></h3>
<p>这种方式是将Compose当作一个Python应用从PyPI源中安装。</p>
<p>执行安装命令：</p>
<hr class="docutils" />
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo pip install -U docker-compose
</pre></div>
</div>
<hr class="docutils" />
<p>可以看到类似如下输出，说明安装成功：</p>
<hr class="docutils" />
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Collecting</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span>
    <span class="n">Downloading</span> <span class="n">docker_compose</span><span class="o">-</span><span class="mf">1.19</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">py2</span><span class="o">.</span><span class="n">py3</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="nb">any</span><span class="o">.</span><span class="n">whl</span> <span class="p">(</span><span class="mi">115</span><span class="n">kB</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">Successfully</span> <span class="n">installed</span> <span class="n">cached</span><span class="o">-</span><span class="nb">property</span><span class="o">-</span><span class="mf">1.3</span><span class="o">.</span><span class="mi">1</span> <span class="n">certifi</span><span class="o">-</span><span class="mf">2018.1</span><span class="o">.</span><span class="mi">18</span> <span class="n">chardet</span><span class="o">-</span><span class="mf">3.0</span><span class="o">.</span><span class="mi">4</span> <span class="n">docker</span><span class="o">-</span><span class="mf">2.7</span><span class="o">.</span><span class="mi">0</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="o">-</span><span class="mf">1.19</span><span class="o">.</span><span class="mi">0</span> <span class="n">docker</span><span class="o">-</span><span class="n">pycreds</span><span class="o">-</span><span class="mf">0.2</span><span class="o">.</span><span class="mi">2</span> <span class="n">idna</span><span class="o">-</span><span class="mf">2.6</span> <span class="n">ipaddress</span><span class="o">-</span><span class="mf">1.0</span><span class="o">.</span><span class="mi">19</span> <span class="n">requests</span><span class="o">-</span><span class="mf">2.18</span><span class="o">.</span><span class="mi">4</span> <span class="n">six</span><span class="o">-</span><span class="mf">1.10</span><span class="o">.</span><span class="mi">0</span> <span class="n">texttable</span><span class="o">-</span><span class="mf">0.9</span><span class="o">.</span><span class="mi">1</span> <span class="n">urllib3</span><span class="o">-</span><span class="mf">1.22</span> <span class="n">websocket</span><span class="o">-</span><span class="n">client</span><span class="o">-</span><span class="mf">0.47</span><span class="o">.</span><span class="mi">0</span>
</pre></div>
</div>
<hr class="docutils" />
<p>安装成功后，可以查看docker-compose命令的基本用法：</p>
<hr class="docutils" />
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker-compose -h
Define and run multi-container applications with Docker.
Usage:
    docker-compose [-f &lt;arg&gt;...] [options] [COMMAND] [ARGS...]
    docker-compose -h|--help
Options:
    -f, --file FILE             Specify an alternate compose file (default: docker-compose.yml)
    -p, --project-name NAME     Specify an alternate project name (default: dir-ectory name)
    --verbose                   Show more output
    --no-ansi                   Do not print ANSI control characters
    -v, --version               Print version and exit
    -H, --host HOST             Daemon socket to connect to
    --tls                       Use TLS; implied by --tlsverify
    --tlscacert CA_PATH         Trust certs signed only by this CA
    --tlscert CLIENT_CERT_PATH  Path to TLS certificate file
    --tlskey TLS_KEY_PATH       Path to TLS key file
    --tlsverify                 Use TLS and verify the remote
    --skip-hostname-check       Don&#39;t check the daemon&#39;s hostname against the name specified
                                in the client certificate (for example if your docker host
                                is an IP address)
    --project-directory PATH    Specify an alternate working directory
                                (default: the path of the Compose file)
Commands:
    build              Build or rebuild services
    bundle             Generate a Docker bundle from the Compose file
    config             Validate and view the Compose file
    create             Create services
    down               Stop and remove containers, networks, images, and volumes
    events             Receive real time events from containers
    exec               Execute a command in a running container
    help               Get help on a command
    images             List images
    kill               Kill containers
    logs               View output from containers
    pause              Pause services
    port               Print the public port for a port binding
    ps                 List containers
    pull               Pull service images
    push               Push service images
    restart            Restart services
    rm                 Remove stopped containers
    run                Run a one-off command
    scale              Set number of containers for a service
    start              Start services
    stop               Stop services
    top                Display the running processes
    unpause            Unpause services
    up                 Create and start containers
    version            Show the Docker-Compose version information
</pre></div>
</div>
<hr class="docutils" />
<p>之后，可以添加bash补全命令：</p>
<hr class="docutils" />
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span>$ curl -L https://raw.githubusercontent.com/docker/compose/1.19.0/contrib/com-pletion/bash/docker-compose &gt; /etc/bash_completion.d/docker-compose
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id16">2.二进制包</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>官方定义编译好二进制包，供大家使用。这些发布的二进制包可以在<a class="reference external" href="https://github.com/docker/compose/releases">https://github.com/docker/compose/releases</a>
页面找到。</p>
<p>将这些二进制文件下载后直接放到执行路径下，并添加执行权限即可。例如，在Linux平台上：</p>
<hr class="docutils" />
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.26.0/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose

$ sudo chmod a+x /usr/local/bin/docker-compose
</pre></div>
</div>
<hr class="docutils" />
<p>可以使用docker-compose version命令来查看版本信息，以测试是否安装成功：</p>
<hr class="docutils" />
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker-compose version
docker-compose version 1.19.0, build 9e633ef
docker-py version: 2.7.0
CPython version: 2.7.12
OpenSSL version: OpenSSL 1.0.2g  1 Mar 2016
</pre></div>
</div>
<hr class="docutils" />
<p>参考文献
<a class="reference external" href="https://www.cnblogs.com/xiao987334176/p/12377113.html">centos7安装docker-compose</a></p>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id17">3.容器中执行</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>Compose既然是一个Python应用，自然也可以直接用容器来执行它：</p>
<hr class="docutils" />
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span>$ curl -L https://github.com/docker/compose/releases/download/1.19.0/run.sh &gt; /usr/local/bin/docker-compose
$ chmod +x /usr/local/bin/docker-compose
</pre></div>
</div>
<hr class="docutils" />
<p>实际上，查看下载的run.sh脚本内容，如下：</p>
<hr class="docutils" />
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span>set -e
VERSION=&quot;1.19.0&quot;
IMAGE=&quot;docker/compose:$VERSION&quot;
# Setup options for connecting to docker host
if [ -z &quot;$DOCKER_HOST&quot; ]; then
    DOCKER_HOST=&quot;/var/run/docker.sock&quot;
fi
if [ -S &quot;$DOCKER_HOST&quot; ]; then
    DOCKER_ADDR=&quot;-v $DOCKER_HOST:$DOCKER_HOST -e DOCKER_HOST&quot;
else
    DOCKER_ADDR=&quot;-e DOCKER_HOST -e DOCKER_TLS_VERIFY -e DOCKER_CERT_PATH&quot;
fi
# Setup volume mounts for compose config and context
if [ &quot;$(pwd)&quot; != &#39;/&#39; ]; then
    VOLUMES=&quot;-v $(pwd):$(pwd)&quot;
fi
if [ -n &quot;$COMPOSE_FILE&quot; ]; then
    compose_dir=$(dirname $COMPOSE_FILE)
fi
# TODO: also check --file argument
if [ -n &quot;$compose_dir&quot; ]; then
    VOLUMES=&quot;$VOLUMES -v $compose_dir:$compose_dir&quot;
fi
if [ -n &quot;$HOME&quot; ]; then
    VOLUMES=&quot;$VOLUMES -v $HOME:$HOME -v $HOME:/root&quot; # mount $HOME in /root to share docker.config
fi
# Only allocate tty if we detect one
if [ -t 1 ]; then
    DOCKER_RUN_OPTIONS=&quot;-t&quot;
fi
if [ -t 0 ]; then
    DOCKER_RUN_OPTIONS=&quot;$DOCKER_RUN_OPTIONS -i&quot;
fi
exec docker run --rm $DOCKER_RUN_OPTIONS $DOCKER_ADDR $COMPOSE_OPTIONS $VOLUMES -w &quot;$(pwd)&quot; $IMAGE &quot;$@&quot;
</pre></div>
</div>
<hr class="docutils" />
<p>可以看到，它其实是下载了docker/compose镜像并运行。</p>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id18">4.卸载</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>如果是二进制包方式安装的，删除二进制文件即可：</p>
<hr class="docutils" />
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo rm /usr/local/bin/docker-compose
</pre></div>
</div>
<hr class="docutils" />
<p>如果是通过Python pip工具安装的，则可以执行如下命令删除：</p>
<hr class="docutils" />
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo pip uninstall docker-compose
</pre></div>
</div>
</div>
</div>
<div class="section" id="compose">
<h2><a class="toc-backref" href="#id19">Compose模板文件</a><a class="headerlink" href="#compose" title="Permalink to this headline">¶</a></h2>
<p>模板文件是使用Compose的核心，涉及的指令关键字也比较多。但大家不用担心，这里的大部分指令与docker[container]create|run相关参数的含义都是类似的。</p>
<p>默认的模板文件名称为docker-compose.yml，格式为YAML格式，目前最新的版本为v3。</p>
<p>版本1的Compose文件结构十分简单，每个顶级元素为服务名称，次级元素为服务容器的配置信息，例如：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">webapp</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">examples</span><span class="o">/</span><span class="n">web</span>
    <span class="n">ports</span><span class="p">:</span>
        <span class="o">-</span> <span class="s2">&quot;80:80&quot;</span>
    <span class="n">volumes</span><span class="p">:</span>
        <span class="o">-</span> <span class="s2">&quot;/data&quot;</span>
</pre></div>
</div>
<hr class="docutils" />
<p>版本2和3扩展了Compose的语法，同时尽量保持跟旧版本的兼容，除了可以声明网络和存储信息外，最大的不同一是添加了版本信息，另一个是需要将所有的服务放到services根下面。</p>
<p>例如，上面例子改写为版本3，并启用资源限制，内容如下：</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span><span class="s2">&quot;3&quot;</span>
<span class="n">services</span><span class="p">:</span>
    <span class="n">webapp</span><span class="p">:</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">examples</span><span class="o">/</span><span class="n">web</span>
        <span class="n">deploy</span><span class="p">:</span>
            <span class="n">replicas</span><span class="p">:</span> <span class="mi">2</span>
            <span class="n">resources</span><span class="p">:</span>
                <span class="n">limits</span><span class="p">:</span>
                    <span class="n">cpus</span><span class="p">:</span> <span class="s2">&quot;0.1&quot;</span>
                    <span class="n">memory</span><span class="p">:</span> <span class="mi">100</span><span class="n">M</span>
                <span class="n">restart_policy</span><span class="p">:</span>
                    <span class="n">condition</span><span class="p">:</span> <span class="n">on</span><span class="o">-</span><span class="n">failure</span>
        <span class="n">ports</span><span class="p">:</span>
            <span class="o">-</span> <span class="s2">&quot;80:80&quot;</span>
        <span class="n">networks</span><span class="p">:</span>
            <span class="o">-</span> <span class="n">mynet</span>
        <span class="n">volumes</span><span class="p">:</span>
            <span class="o">-</span> <span class="s2">&quot;/data&quot;</span>
<span class="n">networks</span><span class="p">:</span>
    <span class="n">mynet</span><span class="p">:</span>
</pre></div>
</div>
<hr class="docutils" />
<p>注意每个服务都必须通过image指令指定镜像或build指令（需要Dockerfile）等来自动构建生成镜像。</p>
<p>如果使用build指令，在Dockerfile中设置的选项（例如：CMD、EXPOSE、VOLUME、ENV等）将会自动被获取，无须在docker-compose.yml中再次设置。</p>
<p>命令列表参见表24-1。</p>
<p>表24-1　Compose模板文件主要命令</p>
<div class="figure">
<img alt="" src="../_images/docker_compose_cmd00001.png" />
</div>
<div class="figure">
<img alt="" src="../_images/docker_compose_cmd_00002.png" />
</div>
<p>下面介绍部分指令的用法。</p>
<p>1.build</p>
<p>指定Dockerfile所在文件夹的路径（可以是绝对路径，或者相对docker-compose.yml文件的路径）。Compose将会利用它自动构建应用镜像，然后使用这个镜像，例如：</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s1">&#39;3&#39;</span>
<span class="n">services</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span>
        <span class="n">build</span><span class="p">:</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="nb">dir</span>
</pre></div>
</div>
<hr class="docutils" />
<p>build指令还可以指定创建镜像的上下文、Dockerfile路径、标签、Shm大小、参数和缓存来源等，例如：</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s1">&#39;3&#39;</span>
<span class="n">services</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span>
        <span class="n">build</span><span class="p">:</span>
            <span class="n">context</span><span class="p">:</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="nb">dir</span>
            <span class="n">dockerfile</span><span class="p">:</span> <span class="n">Dockerfile</span><span class="o">-</span><span class="n">app</span>
            <span class="n">labels</span><span class="p">:</span>
                <span class="n">version</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span>
                <span class="n">released</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
            <span class="n">shm_size</span><span class="p">:</span> <span class="s1">&#39;2gb&#39;</span>
            <span class="n">args</span><span class="p">:</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">value</span>
                <span class="n">name</span><span class="p">:</span> <span class="n">myApp</span>
            <span class="n">cache_from</span><span class="p">:</span>
                <span class="o">-</span> <span class="n">myApp</span><span class="p">:</span><span class="mf">1.0</span>
</pre></div>
</div>
<hr class="docutils" />
<p>2.cap_add，cap_drop</p>
<p>指定容器的内核能力（capacity）分配。例如，让容器拥有所有能力可以指定为：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cap_add</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">ALL</span>
</pre></div>
</div>
<hr class="docutils" />
<p>去掉NET_ADMIN能力可以指定为：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cap_drop</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">NET_ADMIN</span>
</pre></div>
</div>
<hr class="docutils" />
<p>3.command</p>
<p>覆盖容器启动后默认执行的命令，可以为字符串格式或JSON数组格式。例如：</p>
<hr class="docutils" />
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">command</span><span class="p">:</span> <span class="n">echo</span> <span class="s2">&quot;hello world&quot;</span>
</pre></div>
</div>
<hr class="docutils" />
<p>或者：</p>
<hr class="docutils" />
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">command</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;bash&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="s2">&quot;echo&quot;</span><span class="p">,</span> <span class="s2">&quot;hello world&quot;</span><span class="p">]</span>
</pre></div>
</div>
<hr class="docutils" />
<p>4.configs</p>
<p>在Docker
Swarm模式下，可以通过configs来管理和访问非敏感的配置信息。支持从文件读取或外部读取。例如：</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s2">&quot;3.3&quot;</span>
<span class="n">services</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">myApp</span><span class="p">:</span><span class="mf">1.0</span>
        <span class="n">deploy</span><span class="p">:</span>
            <span class="n">replicas</span><span class="p">:</span> <span class="mi">1</span>
        <span class="n">configs</span><span class="p">:</span>
            <span class="o">-</span> <span class="n">file_config</span>
            <span class="o">-</span> <span class="n">external_config</span>
<span class="n">configs</span><span class="p">:</span>
    <span class="n">file_config</span><span class="p">:</span>
        <span class="n">file</span><span class="p">:</span> <span class="o">./</span><span class="n">config_file</span><span class="o">.</span><span class="n">cfg</span>
    <span class="n">external_config</span><span class="p">:</span>
        <span class="n">external</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
<hr class="docutils" />
<p>5.cgroup_parent</p>
<p>指定父cgroup组，意味着将继承该组的资源限制。目前不支持在Swarm模式中使用。例如，创建了一个cgroup组名称为cgroups_1：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cgroup_parent</span><span class="p">:</span> <span class="n">cgroups_1</span>
</pre></div>
</div>
<hr class="docutils" />
<p>6.container_name</p>
<p>指定容器名称。默认将会使用“项目名称_服务名称_序号”这样的格式。目前不支持在Swarm模式中使用。例如：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">container_name</span><span class="p">:</span> <span class="n">docker</span><span class="o">-</span><span class="n">web</span><span class="o">-</span><span class="n">container</span>
</pre></div>
</div>
<hr class="docutils" />
<p>需要注意，指定容器名称后，该服务将无法进行扩展，因为Docker不允许多个容器实例重名。</p>
<p>7.devices</p>
<p>指定设备映射关系，不支持Swarm模式。例如：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">devices</span><span class="p">:</span>
    <span class="o">-</span> <span class="s2">&quot;/dev/ttyUSB1:/dev/ttyUSB0&quot;</span>
</pre></div>
</div>
<hr class="docutils" />
<p>8.depends_on</p>
<p>指定多个服务之间的依赖关系。启动时，会先启动被依赖服务。例如，可以指定依赖于db服务：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">depends_on</span><span class="p">:</span> <span class="n">db</span>
</pre></div>
</div>
<hr class="docutils" />
<p>9.dns</p>
<p>自定义DNS服务器。可以是一个值，也可以是一个列表。例如：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dns</span><span class="p">:</span> <span class="mf">8.8</span><span class="o">.</span><span class="mf">8.8</span>
<span class="n">dns</span><span class="p">:</span>
    <span class="o">-</span> <span class="mf">8.8</span><span class="o">.</span><span class="mf">8.8</span>
    <span class="o">-</span> <span class="mf">9.9</span><span class="o">.</span><span class="mf">9.9</span>
</pre></div>
</div>
<hr class="docutils" />
<p>10.dns_search</p>
<p>配置DNS搜索域。可以是一个值，也可以是一个列表。例如：</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dns_search</span><span class="p">:</span> <span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">dns_search</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">domain1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
    <span class="o">-</span> <span class="n">domain2</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<hr class="docutils" />
<p>11.dockerfile</p>
<p>如果需要，指定额外的编译镜像的Dockefile文件，可以通过该指令来指定。例如：</p>
<hr class="docutils" />
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dockerfile</span><span class="p">:</span> <span class="n">Dockerfile</span><span class="o">-</span><span class="n">alternate</span>
</pre></div>
</div>
<hr class="docutils" />
<p>注意</p>
<p>该指令不能跟image同时使用，否则Compose将不知道根据哪个指令来生成最终的服务镜像。</p>
<p>12.entrypoint</p>
<p>覆盖容器中默认的入口命令。注意，也会取消掉镜像中指定的入口命令和默认启动命令。例如，覆盖为新的入口命令：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">entrypoint</span><span class="p">:</span> <span class="n">python</span> <span class="n">app</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<hr class="docutils" />
<p>13.env_file</p>
<p>从文件中获取环境变量，可以为单独的文件路径或列表。如果通过docker-compose-f
FILE方式来指定Compose模板文件，则env_file中变量的路径会基于模板文件路径。如果有变量名称与environment指令冲突，则按照惯例，以后者为准。例如：</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">env_file</span><span class="p">:</span> <span class="o">.</span><span class="n">env</span>
<span class="n">env_file</span><span class="p">:</span>
    <span class="o">-</span> <span class="o">./</span><span class="n">common</span><span class="o">.</span><span class="n">env</span>
    <span class="o">-</span> <span class="o">./</span><span class="n">apps</span><span class="o">/</span><span class="n">web</span><span class="o">.</span><span class="n">env</span>
    <span class="o">-</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">secrets</span><span class="o">.</span><span class="n">env</span>
</pre></div>
</div>
<hr class="docutils" />
<p>环境变量文件中每一行必须符合格式，支持#开头的注释行，例如：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># common.env: Set development environment</span>
<span class="n">PROG_ENV</span><span class="o">=</span><span class="n">development</span>
</pre></div>
</div>
<hr class="docutils" />
<p>14.environment</p>
<p>设置环境变量，可以使用数组或字典两种格式。只给定名称的变量会自动获取运行Compose主机上对应变量的值，可以用来防止泄露不必要的数据。例如：</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">environment</span><span class="p">:</span>
    <span class="n">RACK_ENV</span><span class="p">:</span> <span class="n">development</span>
    <span class="n">SESSION_SECRET</span><span class="p">:</span>
</pre></div>
</div>
<hr class="docutils" />
<p>或者：</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">environment</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">RACK_ENV</span><span class="o">=</span><span class="n">development</span>
    <span class="o">-</span> <span class="n">SESSION_SECRET</span>
</pre></div>
</div>
<hr class="docutils" />
<p>注意，如果变量名称或者值中用到true|false，yes|no等表达布尔含义的词汇，最好放到引号里，避免YAML自动解析某些内容为对应的布尔语义：</p>
<p><a class="reference external" href="http://yaml.org/type/bool.html">http://yaml.org/type/bool.html</a>中给出了这些特定词汇，包括</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">y</span><span class="o">|</span><span class="n">Y</span><span class="o">|</span><span class="n">yes</span><span class="o">|</span><span class="n">Yes</span><span class="o">|</span><span class="n">YES</span><span class="o">|</span><span class="n">n</span><span class="o">|</span><span class="n">N</span><span class="o">|</span><span class="n">no</span><span class="o">|</span><span class="n">No</span><span class="o">|</span><span class="n">NO</span>
<span class="o">|</span><span class="n">true</span><span class="o">|</span><span class="kc">True</span><span class="o">|</span><span class="n">TRUE</span><span class="o">|</span><span class="n">false</span><span class="o">|</span><span class="kc">False</span><span class="o">|</span><span class="n">FALSE</span>
<span class="o">|</span><span class="n">on</span><span class="o">|</span><span class="n">On</span><span class="o">|</span><span class="n">ON</span><span class="o">|</span><span class="n">off</span><span class="o">|</span><span class="n">Off</span><span class="o">|</span><span class="n">OFF</span>
</pre></div>
</div>
<hr class="docutils" />
<p>15.expose</p>
<p>暴露端口，但不映射到宿主机，只被连接的服务访问。仅可以指定内部端口为参数，如下所示：</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">expose</span><span class="p">:</span>
    <span class="o">-</span> <span class="s2">&quot;3000&quot;</span>
    <span class="o">-</span> <span class="s2">&quot;8000&quot;</span>
</pre></div>
</div>
<hr class="docutils" />
<p>16.extends</p>
<p>基于其他模板文件进行扩展。例如，我们已经有了一个webapp服务，定义一个基础模板文件为common.yml，如下所示：</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># common.yml</span>
<span class="n">webapp</span><span class="p">:</span>
    <span class="n">build</span><span class="p">:</span> <span class="o">./</span><span class="n">webapp</span>
    <span class="n">environment</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">DEBUG</span><span class="o">=</span><span class="n">false</span>
        <span class="o">-</span> <span class="n">SEND_EMAILS</span><span class="o">=</span><span class="n">false</span>
</pre></div>
</div>
<hr class="docutils" />
<p>再编写一个新的development.yml文件，使用common.yml中的webapp服务进行扩展：</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># development.yml</span>
<span class="n">web</span><span class="p">:</span>
    <span class="n">extends</span><span class="p">:</span>
        <span class="n">file</span><span class="p">:</span> <span class="n">common</span><span class="o">.</span><span class="n">yml</span>
        <span class="n">service</span><span class="p">:</span> <span class="n">webapp</span>
    <span class="n">ports</span><span class="p">:</span>
        <span class="o">-</span> <span class="s2">&quot;8000:8000&quot;</span>
    <span class="n">links</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">db</span>
    <span class="n">environment</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">DEBUG</span><span class="o">=</span><span class="n">true</span>
<span class="n">db</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">postgres</span>
</pre></div>
</div>
<hr class="docutils" />
<p>后者会自动继承common.yml中的webapp服务及环境变量定义。使用extends需要注意以下两点：</p>
<p>·要避免出现循环依赖，例如A依赖B，B依赖C，C反过来依赖A的情况。</p>
<p>·extends不会继承links和volumes_from中定义的容器和数据卷资源。</p>
<p>一般情况下，推荐在基础模板中只定义一些可以共享的镜像和环境变量，在扩展模板中具体指定应用变量、链接、数据卷等信息。</p>
<p>17.external_links</p>
<p>链接到docker-compose.yml外部的容器，甚至并非Compose管理的外部容器。参数格式跟links类似。</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">external_links</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">redis_1</span>
    <span class="o">-</span> <span class="n">project_db_1</span><span class="p">:</span><span class="n">mysql</span>
    <span class="o">-</span> <span class="n">project_db_1</span><span class="p">:</span><span class="n">postgresql</span>
</pre></div>
</div>
<hr class="docutils" />
<p>18.extra_hosts</p>
<p>类似Docker中的–add-host参数，指定额外的host名称映射信息。</p>
<p>例如：</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">extra_hosts</span><span class="p">:</span>
    <span class="o">-</span> <span class="s2">&quot;googledns:8.8.8.8&quot;</span>
    <span class="o">-</span> <span class="s2">&quot;dockerhub:52.1.157.61&quot;</span>
</pre></div>
</div>
<hr class="docutils" />
<p>会在启动后的服务容器中/etc/hosts文件中添加如下两条条目。</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">8.8</span><span class="o">.</span><span class="mf">8.8</span> <span class="n">googledns</span>
<span class="mf">52.1</span><span class="o">.</span><span class="mf">157.61</span> <span class="n">dockerhub</span>
</pre></div>
</div>
<hr class="docutils" />
<p>19.healthcheck</p>
<p>指定检测应用健康状态的机制，包括检测方法（test）、间隔（interval）、超时（timeout）、重试次数（retries）、启动等待时间（start_period）等。</p>
<p>例如，指定检测方法为访问8080端口，间隔为30秒，超时为15秒，重试3次，启动后等待30秒再做检查。</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">healthcheck</span><span class="p">:</span>
    <span class="n">test</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;CMD&quot;</span><span class="p">,</span> <span class="s2">&quot;curl&quot;</span><span class="p">,</span> <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;http://localhost:8080&quot;</span><span class="p">]</span>
    <span class="n">interval</span><span class="p">:</span> <span class="mi">30</span><span class="n">s</span>
    <span class="n">timeout</span><span class="p">:</span> <span class="mi">15</span><span class="n">s</span>
    <span class="n">retries</span><span class="p">:</span> <span class="mi">3</span>
    <span class="n">start_period</span><span class="p">:</span> <span class="mi">30</span><span class="n">s</span>
</pre></div>
</div>
<hr class="docutils" />
<p>20.image</p>
<p>指定为镜像名称或镜像ID。如果镜像在本地不存在，Compose将会尝试拉去这个镜像。</p>
<p>例如：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">image</span><span class="p">:</span> <span class="n">ubuntu</span>
<span class="n">image</span><span class="p">:</span> <span class="n">orchardup</span><span class="o">/</span><span class="n">postgresql</span>
<span class="n">image</span><span class="p">:</span> <span class="n">a4bc65fd</span>
</pre></div>
</div>
<hr class="docutils" />
<p>21.isolation</p>
<p>配置容器隔离的机制，包括default、process和hyperv。</p>
<p>22.labels</p>
<p>为容器添加Docker元数据（metadata）信息。例如可以为容器添加辅助说明信息。</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span><span class="p">:</span>
    <span class="n">com</span><span class="o">.</span><span class="n">startupteam</span><span class="o">.</span><span class="n">description</span><span class="p">:</span> <span class="s2">&quot;webapp for a startup team&quot;</span>
    <span class="n">com</span><span class="o">.</span><span class="n">startupteam</span><span class="o">.</span><span class="n">department</span><span class="p">:</span> <span class="s2">&quot;devops department&quot;</span>
    <span class="n">com</span><span class="o">.</span><span class="n">startupteam</span><span class="o">.</span><span class="n">release</span><span class="p">:</span> <span class="s2">&quot;rc3 for v1.0&quot;</span>
</pre></div>
</div>
<hr class="docutils" />
<p>23.links</p>
<p>注意：links命令属于旧的用法，可能在后续版本中被移除。</p>
<p>链接到其他服务中的容器。使用服务名称（同时作为别名）或服务名称：服务别名（SERVICE：ALIAS）格式都可以。</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">links</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">db</span>
    <span class="o">-</span> <span class="n">db</span><span class="p">:</span><span class="n">database</span>
    <span class="o">-</span> <span class="n">redis</span>
</pre></div>
</div>
<hr class="docutils" />
<p>使用的别名将会自动在服务容器中的/etc/hosts里创建。例如：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">172.17</span><span class="o">.</span><span class="mf">2.186</span>  <span class="n">db</span>
<span class="mf">172.17</span><span class="o">.</span><span class="mf">2.186</span>  <span class="n">database</span>
<span class="mf">172.17</span><span class="o">.</span><span class="mf">2.187</span>  <span class="n">redis</span>
</pre></div>
</div>
<hr class="docutils" />
<p>被链接容器中相应的环境变量也将被创建。</p>
<p>24.logging</p>
<p>跟日志相关的配置，包括一系列子配置。</p>
<p>logging.driver：类似于Docker中的–log-driver参数，指定日志驱动类型。目前支持三种日志驱动类型：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;json-file&quot;</span>
<span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;syslog&quot;</span>
<span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span>
</pre></div>
</div>
<hr class="docutils" />
<p>logging.options：日志驱动的相关参数。例如：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">logging</span><span class="p">:</span>
    <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;syslog&quot;</span>
    <span class="n">options</span><span class="p">:</span>
        <span class="n">syslog</span><span class="o">-</span><span class="n">address</span><span class="p">:</span> <span class="s2">&quot;tcp://192.168.0.42:123&quot;</span>
</pre></div>
</div>
<hr class="docutils" />
<p>或：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">logging</span><span class="p">:</span>
    <span class="n">driver</span><span class="p">:</span> <span class="s2">&quot;json-file&quot;</span>
    <span class="n">options</span><span class="p">:</span>
        <span class="nb">max</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="s2">&quot;1000k&quot;</span>
        <span class="nb">max</span><span class="o">-</span><span class="n">file</span><span class="p">:</span> <span class="s2">&quot;20&quot;</span>
</pre></div>
</div>
<hr class="docutils" />
<p>25.network_mode</p>
<p>设置网络模式。使用和docker client的–net参数一样的值。</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">network_mode</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span>
<span class="n">network_mode</span><span class="p">:</span> <span class="s2">&quot;bridge&quot;</span>
<span class="n">network_mode</span><span class="p">:</span> <span class="s2">&quot;host&quot;</span>
<span class="n">network_mode</span><span class="p">:</span> <span class="s2">&quot;service:[service name]&quot;</span>
<span class="n">network_mode</span><span class="p">:</span> <span class="s2">&quot;container:[name or id]&quot;</span>
</pre></div>
</div>
<hr class="docutils" />
<p>26.networks</p>
<p>所加入的网络。需要在顶级的networks字段中定义具体的网络信息。</p>
<p>例如，指定web服务的网络为web_net，并添加服务在网络中别名为web_app。</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span>services:
    web:
        networks:
            web_net：
                aliases: web_app
            ipv4_address: 172.16.0.10
networks:
    web_net:
        driver: bridge
        enable_ipv6: true
        ipam:
            driver: default
            config:
                subnet: 172.16.0.0/24
</pre></div>
</div>
<hr class="docutils" />
<p>27.pid</p>
<p>跟主机系统共享进程命名空间。打开该选项的容器之间，以及容器和宿主机系统之间可以通过进程ID来相互访问和操作。</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pid</span><span class="p">:</span> <span class="s2">&quot;host&quot;</span>
</pre></div>
</div>
<hr class="docutils" />
<p>28.ports</p>
<p>暴露端口信息。</p>
<p>使用宿主：容器（HOST：CONTAINER）格式，或者仅仅指定容器的端口（宿主将会随机选择端口）都可以。</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ports</span><span class="p">:</span>
    <span class="o">-</span> <span class="s2">&quot;3000&quot;</span>
    <span class="o">-</span> <span class="s2">&quot;8000:8000&quot;</span>
    <span class="o">-</span> <span class="s2">&quot;49100:22&quot;</span>
    <span class="o">-</span> <span class="s2">&quot;127.0.0.1:8001:8001&quot;</span>
</pre></div>
</div>
<hr class="docutils" />
<p>或者：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ports</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">target</span><span class="p">:</span> <span class="mi">80</span>
      <span class="n">published</span><span class="p">:</span> <span class="mi">8080</span>
      <span class="n">protocol</span><span class="p">:</span> <span class="n">tcp</span>
      <span class="n">mode</span><span class="p">:</span> <span class="n">ingress</span>
</pre></div>
</div>
<p>注意</p>
<p>当使用HOST：CONTAINER格式来映射端口时，如果你使用的容器端口小于60并且没放到引号里，可能会得到错误结果，因为YAML会自动解析xx：yy这种数字格式为60进制。为避免出现这种问题，建议数字串都采用引号包括起来的字符串格式。</p>
<p>29.secrets</p>
<p>配置应用的秘密数据。</p>
<p>可以指定来源秘密、挂载后名称、权限等。</p>
<p>例如：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s2">&quot;3.1&quot;</span>
<span class="n">services</span><span class="p">:</span>
    <span class="n">web</span><span class="p">:</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">webapp</span><span class="p">:</span><span class="n">stable</span>
        <span class="n">deploy</span><span class="p">:</span>
            <span class="n">replicas</span><span class="p">:</span> <span class="mi">2</span>
        <span class="n">secrets</span><span class="p">:</span>
            <span class="o">-</span> <span class="n">source</span><span class="p">:</span> <span class="n">web_secret</span>
              <span class="n">target</span><span class="p">:</span> <span class="n">web_secret</span>
              <span class="n">uid</span><span class="p">:</span> <span class="s1">&#39;103&#39;</span>
              <span class="n">gid</span><span class="p">:</span> <span class="s1">&#39;103&#39;</span>
              <span class="n">mode</span><span class="p">:</span> <span class="mi">0444</span>
<span class="n">secrets</span><span class="p">:</span>
    <span class="n">web_secret</span><span class="p">:</span>
        <span class="n">file</span><span class="p">:</span> <span class="o">./</span><span class="n">web_secret</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<hr class="docutils" />
<p>30.security_opt</p>
<p>指定容器模板标签（label）机制的默认属性（用户、角色、类型、级别等）。</p>
<p>例如，配置标签的用户名和角色名：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">security_opt</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">label</span><span class="p">:</span><span class="n">user</span><span class="p">:</span><span class="n">USER</span>
    <span class="o">-</span> <span class="n">label</span><span class="p">:</span><span class="n">role</span><span class="p">:</span><span class="n">ROLE</span>
</pre></div>
</div>
<hr class="docutils" />
<p>31.stop_grace_period</p>
<p>指定应用停止时，容器的优雅停止期限。过期后则通过SIGKILL强制退出。</p>
<p>默认值为10s。</p>
<p>32.stop_signal</p>
<p>指定停止容器的信号，默认为SIGTERM。</p>
<p>33.sysctls</p>
<p>配置容器内的内核参数。Swarm模式中不支持。</p>
<p>例如，指定连接数为4096和开启TCP的syncookies：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sysctls</span><span class="p">:</span>
    <span class="n">net</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">somaxconn</span><span class="p">:</span> <span class="mi">4096</span>
    <span class="n">net</span><span class="o">.</span><span class="n">ipv4</span><span class="o">.</span><span class="n">tcp_syncookies</span><span class="p">:</span> <span class="mi">1</span>
</pre></div>
</div>
<hr class="docutils" />
<p>34.ulimits</p>
<p>指定容器的ulimits限制值。</p>
<p>例如，指定最大进程数为65535，指定文件句柄数为20000（软限制，应用可以随时修改，不能超过硬限制）和40000（系统硬限制，只能root用户提高）。</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ulimits</span><span class="p">:</span>
    <span class="n">nproc</span><span class="p">:</span> <span class="mi">65535</span>
    <span class="n">nofile</span><span class="p">:</span>
      <span class="n">soft</span><span class="p">:</span> <span class="mi">20000</span>
      <span class="n">hard</span><span class="p">:</span> <span class="mi">40000</span>
</pre></div>
</div>
<hr class="docutils" />
<p>35.userns_mode</p>
<p>指定用户命名空间模式。Swarm模式中不支持。例如，使用主机上的用户命名空间：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">userns_mode</span><span class="p">:</span> <span class="s2">&quot;host&quot;</span>
</pre></div>
</div>
<hr class="docutils" />
<p>36.volumes</p>
<p>数据卷所挂载路径设置。可以设置宿主机路径（HOST：CONTAINER）或加上访问模式（HOST：CONTAINER：ro）。</p>
<p>支持driver、driver_opts、external、labels、name等子配置。</p>
<p>该指令中路径支持相对路径。例如</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">volumes</span><span class="p">:</span>
    <span class="o">-</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span>
    <span class="o">-</span> <span class="n">cache</span><span class="o">/</span><span class="p">:</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">cache</span>
    <span class="o">-</span> <span class="o">~/</span><span class="n">configs</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">configs</span><span class="o">/</span><span class="p">:</span><span class="n">ro</span>
</pre></div>
</div>
<hr class="docutils" />
<p>或者可以使用更详细的语法格式：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">volumes</span><span class="p">:</span>
    <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">volume</span>
        <span class="n">source</span><span class="p">:</span> <span class="n">mydata</span>
        <span class="n">target</span><span class="p">:</span> <span class="o">/</span><span class="n">data</span>
        <span class="n">volume</span><span class="p">:</span>
            <span class="n">nocopy</span><span class="p">:</span> <span class="n">true</span>
<span class="n">volumes</span><span class="p">:</span>
    <span class="n">mydata</span><span class="p">:</span>
</pre></div>
</div>
<hr class="docutils" />
<p>37.restart</p>
<p>指定重启策略，可以为no（不重启）、always（总是）、on-failure（失败时）、unless-stopped（除非停止）。</p>
<p>注意Swarm模式下要使用restart_policy。在生产环境中推荐配置为always或者unless-stopped。</p>
<p>例如，配置除非停止：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">restart</span><span class="p">:</span> <span class="n">unless</span><span class="o">-</span><span class="n">stopped</span>
</pre></div>
</div>
<hr class="docutils" />
<p>38.deploy</p>
<p>指定部署和运行时的容器相关配置。该命令只在Swarm模式下生效，且只支持docker
stack deploy命令部署。</p>
<p>例如：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s1">&#39;3&#39;</span>
<span class="n">services</span><span class="p">:</span>
    <span class="n">redis</span><span class="p">:</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">web</span><span class="p">:</span><span class="n">stable</span>
        <span class="n">deploy</span><span class="p">:</span>
            <span class="n">replicas</span><span class="p">:</span> <span class="mi">3</span>
            <span class="n">update_config</span><span class="p">:</span>
                <span class="n">parallelism</span><span class="p">:</span> <span class="mi">2</span>
                <span class="n">delay</span><span class="p">:</span> <span class="mi">10</span><span class="n">s</span>
            <span class="n">restart_policy</span><span class="p">:</span>
                <span class="n">condition</span><span class="p">:</span> <span class="n">on</span><span class="o">-</span><span class="n">failure</span>
</pre></div>
</div>
<hr class="docutils" />
<p>deploy命令中包括endpoint_mode、labels、mode、placement、replicas、resources、restart_policy、update_config等配置项。</p>
<p>（1）endpoint_mode</p>
<p>指定服务端点模式。包括两种类型：</p>
<p>vip：Swarm分配一个前端的虚拟地址，客户端通过给地址访问服务，而无须关心后端的应用容器个数；</p>
<p>dnsrr：Swarm分配一个域名给服务，用户访问域名时候回按照轮流顺序返回容器地址。</p>
<p>例如：</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s1">&#39;3&#39;</span>
<span class="n">services</span><span class="p">:</span>
    <span class="n">redis</span><span class="p">:</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">web</span><span class="p">:</span><span class="n">stable</span>
        <span class="n">deploy</span><span class="p">:</span>
            <span class="n">mode</span><span class="p">:</span> <span class="n">replicated</span>
            <span class="n">replicas</span><span class="p">:</span> <span class="mi">3</span>
            <span class="n">endpoint_mode</span><span class="p">:</span> <span class="n">vip</span>
</pre></div>
</div>
<hr class="docutils" />
<p>（2）labels</p>
<p>指定服务的标签。注意标签信息不会影响到服务内的容器。</p>
<p>例如：</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span>
<span class="n">services</span><span class="p">:</span>
    <span class="n">web</span><span class="p">:</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">web</span><span class="p">:</span><span class="n">stable</span>
        <span class="n">deploy</span><span class="p">:</span>
            <span class="n">labels</span><span class="p">:</span>
                <span class="n">description</span><span class="p">:</span> <span class="s2">&quot;This is a web application service.&quot;</span>
</pre></div>
</div>
<hr class="docutils" />
<p>（3）mode</p>
<p>定义容器副本模式，可以为：</p>
<p>global：每个Swarm节点上只有一个该应用容器；</p>
<p>replicated：整个集群中存在指定份数的应用容器副本，默认值。</p>
<p>例如，指定集群中web应用保持3个副本：</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span>
<span class="n">services</span><span class="p">:</span>
    <span class="n">web</span><span class="p">:</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">web</span><span class="p">:</span><span class="n">stable</span>
        <span class="n">deploy</span><span class="p">:</span>
            <span class="n">mode</span><span class="p">:</span> <span class="n">replicated</span>
            <span class="n">replicas</span><span class="p">:</span> <span class="mi">3</span>
</pre></div>
</div>
<hr class="docutils" />
<p>（4）placement</p>
<p>定义容器放置的限制（constraints）和配置（preferences）。限制可以指定只有符合要求的节点上才能运行该应用容器；配置可以指定容器的分配策略。例如，指定集群中web应用容器只存在于高安全的节点上，并且在带有zone标签的节点上均匀分配。：</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s1">&#39;3&#39;</span>
<span class="n">services</span><span class="p">:</span>
    <span class="n">db</span><span class="p">:</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">web</span><span class="p">:</span><span class="n">stable</span>
        <span class="n">deploy</span><span class="p">:</span>
            <span class="n">placement</span><span class="p">:</span>
                <span class="n">constraints</span><span class="p">:</span>
                    <span class="o">-</span> <span class="n">node</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">security</span><span class="o">==</span><span class="n">high</span>
                <span class="n">preferences</span><span class="p">:</span>
                    <span class="o">-</span> <span class="n">spread</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">zone</span>
</pre></div>
</div>
<hr class="docutils" />
<p>（5）replicas</p>
<p>容器副本模式为默认的replicated时，指定副本的个数。</p>
<p>（6）resources</p>
<p>指定使用资源的限制，包括CPU、内存资源等。例如，指定应用使用的CPU份额为10%～25%，内存为200
MB到500 MB。</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s1">&#39;3&#39;</span>
<span class="n">services</span><span class="p">:</span>
    <span class="n">redis</span><span class="p">:</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">web</span><span class="p">:</span><span class="n">stable</span>
        <span class="n">deploy</span><span class="p">:</span>
            <span class="n">resources</span><span class="p">:</span>
                <span class="n">limits</span><span class="p">:</span>
                    <span class="n">cpus</span><span class="p">:</span> <span class="s1">&#39;0.25&#39;</span>
                    <span class="n">memory</span><span class="p">:</span> <span class="mi">500</span><span class="n">M</span>
                <span class="n">reservations</span><span class="p">:</span>
                    <span class="n">cpus</span><span class="p">:</span> <span class="s1">&#39;0.10&#39;</span>
                    <span class="n">memory</span><span class="p">:</span> <span class="mi">200</span><span class="n">M</span>
</pre></div>
</div>
<hr class="docutils" />
<p>（7）restart_policy</p>
<p>指定容器重启的策略。例如，指定重启策略为失败时重启，等待2s，重启最多尝试3次，检测状态的等待时间为10s。</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span>
<span class="n">services</span><span class="p">:</span>
    <span class="n">redis</span><span class="p">:</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">web</span><span class="p">:</span><span class="n">stable</span>
        <span class="n">deploy</span><span class="p">:</span>
            <span class="n">restart_policy</span><span class="p">:</span>
                <span class="n">condition</span><span class="p">:</span> <span class="n">on</span><span class="o">-</span><span class="n">failure</span>
                <span class="n">delay</span><span class="p">:</span> <span class="mi">2</span><span class="n">s</span>
                <span class="n">max_attempts</span><span class="p">:</span> <span class="mi">3</span>
                <span class="n">window</span><span class="p">:</span> <span class="mi">10</span><span class="n">s</span>
</pre></div>
</div>
<hr class="docutils" />
<p>（8）update_config</p>
<p>有些时候需要对容器内容进行更新，可以使用该配置指定升级的行为。包括每次升级多少个容器（parallelism）、升级的延迟（delay）、升级失败后的行动（failure_action）、检测升级后状态的等待时间（monitor）、升级后容忍的最大失败比例（max_failure_ratio）、升级顺序（order）等。例如，指定每次更新两个容器、更新等待10s、先停止旧容器再升级。</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s2">&quot;3.4&quot;</span>
<span class="n">services</span><span class="p">:</span>
    <span class="n">redis</span><span class="p">:</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">web</span><span class="p">:</span><span class="n">stable</span>
        <span class="n">deploy</span><span class="p">:</span>
            <span class="n">replicas</span><span class="p">:</span> <span class="mi">2</span>
            <span class="n">update_config</span><span class="p">:</span>
                <span class="n">parallelism</span><span class="p">:</span> <span class="mi">2</span>
                <span class="n">delay</span><span class="p">:</span> <span class="mi">10</span><span class="n">s</span>
                <span class="n">order</span><span class="p">:</span> <span class="n">stop</span><span class="o">-</span><span class="n">first</span>
</pre></div>
</div>
<hr class="docutils" />
<p>39.其他指令</p>
<p>此外，还有包括domainname、hostname、ipc、mac_address、privileged、read_only、shm_size、stdin_open、tty、user、working_dir等指令，基本跟docker-run中对应参数的功能一致。例如，指定容器中工作目录：</p>
<hr class="docutils" />
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">working_dir</span><span class="p">:</span> <span class="o">/</span><span class="n">code</span>
</pre></div>
</div>
<hr class="docutils" />
<p>指定容器中搜索域名、主机名、mac地址等：</p>
<hr class="docutils" />
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">domainname</span><span class="p">:</span> <span class="n">your_website</span><span class="o">.</span><span class="n">com</span>
<span class="n">hostname</span><span class="p">:</span> <span class="n">test</span>
<span class="n">mac_address</span><span class="p">:</span> <span class="mi">08</span><span class="o">-</span><span class="mi">00</span><span class="o">-</span><span class="mi">27</span><span class="o">-</span><span class="mi">00</span><span class="o">-</span><span class="mi">0</span><span class="n">C</span><span class="o">-</span><span class="mi">0</span><span class="n">A</span>
</pre></div>
</div>
<hr class="docutils" />
<p>允许容器中运行一些特权命令：</p>
<hr class="docutils" />
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">privileged</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
<hr class="docutils" />
<p>40.读取环境变量</p>
<p>从1.5.0版本开始，Compose模板文件支持动态读取主机的系统环境变量。例如，下面的Compose文件将从运行它的环境中读取变量${MONGO_VERSION}的值（不指定时则采用默认值3.2），并写入执行的指令中。</p>
<hr class="docutils" />
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">db</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="s2">&quot;mongo:${MONGO_VERSION-3.2}&quot;</span>
</pre></div>
</div>
<hr class="docutils" />
<p>如果直接执行docker-compose
up则会启动一个mongo：3.2镜像的容器；如果执行MONGO_VERSION=2.8
docker-compose up则会启动一个mongo：2.8镜像的容器。</p>
<p>41.扩展特性</p>
<p>从3.4开始，Compose还支持用户自定义的扩展字段。利用YAML语法里的锚点引用功能来引用自定义字段内容。例如：</p>
<hr class="docutils" />
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s1">&#39;3.4&#39;</span>
<span class="n">x</span><span class="o">-</span><span class="n">logging</span><span class="p">:</span>
    <span class="o">&amp;</span><span class="n">default</span><span class="o">-</span><span class="n">logging</span>
    <span class="n">options</span><span class="p">:</span>
        <span class="nb">max</span><span class="o">-</span><span class="n">size</span><span class="p">:</span> <span class="s1">&#39;10m&#39;</span>
        <span class="nb">max</span><span class="o">-</span><span class="n">file</span><span class="p">:</span> <span class="s1">&#39;10&#39;</span>
    <span class="n">driver</span><span class="p">:</span> <span class="n">json</span><span class="o">-</span><span class="n">file</span>
<span class="n">services</span><span class="p">:</span>
    <span class="n">web</span><span class="p">:</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">webapp</span><span class="p">:</span><span class="n">stable</span>
        <span class="n">logging</span><span class="p">:</span> <span class="o">*</span><span class="n">default</span><span class="o">-</span><span class="n">logging</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h2><a class="toc-backref" href="#id20">Compose命令说明</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<p>对于Compose来说，大部分命令的对象既可以是项目本身，也可以指定为项目中的服务或者容器。如果没有特别的说明，命令对象将是项目，这意味着项目中所有的服务都会受到命令影响。</p>
<p>执行docker-compose[COMMAND]–help或者docker-compose
help[COMMAND]可以查看具体某个命令的使用格式。</p>
<p>Compose命令的基本的使用格式是：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="p">[</span><span class="o">-</span><span class="n">f</span><span class="o">=&lt;</span><span class="n">arg</span><span class="o">&gt;...</span><span class="p">]</span> <span class="p">[</span><span class="n">options</span><span class="p">]</span> <span class="p">[</span><span class="n">COMMAND</span><span class="p">]</span> <span class="p">[</span><span class="n">ARGS</span><span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
<hr class="docutils" />
<p>命令选项如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>·-f，--file FILE：指定使用的Compose模板文件，默认为docker-compose.yml，可以多次指定；

·-p，--project-name NAME：指定项目名称，默认将使用所在目录名称作为项目名；

·--verbose：输出更多调试信息；

·-v，--version：打印版本并退出；

·-H，-host HOST：指定所操作的Docker服务地址；

·-tls：启用TLS，如果指定-tlsverify则默认开启；

·-tlscacert CA_PATH：信任的TLS CA的证书；

·-tlscert CLIENT_CERT_PATH：客户端使用的TLS证书；

·-tlskey TLS_KEY_PATH：TLS的私钥文件路径；

·-tlsverify：使用TLS校验连接对方；

·-skip-hostname-check：不使用TLS证书校验对方的主机名；

·-project-directory PATH：指定工作目录，默认为Compose文件所在路径。
</pre></div>
</div>
<p>命令列表见表24-2。</p>
<p>表24-2　Compose命令</p>
<div class="figure">
<img alt="" src="../_images/docker_compose_cmd00004.png" />
</div>
<div class="section" id="id7">
<h3><a class="toc-backref" href="#id21">Compose命令使用说明如下</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<div class="section" id="build">
<h4>1.build<a class="headerlink" href="#build" title="Permalink to this headline">¶</a></h4>
<p>格式为<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">build</span> <span class="pre">[options]</span> <span class="pre">[SERVICE...]</span></code>。</p>
<p>构建（重新构建）项目中的服务容器。</p>
<p>服务容器一旦构建后，将会带上一个标记名，例如对于Web项目中的一个db容器，可能是web_db。</p>
<p>可以随时在项目目录下运行docker-compose build来重新构建服务。</p>
<p>选项包括：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>·--force-rm：强制删除构建过程中的临时容器；
·--no-cache：构建镜像过程中不使用cache（这将加长构建过程）；
·--pull：始终尝试通过pull来获取更新版本的镜像；
·-m，-memory MEM：指定创建服务所使用的内存限制；
·-build-arg key=val：指定服务创建时的参数。
</pre></div>
</div>
</div>
<div class="section" id="bundle">
<h4>2.bundle<a class="headerlink" href="#bundle" title="Permalink to this headline">¶</a></h4>
<p>格式为<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">bundle</span> <span class="pre">[options]</span></code>。</p>
<p>创建一个可分发（Distributed Application
Bundle，DAB）的配置包，包括整个服务栈的所有数据，他人可以利用该文件启动服务栈。</p>
<p>支持选项包括：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>·-push-images：自动推送镜像到仓库；
·-o，-output PATH：配置包的导出路径。
</pre></div>
</div>
</div>
<div class="section" id="config">
<h4>3.config<a class="headerlink" href="#config" title="Permalink to this headline">¶</a></h4>
<p>格式为<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">config</span> <span class="pre">[options]</span></code>。</p>
<p>校验和查看Compose文件的配置信息。</p>
<p>支持选项包括：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>·-resolve-image-digests：为镜像添加对应的摘要信息；
·-q，-quiet：只检验格式正确与否，不输出内容；
·-services：打印出Compose中所有的服务信息；
·-volumes：打印出Compose中所有的挂载卷信息；
</pre></div>
</div>
</div>
<div class="section" id="down">
<h4>4.down<a class="headerlink" href="#down" title="Permalink to this headline">¶</a></h4>
<p>格式为<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">down</span> <span class="pre">[options]</span></code>。</p>
<p>停止服务栈，并删除相关资源，包括容器、挂载卷、网络、创建镜像等。</p>
<p>默认情况下只清除所创建的容器和网络资源。</p>
<p>支持选项包括：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>·-rmi type：指定删除镜像的类型，包括all（所有镜像），local（仅本地）；
·-v，-volumes：删除挂载数据卷；
·-remove-orphans：清除孤儿容器，即未在Compose服务中定义的容器；
·-t，-timeout TIMEOUT：指定超时时间，默认为10s。
</pre></div>
</div>
</div>
<div class="section" id="events">
<h4>5.events<a class="headerlink" href="#events" title="Permalink to this headline">¶</a></h4>
<p>格式为<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">events</span> <span class="pre">[options]</span> <span class="pre">[SERVICE...]</span></code>。</p>
<p>实时监控容器的事件信息。</p>
<p>支持选项包括-json：以Json对象流格式输出事件信息。</p>
</div>
<div class="section" id="exec">
<h4>6.exec<a class="headerlink" href="#exec" title="Permalink to this headline">¶</a></h4>
<p>格式为<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">exec</span> <span class="pre">[options]</span> <span class="pre">[-e</span> <span class="pre">KEY=VAL...]</span> <span class="pre">SERVICE</span> <span class="pre">COMMAND[ARGS...]</span></code>。</p>
<p>在一个运行中的容器内执行给定命令。</p>
<p>支持选项包括：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>·-d：在后台运行命令；
·-privileged：以特权角色运行命令；
·-u，-user USER：以给定用户身份运行命令；
·-T：不分配TTY伪终端，默认情况下会打开；
·-index=index：当服务有多个容器实例时指定容器索引，默认为第一个；
·-e，-env KEY=VAL：设置环境变量。
</pre></div>
</div>
</div>
<div class="section" id="help">
<h4>7.help<a class="headerlink" href="#help" title="Permalink to this headline">¶</a></h4>
<p>获得一个命令的帮助。</p>
</div>
<div class="section" id="images">
<h4>8.images<a class="headerlink" href="#images" title="Permalink to this headline">¶</a></h4>
<p>格式为<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">images</span> <span class="pre">[options]</span> <span class="pre">[SERVICE...]。</span></code></p>
<p>列出服务所创建的镜像。</p>
<p>支持选项为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>·-q：仅显示镜像的ID。
</pre></div>
</div>
</div>
<div class="section" id="kill">
<h4>9.kill<a class="headerlink" href="#kill" title="Permalink to this headline">¶</a></h4>
<p>格式为<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">kill</span> <span class="pre">[options]</span> <span class="pre">[SERVICE...]。</span></code></p>
<p>通过发送SIGKILL信号来强制停止服务容器。</p>
<p>支持通过-s参数来指定发送的信号，例如通过如下指令发送SIGINT信号。</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker-compose kill -s SIGINT
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="logs">
<h4>10.logs<a class="headerlink" href="#logs" title="Permalink to this headline">¶</a></h4>
<p>格式为<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">logs</span> <span class="pre">[options]</span> <span class="pre">[SERVICE...]。</span></code></p>
<p>查看服务容器的输出。默认情况下，docker-compose将对不同的服务输出使用不同的颜色来区分。可以通过–no-color来关闭颜色。</p>
<p>该命令在调试问题的时候十分有用。</p>
<p>支持选项为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>·-no-color：关闭彩色输出；

·-f，-follow：持续跟踪输出日志消息；

·-t，-timestamps：显示时间戳信息；

·-tail=&quot;all&quot;：仅显示指定行数的最新日志消息。
</pre></div>
</div>
</div>
<div class="section" id="pause">
<h4>11.pause<a class="headerlink" href="#pause" title="Permalink to this headline">¶</a></h4>
<p>格式为<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">pause</span> <span class="pre">[SERVICE...]。</span></code></p>
<p>暂停一个服务容器。</p>
</div>
<div class="section" id="port">
<h4>12.port<a class="headerlink" href="#port" title="Permalink to this headline">¶</a></h4>
<p>格式为<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">port</span> <span class="pre">[options]</span> <span class="pre">SERVICE</span> <span class="pre">PRIVATE_PORT。</span></code></p>
<p>打印某个容器端口所映射的公共端口。</p>
<p>选项：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>·--protocol=proto：指定端口协议，tcp（默认值）或者udp；

·--index=index：如果同一服务存在多个容器，指定命令对象容器的序号（默认为1）。
</pre></div>
</div>
</div>
<div class="section" id="ps">
<h4>13.ps<a class="headerlink" href="#ps" title="Permalink to this headline">¶</a></h4>
<p>格式为<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">ps</span> <span class="pre">[options]</span> <span class="pre">[SERVICE...]。</span></code></p>
<p>列出项目中目前的所有容器。</p>
<p>选项包括-q：只打印容器的ID信息。</p>
</div>
<div class="section" id="pull">
<h4>14.pull<a class="headerlink" href="#pull" title="Permalink to this headline">¶</a></h4>
<p>格式为<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">pull</span> <span class="pre">[options]</span> <span class="pre">[SERVICE...]。</span></code></p>
<p>拉取服务依赖的镜像。</p>
<p>选项包括<code class="docutils literal notranslate"><span class="pre">--ignore-pull-failures：忽略拉取镜像过程中的错误。</span></code></p>
</div>
<div class="section" id="push">
<h4>15.push<a class="headerlink" href="#push" title="Permalink to this headline">¶</a></h4>
<p>格式为<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">push</span> <span class="pre">[options]</span> <span class="pre">[SERVICE...]。</span></code></p>
<p>推送服务创建的镜像到镜像仓库。</p>
<p>选项包括-<code class="docutils literal notranslate"><span class="pre">-ignore-push-failures：忽略推送镜像过程中的错误。</span></code></p>
</div>
<div class="section" id="restart">
<h4>16.restart<a class="headerlink" href="#restart" title="Permalink to this headline">¶</a></h4>
<p>格式为<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">restart</span> <span class="pre">[options]</span> <span class="pre">[SERVICE...]。</span></code></p>
<p>重启项目中的服务。</p>
<p>选项包括<code class="docutils literal notranslate"><span class="pre">-t，--timeout</span> <span class="pre">TIMEOUT：指定重启前停止容器的超时（默认为10秒）。</span></code></p>
</div>
<div class="section" id="rm">
<h4>17.rm<a class="headerlink" href="#rm" title="Permalink to this headline">¶</a></h4>
<p>格式为<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">rm</span> <span class="pre">[options]</span> <span class="pre">[SERVICE...]。</span></code></p>
<p>删除所有（停止状态的）服务容器。推荐先执行docker-compose
stop命令来停止容器。</p>
<p>选项：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>·-f，--force：强制直接删除，包括非停止状态的容器。一般尽量不要使用该选项。

·-v：删除容器所挂载的数据卷。
</pre></div>
</div>
</div>
<div class="section" id="run">
<h4>18.run<a class="headerlink" href="#run" title="Permalink to this headline">¶</a></h4>
<p>格式为<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">run</span> <span class="pre">[options]</span> <span class="pre">[-p</span> <span class="pre">PORT...]</span> <span class="pre">[-e</span> <span class="pre">KEY=VAL...]</span> <span class="pre">SERVICE</span> <span class="pre">[COMMAND]</span> <span class="pre">[ARGS...]。</span></code></p>
<p>在指定服务上执行一个命令。</p>
<p>例如：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker-compose run ubuntu ping docker.com
</pre></div>
</div>
<hr class="docutils" />
<p>将会启动一个ubuntu服务容器，并执行ping docker.com命令。</p>
<p>默认情况下，如果存在关联，则所有关联的服务将会自动被启动，除非这些服务已经在运行中。</p>
<p>该命令类似启动容器后运行指定的命令，相关卷、链接等等都将会按照配置自动创建。</p>
<p>两个不同点：</p>
<p>·给定命令将会覆盖原有的自动运行命令；</p>
<p>·会自动创建端口，以避免冲突。</p>
<p>如果不希望自动启动关联的容器，可以使用–no-deps选项，例如</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker-compose run --no-deps web python manage.py shell
</pre></div>
</div>
<hr class="docutils" />
<p>将不会启动web容器所关联的其他容器。</p>
<p>选项：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>·-d：后台运行容器；
·--name NAME：为容器指定一个名字；
·--entrypoint CMD：覆盖默认的容器启动指令；
·-e KEY=VAL：设置环境变量值，可多次使用选项来设置多个环境变量；
·-u，--user=&quot;&quot;：指定运行容器的用户名或者uid；
·--no-deps：不自动启动关联的服务容器；
·--rm：运行命令后自动删除容器，d模式下将忽略；
·-p，--publish=[]：映射容器端口到本地主机；
·--service-ports：配置服务端口并映射到本地主机；
·-T：不分配伪tty，意味着依赖tty的指令将无法运行。
</pre></div>
</div>
</div>
<div class="section" id="scale">
<h4>19.scale<a class="headerlink" href="#scale" title="Permalink to this headline">¶</a></h4>
<p>格式为<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">scale[options]</span> <span class="pre">[SERVICE=NUM...]。</span></code></p>
<p>设置指定服务运行的容器个数。</p>
<p>通过service=num的参数来设置数量。例如：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker-compose scale web=3 db=2
</pre></div>
</div>
<hr class="docutils" />
<p>将启动3个容器运行web服务，2个容器运行db服务。</p>
<p>一般的，当指定数目多于该服务当前实际运行容器，将新创建并启动容器；反之，将停止容器。</p>
<p>选项包括-t，–timeout TIMEOUT：停止容器时候的超时（默认为10秒）。</p>
</div>
<div class="section" id="start">
<h4>20.start<a class="headerlink" href="#start" title="Permalink to this headline">¶</a></h4>
<p>格式为<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">start</span> <span class="pre">[SERVICE...]。</span></code></p>
<p>启动已经存在的服务容器。</p>
</div>
<div class="section" id="stop">
<h4>21.stop<a class="headerlink" href="#stop" title="Permalink to this headline">¶</a></h4>
<p>格式为<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">stop[options]</span> <span class="pre">[SERVICE...]。</span></code></p>
<p>停止已经处于运行状态的容器，但不删除它。通过docker-compose
start可以再次启动这些容器。</p>
<p>选项包括-t，–timeout TIMEOUT：停止容器时候的超时（默认为10秒）。</p>
</div>
<div class="section" id="top">
<h4>22.top<a class="headerlink" href="#top" title="Permalink to this headline">¶</a></h4>
<p>格式为<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">top</span> <span class="pre">[SERVICE...]。</span></code></p>
<p>显示服务栈中正在运行的进程信息。</p>
</div>
<div class="section" id="unpause">
<h4>23.unpause<a class="headerlink" href="#unpause" title="Permalink to this headline">¶</a></h4>
<p>格式为<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">unpause</span> <span class="pre">[SERVICE...]。</span></code></p>
<p>恢复处于暂停状态中的服务。</p>
</div>
<div class="section" id="up">
<h4>24.up<a class="headerlink" href="#up" title="Permalink to this headline">¶</a></h4>
<p>格式为<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">up[options]</span> <span class="pre">[SERVICE...]。</span></code></p>
<p>该命令十分强大，它将尝试自动完成包括构建镜像，（重新）创建服务，启动服务，并关联服务相关容器的一系列操作。</p>
<p>链接的服务都将会被自动启动，除非已经处于运行状态。</p>
<p>可以说，大部分时候都可以直接通过该命令来启动一个项目。</p>
<p>默认情况，docker-compose
up启动的容器都在前台，控制台将会同时打印所有容器的输出信息，可以很方便进行调试。</p>
<p>当通过Ctrl-C停止命令时，所有容器将会停止。</p>
<p>如果使用<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">up</span> <span class="pre">-d</span></code>，将会在后台启动并运行所有的容器。一般推荐生产环境下使用该选项。</p>
<p>默认情况，如果服务容器已经存在，docker-compose
up将会尝试停止容器，然后重新创建（保持使用volumes-from挂载的卷），以保证新启动的服务匹配docker-compose.yml文件的最新内容。如果用户不希望容器被停止并重新创建，可以使用<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">up--no-recreate</span></code>。这样将只会启动处于停止状态的容器，而忽略已经运行的服务。如果用户只想重新部署某个服务，可以使用<code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">up--no-deps-d&lt;SERVICE_NAME&gt;</span></code>来重新创建服务并后台停止旧服务，启动新服务，并不会影响到其所依赖的服务。</p>
<p>选项：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>·-d：在后台运行服务容器；
·--no-color：不使用颜色来区分不同的服务的控制台输出；
·--no-deps：不启动服务所链接的容器；
·--force-recreate：强制重新创建容器，不能与--no-recreate同时使用；
·--no-recreate：如果容器已经存在了，则不重新创建，不能与--force-recreate同时使用；

·--no-build：不自动构建缺失的服务镜像；
·--abort-on-container-exit：当有容器停止时中止整个服务，与-d选项冲突。

·-t，--timeout TIMEOUT：停止容器时候的超时（默认为10秒），与-d选项冲突；
·--remove-orphans：删除服务中未定义的孤儿容器；
·--exit-code-from SERVICE：退出时返回指定服务容器的退出符；
·--scale SERVICE=NUM：扩展指定服务实例到指定数目。
</pre></div>
</div>
</div>
<div class="section" id="version">
<h4>25.version<a class="headerlink" href="#version" title="Permalink to this headline">¶</a></h4>
<p>格式为docker-compose version。</p>
<p>打印版本信息。</p>
</div>
</div>
</div>
<div class="section" id="docker-compose-yml">
<h2><a class="toc-backref" href="#id22">docker-compose.yml文件配置项</a><a class="headerlink" href="#docker-compose-yml" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://docs.docker.com/compose/compose-file/#reference-and-guidelines">https://docs.docker.com/compose/compose-file/#reference-and-guidelines</a></p>
</div>
<div class="section" id="id8">
<h2><a class="toc-backref" href="#id23">Compose环境变量</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p>环境变量可以用来配置Compose的行为，参见表24-3。</p>
<p>表24-3　Compose环境变量</p>
<div class="figure">
<img alt="" src="../_images/docker_compose_env00001.png" />
</div>
</div>
<div class="section" id="compose-web">
<h2><a class="toc-backref" href="#id24">Compose应用案例一：Web负载均衡</a><a class="headerlink" href="#compose-web" title="Permalink to this headline">¶</a></h2>
<p>负载均衡器+Web应用是十分经典的应用结构。下面，笔者将创建一个该结构的Web项目：一个Haproxy作为负载均衡器，后端挂载三个Web容器。</p>
<p>首先创建一个haproxy_web目录，作为项目工作目录，并在其中分别创建两个子目录：web和haproxy。</p>
<div class="section" id="web">
<h3><a class="toc-backref" href="#id25">1.web子目录</a><a class="headerlink" href="#web" title="Permalink to this headline">¶</a></h3>
<p>在web子目录下将放置所需Web应用代码和Dockerfile，一会将生成需要的Web镜像。</p>
<p>这里用Python程序来实现一个简单的Web应用，该应用能响应HTTP请求，返回的页面将打印出访问者的IP和响应请求的后端容器的IP。</p>
<p>编写一个index.py作为服务器文件，代码为：</p>
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python</span>
<span class="c1">#authors: yeasy.github.com</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">BaseHTTPServer</span>
<span class="kn">from</span> <span class="nn">SimpleHTTPServer</span> <span class="k">import</span> <span class="n">SimpleHTTPRequestHandler</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">fcntl</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="k">class</span> <span class="nc">HandlerClass</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_ip_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ifname</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">socket</span><span class="o">.</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">fcntl</span><span class="o">.</span><span class="n">ioctl</span><span class="p">(</span>
            <span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span>
            <span class="mh">0x8915</span><span class="p">,</span>  <span class="c1"># SIOCGIFADDR</span>
            <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;256s&#39;</span><span class="p">,</span> <span class="n">ifname</span><span class="p">[:</span><span class="mi">15</span><span class="p">])</span>
        <span class="p">)[</span><span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">log_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="s2">&quot;200&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;pickle_data.txt&quot;</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">request</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">time_now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">time_now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
        <span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ip_address</span><span class="p">(</span><span class="s1">&#39;eth0&#39;</span><span class="p">)</span>
        <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">address_string</span><span class="p">()</span>
        <span class="n">addr_pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">server</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">addr_pair</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="p">:</span>
            <span class="n">request</span><span class="p">[</span><span class="n">addr_pair</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ts</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="n">addr_pair</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">del</span> <span class="n">request</span><span class="p">[</span><span class="n">addr_pair</span><span class="p">]</span>
            <span class="n">request</span><span class="p">[</span><span class="n">addr_pair</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">num</span><span class="p">,</span><span class="n">ts</span><span class="p">]</span>
        <span class="n">file</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;index.html&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;!DOCTYPE html&gt; &lt;html&gt; &lt;body&gt;&lt;center&gt;&lt;h1&gt;&lt;font color=</span><span class="se">\&quot;</span><span class="s2">blue</span><span class="se">\&quot;</span><span class="s2"> face=</span><span class="se">\&quot;</span><span class="s2">Georgia, Arial</span><span class="se">\&quot;</span><span class="s2"> size=8&gt;&lt;em&gt;HA&lt;/em&gt;&lt;/font&gt; Webpage Visit Results&lt;/h1&gt;&lt;/center&gt;&quot;</span><span class="p">);</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">request</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">host</span><span class="p">:</span>
                <span class="n">guest</span> <span class="o">=</span> <span class="s2">&quot;LOCAL: &quot;</span><span class="o">+</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">guest</span> <span class="o">=</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">time_now</span><span class="o">-</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">seconds</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;p style=</span><span class="se">\&quot;</span><span class="s2">font-size:150%</span><span class="se">\&quot;</span><span class="s2"> &gt;#&quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span><span class="s2">&quot;: &lt;font color=</span><span class="se">\&quot;</span><span class="s2">red</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span> <span class="s2">&quot;&lt;/font&gt; requests &quot;</span> <span class="o">+</span> <span class="s2">&quot;from &amp;lt&lt;font color=</span><span class="se">\&quot;</span><span class="s2">blue</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span><span class="o">+</span><span class="n">guest</span><span class="o">+</span><span class="s2">&quot;&lt;/font&gt;&amp;gt to WebServer &amp;lt&lt;font color=</span><span class="se">\&quot;</span><span class="s2">blue</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span><span class="o">+</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;&lt;/font&gt;&amp;gt&lt;/p&gt;&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;p style=</span><span class="se">\&quot;</span><span class="s2">font-size:150%</span><span class="se">\&quot;</span><span class="s2"> &gt;#&quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span><span class="s2">&quot;: &lt;font color=</span><span class="se">\&quot;</span><span class="s2">maroon</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span> <span class="s2">&quot;&lt;/font&gt; requests &quot;</span> <span class="o">+</span> <span class="s2">&quot;from &amp;lt&lt;font color=</span><span class="se">\&quot;</span><span class="s2">navy</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span><span class="o">+</span><span class="n">guest</span><span class="o">+</span><span class="s2">&quot;&lt;/font&gt;&amp;gt to WebServer &amp;lt&lt;font color=</span><span class="se">\&quot;</span><span class="s2">navy</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span><span class="o">+</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;&lt;/font&gt;&amp;gt&lt;/p&gt;&quot;</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;/body&gt; &lt;/html&gt;&quot;</span><span class="p">);</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;pickle_data.txt&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">))</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ServerClass</span>  <span class="o">=</span> <span class="n">BaseHTTPServer</span><span class="o">.</span><span class="n">HTTPServer</span>
        <span class="n">Protocol</span>     <span class="o">=</span> <span class="s2">&quot;HTTP/1.0&quot;</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="s2">&quot;0.0.0.0&quot;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">port</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="mi">80</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">HandlerClass</span><span class="o">.</span><span class="n">protocol_version</span> <span class="o">=</span> <span class="n">Protocol</span>
        <span class="n">httpd</span> <span class="o">=</span> <span class="n">ServerClass</span><span class="p">((</span><span class="n">addr</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="n">HandlerClass</span><span class="p">)</span>
        <span class="n">sa</span> <span class="o">=</span> <span class="n">httpd</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
        <span class="nb">print</span> <span class="s2">&quot;Serving HTTP on&quot;</span><span class="p">,</span> <span class="n">sa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;port&quot;</span><span class="p">,</span> <span class="n">sa</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;...&quot;</span>
        <span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">exit</span><span class="p">()</span>
</pre></div>
</div>
<hr class="docutils" />
<p>生成一个临时的index.html文件，其内容会被index.py来更新：</p>
<hr class="docutils" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ touch index.html
</pre></div>
</div>
<hr class="docutils" />
<p>生成一个Dockerfile，部署该Web应用，内容为：</p>
<hr class="docutils" />
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FROM</span> <span class="n">python</span><span class="p">:</span><span class="mf">2.7</span>
<span class="n">WORKDIR</span> <span class="o">/</span><span class="n">code</span>
<span class="n">ADD</span> <span class="o">.</span> <span class="o">/</span><span class="n">code</span>
<span class="n">EXPOSE</span> <span class="mi">80</span>
<span class="n">CMD</span> <span class="n">python</span> <span class="n">index</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="haproxy">
<h3><a class="toc-backref" href="#id26">2.haproxy目录</a><a class="headerlink" href="#haproxy" title="Permalink to this headline">¶</a></h3>
<p>该目录将配置haproxy镜像。在其中生成一个haproxy.cfg文件，内容为：</p>
<hr class="docutils" />
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">global</span>
    <span class="n">log</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">local0</span>
    <span class="n">log</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">local1</span> <span class="n">notice</span>
    <span class="n">maxconn</span> <span class="mi">4096</span>
<span class="n">defaults</span>
    <span class="n">log</span> <span class="k">global</span>
    <span class="n">mode</span> <span class="n">http</span>
    <span class="n">option</span> <span class="n">httplog</span>
    <span class="n">option</span> <span class="n">dontlognull</span>
    <span class="n">timeout</span> <span class="n">connect</span> <span class="mi">5000</span><span class="n">ms</span>
    <span class="n">timeout</span> <span class="n">client</span> <span class="mi">50000</span><span class="n">ms</span>
    <span class="n">timeout</span> <span class="n">server</span> <span class="mi">50000</span><span class="n">ms</span>
<span class="n">listen</span> <span class="n">stats</span>
    <span class="n">bind</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">70</span>
    <span class="n">mode</span> <span class="n">http</span>
    <span class="n">stats</span> <span class="n">enable</span>
    <span class="n">stats</span> <span class="n">hide</span><span class="o">-</span><span class="n">version</span>
    <span class="n">stats</span> <span class="n">scope</span> <span class="o">.</span>
    <span class="n">stats</span> <span class="n">realm</span> <span class="n">Haproxy</span>\ <span class="n">Statistics</span>
    <span class="n">stats</span> <span class="n">uri</span> <span class="o">/</span>
    <span class="n">stats</span> <span class="n">auth</span> <span class="n">user</span><span class="p">:</span><span class="k">pass</span>
<span class="n">frontend</span> <span class="n">balancer</span>
    <span class="n">bind</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">80</span>
    <span class="n">mode</span> <span class="n">http</span>
    <span class="n">default_backend</span> <span class="n">web_backends</span>
<span class="n">backend</span> <span class="n">web_backends</span>
    <span class="n">mode</span> <span class="n">http</span>
    <span class="n">option</span> <span class="n">forwardfor</span>
    <span class="n">balance</span> <span class="n">roundrobin</span>
    <span class="n">server</span> <span class="n">weba</span> <span class="n">weba</span><span class="p">:</span><span class="mi">80</span> <span class="n">check</span>
    <span class="n">server</span> <span class="n">webb</span> <span class="n">webb</span><span class="p">:</span><span class="mi">80</span> <span class="n">check</span>
    <span class="n">server</span> <span class="n">webc</span> <span class="n">webc</span><span class="p">:</span><span class="mi">80</span> <span class="n">check</span>
    <span class="n">option</span> <span class="n">httpchk</span> <span class="n">GET</span> <span class="o">/</span>
    <span class="n">http</span><span class="o">-</span><span class="n">check</span> <span class="n">expect</span> <span class="n">status</span> <span class="mi">200</span>
</pre></div>
</div>
<hr class="docutils" />
<p>3.docker-compose.yml</p>
<p>在haproxy_web目录下编写一个docker-compose.yml文件，该文件是Compose使用的主模板文件。其中，指定启动3个Web容器（weba、webb、webc），以及1个haproxy容器：</p>
<hr class="docutils" />
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This will start a haproxy and three web services. haproxy will act as a loadbalancer.</span>
<span class="c1"># Authors: yeasy.github.com</span>
<span class="n">weba</span><span class="p">:</span>
    <span class="n">build</span><span class="p">:</span> <span class="o">./</span><span class="n">web</span>
    <span class="n">expose</span><span class="p">:</span>
        <span class="o">-</span> <span class="mi">80</span>
<span class="n">webb</span><span class="p">:</span>
    <span class="n">build</span><span class="p">:</span> <span class="o">./</span><span class="n">web</span>
    <span class="n">expose</span><span class="p">:</span>
        <span class="o">-</span> <span class="mi">80</span>
<span class="n">webc</span><span class="p">:</span>
    <span class="n">build</span><span class="p">:</span> <span class="o">./</span><span class="n">web</span>
    <span class="n">expose</span><span class="p">:</span>
        <span class="o">-</span> <span class="mi">80</span>
<span class="n">haproxy</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">haproxy</span><span class="p">:</span><span class="mf">1.6</span>
    <span class="n">volumes</span><span class="p">:</span>
        <span class="o">-</span> <span class="o">./</span><span class="n">haproxy</span><span class="p">:</span><span class="o">/</span><span class="n">haproxy</span><span class="o">-</span><span class="n">override</span>
        <span class="o">-</span> <span class="o">./</span><span class="n">haproxy</span><span class="o">/</span><span class="n">haproxy</span><span class="o">.</span><span class="n">cfg</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">haproxy</span><span class="o">/</span><span class="n">haproxy</span><span class="o">.</span><span class="n">cfg</span><span class="p">:</span><span class="n">ro</span>
    <span class="n">links</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">weba</span>
        <span class="o">-</span> <span class="n">webb</span>
        <span class="o">-</span> <span class="n">webc</span>
    <span class="n">ports</span><span class="p">:</span>
        <span class="o">-</span> <span class="s2">&quot;80:80&quot;</span>
        <span class="o">-</span> <span class="s2">&quot;70:70&quot;</span>
</pre></div>
</div>
<hr class="docutils" />
<p>4.运行compose项目</p>
<p>现在haproxy_web目录应该长成下面的样子：</p>
<hr class="docutils" />
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span>[root@k8s-node1 haproxy_web]# tree -L 3
.
├── docker-compose.yml
├── haproxy
│   └── haproxy.cfg
└── web
    ├── Dockerfile
    ├── index.html
    └── index.py

2 directories, 5 files
</pre></div>
</div>
<hr class="docutils" />
<p>在该目录下执行sudo docker-compose
up命令，控制台会整合打印出所有容器的输出信息：</p>
<hr class="docutils" />
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo docker-compose up
Recreating haproxyweb_webb_1...
Recreating haproxyweb_webc_1...
Recreating composehaproxyweb_weba_1...
Recreating composehaproxyweb_haproxy_1...
Attaching to composehaproxyweb_webb_1, composehaproxyweb_webc_1, composeha-proxyweb_weba_1, composehaproxyweb_haproxy_1
</pre></div>
</div>
<hr class="docutils" />
<p>此时通过浏览器访问本地的80端口，会获取到页面信息，如图所示。</p>
<div class="figure">
<img alt="" src="../_images/docker_haproxy00001.png" />
</div>
<p>图24-1　访问本地80端口</p>
<p>经过haproxy自动转发到后端的某个Web容器上，刷新页面，可以观察到访问的容器地址的变化。</p>
<p>访问本地70端口，可以查看到haproxy的统计信息，如图所示。</p>
<div class="figure">
<img alt="" src="../_images/docker_haproxy00002.png" />
</div>
<p>查看本地的镜像，会发现Compose自动创建的haproxyweb_weba、haproxyweb_webb、haproxyweb_webc镜像：</p>
<hr class="docutils" />
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker images
REPOSITORY         TAG         IMAGE ID         CREATED            VIRTUAL SIZE
haproxyweb_webb    latest      33d5e6f5e20b     44 minutes ago     675.2 MB
haproxyweb_weba    latest      33d5e6f5e20b     44 minutes ago     675.2 MB
haproxyweb_webc    latest      33d5e6f5e20b     44 minutes ago     675.2 MB
</pre></div>
</div>
<hr class="docutils" />
<p>当然，还可以进一步使用consul等方案来实现服务自动发现，这样就可以不用手动指定后端的Web容器了，更为灵活。</p>
<p>Docker快速搭建一套PHP、Nginx、MySQL、Redis、Xdebug、Memcached
开发环境并演进。</p>
<p>python2.X上会出现一个问题，出现的问题如下：</p>
<div class="code shell highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">webb_1</span>     <span class="o">|</span> <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
<span class="n">webb_1</span>     <span class="o">|</span>   <span class="n">File</span> <span class="s2">&quot;/usr/local/lib/python2.7/SocketServer.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">290</span><span class="p">,</span> <span class="ow">in</span> <span class="n">_handle_request_noblock</span>
<span class="n">webb_1</span>     <span class="o">|</span>     <span class="bp">self</span><span class="o">.</span><span class="n">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">client_address</span><span class="p">)</span>
<span class="n">webb_1</span>     <span class="o">|</span>   <span class="n">File</span> <span class="s2">&quot;/usr/local/lib/python2.7/SocketServer.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">318</span><span class="p">,</span> <span class="ow">in</span> <span class="n">process_request</span>
<span class="n">webb_1</span>     <span class="o">|</span>     <span class="bp">self</span><span class="o">.</span><span class="n">finish_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">client_address</span><span class="p">)</span>
<span class="n">webb_1</span>     <span class="o">|</span>   <span class="n">File</span> <span class="s2">&quot;/usr/local/lib/python2.7/SocketServer.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">331</span><span class="p">,</span> <span class="ow">in</span> <span class="n">finish_request</span>
<span class="n">webb_1</span>     <span class="o">|</span>     <span class="bp">self</span><span class="o">.</span><span class="n">RequestHandlerClass</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">client_address</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
<span class="n">webb_1</span>     <span class="o">|</span>   <span class="n">File</span> <span class="s2">&quot;/usr/local/lib/python2.7/SocketServer.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">654</span><span class="p">,</span> <span class="ow">in</span> <span class="fm">__init__</span>
<span class="n">webb_1</span>     <span class="o">|</span>     <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
<span class="n">webb_1</span>     <span class="o">|</span>   <span class="n">File</span> <span class="s2">&quot;/usr/local/lib/python2.7/SocketServer.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">713</span><span class="p">,</span> <span class="ow">in</span> <span class="n">finish</span>
<span class="n">webb_1</span>     <span class="o">|</span>     <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">webb_1</span>     <span class="o">|</span>   <span class="n">File</span> <span class="s2">&quot;/usr/local/lib/python2.7/socket.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">283</span><span class="p">,</span> <span class="ow">in</span> <span class="n">close</span>
<span class="n">webb_1</span>     <span class="o">|</span>     <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
<span class="n">webb_1</span>     <span class="o">|</span>   <span class="n">File</span> <span class="s2">&quot;/usr/local/lib/python2.7/socket.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">307</span><span class="p">,</span> <span class="ow">in</span> <span class="n">flush</span>
<span class="n">webb_1</span>     <span class="o">|</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">view</span><span class="p">[</span><span class="n">write_offset</span><span class="p">:</span><span class="n">write_offset</span><span class="o">+</span><span class="n">buffer_size</span><span class="p">])</span>
<span class="n">webb_1</span>     <span class="o">|</span> <span class="n">error</span><span class="p">:</span> <span class="p">[</span><span class="n">Errno</span> <span class="mi">32</span><span class="p">]</span> <span class="n">Broken</span> <span class="n">pipe</span>
</pre></div>
</div>
<p>为了能够显示一下效果，在网上找了个python3的http服务代码(<a class="reference external" href="https://blog.csdn.net/aaa000830/article/details/79579579">https://blog.csdn.net/aaa000830/article/details/79579579</a>)替换上面的index.py:</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python3</span>
<span class="kn">from</span> <span class="nn">wsgiref.simple_server</span> <span class="k">import</span> <span class="n">make_server</span>
<span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">start_response</span><span class="p">(</span><span class="s1">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/html&#39;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;&lt;h1&gt;Hello, web!&lt;/h1&gt;&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">()]</span>

<span class="n">httpd</span> <span class="o">=</span> <span class="n">make_server</span><span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="n">application</span><span class="p">)</span>
<span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="compose-spark">
<h2><a class="toc-backref" href="#id27">Compose应用案例二：大数据Spark集群</a><a class="headerlink" href="#compose-spark" title="Permalink to this headline">¶</a></h2>
<p>Spark是Berkeley开发的分布式计算的框架，相对于Hadoop来说，Spark可以缓存中间结果到内存而提高某些需要迭代的计算场景的效率，目前收到广泛关注。</p>
<p>熟悉Hadoop的同学也不必担心，Spark很多设计理念和用法都跟Hadoop保持一致和相似，并且在使用上完全兼容HDFS。但是Spark的安装并不容易，依赖包括Java、Scala、HDFS等。</p>
<p>通过使用Docker
Compose，可以快速的在本地搭建一套Spark环境，方便大家开发Spark应用，或者扩展到生产环境。</p>
<p>1.准备工作</p>
<p>这里，笔者采用热门的sequenceiq/docker-spark镜像，这个镜像已经安装了对Spark的完整依赖。由于镜像比较大（2
GB多），推荐先下载镜像到本地：</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>$ docker pull sequenceiq/spark:1.4.0
</pre></div>
</div>
<p>（1）docker-compose.yml文件</p>
<p>首先新建一个spark_cluster目录，并在其中创建一个docker-compose.yml文件。文件内容如下：</p>
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">master</span><span class="p">:</span>
  <span class="n">image</span><span class="p">:</span> <span class="n">sequenceiq</span><span class="o">/</span><span class="n">spark</span><span class="p">:</span><span class="mf">1.4</span><span class="o">.</span><span class="mi">0</span>
  <span class="n">hostname</span><span class="p">:</span> <span class="n">master</span>
  <span class="n">ports</span><span class="p">:</span>
    <span class="o">-</span> <span class="s2">&quot;4040:4040&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;8042:8042&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;7077:7077&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;8088:8088&quot;</span>
      <span class="o">-</span> <span class="s2">&quot;8080:8080&quot;</span>
  <span class="n">restart</span><span class="p">:</span> <span class="n">always</span>
  <span class="n">deploy</span><span class="p">:</span>
    <span class="n">resources</span><span class="p">:</span>
      <span class="n">limits</span><span class="p">:</span>
        <span class="n">cpus</span><span class="p">:</span> <span class="s1">&#39;0.50&#39;</span>
        <span class="n">memory</span><span class="p">:</span> <span class="mi">1024</span><span class="n">M</span>
      <span class="n">reservations</span><span class="p">:</span>
        <span class="n">cpus</span><span class="p">:</span> <span class="s1">&#39;0.25&#39;</span>
        <span class="n">memory</span><span class="p">:</span> <span class="mi">256</span><span class="n">M</span>
  <span class="n">command</span><span class="p">:</span> <span class="n">bash</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">spark</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">start</span><span class="o">-</span><span class="n">master</span><span class="o">.</span><span class="n">sh</span> <span class="o">&amp;&amp;</span> <span class="n">ping</span> <span class="n">localhost</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span>

<span class="n">worker</span><span class="p">:</span>
  <span class="n">image</span><span class="p">:</span> <span class="n">sequenceiq</span><span class="o">/</span><span class="n">spark</span><span class="p">:</span><span class="mf">1.4</span><span class="o">.</span><span class="mi">0</span>
  <span class="n">links</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">master</span><span class="p">:</span><span class="n">master</span>
  <span class="n">expose</span><span class="p">:</span>
    <span class="o">-</span> <span class="s2">&quot;8081&quot;</span>
  <span class="n">restart</span><span class="p">:</span> <span class="n">always</span>
  <span class="n">command</span><span class="p">:</span> <span class="n">bash</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">spark</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">start</span><span class="o">-</span><span class="n">slave</span><span class="o">.</span><span class="n">sh</span> <span class="n">spark</span><span class="p">:</span><span class="o">//</span><span class="n">master</span><span class="p">:</span><span class="mi">7077</span> <span class="o">&amp;&amp;</span> <span class="n">ping</span> <span class="n">localhost</span> <span class="o">&gt;/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span>
</pre></div>
</div>
<p>docker-compose.yml中定义了两种类型的服务：master和slave。master类型的服务容器将负责管理操作，worker则负责具体处理。</p>
<p>（2）master服务</p>
<p>master服务映射了好几组端口到本地，分别功能为：</p>
<p>·4040：Spark运行任务时候提供web界面观测任务的具体执行状况，包括执行到哪个阶段、在哪个executor上执行；</p>
<p>·8042：Hadoop的节点管理界面；</p>
<p>·7077：Spark主节点的监听端口，用户可以提交应用到这个端口，worker节点也可以通过这个端口连接到主节点构成集群；</p>
<p>·8080：Spark的监控界面，可以看到所有的worker、应用整体信息；</p>
<p>·8088：Hadoop集群的整体监控界面</p>
<p>参考文献</p>
<p><a class="reference external" href="https://www.baidu.com/link?url=3hLuzRGHWeIvI2SxPNDZlLcW9wLFV1JFi7QE-Hg-1vG-cD_Thcch1KzpY3AsIQ2PIbCYZEH0sNxCikJTW2pN5B4l4gnboqmAF8n6ujGJueVaStvmC2sfT9wkRc3rVGtW&amp;wd=&amp;eqid=8fb8b4530000cff4000000025efc2b95">利用Docker Compose 搭建Spark
集群</a></p>
</div>
<div class="section" id="compose-lnmp">
<h2><a class="toc-backref" href="#id28">Compose应用案例三：一键部署LNMP</a><a class="headerlink" href="#compose-lnmp" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://www.cnblogs.com/xiangsikai/p/9843930.html">https://www.cnblogs.com/xiangsikai/p/9843930.html</a></p>
</div>
<div class="section" id="compose-nginxtomcat">
<h2><a class="toc-backref" href="#id29">Compose应用案例四： 一键部署Nginx代理Tomcat集群</a><a class="headerlink" href="#compose-nginxtomcat" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://www.cnblogs.com/xiangsikai/p/9850425.html">https://www.cnblogs.com/xiangsikai/p/9850425.html</a></p>
<p>## Compose应用案例五： 一键部署多节点爬虫程序</p>
<p><a class="reference external" href="https://www.cnblogs.com/xiangsikai/p/9850945.html">https://www.cnblogs.com/xiangsikai/p/9850945.html</a></p>
</div>
<div class="section" id="compose-wordpress">
<h2><a class="toc-backref" href="#id30">Compose应用案例六-WordPress部署</a><a class="headerlink" href="#compose-wordpress" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="n">WordPress</span> <span class="o">&amp;&amp;</span> <span class="n">cd</span> <span class="n">WordPress</span> <span class="o">&amp;&amp;</span> <span class="n">mkdir</span> <span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="n">touch</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">docker-compose.yaml</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s1">&#39;3&#39;</span>

<span class="n">services</span><span class="p">:</span>
  <span class="n">db</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">mysql</span><span class="p">:</span><span class="mf">5.7</span>
    <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;./data/db:/var/lib/mysql&quot;</span>
    <span class="n">restart</span><span class="p">:</span> <span class="n">always</span>
    <span class="n">environment</span><span class="p">:</span>
      <span class="n">MYSQL_ROOT_PASSWORD</span><span class="p">:</span> <span class="n">wordpress</span>
      <span class="n">MYSQL_DATABASE</span><span class="p">:</span> <span class="n">wordpress</span>
      <span class="n">MYSQL_USER</span><span class="p">:</span> <span class="n">wordpress</span>
      <span class="n">MYSQL_PASSWORD</span><span class="p">:</span> <span class="n">wordpress</span>
  <span class="n">wordpress</span><span class="p">:</span>
    <span class="n">depends_on</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">db</span>

    <span class="n">image</span><span class="p">:</span> <span class="n">wordpress</span><span class="p">:</span><span class="n">latest</span>
    <span class="n">links</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">db</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;8000:80&quot;</span>
    <span class="n">restart</span><span class="p">:</span> <span class="n">always</span>
    <span class="n">environment</span><span class="p">:</span>
      <span class="n">WORDPRESS_DB_HOST</span><span class="p">:</span> <span class="n">db</span><span class="p">:</span><span class="mi">3306</span>
      <span class="n">WORDPRESS_DB_PASSWORD</span><span class="p">:</span> <span class="n">wordpress</span>
</pre></div>
</div>
<div class="figure">
<img alt="" src="../_images/docker-compose-wordPress0001.png" />
</div>
<p>打开浏览器，输入http://localhost:8000，你可以看到WordPress的安装界面了。上面配置文件中定义了两个服务，一个是db，另一个是wordpress，两个服务基于现成的镜像（数据库使用mysql:5.7
, wordpress在Docker
Hub有官方镜像），因此没有构建过程，所以启动速度很快。</p>
<p>数据库使用了一个数据卷来保存数据，宿主机目录是./data/db，数据库文件被保存在这里，environment标签定义了多个数据库变量。Wordpress服务连接到数据库中，将容器的80端口映射到本地的8000端口中。更详细的WordPress镜像使用方法可以看Docker
Hub的WordPress页面：<code class="docutils literal notranslate"><span class="pre">https://hub.docker.com/r/_/wordpress/</span></code></p>
</div>
<div class="section" id="compose-django">
<h2><a class="toc-backref" href="#id31">Compose应用案例七：Django框架部署</a><a class="headerlink" href="#compose-django" title="Permalink to this headline">¶</a></h2>
<p>1.使用Dockerfile创建基础开发环境</p>
<p><code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FROM</span> <span class="n">python</span><span class="p">:</span><span class="mi">3</span>
<span class="n">ENV</span> <span class="n">PYTHONUNBUFFERED</span> <span class="mi">1</span>
<span class="n">RUN</span> <span class="n">mkdir</span> <span class="o">/</span><span class="n">code</span>
<span class="n">WORKDIR</span> <span class="o">/</span><span class="n">code</span>
<span class="n">ADD</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span> <span class="o">/</span><span class="n">code</span><span class="o">/</span>
<span class="n">RUN</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span> <span class="o">-</span><span class="n">i</span> <span class="s2">&quot;https://pypi.doubanio.com/simple/&quot;</span>
<span class="n">ADD</span> <span class="o">.</span> <span class="o">/</span><span class="n">code</span><span class="o">/</span>
</pre></div>
</div>
<p>根据依赖编写requirements.txt文件</p>
<p><code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">&gt;</span><span class="n">requirements</span><span class="o">.</span><span class="n">txt</span><span class="o">&lt;&lt;</span><span class="n">EOF</span>
<span class="n">Django</span><span class="o">&gt;=</span><span class="mf">1.8</span><span class="p">,</span><span class="o">&lt;</span><span class="mf">2.0</span>
<span class="n">psycopg2</span>
<span class="n">EOF</span>
</pre></div>
</div>
<p>编写编排文件docker-compose.yaml文件</p>
<p><code class="docutils literal notranslate"><span class="pre">docker-compose.yaml</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">version</span><span class="p">:</span> <span class="s1">&#39;3&#39;</span>

<span class="n">services</span><span class="p">:</span>
  <span class="n">db</span><span class="p">:</span>
    <span class="n">image</span><span class="p">:</span> <span class="n">postgres</span>
    <span class="n">environment</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">POSTGRES_USER</span><span class="o">=</span><span class="n">postgres</span>
      <span class="o">-</span> <span class="n">POSTGRES_PASSWORD</span><span class="o">=</span><span class="n">postgres</span>
      <span class="o">-</span> <span class="n">POSTGRES_HOST_AUTH_METHOD</span><span class="o">=</span><span class="n">trust</span>

  <span class="n">app</span><span class="p">:</span>
    <span class="n">build</span><span class="p">:</span> <span class="o">.</span>
    <span class="n">command</span><span class="p">:</span> <span class="n">python3</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">runserver</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">8100</span>
    <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="o">.</span><span class="p">:</span><span class="o">/</span><span class="n">code</span>
    <span class="n">ports</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;8100:8100&quot;</span>
    <span class="n">depends_on</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">db</span>
</pre></div>
</div>
<p>利用docker-compose生成Django项目</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@jenkins</span> <span class="n">Django</span><span class="o">-</span><span class="n">demo</span><span class="p">]</span><span class="c1"># docker-compose run app django-admin.py startproject compose_example .</span>
</pre></div>
</div>
<p>执行完毕之后可以看到创建了一个Django项目，查看项目文件夹</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">.</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@jenkins</span> <span class="n">Django</span><span class="o">-</span><span class="n">demo</span><span class="p">]</span><span class="c1"># ll</span>
<span class="n">total</span> <span class="mi">16</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">2</span> <span class="n">root</span> <span class="n">root</span>  <span class="mi">74</span> <span class="n">Dec</span> <span class="mi">28</span> <span class="mi">01</span><span class="p">:</span><span class="mi">24</span> <span class="n">compose_example</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">336</span> <span class="n">Dec</span> <span class="mi">28</span> <span class="mi">01</span><span class="p">:</span><span class="mi">11</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="o">.</span><span class="n">yaml</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">183</span> <span class="n">Dec</span> <span class="mi">28</span> <span class="mi">01</span><span class="p">:</span><span class="mi">00</span> <span class="n">Dockerfile</span>
<span class="o">-</span><span class="n">rwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span> <span class="mi">813</span> <span class="n">Dec</span> <span class="mi">28</span> <span class="mi">01</span><span class="p">:</span><span class="mi">24</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">root</span> <span class="n">root</span>  <span class="mi">26</span> <span class="n">Dec</span> <span class="mi">28</span> <span class="mi">01</span><span class="p">:</span><span class="mi">10</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<p>注意：</p>
<p>此项目是在root下创建的，默认属主属组都是root，如果是使用其他用户，可以使用如下命令</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sudo chown -R $USER:$USER
</pre></div>
</div>
<p>修改<code class="docutils literal notranslate"><span class="pre">compose_example/setting.py</span></code>文件，修改DATABASES=….的内容如下</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ALLOWED_HOSTS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">]</span>

<span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;django.db.backends.postgresql&#39;</span><span class="p">,</span>
        <span class="s1">&#39;NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="s1">&#39;USER&#39;</span><span class="p">:</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HOST&#39;</span><span class="p">:</span> <span class="s1">&#39;db&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PORT&#39;</span><span class="p">:</span> <span class="mi">5432</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>启动项目，docker-compose会启动两个容器，并连接它们</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@jenkins</span> <span class="n">Django</span><span class="o">-</span><span class="n">demo</span><span class="p">]</span><span class="c1"># docker-compose up -d</span>
<span class="n">Starting</span> <span class="n">django</span><span class="o">-</span><span class="n">demo_db_1</span> <span class="o">...</span> <span class="n">done</span>
<span class="n">Starting</span> <span class="n">django</span><span class="o">-</span><span class="n">demo_app_1</span> <span class="o">...</span> <span class="n">done</span>
</pre></div>
</div>
<p>打开浏览器输入地址进行访问http://ip:8100.至此django项目在docker-compose上部署完毕。</p>
</div>
<div class="section" id="compose-flask-redis">
<h2><a class="toc-backref" href="#id32">compose应用案例八：Flask框架部署，将数值记入Redis</a><a class="headerlink" href="#compose-flask-redis" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://www.cnblogs.com/zhuochong/p/10075360.html">https://www.cnblogs.com/zhuochong/p/10075360.html</a></p>
<p>参考文献：</p>
<p><a class="reference external" href="https://blog.csdn.net/weixin_30507269/article/details/97539603?utm_medium=distribute.pc_relevant.none-task-blog-baidujs_title-2&amp;spm=1001.2101.3001.4242">https://blog.csdn.net/weixin_30507269/article/details/97539603?utm_medium=distribute.pc_relevant.none-task-blog-baidujs_title-2&amp;spm=1001.2101.3001.4242</a></p>
</div>
<div class="section" id="id9">
<h2><a class="toc-backref" href="#id33">参考资料</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://blog.csdn.net/luanpeng825485697/article/details/102620131">https://blog.csdn.net/luanpeng825485697/article/details/102620131</a></p>
<p><a class="reference external" href="https://docs.docker.com/compose/install/">https://docs.docker.com/compose/install/</a></p>
<p><a class="reference external" href="https://www.ctolib.com/topics-141386.html">https://www.ctolib.com/topics-141386.html</a></p>
<p>相关博客</p>
<p><a class="reference external" href="https://github.com/PI-KA-CHU/PIKACHU-JAVA-Notebook/issues/76">https://github.com/PI-KA-CHU/PIKACHU-JAVA-Notebook/issues/76</a></p>
<p><a class="reference external" href="https://www.runoob.com/docker/docker-compose.html">Docker
Compose菜鸟教程</a></p>
<p><a class="reference external" href="https://blog.csdn.net/qq_36148847/article/details/79427878">docker-compose.yml
配置文件编写详解</a></p>
<div class="section" id="id10">
<h3><a class="toc-backref" href="#id34">本章小结</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>本章介绍了Docker的官方工具Compose的安装和使用，以及模板文件的语法和命令，并结合两个具体案例展示Compose带来的编排能力。</p>
<p>在Docker三剑客中，Compose掌管运行时的编排能力，位置十分关键。使用Compose模板文件，用户可以编写包括若干服务的一个模板文件快速启动服务栈；如果分发给他人，也可快速创建一套相同的服务栈。</p>
<p>推荐读者在日常工作中注意使用Compose来编写服务模板，并注意对常见工具栈的模板文件进行积累。</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="17.Docker三剑客之Docker-Swarm.html" class="btn btn-neutral float-right" title="Docker三剑客之Docker-Swarm" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="15.Etcd高可用的键值数据库.html" class="btn btn-neutral float-left" title="Etcd高可用的键值数据库" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2019, huxiaojian

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>