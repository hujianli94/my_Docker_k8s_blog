# Helm简化kubernetes部署

Helm是Kubernetes生态系统中的一个软件包管理工具，有点类似于Linux操作系统里面的“apt-get”和“yum”。

对Kubernetes集群进行部署应用时，我们将面临以下问题：



+ 如何管理、编辑和更新这些分散的Kubernetes应用配置文件。

+ 如何把一套相关的配置文件作为一个应用进行管理。

+ 如何分发和重用Kubernetes的应用配置。



Helm的出现就是为了很好地解决上面这些问题。Helm Chart是用来封装Kubernetes原生应用程序的一系列YAML文件。我们可以在部署应用的时候自定义应用程序的一些Metadata，以便于应用程序的分发。

对于应用发布者而言，可以通过Helm打包应用、管理应用依赖关系、管理应用版本并发布应用到软件仓库。

对于使用者而言，使用Helm后不需要编写复杂的应用部署文件，可以以简单的方式在Kubernetes上查找、安装、升级、回滚、卸载应用程序。



总之，Helm大大简化了应用管理的难度，其主要有以下优点：

```
● 管理复杂应用。Charts能定义很复杂的应用，并且可重复使用应用程序部署定义。
● 易于更新升级。
● 易于共享。Charts无论是在私有服务器还是公共服务器上，都非常易于升级、共享和托管。
● 轻松回滚。
```



## Helm基础

-  Helm

Helm是一个命令行下的客户端工具，主要用于Kubernetes应用程序Chart的创建、打包、发布以及创建和管理本地和远程的Chart仓库。



- Tiller

Tiller是Helm的服务端，部署在Kubernetes集群中。Tiller用于接收Helm的请求，并根据Chart生成Kubernetes的部署文件（Helm称为Release），然后提交给Kubernetes创建应用。Tiller还提供了Release的升级、删除、回滚等一系列功能。



- Chart

Helm的软件包，采用TAR格式，类似于APT的DEB包或者YUM的RPM包，其包含了一组定义Kubernetes资源相关的YAML文件。



- Repository

Helm的软件仓库，保存了一系列的Chart软件包，以供用户下载；并且提供了一个该Repository的Chart包清单文件，以供用户查询。Helm可以同时管理多个不同的Repository。



- Config

应用程序实例化部署运行时的配置信息。



- Release

使用helm install命令在Kubernetes集群中部署的Chart称为Release。Helm中提到的Release和我们通常概念中的版本有所不同，这里的Release可以理解为Helm使用Chart包部署的一个应用实例。在同一个集群中，一个Chart可以使用不同的配置（Config）安装多次，每次安装都会创建一个Release。





## Helm 3 v3  变化

2019 年 11 月 13 日， Helm 团队发布 Helm v3 的第一个稳定版本。
该版本主要变化如下：
架构变化：

![](../_static/k8s-helmv30001.png)

1. 最明显的变化是 Tiller 的删除
2. Release 名称可以在不同命名空间重用
3. 支持将 Chart 推送至 Docker 镜像仓库中
4. 使用 JSONSchema 验证 chart values
5. 其他



## Helm 3快速入门

Helm的版本v2和版本v3目前处于维护当中，考虑了轻量、安全等特性，这里选择只介绍较新的版本v3的部署和使用，版本v2需要额外部署Tiller，而客户端的使用方法大多数都与版本v3相同。



## 安装

### 安装方式1

下载最新的helm 3安装脚本

```shell
curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
```

赋权并执行

```shell
chmod 700 get_helm.sh && sh get_helm.sh
```

通过执行helm命令来验证helm安装。

```
helm
```

增加一个公有稳定版的helm的repo仓库

```shell
helm repo add stable https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts
```

让我们安装稳定的nginx 图表并测试设置

```
helm install nginx stable/nginx-ingress
```

列出已安装的helm 图表

```
helm ls
```



### 安装方式2

安装helm-v3

使用一条命令安装helm

```
curl -L https://git.io/get_helm.sh | bash
```

如果安装包无法下载，可以复制脚本输出的下载链接手动下载，然后解压复制到bin目录，如下所示：

```shell
# Helm 客户端下载地址：https://github.com/helm/helm/releases解压移动到/usr/bin/目录即可。
wget https://get.helm.sh/helm-vv3.2.1-linux-amd64.tar.gz
tar zxvf helm-v3.2.1-linux-amd64.tar.gz
mv linux-amd64/helm /usr/bin/
```



##  查看Charts仓库信息

```
[root@ci-base home]# helm repo list
NAME            URL
ingress-nginx   https://kubernetes.github.io/ingress-nginx
stable          http://mirror.azure.cn/kubernetes/charts
aliyun          https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts
```



## 常见操作

```
4.2  配置国内 t chart  仓库

 微软仓库（http://mirror.azure.cn/kubernetes/charts/）这个仓库推荐，基本
上官网有的 chart 这里都有。
 阿里云仓库（https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts ）
 官方仓库（https://hub.kubeapps.com/charts/incubator）官方 chart 仓库，国内有点不好使。


#添加存储库
helm repo add stable http://mirror.azure.cn/kubernetes/charts
helm repo add aliyun https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts
helm repo update

#查看配置的存储库
helm repo list
helm search repo stable

#删除存储库：
helm repo remove aliyun

# 列出stable仓库中维护的所有Charts的列表
helm search repo

# 列出复合条件的Charts，过滤器查找
helm search repo redis
helm ls --all-namespaces



# 查看Charts的详细信息
[root@ci-base home]# helm inspect chart stable/redis
apiVersion: v1
appVersion: 5.0.7
deprecated: true
description: DEPRECATED Open source, advanced key-value store. It is often referred
  to as a data structure server since keys can contain strings, hashes, lists, sets
  and sorted sets.
home: http://redis.io/
icon: https://bitnami.com/assets/stacks/redis/img/redis-stack-220x234.png
keywords:
- redis
- keyvalue
- database
name: redis
sources:
- https://github.com/bitnami/bitnami-docker-redis
version: 10.5.7

```



## 安装stable/redis在ns=redis中

```
//创建
helm search repo redis
kubectl create namespace redis
helm install chart stable/redis -n redis --dry-run
helm install chart stable/redis -n redis


//查看创建的charts,查看所有ns
[root@ci-base home]# helm list --all-namespaces
NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION
chart           redis           1               2020-11-13 15:11:53.740004087 +0800 CST deployed        redis-10.5.7            5.0.7

//查看单个ns
[root@ci-base ~]# helm list -n ci-gitee-10523


//删除命名空间中的chart
[root@ci-base home]# helm -n redis uninstall chart
release "chart" uninstalled

[root@ci-base home]# helm list -A
NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION
```



```
# 安装stable/redis

//创建
[root@ci-base home]# helm install redis stable/redis

//查看
[root@ci-base home]# helm list
NAME    NAMESPACE       REVISION        UPDATED                                 STATUS          CHART           APP VERSION
redis   default         1               2020-11-13 15:24:01.368251708 +0800 CST deployed        redis-10.5.7    5.0.7

//删除
[root@ci-base home]# helm uninstall redis
或者使用delete
[root@ci-base home]# helm delete redis
release "redis" uninstalled

[root@ci-base home]# helm list


# 回滚
helm rollback
//命令格式：
helm rollback <RELEASE> [REVISION] [flags]
[aiops@3 test]$ helm rollback helloworld 1


# 升级
helm upgrade

//命令语法：
helm uninstall RELEASE_NAME [flags]

# 获取指定Release变更历史
helm history

//获取某个release历史的安装更新记录
$ helm history helloworld


# helm pull
//从chart仓库中下载打包好的chart到本地存储
[aiops@3 test]$ helm pull stable/mysql
```



## helm包检查项目

```
# helm包检查项目
[root@ci-base ~]# helm list --all-namespaces

// 查看Config-Map
[root@ci-base ~]# kubectl get cm -n ci-gitee-10523

// 查看Deployment
[root@ci-base ~]# kubectl get Deployment -n ci-gitee-10523

// 查看service
[root@ci-base ~]# kubectl get svc -n ci-gitee-10523

// 查看ingress
[root@ci-base ~]# kubectl get Ingress -n ci-gitee-10523

// 查看pod
[root@ci-base ~]# kubectl get pod -n ci-gitee-10523

// 查看ReplicaSet
[root@k8s-master ~]# kubectl get rs -lapp=demo

[root@k8s-master ~]# kubectl get rs -lapp=demo --show-labels
NAME                         DESIRED   CURRENT   READY   AGE   LABELS
demo-deployment-68b59dd5b8   2         2         2       73m   app=demo,pod-template-hash=68b59dd5b8



# 查看资源信息
// 查看pod里面的容器
kubectl describe -n dev pod cigiteebe-7c5b7486c-pc22z
```





## Helm安装和卸载

```
# helm安装和卸载
[root@ci-base home]# helm install myapp --debug ./mychart --set service.type=NodePort
[root@ci-base home]# helm uninstall myapp


[root@ci-base home]# helm uninstall chart
[root@ci-base home]# helm list


# 删除命名空间ci-gitee-11856中的chart
helm uninstall -n ci-gitee-11856 ci-gitee-11856

#删除命名空间dev中的chart
helm uninstall -n dev dev


正确姿势
1、brew install helm
2、helm repo add stable http://mirror.azure.cn/kubernetes/charts/
3、helm repo update
4、helm install stable/xxx



helm install --name myapp --dry-run --debug ./mychart --set service.type=NodePort
helm install --name myapp --debug ./mychart --set service.type=NodePort
```



##  使用Helm部署Demo

接下来我们基于以上认知和Demo配置来进行部署，流程如图

![](../_static/k8s-helm0001.png)



### chart 的基本结构

```
[root@ci-base helm]# helm create test
Creating test

[root@ci-base helm]# tree test/ -L 3
test/
├── charts
├── Chart.yaml
├── templates
│   ├── deployment.yaml
│   ├── _helpers.tpl
│   ├── hpa.yaml
│   ├── ingress.yaml
│   ├── NOTES.txt
│   ├── serviceaccount.yaml
│   ├── service.yaml
│   └── tests
│       └── test-connection.yaml
└── values.yaml

```

- charts 目录存放依赖的chart
- Chart.yaml 包含Chart的基本信息，包括chart版本，名称等
- templates 目录下存放应用一系列 k8s 资源的 yaml 模板
- _helpers.tpl 此文件中定义一些可重用的模板片断，此文件中的定义在任何资源定义模板中可用
- NOTES.txt 介绍chart 部署后的帮助信息，如何使用chart等
- values.yaml 包含了必要的值定义（默认值）, 用于存储 templates 目录中模板文件中用到变量的值



### helm create

创建一个 Chart 模板

```
# helm create test
Creating test
```



### helm package

打包一个 Chart 模板

```
[root@ci-base helm]# helm package test
Successfully packaged chart and saved it to: /home/k8s-example/helm/test-0.1.0.tgz
```



### helm search

查找可用的 Chart 模板

```
[root@ci-base helm]# helm search hub nginx
URL                                                     CHART VERSION   APP VERSION     DESCRIPTION
https://hub.helm.sh/charts/wiremind/nginx               2.1.1                           An NGINX HTTP server
https://hub.helm.sh/charts/bitnami/nginx                8.2.3           1.19.6          Chart for the nginx server
.........
```

### helm inspect

查看指定 Chart 的基本信息

```
[root@ci-base helm]# helm inspect chart test
apiVersion: v2
appVersion: 1.16.0
description: A Helm chart for Kubernetes
name: test
type: application
version: 0.1.0

```



### Chart 模板示例

#### Chart 文件结构

```
wordpress
├── charts
├── Chart.yaml
├── README.md
├── requirements.lock
├── requirements.yaml
├── templates
│   ├── deployment.yaml
│   ├── externaldb-secrets.yaml
│   ├── _helpers.tpl
│   ├── ingress.yaml
│   ├── NOTES.txt
│   ├── pvc.yaml
│   ├── secrets.yaml
│   ├── svc.yaml
│   └── tls-secrets.yaml
└── values.yaml
```

一个 wordpress chart 如上（去除部分 test 和 charts 依赖）， 基本结构由以下几个部分组成：

- charts 存放子Chart (Subchart) 的定义，Subchart 指的是当前 Chart 依赖的 Chart ， 在 requirements.yaml 中定义
- Chart.yaml 包含 Chart 信息的 YAML 文件， 包括 Chart 的版本、名称等，在 DCE Helm 插件中还包含 Chart 的 **团队授权** 信息 和 **是否公开** 的信息
- README.md 可选：Chart 的介绍信息等（该文件对于一个大型 Chart 来说十分重要）
- Requirements.yaml 可选：列举当前 Chart 的需要依赖的 Chart
- templates
  - 该目录下存放 Chart 所有的 K8s 资源定义模板，通常不同的资源放在不同的文件中，DCE Helm 插件中自定义模板的 K8s 资源统一放在 all_sources.yaml 文件中
  - _helpers.tpl ， 通常这个文件存放可重用的模板片段，该文件中的定义可以在 Chart 其它资源定义模板中使用
  - NOTES.txt，可选：一段简短使用说明的文本文件，用于安装 Release 后提示用户使用
- values.yaml 当前 Chart 的默认配置的值



### 编写一个简单的 Chart 示例

本节以构建一个名称为 nginx-test Chart 为示例，来描述一个 chart 必要条件。

```
# helm create nginx-test
Creating nginx-test
```

1、Chart.yaml 文件是 一个 chart 必要文件， 该文件可以简单包括以下字段（具体字段请参考[Helm官网](https://links.jianshu.com/go?to=https%3A%2F%2Fhelm.sh%2F))

```
[root@ci-base helm]# cat nginx-test/Chart.yaml |grep -v "^$"|grep -v "^#"
apiVersion: v2
name: nginx-test
description: A Helm chart for Kubernetes
type: application
version: 0.1.0
appVersion: 1.16.0
```

2、values.yaml 文件是 chart 的必要文件，以 nginx 为示例：

```
[root@ci-base helm]# cat nginx-test/values.yaml |grep -v "^$"|grep -v "#"
replicaCount: 1
image:
  repository: nginx
  pullPolicy: IfNotPresent
  tag: ""
imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""
serviceAccount:
  create: true
  annotations: {}
  name: ""
podAnnotations: {}
podSecurityContext: {}
securityContext: {}
service:
  type: ClusterIP
  port: 80
ingress:
  enabled: false
  annotations: {}
  hosts:
    - host: chart-example.local
      paths: []
  tls: []
resources: {}
autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 100
  targetCPUUtilizationPercentage: 80
nodeSelector: {}
tolerations: []
affinity: {}
```

从示例中可以看出，values.yaml 中定义了一些当前chart 的一些默认值，用于 templates 下的 K8s 资源 yaml 渲染时填充默认值。

不过需要注意的是，**如果使用 helm install 来部署一个 Release , 可以通过下面命令指定一份yaml 文件作为填充值**：

```
helm install --values=myvals.yaml nginx
```

> 注意：上面命令不要复制执行，执行会报错的。请根据实际情况执行！！！



3、创建 templates 下的模板文件， 用于生成 Kubernetes 资源清单(manifests) 如下所示:

```
# cat nginx-test/templates/deployment.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "nginx-test.fullname" . }}
  labels:
...
```

上面定义了 一个 deployments.yaml 和 service.yaml 资源文件，里面使用 {{ }} 符号的是 Go 模板语言的标准。其中可以通过：

- .Values 对象访问 values.yaml 文件的内容， 前面的dot(.) 表示从顶层命名空间开始，找到 Values 对象(下同)
- .Release、.Chart 开头的预定义值可用于任何的模板中
- .Chart 对象用来访问 Chart.yaml 文件的内容
- .Release 对象是 Helm的内置对象之一， 使用 Helm 安装一个 release 时，由 Tiller 分配 release 的名称



4、命名模板(_helper.tpl) ：可以从上面看到有 {{ template "nginx-test.fullname" . }} 定义。该定义由 _helper.tpl 文件定义的字段来实现，比如下面一个 _helper.tpl :

```
# cat nginx-test/templates/_helpers.tpl 
{{/* vim: set filetype=mustache: */}}
{{/*
Expand the name of the chart.
*/}}
...
```

该模板定义了 "nginx-test.name"、"nginx-test.fullname"、"nginx-test.chart" 等可重用模板部分，当模板引擎读取该文件时，它存储对 nginx-test.name等的引用， 直到调用 template "nginx-test.name" 为止。然后把值渲染到模板中。

注意 {{ template "nginx-test.chart" . }} 后面有个dot(.)，这是因为一个已命名的模板（用于创建 define) 被渲染时，它将接收由该 template 调用传入的范围（scope)。没有范围传入，在模板中无法访问任何内容，因此在：

```
{{- define "nginx-test.chart" -}}
这里面的 .Chart 将无法访问，导致在模板中无法看到内容，因为这里值为空
{{- end -}}
```

因此在模板中将 范围(scope) 传入即可正常使用：

```
# cat nginx-test/templates/service.yaml 
apiVersion: v1
kind: Service
metadata:
  name: {{ include "nginx-test.fullname" . }}
```

在末尾传递了 . 这样就可以使用 .Values 或者 .Chart 或其它范围(scope)



5、Chart 依赖（requirements.yaml)：比如 WordPress Chart 依赖于 mariadb Chart， 下面是 WordPress 的依赖(requirements.yaml)：

```
dependencies:
- name: mariadb
  version: 5.x.x
  repository: https://kubernetes-charts.storage.googleapis.com/
  condition: mariadb.enabled
  tags:
    - wordpress-database
```



该文件列举当前 Chart 所有的 依赖（subchart)。有几个字段是必要的：

- name: 依赖 Chart 的名称（必要）
- version: 依赖 Chart 的版本号（必要）
- repository: 依赖 Chart 的存储库完整URL，必须通过 helm repo add 添加 repository（存储库）到本地





##  开发自己的  chart
1、先创建模板
2、修改 Chart.yaml，Values.yaml，添加常用的变量
3、 在 templates 目录下创建部署镜像所需要的 yaml 文件，并变量引用 yaml 里经常变动的字段



## 常见命令

```
//基于本地Chart目录部署
#helm install -f values.yaml -n ci-gitee-nginx ci-gitee-nginx ./

//删除release
# helm uninstall -n ci-gitee-nginx ci-gitee-nginx
# helm delete -n ci-gitee-nginx ci-gitee-nginx

// 查看版本历史
# helm history -n ci-gitee-nginx ci-gitee-nginx

// 下载Chart
#helm fetch xinlin/k8sapp

 //基于本地Chart目录部署
# helm install ./k8sapp
 
 // 打包
# helm package nginx_text
 
 // 搜索
# helm search k8sapp

// 启动本地仓库服务
# helm serve

// 查看所有namespaces中部署的release
# helm list --all-namespaces
```





## 参考文献

https://blog.csdn.net/weixin_36938307/article/details/105245770

https://www.cnblogs.com/xiao987334176/p/12752783.html

